<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>åºŸåœŸæ–¹èˆŸ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>âš”ï¸</text></svg>">
    
    <style>
        /* ====== åŸºç¡€é‡ç½® ====== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            font-family: 'Microsoft YaHei', sans-serif;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #0a0a12;
            color: #e0e0ff;
            position: fixed;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overscroll-behavior: none;
        }

        /* ====== åŠ è½½å±å¹• ====== */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a2e;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(52, 152, 219, 0.3);
            border-top-color: #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        /* ====== ä¸»æ¸¸æˆå®¹å™¨ ====== */
        #game-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 4px;
            gap: 4px;
            display: none;
        }

        /* ====== çŠ¶æ€æ  ====== */
        #status-bar {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            border-radius: 8px;
            padding: 6px 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #3498db;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            height: 40px;
            font-size: 11px;
            flex-shrink: 0;
            min-width: 0;
        }

        .status-items-container {
            display: flex;
            align-items: center;
            gap: 8px;
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
            scrollbar-width: none;
            -ms-overflow-style: none;
            flex: 1;
            min-width: 0;
        }

        .status-items-container::-webkit-scrollbar {
            display: none;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
        }

        .status-icon {
            font-size: 14px;
            width: 20px;
            text-align: center;
            color: #3498db;
            flex-shrink: 0;
        }

        .status-value {
            font-size: 11px;
            font-weight: bold;
            color: #fff;
            white-space: nowrap;
        }

        /* ====== ä¸»å†…å®¹åŒºåŸŸ ====== */
        #main-content {
            flex: 1;
            display: flex;
            gap: 4px;
            min-height: 0;
            overflow: hidden;
        }

        /* ====== åœ°å›¾åŒºåŸŸ ====== */
        #map-container {
            flex: 1;
            background: rgba(20, 25, 40, 0.95);
            border-radius: 8px;
            border: 1px solid #444;
            position: relative;
            overflow: hidden;
            min-width: 0;
            min-height: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        .map-header {
            text-align: center;
            margin-bottom: 10px;
            color: #3498db;
            font-size: 14px;
            font-weight: bold;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(52, 152, 219, 0.3);
        }

        .map-buildings-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 8px;
            overflow-y: auto;
            flex: 1;
            padding: 5px;
        }

        .map-building-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 8px;
            border: 1px solid rgba(52, 152, 219, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
        }

        .map-building-item:hover, .map-building-item:active {
            background: rgba(52, 152, 219, 0.1);
            transform: translateY(-1px);
        }

        .map-building-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .map-building-name {
            font-size: 10px;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .map-building-level {
            font-size: 9px;
            color: #FFD700;
            background: rgba(255, 215, 0, 0.1);
            padding: 1px 4px;
            border-radius: 4px;
        }

        .map-info-panel {
            margin-top: 10px;
            padding: 10px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 6px;
            border: 1px solid rgba(52, 152, 219, 0.3);
        }

        .map-info-title {
            color: #3498db;
            font-size: 11px;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .map-info-row {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #95a5a6;
            margin-bottom: 3px;
        }

        /* ====== æ§åˆ¶é¢æ¿ ====== */
        #control-panel {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 4px;
            padding: 6px;
            background: rgba(35, 40, 60, 0.95);
            border-radius: 8px;
            border: 1px solid #444;
            max-height: 100px;
            overflow-y: hidden;
            overflow-x: auto;
            flex-shrink: 0;
        }

        /* ====== æŒ‰é’®ç³»ç»Ÿ ====== */
        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            border: none;
            border-radius: 6px;
            color: white;
            padding: 4px 2px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.1s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            min-height: 50px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            -webkit-tap-highlight-color: transparent;
            overflow: hidden;
            min-width: 0;
            user-select: none;
        }

        .btn:active {
            transform: translateY(1px);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .btn-success { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .btn-warning { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .btn-purple { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
        .btn-orange { background: linear-gradient(135deg, #e67e22, #d35400); }
        .btn-teal { background: linear-gradient(135deg, #1abc9c, #16a085); }
        .btn-gold { background: linear-gradient(135deg, #FFD700, #FFA500); }

        /* ====== å¼¹çª—ç³»ç»Ÿ ====== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: flex-start;
            justify-content: center;
            z-index: 1000;
            padding: 10px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        .modal-content {
            background: #2c3e50;
            border-radius: 12px;
            padding: 15px;
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            border: 2px solid #3498db;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            position: relative;
            margin-top: 5vh;
            -webkit-overflow-scrolling: touch;
        }

        .modal-title {
            font-size: 16px;
            color: #3498db;
            margin-bottom: 15px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #e74c3c;
            color: white;
            border: none;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 1001;
        }

        /* ====== é€šçŸ¥ç³»ç»Ÿ ====== */
        #notification-container {
            position: fixed;
            top: 50px;
            right: 10px;
            z-index: 999;
            display: flex;
            flex-direction: column;
            gap: 5px;
            max-width: 280px;
            pointer-events: none;
        }

        .notification {
            background: #34495e;
            color: white;
            padding: 10px 12px;
            border-radius: 6px;
            border-left: 4px solid #3498db;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            animation: fadeIn 0.3s, fadeOut 0.3s 2.7s forwards;
            font-size: 12px;
            line-height: 1.3;
            pointer-events: auto;
            max-width: 100%;
            word-break: break-word;
        }

        .notification.success { border-left-color: #2ecc71; }
        .notification.warning { border-left-color: #f39c12; }
        .notification.danger { border-left-color: #e74c3c; }
        .notification.info { border-left-color: #3498db; }

        /* ====== å»ºç­‘é¡¹æ ·å¼ ====== */
        .building-item {
            background: rgba(26, 188, 156, 0.1);
            border: 1px solid #1abc9c;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.1s;
            font-size: 12px;
        }

        .building-item:active {
            background: rgba(26, 188, 156, 0.2);
        }

        .building-item.built {
            background: rgba(46, 204, 113, 0.1);
            border-color: #2ecc71;
        }

        .building-item.insufficient {
            background: rgba(231, 76, 60, 0.1);
            border-color: #e74c3c;
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ====== ç§‘æŠ€é¡¹æ ·å¼ ====== */
        .tech-item {
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid #3498db;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.1s;
            font-size: 12px;
        }

        .tech-item:active {
            background: rgba(52, 152, 219, 0.2);
        }

        .tech-item.researched {
            background: rgba(46, 204, 113, 0.1);
            border-color: #2ecc71;
        }

        .tech-item.locked {
            background: rgba(149, 165, 166, 0.1);
            border-color: #95a5a6;
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ====== æˆå°±é¡¹æ ·å¼ ====== */
        .achievement-item {
            background: rgba(155, 89, 182, 0.1);
            border: 1px solid #9b59b6;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .achievement-item.unlocked {
            background: rgba(46, 204, 113, 0.1);
            border-color: #2ecc71;
        }

        /* ====== æ€ªç‰©ç³»ç»Ÿæ ·å¼ ====== */
        .monster-item {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.3);
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 6px;
            font-size: 11px;
        }

        .monster-hp-bar {
            height: 6px;
            background: #34495e;
            border-radius: 3px;
            margin: 4px 0;
            overflow: hidden;
        }

        .monster-hp-fill {
            height: 100%;
            transition: width 0.3s;
        }

        .monster-attack-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border: none;
            border-radius: 4px;
            color: white;
            padding: 4px 8px;
            font-size: 10px;
            cursor: pointer;
            margin-top: 5px;
            width: 100%;
        }

        .monster-attack-btn:active {
            transform: translateY(1px);
        }

        .monster-attack-btn:disabled {
            background: linear-gradient(135deg, #7f8c8d, #95a5a6);
            cursor: not-allowed;
            opacity: 0.6;
        }

        #monster-panel {
            margin-top: 10px;
            padding: 10px;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 6px;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .monster-panel-header {
            color: #e74c3c;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #monster-list {
            max-height: 120px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .monster-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            font-size: 10px;
            margin-bottom: 8px;
        }

        .monster-stat {
            background: rgba(0, 0, 0, 0.2);
            padding: 4px;
            border-radius: 4px;
            text-align: center;
        }

        .monster-stat-value {
            color: #f39c12;
            font-weight: bold;
        }

        /* è¢­å‡»é¢„è­¦æ”¾åœ¨æ€ªç‰©é¢æ¿å†…éƒ¨ */
        .attack-timer-container {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(231, 76, 60, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid #c0392b;
            animation: pulse 2s infinite;
        }

        .attack-timer-container.hidden {
            display: none;
        }

        @keyframes pulse {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }

        /* ====== åŠ¨ç”»å®šä¹‰ ====== */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); }
        }

        @keyframes spin {
            100% { transform: rotate(360deg); }
        }

        /* ====== æ¢ç´¢è®¡æ—¶å™¨ ====== */
        #explore-timer {
            position: fixed;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            z-index: 998;
            font-size: 12px;
            border: 1px solid #2ecc71;
            box-shadow: 0 3px 10px rgba(0,0,0,0.4);
            display: none;
            text-align: center;
            min-width: 180px;
            max-width: 90%;
            word-break: break-word;
        }

        /* ====== å»ºç­‘è¯¦æƒ…å¼¹çª— ====== */
        .building-detail-item {
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid #3498db;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .upgrade-btn {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            border: none;
            border-radius: 6px;
            color: white;
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.1s;
            width: 100%;
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
        }

        .upgrade-btn:active {
            transform: translateY(1px);
        }

        .upgrade-btn:disabled {
            background: linear-gradient(135deg, #7f8c8d, #95a5a6);
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* ====== DLCé¡¹æ ·å¼ ====== */
        .dlc-item {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #FFD700;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .dlc-item.active {
            background: rgba(46, 204, 113, 0.1);
            border-color: #2ecc71;
        }

        .dlc-item.installed {
            background: rgba(52, 152, 219, 0.1);
            border-color: #3498db;
        }

        .dlc-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
        }

        .dlc-badge.new { background: #e74c3c; color: white; }
        .dlc-badge.hot { background: #f39c12; color: white; }
        .dlc-badge.free { background: #2ecc71; color: white; }
        .dlc-badge.premium { background: #9b59b6; color: white; }

        /* ====== æ–‡ä»¶ä¸Šä¼ æ ·å¼ ====== */
        .file-upload-area {
            border: 2px dashed #3498db;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 10px 0;
            background: rgba(52, 152, 219, 0.1);
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-upload-area:hover {
            background: rgba(52, 152, 219, 0.2);
            border-color: #2980b9;
        }

        .file-upload-area.dragover {
            background: rgba(46, 204, 113, 0.2);
            border-color: #27ae60;
            transform: scale(1.02);
        }

        .file-input {
            display: none;
        }

        /* ====== å“åº”å¼è®¾è®¡ ====== */
        /* ç«–å±æ¨¡å¼ */
        @media (max-width: 768px) and (orientation: portrait) {
            #game-container {
                padding: 4px;
                gap: 4px;
            }
            
            #status-bar {
                height: 36px;
                font-size: 10px;
                padding: 4px 6px;
            }
            
            .status-icon {
                font-size: 12px;
                width: 18px;
            }
            
            .status-value {
                font-size: 10px;
            }
            
            #control-panel {
                grid-template-columns: repeat(5, 1fr);
                gap: 3px;
                padding: 4px;
                max-height: 100px;
            }
            
            .btn {
                min-height: 45px;
                padding: 3px 1px;
                font-size: 9px;
                gap: 1px;
            }
            
            .btn span:first-child {
                font-size: 14px;
            }
            
            .modal-content {
                padding: 12px;
                margin-top: 10px;
            }
            
            .modal-title {
                font-size: 14px;
                margin-bottom: 12px;
            }
            
            .close-btn {
                width: 24px;
                height: 24px;
                font-size: 14px;
                top: 8px;
                right: 8px;
            }
            
            .map-buildings-container {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 6px;
            }
            
            .map-building-item {
                padding: 6px;
            }
        }

        /* æ¨ªå±æ¨¡å¼ */
        @media (max-width: 768px) and (orientation: landscape) {
            #game-container {
                padding: 6px;
                gap: 6px;
            }
            
            #status-bar {
                height: 38px;
                font-size: 11px;
                padding: 6px 8px;
            }
            
            #control-panel {
                grid-template-columns: repeat(8, 1fr);
                gap: 4px;
                padding: 6px;
                max-height: 90px;
            }
            
            .btn {
                min-height: 50px;
                padding: 4px 2px;
                font-size: 10px;
                gap: 2px;
            }
        }

        /* è¶…å°å±å¹• */
        @media (max-width: 360px) {
            #control-panel {
                grid-template-columns: repeat(4, 1fr);
                max-height: 120px;
            }
            
            .btn {
                min-height: 50px;
            }
            
            #status-bar {
                height: 34px;
                font-size: 9px;
            }
            
            .status-items-container {
                gap: 6px;
            }
            
            .map-buildings-container {
                grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
                gap: 5px;
            }
        }

        /* å¹³æ¿å’Œå¤§å±å¹• */
        @media (min-width: 768px) {
            #game-container {
                padding: 8px;
                gap: 8px;
            }
            
            #status-bar {
                height: 44px;
                font-size: 12px;
                padding: 8px 12px;
            }
            
            .status-icon {
                font-size: 16px;
                width: 24px;
            }
            
            .status-value {
                font-size: 12px;
            }
            
            #control-panel {
                grid-template-columns: repeat(10, 1fr);
                gap: 6px;
                padding: 8px;
                max-height: 100px;
            }
            
            .btn {
                min-height: 60px;
                padding: 6px 4px;
                font-size: 11px;
                gap: 3px;
            }
        }

        /* ====== é˜²æ­¢é•¿æŒ‰èœå• ====== */
        * {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }
    </style>
</head>
<body>
    <!-- åŠ è½½å±å¹• -->
    <div id="loading-screen">
        <div class="loading-spinner"></div>
        <div style="font-size: 18px; color: #3498db; margin: 8px 0; font-weight: bold;">åºŸåœŸæ–¹èˆŸ</div>
        <div id="loading-text" style="font-size: 12px; color: #95a5a6; text-align: center; max-width: 250px;">
            æ­£åœ¨åˆå§‹åŒ–æ¸¸æˆä¸–ç•Œ...
        </div>
    </div>

    <!-- æ¢ç´¢è®¡æ—¶å™¨ -->
    <div id="explore-timer"></div>

    <!-- é€šçŸ¥å®¹å™¨ -->
    <div id="notification-container"></div>

    <!-- ä¸»æ¸¸æˆç•Œé¢ -->
    <div id="game-container">
        <!-- çŠ¶æ€æ  -->
        <div id="status-bar">
            <div class="status-items-container">
                <div class="status-item">
                    <span class="status-icon">ğŸ“…</span>
                    <span class="status-value" id="day-count">ç¬¬1å¤©</span>
                </div>
                <div class="status-item">
                    <span class="status-icon">â°</span>
                    <span class="status-value" id="time-display">07:00</span>
                </div>
                <div class="status-item">
                    <span class="status-icon">â˜ï¸</span>
                    <span class="status-value" id="weather-display">æ™´æœ—</span>
                </div>
                <div class="status-item">
                    <span class="status-icon">ğŸ‘¥</span>
                    <span class="status-value" id="population">3äºº</span>
                </div>
                <div class="status-item">
                    <span class="status-icon">ğŸ”¬</span>
                    <span class="status-value" id="tech-points">0</span>
                </div>
                <div class="status-item">
                    <span class="status-icon">ğŸ‘¾</span>
                    <span class="status-value" id="monster-count">0</span>
                </div>
            </div>
            
            <div style="display: flex; gap: 4px; flex-shrink: 0;">
                <button class="btn btn-success" id="btn-explore" style="min-height: 28px; padding: 2px 4px;">
                    <span style="font-size: 12px;">ğŸ§­</span>
                    <span style="font-size: 8px;">æ¢ç´¢</span>
                </button>
                <button class="btn btn-warning" id="btn-pause" style="min-height: 28px; padding: 2px 4px;">
                    <span style="font-size: 12px;">â¸ï¸</span>
                    <span style="font-size: 8px;">æš‚åœ</span>
                </button>
                <button class="btn btn-purple" id="btn-settings" style="min-height: 28px; padding: 2px 4px;">
                    <span style="font-size: 12px;">âš™ï¸</span>
                    <span style="font-size: 8px;">è®¾ç½®</span>
                </button>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div id="main-content">
            <div id="map-container">
                <div class="map-header">åŸºåœ°åœ°å›¾ - åºŸåœŸæ–¹èˆŸ</div>
                <div class="map-buildings-container" id="map-buildings-list">
                    <!-- å»ºç­‘å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                </div>
                
                <!-- æ€ªç‰©æˆ˜æ–—é¢æ¿ -->
                <div id="monster-panel">
                    <div class="monster-panel-header">
                        <span>âš”ï¸ æ€ªç‰©è¢­å‡»</span>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <span id="wave-count" style="font-size: 10px; color: #f39c12;">æ³¢æ¬¡: 0</span>
                            <div class="attack-timer-container hidden" id="attack-timer">
                                <span style="font-size: 14px;">âš ï¸</span>
                                <div>
                                    <div style="font-weight: bold; font-size: 10px;">è¢­å‡»é¢„è­¦</div>
                                    <div id="attack-time-left" style="font-size: 9px;">00:00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="monster-list">
                        <!-- æ€ªç‰©å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                    </div>
                    <div class="monster-stats">
                        <div class="monster-stat">
                            <div style="font-size: 9px; color: #95a5a6;">å‡»æ€æ€»æ•°</div>
                            <div class="monster-stat-value" id="total-kills">0</div>
                        </div>
                        <div class="monster-stat">
                            <div style="font-size: 9px; color: #95a5a6;">å½“å‰å¨èƒ</div>
                            <div class="monster-stat-value" id="current-threat">ä½</div>
                        </div>
                    </div>
                    <button class="btn btn-danger" id="btn-auto-defense" style="width: 100%; padding: 6px; font-size: 10px;">
                        ğŸ›¡ï¸ è‡ªåŠ¨é˜²å¾¡
                    </button>
                </div>
                
                <div class="map-info-panel">
                    <div class="map-info-title">ğŸ“ åŸºåœ°ä¿¡æ¯</div>
                    <div class="map-info-row">
                        <span>ğŸ­ å·²å»ºå»ºç­‘:</span>
                        <span id="built-count">3</span>
                    </div>
                    <div class="map-info-row">
                        <span>ğŸ‘¥ å½“å‰äººå£:</span>
                        <span id="map-population">5</span>
                    </div>
                    <div class="map-info-row">
                        <span>âš¡ èƒ½æºçŠ¶æ€:</span>
                        <span id="energy-status">æ­£å¸¸</span>
                    </div>
                    <div class="map-info-row">
                        <span>ğŸ›¡ï¸ é˜²å¾¡ç­‰çº§:</span>
                        <span id="defense-level">1</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div id="control-panel">
            <button class="btn btn-orange" id="btn-survivors">
                <span style="font-size: 14px;">ğŸ‘¥</span>
                <span>å¹¸å­˜è€…</span>
            </button>
            <button class="btn btn-success" id="btn-resources">
                <span style="font-size: 14px;">ğŸ“¦</span>
                <span>èµ„æº</span>
            </button>
            <button class="btn btn-teal" id="btn-buildings">
                <span style="font-size: 14px;">ğŸ—ï¸</span>
                <span>å»ºç­‘</span>
            </button>
            <button class="btn btn-purple" id="btn-tech">
                <span style="font-size: 14px;">ğŸ”¬</span>
                <span>ç§‘æŠ€</span>
            </button>
            <button class="btn btn-teal" id="btn-achievements">
                <span style="font-size: 14px;">ğŸ†</span>
                <span>æˆå°±</span>
            </button>
            <button class="btn btn-gold" id="btn-dlc">
                <span style="font-size: 14px;">ğŸ</span>
                <span>DLC</span>
            </button>
            <button class="btn btn-success" id="btn-save">
                <span style="font-size: 14px;">ğŸ’¾</span>
                <span>ä¿å­˜</span>
            </button>
            <button class="btn btn-danger" id="btn-load">
                <span style="font-size: 14px;">ğŸ“‚</span>
                <span>åŠ è½½</span>
            </button>
        </div>
    </div>

    <!-- æ‰€æœ‰å¼¹çª— -->
    <div class="modal" id="survivors-modal">
        <div class="modal-content">
            <div class="modal-title">å¹¸å­˜è€…ç®¡ç†</div>
            <button class="close-btn" onclick="closeModal('survivors-modal')">Ã—</button>
            <div id="survivors-content">
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 12px; color: #95a5a6; margin-bottom: 8px;">å¹¸å­˜è€…åˆ—è¡¨ (å½“å‰: <span id="survivor-count">5</span>/<span id="max-population">12</span>)</div>
                    <div id="survivors-list" style="max-height: 40vh; overflow-y: auto;"></div>
                </div>
                <button class="btn btn-success" id="recruit-btn" style="width: 100%; padding: 8px;">æ‹›å‹Ÿæ–°å¹¸å­˜è€… (æ¶ˆè€—: 20ææ–™)</button>
            </div>
        </div>
    </div>

    <div class="modal" id="resources-modal">
        <div class="modal-content">
            <div class="modal-title">èµ„æºç®¡ç†</div>
            <button class="close-btn" onclick="closeModal('resources-modal')">Ã—</button>
            <div id="resources-content" style="margin-top: 15px;"></div>
        </div>
    </div>

    <div class="modal" id="buildings-modal">
        <div class="modal-content">
            <div class="modal-title">å»ºç­‘ç³»ç»Ÿ</div>
            <button class="close-btn" onclick="closeModal('buildings-modal')">Ã—</button>
            <div id="buildings-content" style="margin-top: 15px;">
                <div style="font-size: 12px; color: #95a5a6; margin-bottom: 10px;">å¯å»ºé€ å»ºç­‘:</div>
                <div id="buildings-list"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="tech-modal">
        <div class="modal-content">
            <div class="modal-title">ç§‘æŠ€æ ‘</div>
            <button class="close-btn" onclick="closeModal('tech-modal')">Ã—</button>
            <div id="tech-content" style="margin-top: 15px;">
                <div id="tech-tree"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="explore-modal">
        <div class="modal-content">
            <div class="modal-title">æ¢ç´¢åºŸåœŸ</div>
            <button class="close-btn" onclick="closeModal('explore-modal')">Ã—</button>
            <div id="explore-content" style="margin-top: 15px;">
                <div style="font-size: 12px; color: #95a5a6; margin-bottom: 10px;">é€‰æ‹©æ¢ç´¢åœ°ç‚¹ (éœ€è¦ç©ºé—²å¹¸å­˜è€…):</div>
                <div id="explore-options" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px;"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="achievements-modal">
        <div class="modal-content">
            <div class="modal-title">æˆå°±ç³»ç»Ÿ</div>
            <button class="close-btn" onclick="closeModal('achievements-modal')">Ã—</button>
            <div id="achievements-content" style="margin-top: 15px;">
                <div style="font-size: 12px; color: #95a5a6; margin-bottom: 10px;">å·²è§£é”: <span id="unlocked-achievements">0</span>/12</div>
                <div id="achievements-list"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <div class="modal-title">æ¸¸æˆè®¾ç½®</div>
            <button class="close-btn" onclick="closeModal('settings-modal')">Ã—</button>
            <div id="settings-content" style="margin-top: 15px;">
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 6px; font-size: 12px;">æ¸¸æˆé€Ÿåº¦:</label>
                    <select id="game-speed" style="width: 100%; padding: 8px; background: #34495e; color: white; border: 1px solid #2c3e50; border-radius: 4px; font-size: 12px;">
                        <option value="10">ææ…¢</option>
                        <option value="25">æ…¢é€Ÿ</option>
                        <option value="35" selected>æ­£å¸¸</option>
                        <option value="50">å¿«é€Ÿ</option>
                        <option value="300">æå¿«</option>
                    </select>
                </div>
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 6px; font-size: 12px;">å±å¹•æ–¹å‘:</label>
                    <select id="screen-orientation" style="width: 100%; padding: 8px; background: #34495e; color: white; border: 1px solid #2c3e50; border-radius: 4px; font-size: 12px;">
                        <option value="auto">è‡ªåŠ¨</option>
                        <option value="portrait">ç«–å±</option>
                        <option value="landscape">æ¨ªå±</option>
                    </select>
                </div>
                <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div style="font-size: 11px; color: #95a5a6; text-align: center; margin-bottom: 8px;">
                        ã€ŠåºŸåœŸæ–¹èˆŸã€‹v3.0<br>
                        ç”Ÿå­˜å¤©æ•°: <span id="settings-day">1</span>
                    </div>
                    <button class="btn btn-danger" onclick="resetGame()" style="width: 100%; padding: 10px;">é‡ç½®æ¸¸æˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- DLCç®¡ç†å¼¹çª— -->
    <div class="modal" id="dlc-modal">
        <div class="modal-content">
            <div class="modal-title">DLCç®¡ç†</div>
            <button class="close-btn" onclick="closeModal('dlc-modal')">Ã—</button>
            <div id="dlc-content" style="margin-top: 15px;">
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 12px; color: #95a5a6; margin-bottom: 8px;">å·²å®‰è£…çš„DLCæ‰©å±•åŒ…:</div>
                    <div id="dlc-list" style="max-height: 30vh; overflow-y: auto; margin-bottom: 15px;"></div>
                    
                    <div style="text-align: center; margin: 10px 0; font-size: 11px; color: #95a5a6;">
                        ç›®å‰æ²¡æœ‰å®‰è£…ä»»ä½•DLC
                    </div>
                </div>
                
                <div style="margin: 15px 0; padding: 10px; background: rgba(52, 152, 219, 0.1); border-radius: 6px;">
                    <div style="font-size: 12px; color: #3498db; margin-bottom: 5px; font-weight: bold;">ä»URLå®‰è£…DLC</div>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <input type="text" id="dlc-url-input" placeholder="è¾“å…¥DLC JSONæ–‡ä»¶çš„URL" style="flex: 1; padding: 8px; background: #34495e; color: white; border: 1px solid #2c3e50; border-radius: 4px; font-size: 12px;">
                        <button class="btn btn-success" id="dlc-url-load" style="white-space: nowrap;">å®‰è£…</button>
                    </div>
                </div>
                
                <div style="margin: 15px 0; padding: 10px; background: rgba(46, 204, 113, 0.1); border-radius: 6px;">
                    <div style="font-size: 12px; color: #2ecc71; margin-bottom: 5px; font-weight: bold;">æœ¬åœ°ä¸Šä¼ DLCæ–‡ä»¶</div>
                    <div style="margin-top: 8px;">
                        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
                        <div class="file-upload-area" id="file-upload-area">
                            <div style="font-size: 24px; margin-bottom: 8px;">ğŸ“</div>
                            <div style="font-size: 13px; margin-bottom: 5px;">ç‚¹å‡»æˆ–æ‹–æ‹½DLC JSONæ–‡ä»¶åˆ°è¿™é‡Œ</div>
                            <div style="font-size: 10px; color: #95a5a6;">æ”¯æŒ .json æ–‡ä»¶æ ¼å¼</div>
                            <input type="file" id="dlc-file-input" class="file-input" accept=".json">
                        </div>
                    </div>
                </div>
                
                <div style="font-size: 10px; color: #95a5a6; text-align: center; margin-top: 10px;">
                    æç¤º: DLCå¯ä»¥æ·»åŠ æ–°å»ºç­‘ã€ç§‘æŠ€ã€æ€ªç‰©ç­‰å†…å®¹<br>
                    æ‚¨å¯ä»¥ä»GitHubä»“åº“ä¸‹è½½DLCæ–‡ä»¶åä¸Šä¼ å®‰è£…
                </div>
            </div>
        </div>
    </div>

    <script>
        // ====== æ€§èƒ½ä¼˜åŒ– ======
        const PerformanceMonitor = {
            lastFrameTime: 0,
            frameCount: 0,
            fps: 60,
            
            update() {
                const now = performance.now();
                this.frameCount++;
                
                if (now >= this.lastFrameTime + 1000) {
                    this.fps = this.frameCount;
                    this.frameCount = 0;
                    this.lastFrameTime = now;
                }
            }
        };

        // ====== æ¸¸æˆæ ¸å¿ƒç³»ç»Ÿ ======
        class WastelandArkGame {
            constructor() {
                console.log("æ¸¸æˆå®ä¾‹åˆ›å»º...");
                this.isInitialized = false;
                this.gameLoopId = null;
                this.isPaused = false;
                this.isExploring = false;
                this.currentExplore = null;
                this.selectedBuilding = null;
                this.buildingModalOpen = false;
                this.lastUpdateTime = 0;
                this.updateInterval = 1000 / 60;
                
                // DLCç®¡ç†
                this.activeDLCs = [];
                this.availableDLCs = [];
                
                // åˆå§‹åŒ–æ¸¸æˆæ•°æ®
                this.initGameData();
                
                // åŠ è½½å·²å®‰è£…çš„DLC
                this.loadInstalledDLCs();
            }
            
            // åˆå§‹åŒ–æ¸¸æˆæ•°æ®
            initGameData() {
                console.log("åˆå§‹åŒ–æ¸¸æˆæ•°æ®...");
                
                // æ¸¸æˆçŠ¶æ€
                this.gameState = {
                    day: 1,
                    hour: 7,
                    minute: 0,
                    weather: 'æ™´æœ—',
                    techPoints: 50,
                    unlockedTech: [],
                    achievements: [],
                    gameSpeed: 10,
                    orientation: 'auto',
                    basePopulation: 12
                };
                
                // èµ„æºç³»ç»Ÿ
                this.resources = {
                    food: { name: 'é£Ÿç‰©', amount: 200, max: 1000, icon: 'ğŸ', color: '#2ecc71', prod: 5, cons: 3 },
                    water: { name: 'æ°´', amount: 180, max: 800, icon: 'ğŸ’§', color: '#3498db', prod: 4, cons: 2 },
                    materials: { name: 'ææ–™', amount: 150, max: 1500, icon: 'ğŸ”¨', color: '#7f8c8d', prod: 3, cons: 1 },
                    medicine: { name: 'è¯å“', amount: 50, max: 500, icon: 'ğŸ’Š', color: '#e74c3c', prod: 1, cons: 0.5 },
                    ammunition: { name: 'å¼¹è¯', amount: 80, max: 600, icon: 'ğŸ”«', color: '#f39c12', prod: 2, cons: 1 },
                    energy: { name: 'èƒ½æº', amount: 60, max: 800, icon: 'âš¡', color: '#f1c40f', prod: 2, cons: 1.5 }
                };
                
                // å¹¸å­˜è€…ç³»ç»Ÿ
                this.survivors = [
                    this.createSurvivor(1, 'å¼ ä¼Ÿ', 'å»ºé€ '),
                    this.createSurvivor(2, 'æå¨œ', 'åŒ»ç–—'),
                    this.createSurvivor(3, 'ç‹åˆš', 'ç ”ç©¶'),
                    this.createSurvivor(4, 'å®‰é¥¶', 'çªå‡»æ‰‹'),
                    this.createSurvivor(5, 'ç”˜é›¨', 'ç‹™å‡»æ‰‹')
                ];
                
                // å»ºç­‘ç³»ç»Ÿ - åˆ é™¤å‡çº§ç³»ç»Ÿï¼Œå®¿èˆæä¾›æ— é™äººå£
                this.buildings = {
                    built: [
                        { 
                            id: 'command', 
                            type: 'æŒ‡æŒ¥ä¸­å¿ƒ', 
                            icon: 'ğŸ›ï¸', 
                            color: '#3498db', 
                            effect: 'å…¨å±€æ•ˆç‡+10%'
                        },
                        { 
                            id: 'dormitory', 
                            type: 'å®¿èˆ', 
                            icon: 'ğŸ ', 
                            color: '#2ecc71', 
                            effect: 'å¹¸å­˜è€…æ¢å¤+20%ï¼Œæ— é™äººå£ä¸Šé™' // ä¿®æ”¹ï¼šæ— é™äººå£ä¸Šé™
                        },
                        { 
                            id: 'kitchen', 
                            type: 'å¨æˆ¿', 
                            icon: 'ğŸ³', 
                            color: '#e67e22', 
                            effect: 'é£Ÿç‰©æ¶ˆè€—-15%'
                        }
                    ],
                    available: [
                        { id: 'farm', type: 'å†œç”°', cost: { materials: 100, energy: 30 }, effect: 'é£Ÿç‰©+15/å°æ—¶', icon: 'ğŸŒ¾', color: '#27ae60' },
                        { id: 'water_plant', type: 'å‡€æ°´å‚', cost: { materials: 120, energy: 40 }, effect: 'æ°´+12/å°æ—¶', icon: 'ğŸ’§', color: '#2980b9' },
                        { id: 'workshop', type: 'å·¥åŠ', cost: { materials: 150, energy: 50 }, effect: 'ææ–™+20/å°æ—¶', icon: 'ğŸ”¨', color: '#7f8c8d' },
                        { id: 'hospital', type: 'åŒ»ç–—ç«™', cost: { materials: 180, medicine: 50 }, effect: 'è¯å“+8/å°æ—¶', icon: 'ğŸ¥', color: '#e74c3c' },
                        { id: 'armory', type: 'å†›æ¢°åº“', cost: { materials: 200, ammunition: 80 }, effect: 'å¼¹è¯+15/å°æ—¶', icon: 'ğŸ”«', color: '#d35400' },
                        { id: 'power_plant', type: 'å‘ç”µå‚', cost: { materials: 250, energy: 100 }, effect: 'èƒ½æº+25/å°æ—¶', icon: 'âš¡', color: '#f1c40f' },
                        { id: 'library', type: 'å›¾ä¹¦é¦†', cost: { materials: 120, energy: 60 }, effect: 'ç§‘æŠ€ç‚¹+5/å°æ—¶', icon: 'ğŸ“š', color: '#9b59b6' },
                        { id: 'watchtower', type: 'ç­æœ›å¡”', cost: { materials: 160, ammunition: 60 }, effect: 'é¢„è­¦è¢­å‡»ï¼Œé˜²å¾¡+2', icon: 'ğŸ—¼', color: '#34495e' },
                        { id: 'training', type: 'è®­ç»ƒåœº', cost: { materials: 140, food: 80 }, effect: 'å¹¸å­˜è€…ç»éªŒ+10/å°æ—¶', icon: 'ğŸ‹ï¸', color: '#1abc9c' },
                        { id: 'storage', type: 'ä»“åº“', cost: { materials: 180, energy: 70 }, effect: 'èµ„æºä¸Šé™+30%', icon: 'ğŸ“¦', color: '#95a5a6' },
                        { id: 'greenhouse', type: 'æ¸©å®¤', cost: { materials: 220, energy: 90 }, effect: 'é£Ÿç‰©+25/å°æ—¶', icon: 'ğŸŒ¿', color: '#16a085' },
                        { id: 'laboratory', type: 'å®éªŒå®¤', cost: { materials: 300, energy: 120 }, effect: 'ç§‘æŠ€ç ”å‘é€Ÿåº¦+40%', icon: 'ğŸ”¬', color: '#8e44ad' },
                        { id: 'factory', type: 'å·¥å‚', cost: { materials: 400, energy: 150 }, effect: 'ææ–™+35/å°æ—¶', icon: 'ğŸ­', color: '#c0392b' },
                        { id: 'radar', type: 'é›·è¾¾ç«™', cost: { materials: 350, energy: 180 }, effect: 'æ¢ç´¢æˆåŠŸç‡+25%', icon: 'ğŸ“¡', color: '#2c3e50' }
                    ]
                };
                
                // æ€ªç‰©ç³»ç»Ÿ
                this.monsters = {
                    active: [],           // å½“å‰æ´»è·ƒçš„æ€ªç‰©
                    waveCount: 0,         // å½“å‰æ³¢æ¬¡
                    totalKills: 0,        // æ€»å‡»æ€æ•°
                    nextAttackTime: 600,  // ä¸‹æ¬¡è¢­å‡»å€’è®¡æ—¶(ç§’) - 10åˆ†é’Ÿåé¦–æ¬¡è¢­å‡»
                    lastAttackTime: 0,    // ä¸Šæ¬¡è¢­å‡»æ—¶é—´
                    attackInProgress: false, // æ˜¯å¦æ­£åœ¨è¢­å‡»ä¸­
                    baseDefense: 5,       // åŸºåœ°åŸºç¡€é˜²å¾¡åŠ›
                    defenseLevel: 1       // é˜²å¾¡ç­‰çº§
                };
                
                // æ€ªç‰©ç±»å‹æ•°æ® - ä¸°å¯Œçš„æ€ªç‰©ç³»ç»Ÿ
                this.monsterTypes = [
                    {
                        id: 'zombie',
                        name: 'æ™®é€šåƒµå°¸',
                        description: 'è¡ŒåŠ¨ç¼“æ…¢çš„æ„ŸæŸ“è€…',
                        hp: 30,
                        maxHp: 30,
                        damage: 5,
                        speed: 1,
                        reward: { food: 5, materials: 10 },
                        icon: 'ğŸ§Ÿ',
                        color: '#27ae60',
                        spawnChance: 0.4,
                        abilities: []
                    },
                    {
                        id: 'runner',
                        name: 'ç–¾è¡Œåƒµå°¸',
                        description: 'å¿«é€Ÿç§»åŠ¨çš„æ„ŸæŸ“è€…',
                        hp: 25,
                        maxHp: 25,
                        damage: 8,
                        speed: 3,
                        reward: { food: 8, materials: 15 },
                        icon: 'ğŸƒâ€â™‚ï¸',
                        color: '#2ecc71',
                        spawnChance: 0.2,
                        abilities: ['å¿«é€Ÿç§»åŠ¨']
                    },
                    {
                        id: 'mutant',
                        name: 'å˜å¼‚ä½“',
                        description: 'å—è¾å°„å˜å¼‚çš„æ€ªç‰©',
                        hp: 60,
                        maxHp: 60,
                        damage: 12,
                        speed: 2,
                        reward: { materials: 25, medicine: 10 },
                        icon: 'ğŸ§¬',
                        color: '#8e44ad',
                        spawnChance: 0.15,
                        abilities: ['å†ç”Ÿ', 'é«˜é˜²å¾¡']
                    },
                    {
                        id: 'raider',
                        name: 'æ å¤ºè€…',
                        description: 'è£…å¤‡æ­¦å™¨çš„å¹¸å­˜è€…å›å¾’',
                        hp: 45,
                        maxHp: 45,
                        damage: 15,
                        speed: 2,
                        reward: { ammunition: 20, materials: 20 },
                        icon: 'âš”ï¸',
                        color: '#c0392b',
                        spawnChance: 0.1,
                        abilities: ['è¿œç¨‹æ”»å‡»', 'é—ªé¿']
                    },
                    {
                        id: 'spitter',
                        name: 'å–·å°„è€…',
                        description: 'èƒ½è¿œç¨‹å–·å°„é…¸æ¶²çš„æ€ªç‰©',
                        hp: 35,
                        maxHp: 35,
                        damage: 10,
                        speed: 1,
                        reward: { medicine: 15, materials: 15 },
                        icon: 'ğŸ¤¢',
                        color: '#16a085',
                        spawnChance: 0.08,
                        abilities: ['è¿œç¨‹æ”»å‡»', 'è…èš€']
                    },
                    {
                        id: 'tank',
                        name: 'è£…ç”²å·¨å…½',
                        description: 'æå…¶åšå›ºçš„é‡å‹æ€ªç‰©',
                        hp: 120,
                        maxHp: 120,
                        damage: 25,
                        speed: 0.5,
                        reward: { energy: 30, materials: 50 },
                        icon: 'ğŸ¦¾',
                        color: '#7f8c8d',
                        spawnChance: 0.05,
                        abilities: ['é«˜é˜²å¾¡', 'éœ‡è¡æ”»å‡»']
                    },
                    {
                        id: 'swarm',
                        name: 'å°¸ç¾¤',
                        description: 'å¤§é‡çš„åƒµå°¸èšé›†',
                        hp: 80,
                        maxHp: 80,
                        damage: 8,
                        speed: 1,
                        reward: { food: 20, materials: 30 },
                        icon: 'ğŸ‘¥',
                        color: '#95a5a6',
                        spawnChance: 0.02,
                        abilities: ['æ•°é‡ä¼˜åŠ¿', 'åŒ…å›´']
                    }
                ];
                
                // ç²¾è‹±æ€ªç‰©ï¼ˆç¨€æœ‰ï¼‰
                this.eliteMonsters = [
                    {
                        id: 'boss_mutant',
                        name: 'å·¨å‹å˜å¼‚å…½',
                        description: 'æå…¶å±é™©çš„å˜å¼‚é¦–é¢†',
                        hp: 200,
                        maxHp: 200,
                        damage: 35,
                        speed: 1,
                        reward: { energy: 50, techPoints: 25, materials: 100, ammunition: 50 },
                        icon: 'ğŸ‘¾',
                        color: '#e74c3c',
                        spawnChance: 0.01,
                        abilities: ['é¦–é¢†å…‰ç¯', 'ç‹‚æš´', 'å¬å”¤å°å¼Ÿ']
                    },
                    {
                        id: 'alpha_raider',
                        name: 'æ å¤ºè€…é¦–é¢†',
                        description: 'æ å¤ºè€…ç»„ç»‡çš„å¤´ç›®',
                        hp: 150,
                        maxHp: 150,
                        damage: 30,
                        speed: 2,
                        reward: { ammunition: 80, medicine: 40, materials: 80, techPoints: 15 },
                        icon: 'ğŸ‘‘',
                        color: '#f39c12',
                        spawnChance: 0.01,
                        abilities: ['æŒ‡æŒ¥', 'å¼ºåŒ–è£…å¤‡', 'æˆ˜æœ¯æ’¤é€€']
                    }
                ];
                
                // ç§‘æŠ€æ ‘
                this.techTree = [
                    { id: 'basic_farming', name: 'åŸºç¡€å†œä¸š', cost: 50, effect: 'é£Ÿç‰©äº§é‡+25%', icon: 'ğŸŒ¾', requires: [], researchTime: 2 },
                    { id: 'water_purification', name: 'å‡€æ°´æŠ€æœ¯', cost: 45, effect: 'æ°´æ¶ˆè€—-20%', icon: 'ğŸ’§', requires: [], researchTime: 2 },
                    { id: 'advanced_construction', name: 'é«˜çº§å»ºé€ ', cost: 60, effect: 'å»ºç­‘é€Ÿåº¦+30%', icon: 'ğŸ—ï¸', requires: [], researchTime: 3 },
                    { id: 'solar_power', name: 'å¤ªé˜³èƒ½', cost: 80, effect: 'èƒ½æºäº§é‡+20/å°æ—¶', icon: 'â˜€ï¸', requires: ['basic_farming', 'water_purification'], researchTime: 4 },
                    { id: 'medical_research', name: 'åŒ»å­¦ç ”ç©¶', cost: 70, effect: 'è¯å“äº§é‡+15/å°æ—¶', icon: 'ğŸ’Š', requires: [], researchTime: 3 },
                    { id: 'weapon_tech', name: 'æ­¦å™¨æŠ€æœ¯', cost: 90, effect: 'å¼¹è¯äº§é‡+20/å°æ—¶', icon: 'ğŸ”«', requires: ['advanced_construction'], researchTime: 4 },
                    { id: 'automation', name: 'è‡ªåŠ¨åŒ–', cost: 120, effect: 'æ‰€æœ‰èµ„æºç”Ÿäº§+15%', icon: 'âš™ï¸', requires: ['solar_power'], researchTime: 5 },
                    { id: 'genetics', name: 'åŸºå› å­¦', cost: 150, effect: 'å¹¸å­˜è€…å¥åº·ä¸Šé™+20%', icon: 'ğŸ§¬', requires: ['medical_research'], researchTime: 6 },
                    { id: 'nuclear_power', name: 'æ ¸èƒ½', cost: 200, effect: 'èƒ½æºäº§é‡+50/å°æ—¶', icon: 'â˜¢ï¸', requires: ['automation'], researchTime: 8 },
                    { id: 'ai_system', name: 'äººå·¥æ™ºèƒ½', cost: 250, effect: 'ç§‘æŠ€ç ”å‘é€Ÿåº¦+50%', icon: 'ğŸ¤–', requires: ['automation', 'genetics'], researchTime: 10 },
                    { id: 'quantum_tech', name: 'é‡å­æŠ€æœ¯', cost: 300, effect: 'æ‰€æœ‰æ•ˆç‡+25%', icon: 'âš›ï¸', requires: ['ai_system', 'nuclear_power'], researchTime: 12 },
                    { id: 'terraforming', name: 'åœ°å½¢æ”¹é€ ', cost: 400, effect: 'è§£é”é«˜çº§å»ºç­‘', icon: 'ğŸŒ', requires: ['quantum_tech'], researchTime: 15 }
                ];
                
                // æ¢ç´¢åœ°ç‚¹
                this.exploreLocations = [
                    { name: 'åºŸå¼ƒè¶…å¸‚', risk: 'ä½', time: 10, rewards: { food: 50, materials: 30 }, icon: 'ğŸ›’', desc: 'å¯»æ‰¾é£Ÿç‰©å’Œæ—¥ç”¨å“' },
                    { name: 'æ—§åŒ»é™¢', risk: 'ä¸­', time: 15, rewards: { medicine: 60, materials: 20 }, icon: 'ğŸ¥', desc: 'æœå¯»åŒ»ç–—ç‰©èµ„' },
                    { name: 'å†›äº‹åŸºåœ°', risk: 'é«˜', time: 20, rewards: { ammunition: 100, materials: 50 }, icon: 'ğŸ–ï¸', desc: 'å¯»æ‰¾æ­¦å™¨å’Œå¼¹è¯' },
                    { name: 'ç§‘æŠ€ç ”ç©¶æ‰€', risk: 'ä¸­', time: 18, rewards: { energy: 80, techPoints: 15 }, icon: 'ğŸ”¬', desc: 'è·å–ç§‘æŠ€èµ„æ–™' },
                    { name: 'å†œåœºåºŸå¢Ÿ', risk: 'ä½', time: 12, rewards: { food: 80, water: 40 }, icon: 'ğŸšœ', desc: 'æœå¯»å†œä½œç‰©' },
                    { name: 'æ°´å¤„ç†å‚', risk: 'ä¸­', time: 16, rewards: { water: 120, materials: 40 }, icon: 'ğŸ’§', desc: 'è·å–å‡€æ°´è®¾å¤‡' },
                    { name: 'å·¥å‚é—å€', risk: 'é«˜', time: 22, rewards: { materials: 150, energy: 60 }, icon: 'ğŸ­', desc: 'å¯»æ‰¾å·¥ä¸šææ–™' },
                    { name: 'åŠ æ²¹ç«™', risk: 'ä¸­', time: 14, rewards: { energy: 100, materials: 35 }, icon: 'â›½', desc: 'è·å–ç‡ƒæ–™' },
                    { name: 'å›¾ä¹¦é¦†', risk: 'ä½', time: 13, rewards: { techPoints: 20 }, icon: 'ğŸ“š', desc: 'è·å–çŸ¥è¯†å’Œç§‘æŠ€' },
                    { name: 'è­¦å¯Ÿå±€', risk: 'ä¸­', time: 17, rewards: { ammunition: 80, medicine: 40 }, icon: 'ğŸ‘®', desc: 'å¯»æ‰¾æ­¦å™¨å’Œæ€¥æ•‘ç‰©èµ„' },
                    { name: 'å‘ç”µç«™', risk: 'é«˜', time: 25, rewards: { energy: 150, techPoints: 25 }, icon: 'âš¡', desc: 'è·å–èƒ½æºè®¾å¤‡' },
                    { name: 'åœ°ä¸‹æ©ä½“', risk: 'æé«˜', time: 30, rewards: { food: 100, water: 80, medicine: 60, ammunition: 120, materials: 100, energy: 120, techPoints: 50 }, icon: 'ğŸ•³ï¸', desc: 'é«˜é£é™©é«˜å›æŠ¥' }
                ];
                
                // æˆå°±ç³»ç»Ÿ
                this.achievementsList = [
                    { id: 'first_day', name: 'ç¬¬ä¸€é“å…‰', description: 'ç”Ÿå­˜ç¬¬1å¤©', icon: 'ğŸŒ…', unlocked: true, type: 'bronze' },
                    { id: 'builder', name: 'å»ºç­‘å¤§å¸ˆ', description: 'å»ºé€ 5ä¸ªå»ºç­‘', icon: 'ğŸ—ï¸', unlocked: false, type: 'silver' },
                    { id: 'explorer', name: 'æ¢ç´¢è€…', description: 'æ¢ç´¢3ä¸ªä¸åŒåœ°ç‚¹', icon: 'ğŸ§­', unlocked: false, type: 'bronze' },
                    { id: 'survivor', name: 'ç”Ÿå­˜ä¸“å®¶', description: 'æ‹¥æœ‰8åå¹¸å­˜è€…', icon: 'ğŸ‘¥', unlocked: false, type: 'silver' },
                    { id: 'scientist', name: 'ç§‘å­¦å®¶', description: 'ç ”å‘5é¡¹ç§‘æŠ€', icon: 'ğŸ”¬', unlocked: false, type: 'silver' },
                    { id: 'architect', name: 'å»ºç­‘å¸ˆ', description: 'å»ºé€ æ‰€æœ‰ç±»å‹å»ºç­‘', icon: 'ğŸ›ï¸', unlocked: false, type: 'gold' },
                    { id: 'technocrat', name: 'æŠ€æœ¯ä¸“å®¶', description: 'ç ”å‘æ‰€æœ‰ç§‘æŠ€', icon: 'âš›ï¸', unlocked: false, type: 'gold' },
                    { id: 'collector', name: 'æ”¶è—å®¶', description: 'æ”¶é›†1000ä¸ªæ‰€æœ‰èµ„æº', icon: 'ğŸ“¦', unlocked: false, type: 'silver' },
                    { id: 'veteran', name: 'è€å…µ', description: 'ç”Ÿå­˜30å¤©', icon: 'ğŸ–ï¸', unlocked: false, type: 'gold' },
                    { id: 'pioneer', name: 'å¼€æ‹“è€…', description: 'æ¢ç´¢æ‰€æœ‰åœ°ç‚¹', icon: 'ğŸ—ºï¸', unlocked: false, type: 'gold' },
                    { id: 'leader', name: 'é¢†å¯¼è€…', description: 'æ‹¥æœ‰12åå¹¸å­˜è€…', icon: 'ğŸ‘‘', unlocked: false, type: 'platinum' },
                    { id: 'master', name: 'åºŸåœŸå¤§å¸ˆ', description: 'è§£é”æ‰€æœ‰æˆå°±', icon: 'ğŸ†', unlocked: false, type: 'platinum' }
                ];
                
                console.log("æ¸¸æˆæ•°æ®åˆå§‹åŒ–å®Œæˆ");
            }
            
            // ====== DLCç®¡ç†ç³»ç»Ÿ ======
            
            // åŠ è½½å·²å®‰è£…çš„DLC
            loadInstalledDLCs() {
                try {
                    const savedDLCs = localStorage.getItem('wastelandArkDLCs');
                    if (savedDLCs) {
                        this.activeDLCs = JSON.parse(savedDLCs);
                        console.log(`å·²åŠ è½½ ${this.activeDLCs.length} ä¸ªDLC`);
                        
                        // åº”ç”¨å·²å®‰è£…çš„DLC
                        this.activeDLCs.forEach(dlc => {
                            this.applyDLC(dlc);
                        });
                    }
                } catch (error) {
                    console.error('åŠ è½½DLCå¤±è´¥:', error);
                }
            }
            
            // ä¿å­˜DLCåˆ—è¡¨
            saveDLCs() {
                try {
                    localStorage.setItem('wastelandArkDLCs', JSON.stringify(this.activeDLCs));
                } catch (error) {
                    console.error('ä¿å­˜DLCå¤±è´¥:', error);
                }
            }
            
            // ä»URLåŠ è½½DLC
            async loadDLCFromURL(url) {
                try {
                    this.showNotification('æ­£åœ¨ä»URLåŠ è½½DLC...', 'info');
                    
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                    }
                    
                    const dlcData = await response.json();
                    
                    // å®‰è£…DLC
                    this.installDLC(dlcData);
                    
                } catch (error) {
                    console.error('åŠ è½½DLCå¤±è´¥:', error);
                    this.showNotification(`åŠ è½½DLCå¤±è´¥: ${error.message}`, 'danger');
                }
            }
            
            // ä»æœ¬åœ°æ–‡ä»¶åŠ è½½DLC
            loadDLCFromFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        try {
                            const dlcData = JSON.parse(e.target.result);
                            this.installDLC(dlcData);
                            resolve();
                        } catch (error) {
                            reject(new Error('è§£æJSONæ–‡ä»¶å¤±è´¥'));
                        }
                    };
                    
                    reader.onerror = () => {
                        reject(new Error('è¯»å–æ–‡ä»¶å¤±è´¥'));
                    };
                    
                    reader.readAsText(file);
                });
            }
            
            // å®‰è£…DLC
            installDLC(dlcData) {
                // éªŒè¯DLCæ ¼å¼
                if (!dlcData.id || !dlcData.name) {
                    throw new Error('æ— æ•ˆçš„DLCæ ¼å¼ï¼šç¼ºå°‘idæˆ–nameå­—æ®µ');
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
                if (this.activeDLCs.some(dlc => dlc.id === dlcData.id)) {
                    this.showNotification('DLCå·²å®‰è£…', 'warning');
                    return;
                }
                
                // æ·»åŠ åˆ°æ´»è·ƒDLCåˆ—è¡¨
                const dlcToInstall = {
                    ...dlcData,
                    installed: true,
                    installDate: new Date().toISOString()
                };
                
                this.activeDLCs.push(dlcToInstall);
                
                // åº”ç”¨DLCå†…å®¹
                this.applyDLC(dlcData);
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                this.saveDLCs();
                
                this.showNotification(`DLC "${dlcData.name}" å®‰è£…æˆåŠŸï¼`, 'success');
                console.log(`DLC "${dlcData.name}" å·²å®‰è£…`);
                
                // æ›´æ–°DLCç•Œé¢
                this.updateDLCModal();
            }
            
            // å¸è½½DLC
            uninstallDLC(dlcId) {
                const dlcIndex = this.activeDLCs.findIndex(dlc => dlc.id === dlcId);
                if (dlcIndex === -1) return;
                
                const dlc = this.activeDLCs[dlcIndex];
                
                // ç§»é™¤DLCå†…å®¹
                this.removeDLC(dlc);
                
                // ä»æ´»è·ƒåˆ—è¡¨ä¸­ç§»é™¤
                this.activeDLCs.splice(dlcIndex, 1);
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                this.saveDLCs();
                
                this.showNotification(`DLC "${dlc.name}" å·²å¸è½½`, 'info');
                console.log(`DLC "${dlc.name}" å·²å¸è½½`);
                
                // æ›´æ–°DLCç•Œé¢
                this.updateDLCModal();
            }
            
            // åº”ç”¨DLCå†…å®¹åˆ°æ¸¸æˆ
            applyDLC(dlcData) {
                console.log(`åº”ç”¨DLC: ${dlcData.name}`);
                
                // æ·»åŠ æ–°å»ºç­‘
                if (dlcData.buildings && dlcData.buildings.available) {
                    dlcData.buildings.available.forEach(building => {
                        this.buildings.available.push(building);
                    });
                }
                
                // æ·»åŠ æ–°ç§‘æŠ€
                if (dlcData.techTree) {
                    dlcData.techTree.forEach(tech => {
                        this.techTree.push(tech);
                    });
                }
                
                // æ·»åŠ æ–°æ€ªç‰©ç±»å‹
                if (dlcData.monsterTypes) {
                    dlcData.monsterTypes.forEach(monster => {
                        this.monsterTypes.push(monster);
                    });
                }
                
                // æ·»åŠ æ–°æ¢ç´¢åœ°ç‚¹
                if (dlcData.exploreLocations) {
                    dlcData.exploreLocations.forEach(location => {
                        this.exploreLocations.push(location);
                    });
                }
                
                // æ·»åŠ æ–°æˆå°±
                if (dlcData.achievementsList) {
                    dlcData.achievementsList.forEach(achievement => {
                        this.achievementsList.push(achievement);
                    });
                }
            }
            
            // ç§»é™¤DLCå†…å®¹
            removeDLC(dlcData) {
                console.log(`ç§»é™¤DLC: ${dlcData.name}`);
                
                // ç§»é™¤DLCæ·»åŠ çš„å»ºç­‘
                if (dlcData.buildings && dlcData.buildings.available) {
                    const dlcBuildingIds = dlcData.buildings.available.map(b => b.id);
                    this.buildings.available = this.buildings.available.filter(b => !dlcBuildingIds.includes(b.id));
                }
                
                // ç§»é™¤DLCæ·»åŠ çš„ç§‘æŠ€
                if (dlcData.techTree) {
                    const dlcTechIds = dlcData.techTree.map(t => t.id);
                    this.techTree = this.techTree.filter(t => !dlcTechIds.includes(t.id));
                    
                    // åŒæ—¶ä»å·²è§£é”ç§‘æŠ€ä¸­ç§»é™¤
                    this.gameState.unlockedTech = this.gameState.unlockedTech.filter(id => !dlcTechIds.includes(id));
                }
                
                // ç§»é™¤DLCæ·»åŠ çš„æ€ªç‰©ç±»å‹
                if (dlcData.monsterTypes) {
                    const dlcMonsterIds = dlcData.monsterTypes.map(m => m.id);
                    this.monsterTypes = this.monsterTypes.filter(m => !dlcMonsterIds.includes(m.id));
                }
                
                // ç§»é™¤DLCæ·»åŠ çš„æ¢ç´¢åœ°ç‚¹
                if (dlcData.exploreLocations) {
                    const dlcLocationNames = dlcData.exploreLocations.map(l => l.name);
                    this.exploreLocations = this.exploreLocations.filter(l => !dlcLocationNames.includes(l.name));
                }
                
                // ç§»é™¤DLCæ·»åŠ çš„æˆå°±
                if (dlcData.achievementsList) {
                    const dlcAchievementIds = dlcData.achievementsList.map(a => a.id);
                    this.achievementsList = this.achievementsList.filter(a => !dlcAchievementIds.includes(a.id));
                }
            }
            
            // æ›´æ–°DLCæ¨¡æ€çª—å£
            updateDLCModal() {
                const container = document.getElementById('dlc-list');
                if (!container) return;
                
                container.innerHTML = '';
                
                if (this.activeDLCs.length === 0) {
                    return;
                }
                
                this.activeDLCs.forEach(dlc => {
                    const dlcDiv = document.createElement('div');
                    dlcDiv.className = `dlc-item installed`;
                    
                    const installDate = new Date(dlc.installDate || Date.now()).toLocaleDateString('zh-CN');
                    
                    dlcDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="font-size: 28px; color: #FFD700;">${dlc.icon || 'ğŸ'}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; font-size: 14px; color: #3498db;">
                                    ${dlc.name}
                                    <span style="font-size: 10px; color: #95a5a6; margin-left: 5px;">v${dlc.version || '1.0'}</span>
                                </div>
                                <div style="font-size: 11px; color: #95a5a6; margin: 3px 0;">${dlc.description || 'æ— æè¿°'}</div>
                                <div style="font-size: 10px; color: #7f8c8d;">
                                    ä½œè€…: ${dlc.author || 'æœªçŸ¥'} | å®‰è£…æ—¶é—´: ${installDate}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <button class="btn btn-danger" 
                                        onclick="game.uninstallDLC('${dlc.id}')"
                                        style="padding: 6px 12px; font-size: 11px; min-height: auto;">
                                    å¸è½½
                                </button>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(dlcDiv);
                });
            }
            
            // åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
            initFileUpload() {
                const fileUploadArea = document.getElementById('file-upload-area');
                const fileInput = document.getElementById('dlc-file-input');
                
                if (!fileUploadArea || !fileInput) return;
                
                // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
                fileUploadArea.addEventListener('click', () => {
                    fileInput.click();
                });
                
                // æ–‡ä»¶é€‰æ‹©å˜åŒ–
                fileInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                    if (!file.name.endsWith('.json')) {
                        this.showNotification('è¯·é€‰æ‹©JSONæ ¼å¼çš„æ–‡ä»¶', 'warning');
                        return;
                    }
                    
                    try {
                        this.showNotification('æ­£åœ¨è¯»å–DLCæ–‡ä»¶...', 'info');
                        await this.loadDLCFromFile(file);
                        fileInput.value = ''; // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                    } catch (error) {
                        console.error('ä¸Šä¼ DLCå¤±è´¥:', error);
                        this.showNotification(`ä¸Šä¼ å¤±è´¥: ${error.message}`, 'danger');
                    }
                });
                
                // æ‹–æ‹½åŠŸèƒ½
                fileUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    fileUploadArea.classList.add('dragover');
                });
                
                fileUploadArea.addEventListener('dragleave', () => {
                    fileUploadArea.classList.remove('dragover');
                });
                
                fileUploadArea.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    fileUploadArea.classList.remove('dragover');
                    
                    const file = e.dataTransfer.files[0];
                    if (!file) return;
                    
                    // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                    if (!file.name.endsWith('.json')) {
                        this.showNotification('è¯·æ‹–æ‹½JSONæ ¼å¼çš„æ–‡ä»¶', 'warning');
                        return;
                    }
                    
                    try {
                        this.showNotification('æ­£åœ¨è¯»å–DLCæ–‡ä»¶...', 'info');
                        await this.loadDLCFromFile(file);
                    } catch (error) {
                        console.error('ä¸Šä¼ DLCå¤±è´¥:', error);
                        this.showNotification(`ä¸Šä¼ å¤±è´¥: ${error.message}`, 'danger');
                    }
                });
            }
            
            // æ˜¾ç¤ºDLCæ¨¡æ€çª—å£
            showDLCModal() {
                this.updateDLCModal();
                this.showModal('dlc-modal');
            }
            
            // ====== åˆ›å»ºå¹¸å­˜è€… ======
            createSurvivor(id, name, skill) {
                const skills = {
                    'å»ºé€ ': { icon: 'ğŸ”¨', color: '#e67e22', desc: 'å»ºç­‘é€Ÿåº¦+20%' },
                    'åŒ»ç–—': { icon: 'ğŸ’Š', color: '#e74c3c', desc: 'æ²»ç–—æ•ˆç‡+30%' },
                    'ç ”ç©¶': { icon: 'ğŸ”¬', color: '#9b59b6', desc: 'ç§‘ç ”é€Ÿåº¦+25%' },
                    'æ¢ç´¢': { icon: 'ğŸ§­', color: '#3498db', desc: 'æ¢ç´¢æˆåŠŸç‡+15%' },
                    'æˆ˜æ–—': { icon: 'âš”ï¸', color: '#c0392b', desc: 'æˆ˜æ–—åŠ›+20%' },
                    'å†œä¸š': { icon: 'ğŸŒ¾', color: '#27ae60', desc: 'é£Ÿç‰©äº§é‡+25%' },
                    'çªå‡»æ‰‹': { icon: 'ğŸ”«', color: '#c0392b', desc: 'çªå‡»èƒ½åŠ›+30%' },
                    'ç‹™å‡»æ‰‹': { icon: 'ğŸ¯', color: '#3498db', desc: 'ç²¾å‡†å°„å‡»+25%' }
                };
                
                const skillData = skills[skill] || skills['å»ºé€ '];
                
                return {
                    id: id,
                    name: name,
                    skill: skill,
                    skillIcon: skillData.icon,
                    skillColor: skillData.color,
                    skillDesc: skillData.desc,
                    health: 85 + Math.floor(Math.random() * 15),
                    hunger: 40 + Math.floor(Math.random() * 30),
                    energy: 90 + Math.floor(Math.random() * 10),
                    morale: 70 + Math.floor(Math.random() * 30),
                    assigned: false,
                    level: 1,
                    experience: 0,
                    kills: 0,
                    status: 'ç©ºé—²',
                    exploring: false
                };
            }
            
            // è®¡ç®—æœ€å¤§äººå£ä¸Šé™ - ä¿®æ”¹ï¼šå®¿èˆæä¾›æ— é™äººå£
            getMaxPopulation() {
                // æ£€æŸ¥æ˜¯å¦æœ‰å®¿èˆ
                const hasDormitory = this.buildings.built.some(b => b.type === 'å®¿èˆ');
                
                if (hasDormitory) {
                    // æœ‰å®¿èˆï¼šæ— é™äººå£
                    return Infinity;
                } else {
                    // æ— å®¿èˆï¼šåŸºç¡€äººå£ä¸Šé™
                    return this.gameState.basePopulation;
                }
            }
            
            // åˆå§‹åŒ–æ¸¸æˆ
            initialize() {
                console.log("å¼€å§‹åˆå§‹åŒ–æ¸¸æˆ...");
                try {
                    this.showLoadingMessage('åˆå§‹åŒ–æ¸¸æˆç•Œé¢...');
                    
                    // è®¾ç½®UIäº‹ä»¶
                    this.setupUI();
                    
                    // æ£€æŸ¥ä¿å­˜æ•°æ®
                    this.loadGame();
                    
                    this.showLoadingMessage('åŠ è½½æ¸¸æˆèµ„æº...');
                    
                    // å¯åŠ¨æ¸¸æˆ
                    this.startGameLoop();
                    this.updateUI();
                    this.updateMap();
                    
                    this.showLoadingMessage('æ¸¸æˆå‡†å¤‡å°±ç»ª...');
                    
                    // æ˜¾ç¤ºæ¸¸æˆç•Œé¢
                    setTimeout(() => {
                        document.getElementById('loading-screen').style.opacity = '0';
                        setTimeout(() => {
                            document.getElementById('loading-screen').style.display = 'none';
                            document.getElementById('game-container').style.display = 'flex';
                            this.showNotification('ã€ŠåºŸåœŸæ–¹èˆŸã€‹å·²å¯åŠ¨ï¼', 'success');
                            
                            // é¦–æ¬¡è­¦å‘Šï¼š10åˆ†é’Ÿåå°†æœ‰æ€ªç‰©è¢­å‡»
                            setTimeout(() => {
                                this.showNotification('æ³¨æ„ï¼š10åˆ†é’Ÿåå°†æœ‰æ€ªç‰©è¢­å‡»ï¼', 'warning');
                            }, 2000);
                            
                        }, 300);
                    }, 500);
                    
                    this.isInitialized = true;
                    console.log('âœ… æ¸¸æˆåˆå§‹åŒ–å®Œæˆï¼');
                    
                } catch (error) {
                    console.error('âŒ æ¸¸æˆåˆå§‹åŒ–å¤±è´¥:', error);
                    this.showLoadingMessage('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                    
                    setTimeout(() => {
                        document.getElementById('loading-screen').innerHTML = `
                            <div style="text-align: center; padding: 20px; color: #e74c3c;">
                                <div style="font-size: 18px; margin-bottom: 15px;">âš ï¸ å¯åŠ¨å¤±è´¥</div>
                                <div style="margin-bottom: 15px; font-size: 12px;">${error.message}</div>
                                <button onclick="location.reload()" style="
                                    background: #3498db;
                                    color: white;
                                    border: none;
                                    padding: 10px 20px;
                                    border-radius: 6px;
                                    font-size: 14px;
                                    cursor: pointer;
                                ">é‡æ–°åŠ è½½</button>
                            </div>
                        `;
                    }, 500);
                }
            }
            
            // æ˜¾ç¤ºåŠ è½½æ¶ˆæ¯
            showLoadingMessage(message) {
                const loadingText = document.getElementById('loading-text');
                if (loadingText) {
                    loadingText.textContent = message;
                }
            }
            
            // è®¾ç½®UIäº‹ä»¶
            setupUI() {
                console.log("è®¾ç½®UIäº‹ä»¶...");
                
                // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ä¼˜åŒ–æŒ‰é’®ç‚¹å‡»
                const gameContainer = document.getElementById('game-container');
                if (gameContainer) {
                    gameContainer.addEventListener('click', (e) => {
                        const target = e.target.closest('.btn');
                        if (!target) return;
                        
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // é˜²é‡å¤ç‚¹å‡»
                        if (target.dataset.lastClick && Date.now() - target.dataset.lastClick < 500) {
                            return;
                        }
                        target.dataset.lastClick = Date.now();
                        
                        const btnId = target.id;
                        this.handleButtonClick(btnId);
                    }, { passive: true });
                    
                    // å»ºç­‘ç‚¹å‡»äº‹ä»¶
                    gameContainer.addEventListener('click', (e) => {
                        const target = e.target.closest('.map-building-item');
                        if (!target) return;
                        
                        // æŸ¥æ‰¾å¯¹åº”çš„å»ºç­‘
                        const buildingName = target.querySelector('.map-building-name').textContent;
                        const building = this.buildings.built.find(b => b.type === buildingName);
                        if (building) {
                            this.showBuildingDetail(building);
                        }
                    }, { passive: true });
                    const recruitBtn = document.getElementById('recruit-btn');
                    if (recruitBtn) {
                        recruitBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            this.recruitSurvivor();
                        }, { passive: true });}
                }
                
                // æ¨¡æ€çª—å£å…³é—­æŒ‰é’®
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('close-btn')) {
                        const modal = e.target.closest('.modal');
                        if (modal) {
                            this.closeModal(modal.id);
                        }
                    }
                });
                
                // æ¸¸æˆé€Ÿåº¦è®¾ç½®
                const gameSpeedSelect = document.getElementById('game-speed');
                if (gameSpeedSelect) {
                    gameSpeedSelect.value = this.gameState.gameSpeed;
                    gameSpeedSelect.addEventListener('change', (e) => {
                        this.gameState.gameSpeed = parseFloat(e.target.value);
                    }, { passive: true });
                }
                
                // å±å¹•æ–¹å‘è®¾ç½®
                const orientationSelect = document.getElementById('screen-orientation');
                if (orientationSelect) {
                    orientationSelect.value = this.gameState.orientation;
                    orientationSelect.addEventListener('change', (e) => {
                        this.gameState.orientation = e.target.value;
                        this.applyOrientation();
                    }, { passive: true });
                }
                
                // æ¢ç´¢è®¡æ—¶å™¨æ›´æ–°
                setInterval(() => {
                    this.updateExploreTimer();
                }, 1000);
                
                // æ€ªç‰©è¢­å‡»è®¡æ—¶å™¨
                setInterval(() => {
                    this.updateMonsterAttackTimer();
                }, 1000);
                
                // è‡ªåŠ¨é˜²å¾¡æŒ‰é’®
                const autoDefenseBtn = document.getElementById('btn-auto-defense');
                if (autoDefenseBtn) {
                    autoDefenseBtn.addEventListener('click', () => {
                        this.autoDefense();
                    }, { passive: true });
                }
                
                // DLC URLåŠ è½½æŒ‰é’®
                const dlcUrlLoadBtn = document.getElementById('dlc-url-load');
                const dlcUrlInput = document.getElementById('dlc-url-input');
                if (dlcUrlLoadBtn && dlcUrlInput) {
                    dlcUrlLoadBtn.addEventListener('click', () => {
                        const url = dlcUrlInput.value.trim();
                        if (url) {
                            this.loadDLCFromURL(url);
                            dlcUrlInput.value = '';
                        } else {
                            this.showNotification('è¯·è¾“å…¥DLC URL', 'warning');
                        }
                    }, { passive: true });
                }
                
                // åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ 
                this.initFileUpload();
                
                // ä¿®å¤ï¼šä¸ºæ€ªç‰©åˆ—è¡¨å®¹å™¨æ·»åŠ äº‹ä»¶å§”æ‰˜æ¥å¤„ç†æ”»å‡»æŒ‰é’®
                const monsterListContainer = document.getElementById('monster-panel');
                if (monsterListContainer) {
                    monsterListContainer.addEventListener('click', (e) => {
                        const target = e.target.closest('.monster-attack-btn');
                        if (!target) return;
                        
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // æŸ¥æ‰¾å¯¹åº”çš„æ€ªç‰©
                        const monsterItem = target.closest('.monster-item');
                        if (monsterItem) {
                            // ä»æŒ‰é’®çš„onclickå±æ€§ä¸­æå–æ€ªç‰©ID
                            const onclickAttr = target.getAttribute('onclick');
                            if (onclickAttr) {
                                const match = onclickAttr.match(/attackMonster\('([^']+)'\)/);
                                if (match && match[1]) {
                                    this.attackMonster(match[1]);
                                }
                            }
                        }
                    }, { passive: true });
                }
            }
            
            // åº”ç”¨å±å¹•æ–¹å‘è®¾ç½®
            applyOrientation() {
                if (this.gameState.orientation === 'portrait') {
                    // å¼ºåˆ¶ç«–å±
                    screen.orientation.lock('portrait').catch(() => {
                        console.log('å±å¹•æ–¹å‘é”å®šå¤±è´¥');
                    });
                } else if (this.gameState.orientation === 'landscape') {
                    // å¼ºåˆ¶æ¨ªå±
                    screen.orientation.lock('landscape').catch(() => {
                        console.log('å±å¹•æ–¹å‘é”å®šå¤±è´¥');
                    });
                } else {
                    // è‡ªåŠ¨
                    screen.orientation.unlock();
                }
            }
            
            // å¤„ç†æŒ‰é’®ç‚¹å‡»
            handleButtonClick(btnId) {
                switch (btnId) {
                    case 'btn-explore':
                        this.showExploreModal();
                        break;
                    case 'btn-pause':
                        this.togglePause();
                        break;
                    case 'btn-settings':
                        this.showSettingsModal();
                        break;
                    case 'btn-survivors':
                        this.showSurvivorsModal();
                        break;
                    case 'btn-resources':
                        this.showResourcesModal();
                        break;
                    case 'btn-buildings':
                        this.showBuildingsModal();
                        break;
                    case 'btn-tech':
                        this.showTechModal();
                        break;
                    case 'btn-achievements':
                        this.showAchievementsModal();
                        break;
                    case 'btn-dlc':
                        this.showDLCModal();
                        break;
                    case 'btn-save':
                        this.saveGame();
                        break;
                    case 'btn-load':
                        this.loadGame();
                        break;
                    case 'recruit-btn':
                        this.recruitSurvivor();
                        break;
                }
            }
            
            // å¼€å§‹æ¸¸æˆå¾ªç¯
            startGameLoop() {
                console.log("å¯åŠ¨æ¸¸æˆå¾ªç¯...");
                if (this.gameLoopId) clearInterval(this.gameLoopId);
                
                this.lastUpdateTime = performance.now();
                
                const gameLoop = (currentTime) => {
                    if (!this.isPaused) {
                        const deltaTime = currentTime - this.lastUpdateTime;
                        
                        try {
                            this.updateGameTime(deltaTime);
                            this.updateResources();
                            this.updateSurvivors();
                            this.updateMonsters();
                            this.updateUI();
                            
                            if (Math.random() < 0.0005 * this.gameState.gameSpeed * (deltaTime / 1000)) {
                                this.checkRandomEvents();
                            }
                        } catch (error) {
                            console.error('æ¸¸æˆå¾ªç¯é”™è¯¯:', error);
                        }
                        
                        this.lastUpdateTime = currentTime;
                    }
                    
                    this.gameLoopId = requestAnimationFrame(gameLoop);
                };
                
                this.gameLoopId = requestAnimationFrame(gameLoop);
                console.log("âœ… æ¸¸æˆå¾ªç¯å·²å¯åŠ¨");
            }
            
            // æ›´æ–°æ¸¸æˆæ—¶é—´
            updateGameTime(deltaTime) {
                const speed = this.gameState.gameSpeed;
                const timeScale = deltaTime / 1000;
                
                this.gameState.minute += speed * timeScale * 0.5;
                
                if (this.gameState.minute >= 60) {
                    this.gameState.hour += 1;
                    this.gameState.minute = 0;
                    
                    this.updateHourlyResources();
                    
                    if (this.gameState.hour >= 24) {
                        this.gameState.day += 1;
                        this.gameState.hour = 0;
                        this.updateDaily();
                    }
                }
            }
            
            // æ¯å°æ—¶èµ„æºæ›´æ–°
            updateHourlyResources() {
                Object.values(this.resources).forEach(res => {
                    res.amount = Math.min(res.max, res.amount + res.prod);
                });
                
                const survivorCount = this.survivors.length;
                this.resources.food.amount = Math.max(0, this.resources.food.amount - survivorCount * this.resources.food.cons);
                this.resources.water.amount = Math.max(0, this.resources.water.amount - survivorCount * this.resources.water.cons);
                this.resources.energy.amount = Math.max(0, this.resources.energy.amount - survivorCount * this.resources.energy.cons);
                
                const labCount = this.buildings.built.filter(b => b.type === 'å›¾ä¹¦é¦†').length;
                this.gameState.techPoints += labCount * 5;
                
                // æ›´æ–°åœ°å›¾
                if (Date.now() % 5000 < 100) {
                    this.updateMap();
                }
            }
            
            // æ¯æ—¥æ›´æ–°
            updateDaily() {
                const weathers = ['æ™´æœ—', 'å¤šäº‘', 'å°é›¨', 'å¤§é›¨', 'æ²™å°˜æš´', 'è¾å°„é›¨'];
                this.gameState.weather = weathers[Math.floor(Math.random() * weathers.length)];
                
                this.survivors.forEach(survivor => {
                    survivor.hunger += 15;
                    if (survivor.hunger > 80) {
                        survivor.health -= 8;
                        survivor.morale -= 10;
                    }
                    
                    if (survivor.health < 30) {
                        survivor.morale -= 15;
                    }
                    
                    survivor.morale = Math.max(0, Math.min(100, survivor.morale));
                });
                
                // æ¯æ—¥å‡å°‘æ€ªç‰©è¢­å‡»å€’è®¡æ—¶
                this.monsters.nextAttackTime -= 60; // å‡å°‘1åˆ†é’Ÿ
                if (this.monsters.nextAttackTime < 60) {
                    this.monsters.nextAttackTime = 60; // æœ€å°‘1åˆ†é’Ÿ
                }
                
                this.checkAchievements();
                
                this.showNotification(`ç¬¬${this.gameState.day}å¤©å¼€å§‹äº†ï¼å¤©æ°”: ${this.gameState.weather}`, 'info');
                this.updateMap();
            }
            
            // æ›´æ–°èµ„æº
            updateResources() {
                Object.values(this.resources).forEach(res => {
                    res.amount = Math.max(0, Math.min(res.max, res.amount));
                });
            }
            
            // æ›´æ–°å¹¸å­˜è€…
            updateSurvivors() {
                this.survivors.forEach(survivor => {
                    if (!survivor.assigned) {
                        survivor.energy = Math.min(100, survivor.energy + 0.2);
                    } else {
                        survivor.energy = Math.max(0, survivor.energy - 0.1);
                    }
                    
                    if (survivor.health < 100) {
                        if (this.resources.medicine.amount > 0 && survivor.health < 70) {
                            survivor.health = Math.min(100, survivor.health + 0.1);
                            this.resources.medicine.amount -= 0.05;
                        } else if (!survivor.assigned) {
                            survivor.health = Math.min(100, survivor.health + 0.05);
                        }
                    }
                    
                    if (!survivor.assigned && survivor.health > 70) {
                        survivor.morale = Math.min(100, survivor.morale + 0.1);
                    }
                });
            }
            
            // ====== æ€ªç‰©ç³»ç»Ÿæ ¸å¿ƒæ–¹æ³• ======
            
            // æ›´æ–°æ€ªç‰©
            updateMonsters() {
                if (this.monsters.attackInProgress) {
                    // æ€ªç‰©æ”»å‡»åŸºåœ°
                    this.monsters.active.forEach((monster, index) => {
                        if (monster.hp > 0) {
                            // æ€ªç‰©å¯¹åŸºåœ°é€ æˆä¼¤å®³
                            const damage = Math.floor(monster.damage * Math.random() * 0.5);
                            
                            // éšæœºé€‰æ‹©ä¸€ä¸ªå¹¸å­˜è€…å—ä¼¤
                            if (this.survivors.length > 0 && Math.random() < 0.3) {
                                const randomSurvivor = this.survivors[Math.floor(Math.random() * this.survivors.length)];
                                randomSurvivor.health -= damage;
                                randomSurvivor.morale -= 5;
                                
                                if (randomSurvivor.health <= 0) {
                                    randomSurvivor.health = 0;
                                    this.showNotification(`${randomSurvivor.name}åœ¨æˆ˜æ–—ä¸­é‡ä¼¤ï¼`, 'danger');
                                }
                            }
                            
                            // æ€ªç‰©è‡ªç„¶æ¢å¤
                            if (monster.hp < monster.maxHp && Math.random() < 0.01) {
                                monster.hp = Math.min(monster.maxHp, monster.hp + 1);
                            }
                        }
                    });
                    
                    // æ›´æ–°æ€ªç‰©æ˜¾ç¤º
                    this.updateMonsterDisplay();
                }
            }
            
            // æ›´æ–°æ€ªç‰©è¢­å‡»è®¡æ—¶å™¨
            updateMonsterAttackTimer() {
                if (this.isPaused || this.monsters.attackInProgress) {
                    return;
                }
                
                this.monsters.nextAttackTime--;
                
                // æ˜¾ç¤º/éšè—è¢­å‡»è®¡æ—¶å™¨
                const attackTimer = document.getElementById('attack-timer');
                if (this.monsters.nextAttackTime <= 60) {
                    attackTimer.classList.remove('hidden');
                    
                    // æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
                    const minutes = Math.floor(this.monsters.nextAttackTime / 60);
                    const seconds = this.monsters.nextAttackTime % 60;
                    document.getElementById('attack-time-left').textContent = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    // æœ€å30ç§’é—ªçƒè­¦å‘Š
                    if (this.monsters.nextAttackTime <= 30) {
                        attackTimer.style.animation = 'pulse 0.5s infinite';
                    }
                    
                    // æœ€å10ç§’çº¢è‰²è­¦å‘Š
                    if (this.monsters.nextAttackTime <= 10) {
                        attackTimer.style.background = 'rgba(231, 76, 60, 1)';
                    }
                } else {
                    attackTimer.classList.add('hidden');
                }
                
                // è§¦å‘æ€ªç‰©è¢­å‡»
                if (this.monsters.nextAttackTime <= 0) {
                    this.startMonsterAttack();
                }
            }
            
            // å¼€å§‹æ€ªç‰©è¢­å‡»
            startMonsterAttack() {
                this.monsters.attackInProgress = true;
                this.monsters.waveCount++;
                
                // ç”Ÿæˆæ€ªç‰©
                this.generateMonsterWave();
                
                // æ˜¾ç¤ºè¢­å‡»é€šçŸ¥
                this.showNotification(`âš”ï¸ ç¬¬${this.monsters.waveCount}æ³¢æ€ªç‰©è¢­å‡»ï¼`, 'danger');
                
                // è®¾ç½®ä¸‹ä¸€æ¬¡è¢­å‡»æ—¶é—´ï¼ˆ5-10åˆ†é’Ÿï¼‰
                this.monsters.nextAttackTime = 300 + Math.floor(Math.random() * 300);
                
                // æ›´æ–°æ€ªç‰©æ˜¾ç¤º
                this.updateMonsterDisplay();
            }
            
            // ç”Ÿæˆæ€ªç‰©æ³¢æ¬¡
            generateMonsterWave() {
                this.monsters.active = [];
                
                // åŸºç¡€æ€ªç‰©æ•°é‡
                let monsterCount = 3 + Math.floor(this.monsters.waveCount / 2);
                
                // æ ¹æ®å¤©æ•°å¢åŠ éš¾åº¦
                monsterCount += Math.floor(this.gameState.day / 5);
                
                // é™åˆ¶æœ€å¤§æ•°é‡
                monsterCount = Math.min(monsterCount, 8);
                
                // ç”Ÿæˆæ€ªç‰©
                for (let i = 0; i < monsterCount; i++) {
                    // é€‰æ‹©æ€ªç‰©ç±»å‹
                    let monsterType;
                    const rand = Math.random();
                    
                    // ç²¾è‹±æ€ªç‰©æ¦‚ç‡
                    let eliteChance = 0.01 + (this.monsters.waveCount * 0.005);
                    eliteChance = Math.min(eliteChance, 0.15); // æœ€å¤§15%
                    
                    if (rand < eliteChance && this.eliteMonsters.length > 0) {
                        // ç²¾è‹±æ€ªç‰©
                        monsterType = this.eliteMonsters[Math.floor(Math.random() * this.eliteMonsters.length)];
                    } else {
                        // æ™®é€šæ€ªç‰©
                        let cumulativeChance = 0;
                        for (const type of this.monsterTypes) {
                            cumulativeChance += type.spawnChance;
                            if (rand < cumulativeChance) {
                                monsterType = type;
                                break;
                            }
                        }
                    }
                    
                    if (monsterType) {
                        // æ ¹æ®æ³¢æ¬¡å¢åŠ æ€ªç‰©å¼ºåº¦
                        let hpMultiplier = 1.0 + (this.monsters.waveCount * 0.05);
                        let damageMultiplier = 1.0 + (this.monsters.waveCount * 0.02);
                        
                        // åˆ›å»ºæ€ªç‰©å®ä¾‹
                        const monster = {
                            id: `${monsterType.id}_${Date.now()}_${i}`,
                            type: monsterType.id,
                            name: monsterType.name,
                            description: monsterType.description,
                            hp: Math.floor(monsterType.hp * hpMultiplier),
                            maxHp: Math.floor(monsterType.hp * hpMultiplier),
                            damage: Math.floor(monsterType.damage * damageMultiplier),
                            speed: monsterType.speed,
                            reward: {...monsterType.reward},
                            icon: monsterType.icon,
                            color: monsterType.color,
                            abilities: [...monsterType.abilities],
                            attacks: 0
                        };
                        
                        this.monsters.active.push(monster);
                    }
                }
                
                console.log(`ç”Ÿæˆç¬¬${this.monsters.waveCount}æ³¢æ€ªç‰©ï¼Œæ•°é‡: ${this.monsters.active.length}`);
            }
            
            // æ›´æ–°æ€ªç‰©æ˜¾ç¤º
            updateMonsterDisplay() {
                const container = document.getElementById('monster-list');
                if (!container) return;
                
                container.innerHTML = '';
                
                if (this.monsters.active.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 15px; color: #95a5a6;">
                            <div style="font-size: 24px; margin-bottom: 5px;">ğŸ›¡ï¸</div>
                            <div style="font-size: 11px;">å½“å‰æ²¡æœ‰æ€ªç‰©è¢­å‡»</div>
                            <div style="font-size: 9px; margin-top: 3px;">ä¸‹ä¸€æ³¢è¢­å‡»å€’è®¡æ—¶ä¸­...</div>
                        </div>
                    `;
                    return;
                }
                
                this.monsters.active.forEach(monster => {
                    const hpPercent = (monster.hp / monster.maxHp) * 100;
                    const hpColor = hpPercent > 70 ? '#2ecc71' : 
                                  hpPercent > 30 ? '#f39c12' : '#e74c3c';
                    
                    const monsterDiv = document.createElement('div');
                    monsterDiv.className = 'monster-item';
                    monsterDiv.style.borderLeftColor = monster.color;
                    
                    let abilitiesText = '';
                    if (monster.abilities.length > 0) {
                        abilitiesText = `<div style="font-size: 9px; color: ${monster.color}; margin-top: 3px;">èƒ½åŠ›: ${monster.abilities.join(', ')}</div>`;
                    }
                    
                    monsterDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="font-size: 20px;">${monster.icon}</div>
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="font-weight: bold; font-size: 12px; color: ${monster.color};">${monster.name}</div>
                                    <div style="font-size: 10px; color: #95a5a6;">HP: ${monster.hp}/${monster.maxHp}</div>
                                </div>
                                <div style="font-size: 9px; color: #bdc3c7; margin: 2px 0;">${monster.description}</div>
                                ${abilitiesText}
                                <div class="monster-hp-bar">
                                    <div class="monster-hp-fill" style="width: ${hpPercent}%; background: ${hpColor};"></div>
                                </div>
                            </div>
                        </div>
                        <button class="monster-attack-btn" onclick="game.attackMonster('${monster.id}')">
                            âš”ï¸ æ”»å‡» (æ¶ˆè€—: 5å¼¹è¯)
                        </button>
                    `;
                    
                    container.appendChild(monsterDiv);
                });
                
                // æ›´æ–°æ€ªç‰©ç»Ÿè®¡
                document.getElementById('wave-count').textContent = `æ³¢æ¬¡: ${this.monsters.waveCount}`;
                document.getElementById('total-kills').textContent = this.monsters.totalKills;
                
                // è®¡ç®—å½“å‰å¨èƒç­‰çº§
                const totalMonsterHP = this.monsters.active.reduce((sum, m) => sum + m.hp, 0);
                const avgDamage = this.monsters.active.reduce((sum, m) => sum + m.damage, 0) / Math.max(1, this.monsters.active.length);
                const threatLevel = totalMonsterHP * avgDamage / 100;
                
                let threatText = 'ä½';
                let threatColor = '#2ecc71';
                
                if (threatLevel > 50) {
                    threatText = 'ä¸­';
                    threatColor = '#f39c12';
                }
                if (threatLevel > 150) {
                    threatText = 'é«˜';
                    threatColor = '#e67e22';
                }
                if (threatLevel > 300) {
                    threatText = 'æé«˜';
                    threatColor = '#e74c3c';
                }
                
                document.getElementById('current-threat').textContent = threatText;
                document.getElementById('current-threat').style.color = threatColor;
                
                // æ›´æ–°çŠ¶æ€æ æ€ªç‰©è®¡æ•°
                document.getElementById('monster-count').textContent = this.monsters.active.length;
            }
            
            // æ”»å‡»æ€ªç‰©
            attackMonster(monsterId) {
                if (this.resources.ammunition.amount < 5) {
                    this.showNotification('å¼¹è¯ä¸è¶³ï¼éœ€è¦5å¼¹è¯', 'danger');
                    return;
                }
                
                const monster = this.monsters.active.find(m => m.id === monsterId);
                if (!monster) {
                    this.showNotification('æ€ªç‰©ä¸å­˜åœ¨ï¼', 'warning');
                    return;
                }
                
                // æ¶ˆè€—å¼¹è¯
                this.resources.ammunition.amount -= 5;
                
                // è®¡ç®—ä¼¤å®³
                let damage = 10 + Math.floor(Math.random() * 15); // åŸºç¡€ä¼¤å®³ 10-25
                
                // ç­æœ›å¡”æä¾›é¢å¤–ä¼¤å®³
                const watchtowerCount = this.buildings.built.filter(b => b.type === 'ç­æœ›å¡”').length;
                damage += watchtowerCount * 5;
                
                // éšæœºé€‰æ‹©æˆ˜æ–—æŠ€èƒ½å¹¸å­˜è€…
                const fighters = this.survivors.filter(s => s.skill === 'æˆ˜æ–—' || s.skill === 'çªå‡»æ‰‹' || s.skill === 'ç‹™å‡»æ‰‹');
                if (fighters.length > 0) {
                    const fighter = fighters[Math.floor(Math.random() * fighters.length)];
                    damage = Math.floor(damage * 1.2); // æˆ˜æ–—ä¸“å®¶+20%ä¼¤å®³
                    fighter.experience += 5;
                    
                    if (fighter.experience >= 100) {
                        fighter.level += 1;
                        fighter.experience = 0;
                        this.showNotification(`${fighter.name}å‡çº§åˆ°Lv.${fighter.level}ï¼`, 'success');
                    }
                }
                
                // åº”ç”¨ä¼¤å®³
                monster.hp -= damage;
                monster.attacks++;
                
                if (monster.hp <= 0) {
                    // æ€ªç‰©æ­»äº¡
                    this.killMonster(monster);
                } else {
                    // æ€ªç‰©å—ä¼¤
                    this.showNotification(`å¯¹${monster.name}é€ æˆ${damage}ç‚¹ä¼¤å®³ï¼`, 'success');
                }
                
                // æ›´æ–°æ˜¾ç¤º
                this.updateMonsterDisplay();
                this.updateUI();
                
                // æ£€æŸ¥æ˜¯å¦æ¸…é™¤æ‰€æœ‰æ€ªç‰©
                this.checkWaveClear();
            }
            
            // è‡ªåŠ¨é˜²å¾¡
            autoDefense() {
                if (this.monsters.active.length === 0) {
                    this.showNotification('å½“å‰æ²¡æœ‰æ€ªç‰©éœ€è¦é˜²å¾¡', 'warning');
                    return;
                }
                
                if (this.resources.ammunition.amount < 20) {
                    this.showNotification('å¼¹è¯ä¸è¶³ï¼è‡ªåŠ¨é˜²å¾¡éœ€è¦20å¼¹è¯', 'danger');
                    return;
                }
                
                // æ¶ˆè€—å¼¹è¯
                this.resources.ammunition.amount -= 20;
                
                // å¯¹æ¯ä¸ªæ€ªç‰©é€ æˆä¼¤å®³
                let totalDamage = 0;
                let killedCount = 0;
                
                this.monsters.active.forEach(monster => {
                    const damage = 15 + Math.floor(Math.random() * 20); // 15-35ä¼¤å®³
                    monster.hp -= damage;
                    totalDamage += damage;
                    
                    if (monster.hp <= 0) {
                        this.killMonster(monster, false);
                        killedCount++;
                    }
                });
                
                // ç§»é™¤æ­»äº¡çš„æ€ªç‰©
                this.monsters.active = this.monsters.active.filter(m => m.hp > 0);
                
                // æ˜¾ç¤ºç»“æœ
                if (killedCount > 0) {
                    this.showNotification(`è‡ªåŠ¨é˜²å¾¡æ¶ˆç­äº†${killedCount}åªæ€ªç‰©ï¼`, 'success');
                } else {
                    this.showNotification(`è‡ªåŠ¨é˜²å¾¡é€ æˆ${totalDamage}ç‚¹æ€»ä¼¤å®³ï¼`, 'info');
                }
                
                // æ›´æ–°æ˜¾ç¤º
                this.updateMonsterDisplay();
                this.updateUI();
                this.checkWaveClear();
            }
            
            // æ€æ­»æ€ªç‰©
            killMonster(monster, showNotification = true) {
                // ç§»é™¤æ€ªç‰©
                const index = this.monsters.active.findIndex(m => m.id === monster.id);
                if (index !== -1) {
                    this.monsters.active.splice(index, 1);
                }
                
                // å¢åŠ å‡»æ€è®¡æ•°
                this.monsters.totalKills++;
                
                // ç»™äºˆå¥–åŠ±
                let rewardText = `æ¶ˆç­äº†${monster.name}ï¼è·å¾—ï¼š`;
                Object.entries(monster.reward).forEach(([resource, amount]) => {
                    if (this.resources[resource]) {
                        this.resources[resource].amount += amount;
                        rewardText += `${this.resources[resource].name}+${amount} `;
                    } else if (resource === 'techPoints') {
                        this.gameState.techPoints += amount;
                        rewardText += `ç§‘æŠ€ç‚¹+${amount} `;
                    }
                });
                
                // éšæœºå¹¸å­˜è€…è·å¾—ç»éªŒ
                if (this.survivors.length > 0) {
                    const randomSurvivor = this.survivors[Math.floor(Math.random() * this.survivors.length)];
                    randomSurvivor.experience += 10;
                    randomSurvivor.kills += 1;
                    
                    if (randomSurvivor.experience >= 100) {
                        randomSurvivor.level += 1;
                        randomSurvivor.experience = 0;
                        rewardText += ` ${randomSurvivor.name}å‡çº§åˆ°Lv.${randomSurvivor.level}`;
                    }
                }
                
                // æ˜¾ç¤ºé€šçŸ¥
                if (showNotification) {
                    this.showNotification(rewardText, 'success');
                }
                
                // æ£€æŸ¥æˆå°±
                this.checkAchievements();
            }
            
            // æ£€æŸ¥æ˜¯å¦æ¸…é™¤æ³¢æ¬¡
            checkWaveClear() {
                if (this.monsters.active.length === 0 && this.monsters.attackInProgress) {
                    // æ³¢æ¬¡æ¸…é™¤
                    this.monsters.attackInProgress = false;
                    
                    // ç»™äºˆæ³¢æ¬¡å¥–åŠ±
                    const waveReward = {
                        materials: this.monsters.waveCount * 20,
                        ammunition: this.monsters.waveCount * 15,
                        techPoints: Math.floor(this.monsters.waveCount * 1.5)
                    };
                    
                    Object.entries(waveReward).forEach(([resource, amount]) => {
                        if (this.resources[resource]) {
                            this.resources[resource].amount += amount;
                        } else if (resource === 'techPoints') {
                            this.gameState.techPoints += amount;
                        }
                    });
                    
                    this.showNotification(`ğŸ‰ æˆåŠŸæŠµå¾¡ç¬¬${this.monsters.waveCount}æ³¢æ€ªç‰©è¢­å‡»ï¼è·å¾—é¢å¤–å¥–åŠ±ï¼`, 'success');
                    
                    // æ›´æ–°é˜²å¾¡ç­‰çº§
                    this.monsters.defenseLevel = Math.min(10, 1 + Math.floor(this.monsters.totalKills / 10));
                    
                    // æ›´æ–°æ˜¾ç¤º
                    this.updateMonsterDisplay();
                    this.updateMap();
                }
            }
            
            // ====== å…¶ä»–æ¸¸æˆç³»ç»Ÿ ======
            
            // æ›´æ–°UI
            updateUI() {
                try {
                    const maxPopulation = this.getMaxPopulation();
                    const populationDisplay = maxPopulation === Infinity ? 
                        `${this.survivors.length}/âˆ` : 
                        `${this.survivors.length}/${maxPopulation}`;
                    
                    document.getElementById('day-count').textContent = `ç¬¬${Math.floor(this.gameState.day)}å¤©`;
                    document.getElementById('time-display').textContent = 
                        `${Math.floor(this.gameState.hour).toString().padStart(2, '0')}:${Math.floor(this.gameState.minute).toString().padStart(2, '0')}`;
                    document.getElementById('weather-display').textContent = this.gameState.weather;
                    document.getElementById('population').textContent = `${populationDisplay}äºº`;
                    document.getElementById('tech-points').textContent = Math.floor(this.gameState.techPoints);
                    document.getElementById('survivor-count').textContent = this.survivors.length;
                    document.getElementById('max-population').textContent = maxPopulation === Infinity ? 'âˆ' : maxPopulation;
                    document.getElementById('settings-day').textContent = Math.floor(this.gameState.day);
                    
                    const pauseBtn = document.getElementById('btn-pause');
                    if (pauseBtn) {
                        pauseBtn.innerHTML = this.isPaused ? 
                            '<span style="font-size: 12px;">â–¶ï¸</span><span style="font-size: 8px;">ç»§ç»­</span>' : 
                            '<span style="font-size: 12px;">â¸ï¸</span><span style="font-size: 8px;">æš‚åœ</span>';
                    }
                    
                } catch (error) {
                    console.error('æ›´æ–°UIé”™è¯¯:', error);
                }
            }
            
            // æ›´æ–°åœ°å›¾æ˜¾ç¤º
            updateMap() {
                const container = document.getElementById('map-buildings-list');
                if (!container) return;
                
                container.innerHTML = '';
                
                this.buildings.built.forEach(building => {
                    const buildingDiv = document.createElement('div');
                    buildingDiv.className = 'map-building-item';
                    buildingDiv.style.borderColor = building.color;
                    
                    buildingDiv.innerHTML = `
                        <div class="map-building-icon" style="color: ${building.color}">${building.icon}</div>
                        <div class="map-building-name">${building.type}</div>
                        <div class="map-building-level">å·²å»ºé€ </div>
                    `;
                    
                    container.appendChild(buildingDiv);
                });
                
                // æ›´æ–°åŸºåœ°ä¿¡æ¯
                document.getElementById('built-count').textContent = this.buildings.built.length;
                const maxPopulation = this.getMaxPopulation();
                const mapPopulationDisplay = maxPopulation === Infinity ? 
                    `${this.survivors.length}/âˆ` : 
                    `${this.survivors.length}/${maxPopulation}`;
                document.getElementById('map-population').textContent = mapPopulationDisplay;
                
                const energyPercent = (this.resources.energy.amount / this.resources.energy.max) * 100;
                document.getElementById('energy-status').textContent = 
                    energyPercent > 70 ? 'å……è¶³' : energyPercent > 30 ? 'æ­£å¸¸' : 'ä¸è¶³';
                document.getElementById('energy-status').style.color = 
                    energyPercent > 70 ? '#2ecc71' : energyPercent > 30 ? '#f39c12' : '#e74c3c';
                
                document.getElementById('defense-level').textContent = this.monsters.defenseLevel;
                document.getElementById('defense-level').style.color = 
                    this.monsters.defenseLevel >= 8 ? '#2ecc71' : 
                    this.monsters.defenseLevel >= 5 ? '#f39c12' : 
                    this.monsters.defenseLevel >= 3 ? '#e67e22' : '#e74c3c';
            }
            
            // æ£€æŸ¥éšæœºäº‹ä»¶
            checkRandomEvents() {
                if (Math.random() < 0.001 * this.gameState.gameSpeed) {
                    this.triggerRandomEvent();
                }
            }
            
            // è§¦å‘éšæœºäº‹ä»¶
            triggerRandomEvent() {
                const events = [
                    {
                        type: 'resource',
                        message: 'å‘ç°äº†ä¸€ä¸ªèµ„æºç‚¹ï¼',
                        action: () => {
                            const resources = ['food', 'water', 'materials', 'medicine', 'ammunition', 'energy'];
                            const resource = resources[Math.floor(Math.random() * resources.length)];
                            const amount = 30 + Math.floor(Math.random() * 70);
                            this.resources[resource].amount += amount;
                            return `è·å¾—${this.resources[resource].name}+${amount}`;
                        }
                    },
                    {
                        type: 'survivor',
                        message: 'æ–°çš„å¹¸å­˜è€…è¯·æ±‚åŠ å…¥ï¼',
                        action: () => {
                            const maxPopulation = this.getMaxPopulation();
                            if (maxPopulation === Infinity || this.survivors.length < maxPopulation) {
                                this.recruitSurvivor();
                                return 'æ–°çš„å¹¸å­˜è€…åŠ å…¥äº†åŸºåœ°';
                            }
                            return 'åŸºåœ°å·²æ»¡å‘˜ï¼Œæ— æ³•æ¥çº³æ–°çš„å¹¸å­˜è€…';
                        }
                    },
                    {
                        type: 'tech',
                        message: 'ç ”ç©¶æœ‰äº†æ–°å‘ç°ï¼',
                        action: () => {
                            const points = 10 + Math.floor(Math.random() * 20);
                            this.gameState.techPoints += points;
                            return `è·å¾—ç§‘æŠ€ç‚¹+${points}`;
                        }
                    },
                    {
                        type: 'monster',
                        message: 'å‘ç°å°è‚¡æ€ªç‰©ï¼',
                        action: () => {
                            if (!this.monsters.attackInProgress) {
                                // ç”Ÿæˆ1-2åªéšæœºæ€ªç‰©
                                const count = 1 + Math.floor(Math.random() * 2);
                                for (let i = 0; i < count; i++) {
                                    const monsterType = this.monsterTypes[Math.floor(Math.random() * this.monsterTypes.length)];
                                    const monster = {
                                        id: `random_${Date.now()}_${i}`,
                                        type: monsterType.id,
                                        name: monsterType.name,
                                        description: monsterType.description,
                                        hp: monsterType.hp,
                                        maxHp: monsterType.hp,
                                        damage: monsterType.damage,
                                        speed: monsterType.speed,
                                        reward: {...monsterType.reward},
                                        icon: monsterType.icon,
                                        color: monsterType.color,
                                        abilities: [...monsterType.abilities],
                                        attacks: 0
                                    };
                                    this.monsters.active.push(monster);
                                }
                                this.monsters.attackInProgress = true;
                                this.updateMonsterDisplay();
                                return 'å‘ç°æ€ªç‰©ï¼Œå‡†å¤‡æˆ˜æ–—ï¼';
                            }
                            return 'å·²ç»åœ¨æˆ˜æ–—ä¸­ï¼';
                        }
                    }
                ];
                
                const event = events[Math.floor(Math.random() * events.length)];
                const result = event.action();
                this.showNotification(result, 'success');
            }
            
            // æ˜¾ç¤ºæ¨¡æ€çª—å£
            showModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'flex';
                    setTimeout(() => {
                        this.updateModalContent(modalId);
                    }, 10);
                }
            }
            
            // å…³é—­æ¨¡æ€çª—å£
            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                    if (modalId === 'building-detail-modal') {
                        this.buildingModalOpen = false;
                        this.selectedBuilding = null;
                    }
                }
            }
            
            // æ›´æ–°æ¨¡æ€çª—å£å†…å®¹
            updateModalContent(modalId) {
                switch (modalId) {
                    case 'survivors-modal':
                        this.updateSurvivorsModal();
                        break;
                    case 'resources-modal':
                        this.updateResourcesModal();
                        break;
                    case 'buildings-modal':
                        this.updateBuildingsModal();
                        break;
                    case 'tech-modal':
                        this.updateTechModal();
                        break;
                    case 'explore-modal':
                        this.updateExploreModal();
                        break;
                    case 'achievements-modal':
                        this.updateAchievementsModal();
                        break;
                    case 'settings-modal':
                        this.updateSettingsModal();
                        break;
                    case 'dlc-modal':
                        this.updateDLCModal();
                        break;
                }
            }
            
            // æ›´æ–°è®¾ç½®æ¨¡æ€çª—å£
            updateSettingsModal() {
                const gameSpeedSelect = document.getElementById('game-speed');
                const orientationSelect = document.getElementById('screen-orientation');
                
                if (gameSpeedSelect) {
                    gameSpeedSelect.value = this.gameState.gameSpeed;
                }
                
                if (orientationSelect) {
                    orientationSelect.value = this.gameState.orientation;
                }
            }
            
            // æ›´æ–°å¹¸å­˜è€…æ¨¡æ€çª—å£
            updateSurvivorsModal() {
                const container = document.getElementById('survivors-list');
                if (!container) return;
                
                container.innerHTML = '';
                
                this.survivors.forEach(survivor => {
                    const survivorDiv = document.createElement('div');
                    survivorDiv.className = 'building-item';
                    survivorDiv.style.cssText = `
                        background: rgba(255,255,255,0.05);
                        border-radius: 6px;
                        padding: 10px;
                        margin-bottom: 6px;
                        border-left: 3px solid ${survivor.skillColor};
                        font-size: 12px;
                    `;
                    
                    const healthPercent = Math.max(0, Math.min(100, survivor.health));
                    const energyPercent = Math.max(0, Math.min(100, survivor.energy));
                    const moralePercent = Math.max(0, Math.min(100, survivor.morale));
                    
                    survivorDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="font-size: 24px;">${survivor.skillIcon}</div>
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: bold; font-size: 13px;">${survivor.name}</div>
                                        <div style="font-size: 11px; color: ${survivor.skillColor};">${survivor.skill}ä¸“å®¶</div>
                                    </div>
                                    <div style="font-size: 11px; color: #95a5a6;">${survivor.status}${survivor.exploring ? ' (æ¢ç´¢ä¸­)' : ''}</div>
                                </div>
                                
                                <div style="margin: 6px 0;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                                        <span style="font-size: 10px;">â¤ï¸ å¥åº·</span>
                                        <span style="font-size: 10px;">${Math.round(healthPercent)}%</span>
                                    </div>
                                    <div style="height: 4px; background: #34495e; border-radius: 2px; overflow: hidden;">
                                        <div style="height: 100%; width: ${healthPercent}%; background: #e74c3c;"></div>
                                    </div>
                                </div>
                                
                                <div style="margin: 6px 0;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                                        <span style="font-size: 10px;">âš¡ èƒ½é‡</span>
                                        <span style="font-size: 10px;">${Math.round(energyPercent)}%</span>
                                    </div>
                                    <div style="height: 4px; background: #34495e; border-radius: 2px; overflow: hidden;">
                                        <div style="height: 100%; width: ${energyPercent}%; background: #3498db;"></div>
                                    </div>
                                </div>
                                
                                <div style="margin: 6px 0;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                                        <span style="font-size: 10px;">ğŸ˜Š å£«æ°”</span>
                                        <span style="font-size: 10px;">${Math.round(moralePercent)}%</span>
                                    </div>
                                    <div style="height: 4px; background: #34495e; border-radius: 2px; overflow: hidden;">
                                        <div style="height: 100%; width: ${moralePercent}%; background: #f39c12;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(survivorDiv);
                });
            }
            
            // æ‹›å‹Ÿæ–°å¹¸å­˜è€…
            recruitSurvivor() {
                if (this.resources.materials.amount < 20) {
                    this.showNotification('ææ–™ä¸è¶³ï¼Œéœ€è¦20ææ–™', 'danger');
                    return;
                }
                
                const maxPopulation = this.getMaxPopulation();
                if (maxPopulation !== Infinity && this.survivors.length >= maxPopulation) {
                    this.showNotification(`å¹¸å­˜è€…äººæ•°å·²è¾¾ä¸Šé™ (${maxPopulation}äºº)`, 'warning');
                    return;
                }
                
                const names = ['èµµæ•', 'åˆ˜å¼º', 'é™ˆé™', 'å­™æµ©', 'å‘¨å©·', 'å´æ˜', 'éƒ‘çˆ½', 'å†¯åˆš', 'é™ˆä¼Ÿ', 'æ¨é™'];
                const skills = ['å»ºé€ ', 'åŒ»ç–—', 'ç ”ç©¶', 'æ¢ç´¢', 'æˆ˜æ–—', 'å†œä¸š', 'çªå‡»æ‰‹', 'ç‹™å‡»æ‰‹'];
                
                const randomName = names[Math.floor(Math.random() * names.length)];
                const randomSkill = skills[Math.floor(Math.random() * skills.length)];
                const newId = this.survivors.length > 0 ? Math.max(...this.survivors.map(s => s.id)) + 1 : 1;
                
                const newSurvivor = this.createSurvivor(newId, randomName, randomSkill);
                this.survivors.push(newSurvivor);
                this.resources.materials.amount -= 20;
                
                this.showNotification(`${newSurvivor.name}åŠ å…¥äº†ä½ çš„åŸºåœ°ï¼(æŠ€èƒ½: ${newSurvivor.skill})`, 'success');
                
                this.updateSurvivorsModal();
                this.updateUI();
                this.updateMap();
                this.checkAchievements();
            }
            
            // æ›´æ–°èµ„æºæ¨¡æ€çª—å£
            updateResourcesModal() {
                const container = document.getElementById('resources-content');
                if (!container) return;
                
                container.innerHTML = '';
                
                Object.values(this.resources).forEach(resource => {
                    const percent = (resource.amount / resource.max) * 100;
                    const resourceDiv = document.createElement('div');
                    resourceDiv.className = 'building-item';
                    resourceDiv.style.cssText = `
                        background: rgba(255,255,255,0.05);
                        border-radius: 6px;
                        padding: 10px;
                        margin-bottom: 6px;
                        border-left: 3px solid ${resource.color};
                        font-size: 12px;
                    `;
                    
                    resourceDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="font-size: 24px;">${resource.icon}</div>
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="font-weight: bold; font-size: 13px;">${resource.name}</div>
                                    <div style="font-size: 12px;">${Math.floor(resource.amount)}/${resource.max}</div>
                                </div>
                                
                                <div style="margin: 8px 0;">
                                    <div style="height: 6px; background: #34495e; border-radius: 3px; overflow: hidden;">
                                        <div style="height: 100%; width: ${percent}%; background: ${resource.color};"></div>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; font-size: 10px; color: #95a5a6; margin-top: 2px;">
                                        <span>${percent.toFixed(1)}%</span>
                                        <span style="color: ${resource.prod > resource.cons ? '#2ecc71' : '#e74c3c'}">
                                            å‡€äº§é‡: ${(resource.prod - resource.cons).toFixed(1)}/å°æ—¶
                                        </span>
                                    </div>
                                </div>
                                
                                <div style="font-size: 11px; color: #bdc3c7;">
                                    äº§é‡: ${resource.prod}/h | æ¶ˆè€—: ${resource.cons}/h
                                </div>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(resourceDiv);
                });
            }
            
            // æ›´æ–°å»ºç­‘æ¨¡æ€çª—å£
            updateBuildingsModal() {
                const container = document.getElementById('buildings-list');
                if (!container) return;
                
                container.innerHTML = '';
                
                const builtDiv = document.createElement('div');
                builtDiv.innerHTML = '<div style="font-size: 12px; color: #2ecc71; margin-bottom: 8px;">âœ“ å·²å»ºé€ çš„å»ºç­‘:</div>';
                this.buildings.built.forEach(building => {
                    const buildingDiv = document.createElement('div');
                    buildingDiv.className = 'building-item built';
                    buildingDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="font-size: 20px; color: ${building.color}; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); border-radius: 6px;">
                                ${building.icon}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; font-size: 13px;">${building.type}</div>
                                <div style="font-size: 11px; color: #95a5a6;">${building.effect}</div>
                                ${building.type === 'å®¿èˆ' ? `<div style="font-size: 10px; color: #2ecc71;">æä¾›æ— é™äººå£ä¸Šé™</div>` : ''}
                            </div>
                        </div>
                    `;
                    builtDiv.appendChild(buildingDiv);
                });
                container.appendChild(builtDiv);
                
                const availableDiv = document.createElement('div');
                availableDiv.innerHTML = '<div style="font-size: 12px; color: #3498db; margin: 12px 0 8px 0;">ğŸ”¨ å¯å»ºé€ çš„å»ºç­‘:</div>';
                
                this.buildings.available.forEach(building => {
                    const canAfford = Object.entries(building.cost).every(
                        ([resource, amount]) => this.resources[resource]?.amount >= amount
                    );
                    
                    const buildingDiv = document.createElement('div');
                    buildingDiv.className = `building-item ${canAfford ? '' : 'insufficient'}`;
                    buildingDiv.style.cursor = canAfford ? 'pointer' : 'not-allowed';
                    
                    let costText = '';
                    Object.entries(building.cost).forEach(([resource, amount]) => {
                        const hasEnough = this.resources[resource]?.amount >= amount;
                        costText += `<span style="color: ${hasEnough ? '#2ecc71' : '#e74c3c'}; margin-right: 6px; font-size: 10px;">${this.resources[resource]?.name}: ${amount}</span>`;
                    });
                    
                    buildingDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="font-size: 20px; color: ${building.color}; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); border-radius: 6px;">
                                ${building.icon}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; font-size: 13px;">${building.type}</div>
                                <div style="font-size: 11px; color: #95a5a6; margin: 3px 0;">${building.effect}</div>
                                <div style="font-size: 10px; margin: 3px 0;">${costText}</div>
                            </div>
                            <div style="font-size: 20px;">
                                ${canAfford ? 'ğŸ”¨' : 'ğŸ”’'}
                            </div>
                        </div>
                    `;
                    
                    if (canAfford) {
                        buildingDiv.addEventListener('click', () => {
                            this.buildStructure(building);
                        }, { passive: true });
                    }
                    
                    availableDiv.appendChild(buildingDiv);
                });
                
                container.appendChild(availableDiv);
            }
            
            // å»ºé€ å»ºç­‘
            buildStructure(building) {
                try {
                    Object.entries(building.cost).forEach(([resource, amount]) => {
                        if (this.resources[resource].amount < amount) {
                            throw new Error(`${this.resources[resource].name}ä¸è¶³ï¼éœ€è¦${amount}ï¼Œå½“å‰${this.resources[resource].amount}`);
                        }
                    });
                    
                    Object.entries(building.cost).forEach(([resource, amount]) => {
                        this.resources[resource].amount -= amount;
                    });
                    
                    const newBuilding = {
                        id: building.id,
                        type: building.type,
                        icon: building.icon,
                        color: building.color,
                        effect: building.effect
                    };
                    
                    this.buildings.built.push(newBuilding);
                    this.applyBuildingEffect(building);
                    this.buildings.available = this.buildings.available.filter(b => b.id !== building.id);
                    
                    this.showNotification(`${building.type}å»ºé€ å®Œæˆï¼(${building.effect})`, 'success');
                    
                    this.updateBuildingsModal();
                    this.updateUI();
                    this.updateMap();
                    this.checkAchievements();
                    
                } catch (error) {
                    this.showNotification(error.message, 'danger');
                }
            }
            
            // åº”ç”¨å»ºç­‘æ•ˆæœ
            applyBuildingEffect(building) {
                if (building.effect.includes('é£Ÿç‰©')) {
                    const amount = parseInt(building.effect.match(/\d+/)[0]) || 15;
                    this.resources.food.prod += amount;
                } else if (building.effect.includes('æ°´')) {
                    const amount = parseInt(building.effect.match(/\d+/)[0]) || 12;
                    this.resources.water.prod += amount;
                } else if (building.effect.includes('ææ–™')) {
                    const amount = parseInt(building.effect.match(/\d+/)[0]) || 20;
                    this.resources.materials.prod += amount;
                } else if (building.effect.includes('è¯å“')) {
                    const amount = parseInt(building.effect.match(/\d+/)[0]) || 8;
                    this.resources.medicine.prod += amount;
                } else if (building.effect.includes('å¼¹è¯')) {
                    const amount = parseInt(building.effect.match(/\d+/)[0]) || 15;
                    this.resources.ammunition.prod += amount;
                } else if (building.effect.includes('èƒ½æº')) {
                    const amount = parseInt(building.effect.match(/\d+/)[0]) || 25;
                    this.resources.energy.prod += amount;
                } else if (building.effect.includes('é˜²å¾¡')) {
                    this.monsters.baseDefense += 2;
                }
            }
            
            // æ›´æ–°ç§‘æŠ€æ¨¡æ€çª—å£
            updateTechModal() {
                const container = document.getElementById('tech-tree');
                if (!container) return;
                
                container.innerHTML = '';
                
                this.techTree.forEach(tech => {
                    const isUnlocked = this.gameState.unlockedTech.includes(tech.id);
                    const canResearch = this.gameState.techPoints >= tech.cost && 
                                        tech.requires.every(req => this.gameState.unlockedTech.includes(req));
                    
                    const techDiv = document.createElement('div');
                    techDiv.className = `tech-item ${isUnlocked ? 'researched' : (canResearch ? '' : 'locked')}`;
                    
                    let requiresText = 'æ— å‰ç½®éœ€æ±‚';
                    if (tech.requires.length > 0) {
                        requiresText = 'éœ€è¦: ' + tech.requires.map(req => {
                            const reqTech = this.techTree.find(t => t.id === req);
                            return reqTech ? reqTech.name : req;
                        }).join(', ');
                    }
                    
                    techDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="font-size: 24px;">${tech.icon}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; font-size: 13px;">${tech.name}</div>
                                <div style="font-size: 11px; color: #95a5a6; margin: 3px 0;">${tech.effect}</div>
                                <div style="font-size: 10px; color: #bdc3c7; margin: 3px 0;">${requiresText}</div>
                                <div style="font-size: 10px; color: #3498db;">ç ”ç©¶æ—¶é—´: ${tech.researchTime}å°æ—¶</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 12px; font-weight: bold; color: ${this.gameState.techPoints >= tech.cost ? '#2ecc71' : '#e74c3c'}">
                                    ${tech.cost} ç§‘æŠ€ç‚¹
                                </div>
                                <div style="font-size: 20px; margin-top: 3px;">
                                    ${isUnlocked ? 'âœ…' : (canResearch ? 'ğŸ”¬' : 'ğŸ”’')}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    if (canResearch && !isUnlocked) {
                        techDiv.addEventListener('click', () => {
                            this.researchTech(tech);
                        }, { passive: true });
                    }
                    
                    container.appendChild(techDiv);
                });
            }
            
            // ç ”ç©¶ç§‘æŠ€
            researchTech(tech) {
                if (this.gameState.techPoints < tech.cost) {
                    this.showNotification(`ç§‘æŠ€ç‚¹ä¸è¶³ï¼éœ€è¦${tech.cost}ï¼Œå½“å‰${Math.floor(this.gameState.techPoints)}`, 'danger');
                    return;
                }
                
                if (!tech.requires.every(req => this.gameState.unlockedTech.includes(req))) {
                    this.showNotification('å‰ç½®ç§‘æŠ€æœªè§£é”ï¼', 'danger');
                    return;
                }
                
                this.gameState.techPoints -= tech.cost;
                this.gameState.unlockedTech.push(tech.id);
                
                this.applyTechEffect(tech);
                
                this.showNotification(`${tech.name}ç ”å‘æˆåŠŸï¼(${tech.effect})`, 'success');
                
                this.updateTechModal();
                this.checkAchievements();
            }
            
            // åº”ç”¨ç§‘æŠ€æ•ˆæœ
            applyTechEffect(tech) {
                if (tech.effect.includes('é£Ÿç‰©äº§é‡')) {
                    this.resources.food.prod *= 1.25;
                } else if (tech.effect.includes('æ°´æ¶ˆè€—')) {
                    this.resources.water.cons *= 0.8;
                } else if (tech.effect.includes('èƒ½æºäº§é‡')) {
                    const amount = parseInt(tech.effect.match(/\d+/)[0]);
                    this.resources.energy.prod += amount;
                } else if (tech.effect.includes('è¯å“äº§é‡')) {
                    const amount = parseInt(tech.effect.match(/\d+/)[0]);
                    this.resources.medicine.prod += amount;
                } else if (tech.effect.includes('å¼¹è¯äº§é‡')) {
                    const amount = parseInt(tech.effect.match(/\d+/)[0]);
                    this.resources.ammunition.prod += amount;
                } else if (tech.effect.includes('æ‰€æœ‰èµ„æºç”Ÿäº§')) {
                    Object.values(this.resources).forEach(res => {
                        res.prod *= 1.15;
                    });
                } else if (tech.effect.includes('æ‰€æœ‰æ•ˆç‡')) {
                    Object.values(this.resources).forEach(res => {
                        res.prod *= 1.25;
                        res.cons *= 0.9;
                    });
                }
            }
            
            // æ›´æ–°æ¢ç´¢æ¨¡æ€çª—å£
            updateExploreModal() {
                const container = document.getElementById('explore-options');
                if (!container) return;
                
                container.innerHTML = '';
                
                const availableSurvivors = this.survivors.filter(s => !s.assigned && !s.exploring);
                if (availableSurvivors.length === 0) {
                    container.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 15px; color: #e74c3c;">
                            <div style="font-size: 20px; margin-bottom: 8px;">âš ï¸</div>
                            <div style="font-size: 12px;">æ²¡æœ‰å¯ç”¨çš„å¹¸å­˜è€…è¿›è¡Œæ¢ç´¢ï¼</div>
                            <div style="font-size: 11px; color: #95a5a6; margin-top: 6px;">è¯·ç¡®ä¿æœ‰å¹¸å­˜è€…å¤„äºç©ºé—²çŠ¶æ€</div>
                        </div>
                    `;
                    return;
                }
                
                this.exploreLocations.forEach(location => {
                    const exploreBtn = document.createElement('button');
                    exploreBtn.className = 'btn';
                    exploreBtn.style.cssText = `
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        padding: 10px 6px;
                        height: auto;
                        min-height: 80px;
                    `;
                    
                    const riskColor = location.risk === 'ä½' ? '#2ecc71' : 
                                     location.risk === 'ä¸­' ? '#f39c12' : 
                                     location.risk === 'é«˜' ? '#e67e22' : '#e74c3c';
                    
                    exploreBtn.innerHTML = `
                        <span style="font-size: 24px; margin-bottom: 4px;">${location.icon}</span>
                        <span style="font-weight: bold; font-size: 12px; margin-bottom: 2px;">${location.name}</span>
                        <span style="font-size: 10px; color: ${riskColor};">é£é™©: ${location.risk}</span>
                        <span style="font-size: 9px; color: #95a5a6; margin-top: 2px;">è€—æ—¶: ${location.time}ç§’</span>
                        <span style="font-size: 8px; color: #bdc3c7; margin-top: 1px; text-align: center;">${location.desc}</span>
                    `;
                    
                    exploreBtn.addEventListener('click', () => {
                        this.startExploration(location);
                    }, { passive: true });
                    
                    container.appendChild(exploreBtn);
                });
            }
            
            // å¼€å§‹æ¢ç´¢
            startExploration(location) {
                if (this.isExploring) {
                    this.showNotification('å·²ç»åœ¨æ¢ç´¢ä¸­ï¼', 'warning');
                    return;
                }
                
                const availableSurvivors = this.survivors.filter(s => !s.assigned && !s.exploring);
                if (availableSurvivors.length === 0) {
                    this.showNotification('æ²¡æœ‰å¯ç”¨çš„å¹¸å­˜è€…ï¼', 'danger');
                    return;
                }
                
                const explorer = availableSurvivors[0];
                explorer.exploring = true;
                explorer.status = `æ¢ç´¢${location.name}`;
                
                this.isExploring = true;
                this.currentExplore = location;
                this.exploreTimeLeft = location.time;
                
                this.closeModal('explore-modal');
                
                const timerDisplay = document.getElementById('explore-timer');
                timerDisplay.style.display = 'block';
                this.updateExploreTimer();
                
                this.showNotification(`${explorer.name}å¼€å§‹æ¢ç´¢${location.name}...`, 'info');
            }
            
            // æ›´æ–°æ¢ç´¢è®¡æ—¶å™¨
            updateExploreTimer() {
                if (!this.isExploring) return;
                
                const timerDisplay = document.getElementById('explore-timer');
                if (this.exploreTimeLeft <= 0) {
                    this.finishExploration();
                    timerDisplay.style.display = 'none';
                    return;
                }
                
                this.exploreTimeLeft--;
                
                const explorer = this.survivors.find(s => s.exploring);
                if (explorer) {
                    timerDisplay.innerHTML = `
                        <div style="font-size: 12px; margin-bottom: 4px;">æ¢ç´¢ä¸­: ${this.currentExplore.name}</div>
                        <div style="font-size: 16px; font-weight: bold; color: #FFC107;">${this.exploreTimeLeft}ç§’</div>
                        <div style="font-size: 11px; margin-top: 3px;">æ¢ç´¢è€…: ${explorer.name}</div>
                        <div style="font-size: 9px; color: #95a5a6; margin-top: 2px;">é£é™©: ${this.currentExplore.risk}</div>
                    `;
                }
            }
            
            // å®Œæˆæ¢ç´¢
            finishExploration() {
                if (!this.currentExplore) return;
                
                const explorer = this.survivors.find(s => s.exploring);
                if (!explorer) return;
                
                this.isExploring = false;
                explorer.exploring = false;
                explorer.status = 'ç©ºé—²';
                
                const successRate = this.currentExplore.risk === 'ä½' ? 0.85 : 
                                  this.currentExplore.risk === 'ä¸­' ? 0.65 : 
                                  this.currentExplore.risk === 'é«˜' ? 0.45 : 0.25;
                
                if (Math.random() < successRate) {
                    let rewardText = `æ¢ç´¢æˆåŠŸï¼${explorer.name}å¸¦å›äº†: `;
                    
                    Object.entries(this.currentExplore.rewards).forEach(([resource, amount]) => {
                        if (resource === 'techPoints') {
                            this.gameState.techPoints += amount;
                            rewardText += `ç§‘æŠ€ç‚¹+${amount} `;
                        } else if (this.resources[resource]) {
                            this.resources[resource].amount += amount;
                            rewardText += `${this.resources[resource].name}+${amount} `;
                        }
                    });
                    
                    explorer.experience += 20;
                    if (explorer.experience >= 100) {
                        explorer.level += 1;
                        explorer.experience = 0;
                        rewardText += ` ${explorer.name}å‡çº§åˆ°Lv.${explorer.level}`;
                    }
                    
                    this.showNotification(rewardText, 'success');
                    this.checkAchievements();
                } else {
                    explorer.health -= 25;
                    explorer.morale -= 20;
                    this.showNotification(`æ¢ç´¢å¤±è´¥ï¼${explorer.name}åœ¨${this.currentExplore.name}å—ä¼¤`, 'danger');
                }
                
                this.currentExplore = null;
                this.updateUI();
                this.updateMap();
            }
            
            // æ›´æ–°æˆå°±æ¨¡æ€çª—å£
            updateAchievementsModal() {
                const container = document.getElementById('achievements-list');
                if (!container) return;
                
                container.innerHTML = '';
                
                const unlockedCount = this.achievementsList.filter(a => a.unlocked).length;
                document.getElementById('unlocked-achievements').textContent = unlockedCount;
                
                this.achievementsList.forEach(achievement => {
                    const achievementDiv = document.createElement('div');
                    achievementDiv.className = `achievement-item ${achievement.unlocked ? 'unlocked' : ''}`;
                    
                    const typeColor = {
                        'bronze': '#cd7f32',
                        'silver': '#c0c0c0',
                        'gold': '#ffd700',
                        'platinum': '#e5e4e2'
                    }[achievement.type] || '#9b59b6';
                    
                    achievementDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="font-size: 24px; color: ${typeColor};">${achievement.icon}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; font-size: 13px; color: ${achievement.unlocked ? '#2ecc71' : '#bdc3c7'}">
                                    ${achievement.name}
                                    <span style="font-size: 9px; padding: 1px 4px; background: ${typeColor}30; color: ${typeColor}; border-radius: 8px; margin-left: 6px;">
                                        ${achievement.type.toUpperCase()}
                                    </span>
                                </div>
                                <div style="font-size: 11px; color: #95a5a6; margin: 3px 0;">
                                    ${achievement.description}
                                </div>
                            </div>
                            <div style="font-size: 24px;">
                                ${achievement.unlocked ? 'ğŸ†' : 'ğŸ”’'}
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(achievementDiv);
                });
            }
            
            // æ£€æŸ¥æˆå°±
            checkAchievements() {
                let newAchievement = false;
                
                const builtCount = this.buildings.built.length;
                if (builtCount >= 5) {
                    const achievement = this.achievementsList.find(a => a.id === 'builder');
                    if (achievement && !achievement.unlocked) {
                        achievement.unlocked = true;
                        newAchievement = true;
                    }
                }
                
                const maxPopulation = this.getMaxPopulation();
                if (this.survivors.length >= 8) {
                    const achievement = this.achievementsList.find(a => a.id === 'survivor');
                    if (achievement && !achievement.unlocked) {
                        achievement.unlocked = true;
                        newAchievement = true;
                    }
                }
                
                if (this.survivors.length >= 12) {
                    const achievement = this.achievementsList.find(a => a.id === 'leader');
                    if (achievement && !achievement.unlocked) {
                        achievement.unlocked = true;
                        newAchievement = true;
                    }
                }
                
                const techCount = this.gameState.unlockedTech.length;
                if (techCount >= 5) {
                    const achievement = this.achievementsList.find(a => a.id === 'scientist');
                    if (achievement && !achievement.unlocked) {
                        achievement.unlocked = true;
                        newAchievement = true;
                    }
                }
                
                if (techCount >= this.techTree.length) {
                    const achievement = this.achievementsList.find(a => a.id === 'technocrat');
                    if (achievement && !achievement.unlocked) {
                        achievement.unlocked = true;
                        newAchievement = true;
                    }
                }
                
                if (this.gameState.day >= 30) {
                    const achievement = this.achievementsList.find(a => a.id === 'veteran');
                    if (achievement && !achievement.unlocked) {
                        achievement.unlocked = true;
                        newAchievement = true;
                    }
                }
                
                const allResources = Object.values(this.resources);
                if (allResources.every(res => res.amount >= 1000)) {
                    const achievement = this.achievementsList.find(a => a.id === 'collector');
                    if (achievement && !achievement.unlocked) {
                        achievement.unlocked = true;
                        newAchievement = true;
                    }
                }
                
                if (this.buildings.built.length >= this.buildings.available.length + 3) {
                    const achievement = this.achievementsList.find(a => a.id === 'architect');
                    if (achievement && !achievement.unlocked) {
                        achievement.unlocked = true;
                        newAchievement = true;
                    }
                }
                
                const allUnlocked = this.achievementsList.filter(a => a.id !== 'master').every(a => a.unlocked);
                if (allUnlocked) {
                    const achievement = this.achievementsList.find(a => a.id === 'master');
                    if (achievement && !achievement.unlocked) {
                        achievement.unlocked = true;
                        newAchievement = true;
                    }
                }
                
                if (newAchievement) {
                    this.updateAchievementsModal();
                }
            }
            
            // åˆ‡æ¢æš‚åœçŠ¶æ€
            togglePause() {
                this.isPaused = !this.isPaused;
                this.showNotification(
                    this.isPaused ? 'æ¸¸æˆå·²æš‚åœ' : 'æ¸¸æˆç»§ç»­',
                    this.isPaused ? 'warning' : 'success'
                );
                this.updateUI();
            }
            
            // æ˜¾ç¤ºæ¢ç´¢æ¨¡æ€çª—å£
            showExploreModal() {
                if (this.isExploring) {
                    this.showNotification('æ­£åœ¨æ¢ç´¢ä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆ', 'warning');
                    return;
                }
                
                this.showModal('explore-modal');
            }
            
            // æ˜¾ç¤ºå¹¸å­˜è€…æ¨¡æ€çª—å£
            showSurvivorsModal() {
                this.showModal('survivors-modal');
            }
            
            // æ˜¾ç¤ºèµ„æºæ¨¡æ€çª—å£
            showResourcesModal() {
                this.showModal('resources-modal');
            }
            
            // æ˜¾ç¤ºå»ºç­‘æ¨¡æ€çª—å£
            showBuildingsModal() {
                this.showModal('buildings-modal');
            }
            
            // æ˜¾ç¤ºç§‘æŠ€æ¨¡æ€çª—å£
            showTechModal() {
                this.showModal('tech-modal');
            }
            
            // æ˜¾ç¤ºæˆå°±æ¨¡æ€çª—å£
            showAchievementsModal() {
                this.showModal('achievements-modal');
            }
            
            // æ˜¾ç¤ºè®¾ç½®æ¨¡æ€çª—å£
            showSettingsModal() {
                this.showModal('settings-modal');
            }
            
            // æ˜¾ç¤ºé€šçŸ¥
            showNotification(message, type = 'info') {
                const container = document.getElementById('notification-container');
                if (!container) return;
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                container.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.style.opacity = '0';
                        notification.style.transform = 'translateY(-10px)';
                        setTimeout(() => {
                            if (notification.parentNode) {
                                notification.parentNode.removeChild(notification);
                            }
                        }, 300);
                    }
                }, 3000);
            }
            
            // ä¿å­˜æ¸¸æˆ
            saveGame() {
                try {
                    const saveData = {
                        gameState: this.gameState,
                        resources: this.resources,
                        survivors: this.survivors,
                        buildings: this.buildings,
                        monsters: this.monsters,
                        achievements: this.achievementsList,
                        unlockedTech: this.gameState.unlockedTech
                    };
                    
                    localStorage.setItem('wastelandArkSave', JSON.stringify(saveData));
                    this.showNotification('æ¸¸æˆå·²ä¿å­˜ï¼', 'success');
                    console.log('ğŸ’¾ æ¸¸æˆä¿å­˜æˆåŠŸ');
                } catch (error) {
                    console.error('ä¿å­˜å¤±è´¥:', error);
                    this.showNotification('ä¿å­˜å¤±è´¥ï¼', 'danger');
                }
            }
            
            // åŠ è½½æ¸¸æˆ
            loadGame() {
                try {
                    const saveData = localStorage.getItem('wastelandArkSave');
                    if (!saveData) {
                        console.log('ğŸ“‚ æ— å­˜æ¡£æ•°æ®ï¼Œå¼€å§‹æ–°æ¸¸æˆ');
                        return;
                    }
                    
                    const data = JSON.parse(saveData);
                    
                    this.gameState = data.gameState || this.gameState;
                    this.resources = data.resources || this.resources;
                    this.survivors = data.survivors || this.survivors;
                    this.buildings = data.buildings || this.buildings;
                    this.monsters = data.monsters || this.monsters;
                    this.achievementsList = data.achievements || this.achievementsList;
                    this.gameState.unlockedTech = data.unlockedTech || [];
                    
                    this.showNotification('æ¸¸æˆå·²åŠ è½½ï¼', 'success');
                    console.log('ğŸ“‚ æ¸¸æˆåŠ è½½æˆåŠŸ');
                    
                } catch (error) {
                    console.error('åŠ è½½å¤±è´¥:', error);
                    this.showNotification('åŠ è½½å­˜æ¡£å¤±è´¥ï¼Œå¼€å§‹æ–°æ¸¸æˆ', 'warning');
                }
            }
        }

        // ====== å…¨å±€è¾…åŠ©å‡½æ•° ======
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        function resetGame() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ¸¸æˆå—ï¼Ÿæ‰€æœ‰è¿›åº¦éƒ½å°†ä¸¢å¤±ï¼')) {
                localStorage.removeItem('wastelandArkSave');
                localStorage.removeItem('wastelandArkDLCs');
                location.reload();
            }
        }

        // ====== æ¸¸æˆå¯åŠ¨ ======
        let game;

        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–æ¸¸æˆ...");
            
            try {
                game = new WastelandArkGame();
                window.game = game;
                
                setTimeout(() => {
                    game.initialize();
                }, 100);
                
                console.log('ğŸ° ã€ŠåºŸåœŸæ–¹èˆŸã€‹v2.0 æ­£åœ¨å¯åŠ¨...');
                console.log('ğŸ“± ç§»åŠ¨ç«¯ä¼˜åŒ–å·²å¯ç”¨');
                console.log('âœ… å®Œæ•´åŠŸèƒ½ç³»ç»Ÿå·²é›†æˆ');
                console.log('ğŸ‘¾ ä¸°å¯Œæ€ªç‰©ç³»ç»Ÿå·²æ¿€æ´»');
                console.log('ğŸ—ï¸ å»ºç­‘å‡çº§ç³»ç»Ÿå·²ç§»é™¤');
                console.log('ğŸ‘¥ å®¿èˆæä¾›æ— é™äººå£ä¸Šé™');
                console.log('ğŸ DLCç®¡ç†ç³»ç»Ÿå·²æ¿€æ´»ï¼ˆæ”¯æŒURLå®‰è£…å’Œæœ¬åœ°ä¸Šä¼ ï¼‰');
                
            } catch (error) {
                console.error('âŒ æ¸¸æˆå¯åŠ¨å¤±è´¥:', error);
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #e74c3c;">
                            <div style="font-size: 18px; margin-bottom: 15px;">âš ï¸ å¯åŠ¨å¤±è´¥</div>
                            <div style="margin-bottom: 15px; font-size: 12px;">${error.message}</div>
                            <button onclick="location.reload()" style="
                                background: #3498db;
                                color: white;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 6px;
                                font-size: 14px;
                                cursor: pointer;
                            ">é‡æ–°åŠ è½½</button>
                        </div>
                    `;
                }
            }
        });

        // çª—å£å¤§å°å˜åŒ–å¤„ç†
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                if (game) {
                    game.updateMap();
                }
            }, 100);
        }, { passive: true });

        // é˜²æ­¢é¡µé¢æ»šåŠ¨
        document.addEventListener('touchmove', (e) => {
            if (e.target.tagName !== 'BUTTON' && e.target.closest('.modal-content') === null && e.target.closest('.map-buildings-container') === null) {
                e.preventDefault();
            }
        }, { passive: false });

        // ä¿®å¤ï¼šå¤„ç†iOS Safariçš„100vhé—®é¢˜
        function setRealViewportHeight() {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        
        setRealViewportHeight();
        window.addEventListener('resize', setRealViewportHeight);
    </script>
</body>
</html>

