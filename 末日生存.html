<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>åºŸåœŸæ–¹èˆŸ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>âš”ï¸</text></svg>">
    
    <style>
        /* ====== åŸºç¡€é‡ç½® ====== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            touch-action: manipulation;
            font-family: 'Microsoft YaHei', sans-serif;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #0a0a12;
            color: #e0e0ff;
            position: fixed;
        }

        /* ====== åŠ è½½å±å¹• ====== */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a2e;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(52, 152, 219, 0.3);
            border-top-color: #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        /* ====== ä¸»æ¸¸æˆå®¹å™¨ ====== */
        #game-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 8px;
            gap: 8px;
            display: none;
        }

        /* ====== çŠ¶æ€æ  ====== */
        #status-bar {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid #3498db;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            height: 60px;
            font-size: 14px;
            flex-shrink: 0;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-icon {
            font-size: 20px;
            width: 30px;
            text-align: center;
            color: #3498db;
        }

        .status-value {
            font-size: 15px;
            font-weight: bold;
            color: #fff;
        }

        /* ====== ä¸»å†…å®¹åŒºåŸŸ ====== */
        #main-content {
            flex: 1;
            display: flex;
            gap: 8px;
            min-height: 0;
            overflow: hidden;
        }

        /* ====== åœ°å›¾åŒºåŸŸ ====== */
        #map-container {
            flex: 1;
            background: rgba(20, 25, 40, 0.95);
            border-radius: 12px;
            border: 2px solid #444;
            position: relative;
            overflow: hidden;
        }

        #base-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* ====== æ§åˆ¶é¢æ¿ ====== */
        #control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 8px;
            padding: 12px;
            background: rgba(35, 40, 60, 0.95);
            border-radius: 12px;
            border: 2px solid #444;
            max-height: 200px;
            overflow-y: auto;
        }

        /* ====== æŒ‰é’®ç³»ç»Ÿ ====== */
        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            border: none;
            border-radius: 8px;
            color: white;
            padding: 10px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            min-height: 70px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3);
        }

        .btn-success { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .btn-warning { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .btn-purple { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
        .btn-orange { background: linear-gradient(135deg, #e67e22, #d35400); }
        .btn-dlc { background: linear-gradient(135deg, #FF6B6B, #EE5A24); }
        .btn-building { background: linear-gradient(135deg, #1abc9c, #16a085); }
        .btn-teal { background: linear-gradient(135deg, #1abc9c, #16a085); }

        /* ====== å¼¹çª—ç³»ç»Ÿ ====== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .modal-content {
            background: #2c3e50;
            border-radius: 16px;
            padding: 24px;
            width: 95%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border: 3px solid #3498db;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
        }

        .modal-title {
            font-size: 20px;
            color: #3498db;
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #e74c3c;
            color: white;
            border: none;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 1001;
        }

        /* ====== é€šçŸ¥ç³»ç»Ÿ ====== */
        #notification-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
        }

        .notification {
            background: #34495e;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            border-left: 6px solid #3498db;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: fadeIn 0.3s, fadeOut 0.3s 2.7s forwards;
            font-size: 14px;
            line-height: 1.5;
        }

        .notification.success { border-left-color: #2ecc71; }
        .notification.warning { border-left-color: #f39c12; }
        .notification.danger { border-left-color: #e74c3c; }

        /* ====== å»ºç­‘é¡¹æ ·å¼ ====== */
        .building-item {
            background: rgba(26, 188, 156, 0.1);
            border: 1px solid #1abc9c;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .building-item:hover {
            background: rgba(26, 188, 156, 0.2);
        }

        .building-item.built {
            background: rgba(46, 204, 113, 0.1);
            border-color: #2ecc71;
        }

        .building-item.insufficient {
            background: rgba(231, 76, 60, 0.1);
            border-color: #e74c3c;
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ====== ç§‘æŠ€é¡¹æ ·å¼ ====== */
        .tech-item {
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid #3498db;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tech-item:hover {
            background: rgba(52, 152, 219, 0.2);
        }

        .tech-item.researched {
            background: rgba(46, 204, 113, 0.1);
            border-color: #2ecc71;
        }

        .tech-item.locked {
            background: rgba(149, 165, 166, 0.1);
            border-color: #95a5a6;
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ====== æˆå°±é¡¹æ ·å¼ ====== */
        .achievement-item {
            background: rgba(155, 89, 182, 0.1);
            border: 1px solid #9b59b6;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .achievement-item.unlocked {
            background: rgba(46, 204, 113, 0.1);
            border-color: #2ecc71;
        }

        /* ====== DLCé¡¹æ ·å¼ ====== */
        .dlc-item {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid #FF6B6B;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .dlc-item.free {
            border-color: #2ecc71;
            background: rgba(46, 204, 113, 0.1);
        }

        .dlc-item.paid {
            border-color: #f39c12;
            background: rgba(243, 156, 18, 0.1);
        }

        /* ====== å‡çº§é¡¹æ ·å¼ ====== */
        .upgrade-item {
            background: rgba(243, 156, 18, 0.1);
            border: 1px solid #f39c12;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upgrade-item:hover {
            background: rgba(243, 156, 18, 0.2);
        }

        .upgrade-item.upgraded {
            background: rgba(46, 204, 113, 0.1);
            border-color: #2ecc71;
        }

        .upgrade-item.insufficient {
            background: rgba(231, 76, 60, 0.1);
            border-color: #e74c3c;
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ====== åŠ¨ç”»å®šä¹‰ ====== */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }

        @keyframes spin {
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* ====== æ¢ç´¢è®¡æ—¶å™¨ ====== */
        #explore-timer {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 998;
            font-size: 16px;
            border: 2px solid #2ecc71;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            display: none;
            text-align: center;
            min-width: 250px;
        }

        /* ====== å“åº”å¼è®¾è®¡ ====== */
        @media (max-width: 768px) {
            #status-bar { height: 50px; font-size: 12px; }
            #control-panel { grid-template-columns: repeat(4, 1fr); }
        }

        @media (max-width: 480px) {
            .modal-content { padding: 16px; }
            #control-panel { grid-template-columns: repeat(3, 1fr); }
        }

        /* ====== å±å¹•æ–¹å‘ ====== */
        body.portrait-mode #game-container { flex-direction: column; }
        body.landscape-mode #game-container { flex-direction: row; }
        body.landscape-mode #main-content { flex-direction: row; }
        body.landscape-mode #map-container { flex: 3; }
        body.landscape-mode #control-panel { 
            flex-direction: column; 
            width: 90px;
            overflow-y: auto;
            grid-template-columns: 1fr;
        }
    </style>
</head>
<body class="portrait-mode">
    <!-- åŠ è½½å±å¹• -->
    <div id="loading-screen">
        <div class="loading-spinner"></div>
        <div style="font-size: 24px; color: #3498db; margin: 10px 0; font-weight: bold;">åºŸåœŸæ–¹èˆŸ</div>
        <div id="loading-text" style="font-size: 14px; color: #95a5a6; text-align: center; max-width: 300px;">
            æ­£åœ¨åˆå§‹åŒ–æ¸¸æˆä¸–ç•Œ...
        </div>
    </div>

    <!-- æ¢ç´¢è®¡æ—¶å™¨ -->
    <div id="explore-timer"></div>

    <!-- é€šçŸ¥å®¹å™¨ -->
    <div id="notification-container"></div>

    <!-- ä¸»æ¸¸æˆç•Œé¢ -->
    <div id="game-container">
        <!-- çŠ¶æ€æ  -->
        <div id="status-bar">
            <div style="display: flex; align-items: center; gap: 20px; overflow-x: auto;">
                <div class="status-item">
                    <span class="status-icon">ğŸ“…</span>
                    <span class="status-value" id="day-count">ç¬¬1å¤©</span>
                </div>
                <div class="status-item">
                    <span class="status-icon">â°</span>
                    <span class="status-value" id="time-display">07:00</span>
                </div>
                <div class="status-item">
                    <span class="status-icon">â˜ï¸</span>
                    <span class="status-value" id="weather-display">æ™´æœ—</span>
                </div>
                <div class="status-item">
                    <span class="status-icon">ğŸ‘¥</span>
                    <span class="status-value" id="population">3äºº</span>
                </div>
                <div class="status-item">
                    <span class="status-icon">ğŸ”¬</span>
                    <span class="status-value" id="tech-points">0</span>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" id="btn-explore" style="min-height: 40px; padding: 5px 10px;">
                    <span style="font-size: 16px;">ğŸ§­</span>
                    <span style="font-size: 10px;">æ¢ç´¢</span>
                </button>
                <button class="btn btn-warning" id="btn-pause" style="min-height: 40px; padding: 5px 10px;">
                    <span style="font-size: 16px;">â¸ï¸</span>
                    <span style="font-size: 10px;">æš‚åœ</span>
                </button>
                <button class="btn btn-purple" id="btn-settings" style="min-height: 40px; padding: 5px 10px;">
                    <span style="font-size: 16px;">âš™ï¸</span>
                    <span style="font-size: 10px;">è®¾ç½®</span>
                </button>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div id="main-content">
            <div id="map-container">
                <canvas id="base-canvas"></canvas>
            </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div id="control-panel">
            <button class="btn btn-orange" id="btn-survivors">
                <span style="font-size: 20px;">ğŸ‘¥</span>
                <span>å¹¸å­˜è€…</span>
            </button>
            <button class="btn btn-success" id="btn-resources">
                <span style="font-size: 20px;">ğŸ“¦</span>
                <span>èµ„æº</span>
            </button>
            <button class="btn btn-building" id="btn-buildings">
                <span style="font-size: 20px;">ğŸ—ï¸</span>
                <span>å»ºç­‘</span>
            </button>
            <button class="btn btn-purple" id="btn-tech">
                <span style="font-size: 20px;">ğŸ”¬</span>
                <span>ç§‘æŠ€</span>
            </button>
            <button class="btn btn-warning" id="btn-upgrade">
                <span style="font-size: 20px;">â¬†ï¸</span>
                <span>å‡çº§</span>
            </button>
            <button class="btn btn-teal" id="btn-achievements">
                <span style="font-size: 20px;">ğŸ†</span>
                <span>æˆå°±</span>
            </button>
            <button class="btn btn-success" id="btn-save">
                <span style="font-size: 20px;">ğŸ’¾</span>
                <span>ä¿å­˜</span>
            </button>
            <button class="btn btn-danger" id="btn-load">
                <span style="font-size: 20px;">ğŸ“‚</span>
                <span>åŠ è½½</span>
            </button>
            <!-- æ·»åŠ DLCç®¡ç†å™¨æŒ‰é’® -->
            <button class="btn btn-dlc" id="btn-dlc-manager">
                <span style="font-size: 20px;">ğŸ”„</span>
                <span>DLCç®¡ç†</span>
            </button>
            <button class="btn btn-dlc" id="btn-dlc">
                <span style="font-size: 20px;">ğŸ</span>
                <span>DLCå•†åº—</span>
            </button>
        </div>

        <!-- DLCä¸“ç”¨é¢æ¿ -->
        <div id="dlc-panel" style="margin-top: 10px;">
            <div style="font-size: 14px; color: #FF6B6B; text-align: center; margin-bottom: 8px; font-weight: bold;">æ‰©å±•å†…å®¹ (DLC)</div>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 8px; padding: 12px; background: rgba(35, 40, 60, 0.95); border-radius: 12px; border: 2px solid #FF6B6B;">
                <!-- å…è´¹DLCæŒ‰é’® -->
                <button class="btn btn-success" id="btn-wastelandTech" style="min-height: 80px; padding: 8px 5px;">
                    <span style="font-size: 24px;">ğŸ”¬</span>
                    <span style="font-size: 10px;">åºŸåœŸç§‘æŠ€</span>
                    <span style="font-size: 8px; color: rgba(255,255,255,0.7);">å·²è§£é”</span>
                </button>
                
                <button class="btn btn-success" id="btn-undergroundShelter" style="min-height: 80px; padding: 8px 5px;">
                    <span style="font-size: 24px;">ğŸ•³ï¸</span>
                    <span style="font-size: 10px;">åœ°ä¸‹æ©ä½“</span>
                    <span style="font-size: 8px; color: rgba(255,255,255,0.7);">å·²è§£é”</span>
                </button>
                
                <button class="btn btn-success" id="btn-mutatedCreatures" style="min-height: 80px; padding: 8px 5px;">
                    <span style="font-size: 24px;">ğŸ§Ÿ</span>
                    <span style="font-size: 10px;">å˜å¼‚ç”Ÿç‰©</span>
                    <span style="font-size: 8px; color: rgba(255,255,255,0.7);">å·²è§£é”</span>
                </button>
                
                <button class="btn btn-success" id="btn-allianceExpansion" style="min-height: 80px; padding: 8px 5px;">
                    <span style="font-size: 24px;">ğŸ¤</span>
                    <span style="font-size: 10px;">è”ç›Ÿç³»ç»Ÿ</span>
                    <span style="font-size: 8px; color: rgba(255,255,255,0.7);">å·²è§£é”</span>
                </button>
                
                <!-- ä»˜è´¹DLCæŒ‰é’® -->
                <button class="btn btn-warning" id="btn-mysteryOrigin" style="min-height: 80px; padding: 8px 5px;">
                    <span style="font-size: 24px;">ğŸ”®</span>
                    <span style="font-size: 10px;">ç¥ç§˜èµ·æº</span>
                    <span style="font-size: 8px; color: #FFD700; background: rgba(155, 89, 182, 0.3); padding: 2px 5px; border-radius: 4px; margin-top: 2px;">Â¥10</span>
                </button>
                
                <button class="btn btn-warning" id="btn-futureCity" style="min-height: 80px; padding: 8px 5px;">
                    <span style="font-size: 24px;">ğŸ™ï¸</span>
                    <span style="font-size: 10px;">æœªæ¥éƒ½å¸‚</span>
                    <span style="font-size: 8px; color: #FFD700; background: rgba(243, 156, 18, 0.3); padding: 2px 5px; border-radius: 4px; margin-top: 2px;">Â¥15</span>
                </button>
                
                <button class="btn btn-warning" id="btn-spaceColony" style="min-height: 80px; padding: 8px 5px;">
                    <span style="font-size: 24px;">ğŸš€</span>
                    <span style="font-size: 10px;">å¤ªç©ºæ®–æ°‘</span>
                    <span style="font-size: 8px; color: #FFD700; background: rgba(52, 152, 219, 0.3); padding: 2px 5px; border-radius: 4px; margin-top: 2px;">Â¥20</span>
                </button>
            </div>
        </div>
    </div>

    <!-- æ‰€æœ‰å¼¹çª— -->
    <div class="modal" id="survivors-modal">
        <div class="modal-content">
            <div class="modal-title">å¹¸å­˜è€…ç®¡ç†</div>
            <button class="close-btn" onclick="closeModal('survivors-modal')">Ã—</button>
            <div id="survivors-content">
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 14px; color: #95a5a6; margin-bottom: 10px;">å¹¸å­˜è€…åˆ—è¡¨ (å½“å‰: <span id="survivor-count">3</span>/12)</div>
                    <div id="survivors-list" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
                <button class="btn btn-success" id="recruit-btn" style="width: 100%;">æ‹›å‹Ÿæ–°å¹¸å­˜è€… (æ¶ˆè€—: 20ææ–™)</button>
            </div>
        </div>
    </div>

    <div class="modal" id="resources-modal">
        <div class="modal-content">
            <div class="modal-title">èµ„æºç®¡ç†</div>
            <button class="close-btn" onclick="closeModal('resources-modal')">Ã—</button>
            <div id="resources-content" style="margin-top: 20px;"></div>
        </div>
    </div>

    <div class="modal" id="buildings-modal">
        <div class="modal-content">
            <div class="modal-title">å»ºç­‘ç³»ç»Ÿ</div>
            <button class="close-btn" onclick="closeModal('buildings-modal')">Ã—</button>
            <div id="buildings-content" style="margin-top: 20px;">
                <div style="font-size: 14px; color: #95a5a6; margin-bottom: 15px;">å¯å»ºé€ å»ºç­‘:</div>
                <div id="buildings-list"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="tech-modal">
        <div class="modal-content">
            <div class="modal-title">ç§‘æŠ€æ ‘</div>
            <button class="close-btn" onclick="closeModal('tech-modal')">Ã—</button>
            <div id="tech-content" style="margin-top: 20px;">
                <div id="tech-tree"></div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢ï¼šå‡çº§ç³»ç»Ÿå¼¹çª— -->
    <div class="modal" id="upgrade-modal">
        <div class="modal-content">
            <div class="modal-title">å‡çº§ç³»ç»Ÿ</div>
            <button class="close-btn" onclick="closeModal('upgrade-modal')">Ã—</button>
            <div id="upgrade-content" style="margin-top: 20px;">
                <div style="font-size: 14px; color: #95a5a6; margin-bottom: 15px;">
                    å¯å‡çº§é¡¹ç›® (å·²é€‰æ‹©: <span id="selected-upgrade-type">å»ºç­‘</span>)
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="btn" id="btn-upgrade-buildings" style="flex: 1;">
                        <span style="font-size: 16px;">ğŸ—ï¸</span>
                        <span style="font-size: 10px;">å»ºç­‘å‡çº§</span>
                    </button>
                    <button class="btn" id="btn-upgrade-resources" style="flex: 1;">
                        <span style="font-size: 16px;">ğŸ“ˆ</span>
                        <span style="font-size: 10px;">èµ„æºç”Ÿäº§</span>
                    </button>
                    <button class="btn" id="btn-upgrade-survivors" style="flex: 1;">
                        <span style="font-size: 16px;">ğŸ‘¥</span>
                        <span style="font-size: 10px;">å¹¸å­˜è€…å¼ºåŒ–</span>
                    </button>
                </div>
                
                <div id="upgrade-list-container" style="max-height: 400px; overflow-y: auto;"></div>
                
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div style="font-size: 12px; color: #95a5a6; margin-bottom: 10px;">
                        å¯ç”¨å‡çº§ç‚¹æ•°: <span id="upgrade-points">0</span> ç‚¹
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" id="btn-reset-upgrades" style="flex: 1;">é‡ç½®å‡çº§</button>
                        <button class="btn btn-warning" id="btn-get-upgrade-points" style="flex: 1;">è·å–ç‚¹æ•°</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="explore-modal">
        <div class="modal-content">
            <div class="modal-title">æ¢ç´¢åºŸåœŸ</div>
            <button class="close-btn" onclick="closeModal('explore-modal')">Ã—</button>
            <div id="explore-content" style="margin-top: 20px;">
                <div style="font-size: 14px; color: #95a5a6; margin-bottom: 15px;">é€‰æ‹©æ¢ç´¢åœ°ç‚¹ (éœ€è¦ç©ºé—²å¹¸å­˜è€…):</div>
                <div id="explore-options" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="achievements-modal">
        <div class="modal-content">
            <div class="modal-title">æˆå°±ç³»ç»Ÿ</div>
            <button class="close-btn" onclick="closeModal('achievements-modal')">Ã—</button>
            <div id="achievements-content" style="margin-top: 20px;">
                <div style="font-size: 14px; color: #95a5a6; margin-bottom: 15px;">å·²è§£é”: <span id="unlocked-achievements">0</span>/12</div>
                <div id="achievements-list"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <div class="modal-title">æ¸¸æˆè®¾ç½®</div>
            <button class="close-btn" onclick="closeModal('settings-modal')">Ã—</button>
            <div id="settings-content" style="margin-top: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 14px;">æ¸¸æˆé€Ÿåº¦:</label>
                    <select id="game-speed" style="width: 100%; padding: 10px; background: #34495e; color: white; border: 1px solid #2c3e50; border-radius: 6px;">
                        <option value="0.5">ææ…¢</option>
                        <option value="1">æ…¢é€Ÿ</option>
                        <option value="2" selected>æ­£å¸¸</option>
                        <option value="3">å¿«é€Ÿ</option>
                        <option value="5">æå¿«</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 14px;">å±å¹•æ–¹å‘:</label>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="setOrientation('portrait')" style="flex: 1;">ğŸ“± ç«–å±</button>
                        <button class="btn" onclick="setOrientation('landscape')" style="flex: 1;">ğŸ”„ æ¨ªå±</button>
                    </div>
                </div>
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div style="font-size: 12px; color: #95a5a6; text-align: center; margin-bottom: 10px;">
                        ã€ŠåºŸåœŸæ–¹èˆŸã€‹v2.0<br>
                        ç”Ÿå­˜å¤©æ•°: <span id="settings-day">1</span>
                    </div>
                    <button class="btn btn-danger" onclick="resetGame()" style="width: 100%;">é‡ç½®æ¸¸æˆ</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="dlc-modal">
        <div class="modal-content">
            <div class="modal-title">DLCå•†åº—</div>
            <button class="close-btn" onclick="closeModal('dlc-modal')">Ã—</button>
            <div id="dlc-content" style="margin-top: 20px;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 48px; margin-bottom: 10px;">ğŸ®</div>
                    <div style="font-size: 18px; color: #3498db; margin-bottom: 10px;">ã€ŠåºŸåœŸæ–¹èˆŸã€‹æ‰©å±•å†…å®¹</div>
                    <div style="font-size: 12px; color: #95a5a6;">æ›´å¤šç²¾å½©å†…å®¹æ­£åœ¨å¼€å‘ä¸­</div>
                </div>
                
                <div style="background: rgba(52, 152, 219, 0.1); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                    <div style="font-size: 16px; margin-bottom: 10px; color: #3498db;">æ€»ä½“å¼€å‘è¿›åº¦</div>
                    <div style="height: 20px; background: #34495e; border-radius: 10px; overflow: hidden; margin-bottom: 8px;">
                        <div style="height: 100%; background: linear-gradient(90deg, #3498db, #9b59b6); width: 100%; border-radius: 10px;"></div>
                    </div>
                    <div style="font-size: 12px; color: #95a5a6;">å·²å®Œæˆ: 100% | ä¸Šçº¿æ—¶é—´: 2026å¹´1æœˆ16æ—¥</div>
                </div>
                
                <div style="margin-bottom: 10px;">
                    <div style="font-size: 14px; color: #2ecc71; margin-bottom: 8px;">âœ“ å…è´¹æ‰©å±•åŒ… (å·²è§£é”):</div>
                    <div id="free-dlc-list"></div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 14px; color: #f39c12; margin-bottom: 8px;">â­ ä»˜è´¹æ‰©å±•åŒ… (å¯è´­ä¹°):</div>
                    <div id="paid-dlc-list"></div>
                </div>
                
                <button class="btn btn-dlc" onclick="notifyDLC()" style="width: 100%;">ğŸ”” æœ‰æ–°å†…å®¹æ—¶é€šçŸ¥æˆ‘</button>
            </div>
        </div>
    </div>

    <!-- DLCç®¡ç†å™¨çª—å£ -->
    <div class="modal" id="dlc-manager-modal">
        <div class="modal-content">
            <div class="modal-title">DLCç®¡ç†å™¨</div>
            <button class="close-btn" onclick="closeModal('dlc-manager-modal')">Ã—</button>
            <div id="dlc-manager-content" style="margin-top: 20px;">
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button class="btn btn-success" id="btn-sync-dlc" style="flex: 1;">
                            <span style="font-size: 18px;">ğŸ”„</span>
                            <span>åŒæ­¥DLC</span>
                        </button>
                        <button class="btn btn-warning" id="btn-refresh-dlc" style="flex: 1;">
                            <span style="font-size: 18px;">ğŸ”„</span>
                            <span>åˆ·æ–°åˆ—è¡¨</span>
                        </button>
                    </div>
                    <div style="font-size: 12px; color: #95a5a6; text-align: center; margin-bottom: 10px;">
                        DLCæœåŠ¡å™¨: <span id="dlc-server-url">æœªè®¾ç½®</span>
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 14px; color: #3498db; margin-bottom: 10px;">ğŸ“¦ å·²å®‰è£…çš„DLC:</div>
                    <div id="installed-dlc-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;"></div>
                </div>
                
                <div>
                    <div style="font-size: 14px; color: #f39c12; margin-bottom: 10px;">ğŸ”„ å¯è·å–çš„DLC:</div>
                    <div id="available-dlc-list" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- DLCè´­ä¹°çª—å£ -->
    <div class="modal" id="purchase-modal">
        <div class="modal-content">
            <div class="modal-title">è´­ä¹°DLCæ‰©å±•</div>
            <button class="close-btn" onclick="closeModal('purchase-modal')">Ã—</button>
            <div id="purchase-content" style="margin-top: 20px;">
                <div id="purchase-dlc-info" style="text-align: center; margin-bottom: 25px;">
                    <div id="dlc-icon" style="font-size: 64px; margin-bottom: 15px;">ğŸ”®</div>
                    <div id="dlc-name" style="font-size: 22px; color: #3498db; margin-bottom: 8px;">ç¥ç§˜èµ·æºæ‰©å±•åŒ…</div>
                    <div id="dlc-price" style="font-size: 28px; color: #f39c12; font-weight: bold; margin-bottom: 15px;">Â¥10</div>
                    <div id="dlc-desc" style="font-size: 14px; color: #95a5a6; max-width: 400px; margin: 0 auto 20px;">
                        å…¨æ–°å‰§æƒ…ã€åŒºåŸŸå’Œå¤šé‡ç»“å±€
                    </div>
                </div>
                
                <div style="background: rgba(243, 156, 18, 0.1); border-radius: 10px; padding: 20px; margin-bottom: 25px;">
                    <div style="font-size: 16px; color: #f39c12; margin-bottom: 15px; text-align: center;">è´­ä¹°åè§£é”å†…å®¹</div>
                    <div id="dlc-features" style="display: grid; grid-template-columns: 1fr; gap: 10px;"></div>
                </div>
                
                <div style="text-align: center; margin-bottom: 25px;">
                    <div style="font-size: 12px; color: #95a5a6; margin-bottom: 10px;">é€‰æ‹©æ”¯ä»˜æ–¹å¼</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 20px;">
                        <button class="pay-method" data-method="wechat" style="background: rgba(46, 204, 113, 0.1); border: 2px solid #2ecc71; color: white; padding: 10px 15px; border-radius: 8px; font-size: 14px; cursor: pointer;">
                            <span style="font-size: 18px;">ğŸ’°</span> å¾®ä¿¡æ”¯ä»˜
                        </button>
                        <button class="pay-method" data-method="alipay" style="background: rgba(52, 152, 219, 0.1); border: 2px solid #3498db; color: white; padding: 10px 15px; border-radius: 8px; font-size: 14px; cursor: pointer;">
                            <span style="font-size: 18px;">ğŸ’³</span> æ”¯ä»˜å®
                        </button>
                        <button class="pay-method" data-method="card" style="background: rgba(155, 89, 182, 0.1); border: 2px solid #9b59b6; color: white; padding: 10px 15px; border-radius: 8px; font-size: 14px; cursor: pointer;">
                            <span style="font-size: 18px;">ğŸ’³</span> é“¶è¡Œå¡
                        </button>
                    </div>
                </div>
                
                <button class="btn btn-warning" id="confirm-purchase" style="width: 100%; padding: 15px; font-size: 16px; background: linear-gradient(135deg, #f39c12, #e67e22);">
                    <span style="font-size: 20px; margin-right: 8px;">ğŸ’°</span>
                    ç¡®è®¤è´­ä¹°
                </button>
                
                <div style="text-align: center; margin-top: 15px;">
                    <label style="font-size: 12px; color: #95a5a6;">
                        <input type="checkbox" id="terms-checkbox" style="margin-right: 5px;">
                        æˆ‘å·²é˜…è¯»å¹¶åŒæ„ã€Šç”¨æˆ·åè®®ã€‹å’Œã€Šé€€æ¬¾æ”¿ç­–ã€‹
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- DLCè¯¦æƒ…çª—å£ -->
    <div class="modal" id="dlc-detail-modal">
        <div class="modal-content">
            <div class="modal-title">DLCè¯¦æƒ…</div>
            <button class="close-btn" onclick="closeModal('dlc-detail-modal')">Ã—</button>
            <div id="dlc-detail-content" style="margin-top: 20px;"></div>
        </div>
    </div>

    <script>
        // ====== DLCæœåŠ¡å™¨é…ç½® ======
        const DLC_CONFIG = {
            // é»˜è®¤DLCæœåŠ¡å™¨åœ°å€ï¼ˆå¯ä»¥ä¿®æ”¹ï¼‰
            SERVER_URL: 'https://your-cdn.com/dlc/',
            
            // æ‰€æœ‰DLCçš„é…ç½®æ–‡ä»¶åˆ—è¡¨
            DLC_FILES: [
                'wastelandTech-dlc.json',
                'undergroundShelter-dlc.json',
                'mutatedCreatures-dlc.json', 
                'allianceExpansion-dlc.json',
                'mysteryOrigin-dlc.json',
                'futureCity-dlc.json',
                'spaceColony-dlc.json'
            ],
            
            // ç¼“å­˜æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
            CACHE_DURATION: 3600000 // 1å°æ—¶
        };

        // ====== æ¸¸æˆæ ¸å¿ƒç³»ç»Ÿ ======
        class WastelandArkGame {
            constructor() {
                console.log("æ¸¸æˆå®ä¾‹åˆ›å»º...");
                this.isInitialized = false;
                this.gameLoopId = null;
                this.isPaused = false;
                this.isExploring = false;
                this.exploreTimer = null;
                this.currentExplore = null;
                this.exploreTimeLeft = 0;
                this.canvas = null;
                this.ctx = null;
                
                // åˆå§‹åŒ–DLCç®¡ç†å™¨
                this.dlcManager = null;
                
                // åˆå§‹åŒ–æ¸¸æˆæ•°æ®
                this.initGameData();
            }
            
            // åˆå§‹åŒ–æ¸¸æˆæ•°æ®
            initGameData() {
                console.log("åˆå§‹åŒ–æ¸¸æˆæ•°æ®...");
                
                // æ¸¸æˆçŠ¶æ€
                this.gameState = {
                    day: 1,
                    hour: 7,
                    minute: 0,
                    weather: 'æ™´æœ—',
                    threatLevel: 1,
                    techPoints: 0,
                    unlockedTech: [],
                    achievements: [],
                    gameSpeed: 2,
                    orientation: 'portrait',
                    dlcUnlocked: {
                        wastelandTech: true,
                        undergroundShelter: true,
                        mutatedCreatures: true,
                        allianceExpansion: true,
                        mysteryOrigin: false,
                        futureCity: false,
                        spaceColony: false
                    }
                };
                
                // èµ„æºç³»ç»Ÿ
                this.resources = {
                    food: { name: 'é£Ÿç‰©', amount: 200, max: 1000, icon: 'ğŸ', color: '#2ecc71', prod: 5, cons: 3 },
                    water: { name: 'æ°´', amount: 180, max: 800, icon: 'ğŸ’§', color: '#3498db', prod: 4, cons: 2 },
                    materials: { name: 'ææ–™', amount: 150, max: 1500, icon: 'ğŸ”¨', color: '#7f8c8d', prod: 3, cons: 1 },
                    medicine: { name: 'è¯å“', amount: 50, max: 500, icon: 'ğŸ’Š', color: '#e74c3c', prod: 1, cons: 0.5 },
                    ammunition: { name: 'å¼¹è¯', amount: 80, max: 600, icon: 'ğŸ”«', color: '#f39c12', prod: 2, cons: 1 },
                    energy: { name: 'èƒ½æº', amount: 60, max: 800, icon: 'âš¡', color: '#f1c40f', prod: 2, cons: 1.5 }
                };
                
                // å¹¸å­˜è€…ç³»ç»Ÿ
                this.survivors = [
                    this.createSurvivor(1, 'å¼ ä¼Ÿ', 'å»ºé€ '),
                    this.createSurvivor(2, 'æå¨œ', 'åŒ»ç–—'),
                    this.createSurvivor(3, 'ç‹åˆš', 'ç ”ç©¶')
                ];
                
                // å»ºç­‘ç³»ç»Ÿ
                this.buildings = {
                    built: [
                        { id: 'command', type: 'æŒ‡æŒ¥ä¸­å¿ƒ', level: 1, x: 0.5, y: 0.3, icon: 'CC', color: '#3498db', effect: 'å…¨å±€æ•ˆç‡+10%' },
                        { id: 'dormitory', type: 'å®¿èˆ', level: 1, x: 0.3, y: 0.5, icon: 'DS', color: '#2ecc71', effect: 'å¹¸å­˜è€…æ¢å¤+20%' },
                        { id: 'kitchen', type: 'å¨æˆ¿', level: 1, x: 0.7, y: 0.5, icon: 'CF', color: '#e67e22', effect: 'é£Ÿç‰©æ¶ˆè€—-15%' }
                    ],
                    available: [
                        { id: 'farm', type: 'å†œç”°', cost: { materials: 100, energy: 30 }, effect: 'é£Ÿç‰©+15/å°æ—¶', icon: 'NT', color: '#27ae60', position: { x: 0.2, y: 0.7 } },
                        { id: 'water_plant', type: 'å‡€æ°´å‚', cost: { materials: 120, energy: 40 }, effect: 'æ°´+12/å°æ—¶', icon: 'WS', color: '#2980b9', position: { x: 0.8, y: 0.7 } },
                        { id: 'workshop', type: 'å·¥åŠ', cost: { materials: 150, energy: 50 }, effect: 'ææ–™+20/å°æ—¶', icon: 'GF', color: '#7f8c8d', position: { x: 0.15, y: 0.3 } },
                        { id: 'hospital', type: 'åŒ»ç–—ç«™', cost: { materials: 180, medicine: 50 }, effect: 'è¯å“+8/å°æ—¶', icon: 'YL', color: '#e74c3c', position: { x: 0.85, y: 0.3 } },
                        { id: 'armory', type: 'å†›æ¢°åº“', cost: { materials: 200, ammunition: 80 }, effect: 'å¼¹è¯+15/å°æ—¶', icon: 'JX', color: '#d35400', position: { x: 0.2, y: 0.2 } },
                        { id: 'power_plant', type: 'å‘ç”µå‚', cost: { materials: 250, energy: 100 }, effect: 'èƒ½æº+25/å°æ—¶', icon: 'FD', color: '#f1c40f', position: { x: 0.8, y: 0.2 } },
                        { id: 'library', type: 'å›¾ä¹¦é¦†', cost: { materials: 120, energy: 60 }, effect: 'ç§‘æŠ€ç‚¹+5/å°æ—¶', icon: 'TS', color: '#9b59b6', position: { x: 0.4, y: 0.8 } },
                        { id: 'watchtower', type: 'ç­æœ›å¡”', cost: { materials: 160, ammunition: 60 }, effect: 'å¨èƒ-3ï¼Œé¢„è­¦è¢­å‡»', icon: 'LT', color: '#34495e', position: { x: 0.6, y: 0.8 } },
                        { id: 'training', type: 'è®­ç»ƒåœº', cost: { materials: 140, food: 80 }, effect: 'å¹¸å­˜è€…ç»éªŒ+10/å°æ—¶', icon: 'XL', color: '#1abc9c', position: { x: 0.35, y: 0.65 } },
                        { id: 'storage', type: 'ä»“åº“', cost: { materials: 180, energy: 70 }, effect: 'èµ„æºä¸Šé™+30%', icon: 'CK', color: '#95a5a6', position: { x: 0.65, y: 0.65 } },
                        { id: 'greenhouse', type: 'æ¸©å®¤', cost: { materials: 220, energy: 90 }, effect: 'é£Ÿç‰©+25/å°æ—¶', icon: 'WS', color: '#16a085', position: { x: 0.25, y: 0.45 } },
                        { id: 'laboratory', type: 'å®éªŒå®¤', cost: { materials: 300, energy: 120 }, effect: 'ç§‘æŠ€ç ”å‘é€Ÿåº¦+40%', icon: 'SY', color: '#8e44ad', position: { x: 0.75, y: 0.45 } },
                        { id: 'factory', type: 'å·¥å‚', cost: { materials: 400, energy: 150 }, effect: 'ææ–™+35/å°æ—¶', icon: 'GC', color: '#c0392b', position: { x: 0.5, y: 0.15 } },
                        { id: 'radar', type: 'é›·è¾¾ç«™', cost: { materials: 350, energy: 180 }, effect: 'æ¢ç´¢æˆåŠŸç‡+25%', icon: 'LD', color: '#2c3e50', position: { x: 0.5, y: 0.9 } }
                    ]
                };
                
                // ç§‘æŠ€æ ‘
                this.techTree = [
                    { id: 'basic_farming', name: 'åŸºç¡€å†œä¸š', cost: 50, effect: 'é£Ÿç‰©äº§é‡+25%', icon: 'ğŸŒ¾', requires: [], researchTime: 2 },
                    { id: 'water_purification', name: 'å‡€æ°´æŠ€æœ¯', cost: 45, effect: 'æ°´æ¶ˆè€—-20%', icon: 'ğŸ’§', requires: [], researchTime: 2 },
                    { id: 'advanced_construction', name: 'é«˜çº§å»ºé€ ', cost: 60, effect: 'å»ºç­‘é€Ÿåº¦+30%', icon: 'ğŸ—ï¸', requires: [], researchTime: 3 },
                    { id: 'solar_power', name: 'å¤ªé˜³èƒ½', cost: 80, effect: 'èƒ½æºäº§é‡+20/å°æ—¶', icon: 'â˜€ï¸', requires: ['basic_farming', 'water_purification'], researchTime: 4 },
                    { id: 'medical_research', name: 'åŒ»å­¦ç ”ç©¶', cost: 70, effect: 'è¯å“äº§é‡+15/å°æ—¶', icon: 'ğŸ’Š', requires: [], researchTime: 3 },
                    { id: 'weapon_tech', name: 'æ­¦å™¨æŠ€æœ¯', cost: 90, effect: 'å¼¹è¯äº§é‡+20/å°æ—¶', icon: 'ğŸ”«', requires: ['advanced_construction'], researchTime: 4 },
                    { id: 'automation', name: 'è‡ªåŠ¨åŒ–', cost: 120, effect: 'æ‰€æœ‰èµ„æºç”Ÿäº§+15%', icon: 'âš™ï¸', requires: ['solar_power'], researchTime: 5 },
                    { id: 'genetics', name: 'åŸºå› å­¦', cost: 150, effect: 'å¹¸å­˜è€…å¥åº·ä¸Šé™+20%', icon: 'ğŸ§¬', requires: ['medical_research'], researchTime: 6 },
                    { id: 'nuclear_power', name: 'æ ¸èƒ½', cost: 200, effect: 'èƒ½æºäº§é‡+50/å°æ—¶', icon: 'â˜¢ï¸', requires: ['automation'], researchTime: 8 },
                    { id: 'ai_system', name: 'äººå·¥æ™ºèƒ½', cost: 250, effect: 'ç§‘æŠ€ç ”å‘é€Ÿåº¦+50%', icon: 'ğŸ¤–', requires: ['automation', 'genetics'], researchTime: 10 },
                    { id: 'quantum_tech', name: 'é‡å­æŠ€æœ¯', cost: 300, effect: 'æ‰€æœ‰æ•ˆç‡+25%', icon: 'âš›ï¸', requires: ['ai_system', 'nuclear_power'], researchTime: 12 },
                    { id: 'terraforming', name: 'åœ°å½¢æ”¹é€ ', cost: 400, effect: 'è§£é”é«˜çº§å»ºç­‘', icon: 'ğŸŒ', requires: ['quantum_tech'], researchTime: 15 }
                ];
                
                // æ¢ç´¢åœ°ç‚¹
                this.exploreLocations = [
                    { name: 'åºŸå¼ƒè¶…å¸‚', risk: 'ä½', time: 10, rewards: { food: 50, materials: 30 }, icon: 'ğŸ›’', desc: 'å¯»æ‰¾é£Ÿç‰©å’Œæ—¥ç”¨å“' },
                    { name: 'æ—§åŒ»é™¢', risk: 'ä¸­', time: 15, rewards: { medicine: 60, materials: 20 }, icon: 'ğŸ¥', desc: 'æœå¯»åŒ»ç–—ç‰©èµ„' },
                    { name: 'å†›äº‹åŸºåœ°', risk: 'é«˜', time: 20, rewards: { ammunition: 100, materials: 50 }, icon: 'ğŸ–ï¸', desc: 'å¯»æ‰¾æ­¦å™¨å’Œå¼¹è¯' },
                    { name: 'ç§‘æŠ€ç ”ç©¶æ‰€', risk: 'ä¸­', time: 18, rewards: { energy: 80, techPoints: 15 }, icon: 'ğŸ”¬', desc: 'è·å–ç§‘æŠ€èµ„æ–™' },
                    { name: 'å†œåœºåºŸå¢Ÿ', risk: 'ä½', time: 12, rewards: { food: 80, water: 40 }, icon: 'ğŸšœ', desc: 'æœå¯»å†œä½œç‰©' },
                    { name: 'æ°´å¤„ç†å‚', risk: 'ä¸­', time: 16, rewards: { water: 120, materials: 40 }, icon: 'ğŸ’§', desc: 'è·å–å‡€æ°´è®¾å¤‡' },
                    { name: 'å·¥å‚é—å€', risk: 'é«˜', time: 22, rewards: { materials: 150, energy: 60 }, icon: 'ğŸ­', desc: 'å¯»æ‰¾å·¥ä¸šææ–™' },
                    { name: 'åŠ æ²¹ç«™', risk: 'ä¸­', time: 14, rewards: { energy: 100, materials: 35 }, icon: 'â›½', desc: 'è·å–ç‡ƒæ–™' },
                    { name: 'å›¾ä¹¦é¦†', risk: 'ä½', time: 13, rewards: { techPoints: 20 }, icon: 'ğŸ“š', desc: 'è·å–çŸ¥è¯†å’Œç§‘æŠ€' },
                    { name: 'è­¦å¯Ÿå±€', risk: 'ä¸­', time: 17, rewards: { ammunition: 80, medicine: 40 }, icon: 'ğŸ‘®', desc: 'å¯»æ‰¾æ­¦å™¨å’Œæ€¥æ•‘ç‰©èµ„' },
                    { name: 'å‘ç”µç«™', risk: 'é«˜', time: 25, rewards: { energy: 150, techPoints: 25 }, icon: 'âš¡', desc: 'è·å–èƒ½æºè®¾å¤‡' },
                    { name: 'åœ°ä¸‹æ©ä½“', risk: 'æé«˜', time: 30, rewards: { food: 100, water: 80, medicine: 60, ammunition: 120, materials: 100, energy: 120, techPoints: 50 }, icon: 'ğŸ•³ï¸', desc: 'é«˜é£é™©é«˜å›æŠ¥' }
                ];
                
                // æˆå°±ç³»ç»Ÿ
                this.achievementsList = [
                    { id: 'first_day', name: 'ç¬¬ä¸€é“å…‰', description: 'ç”Ÿå­˜ç¬¬1å¤©', icon: 'ğŸŒ…', unlocked: true, type: 'bronze' },
                    { id: 'builder', name: 'å»ºç­‘å¤§å¸ˆ', description: 'å»ºé€ 5ä¸ªå»ºç­‘', icon: 'ğŸ—ï¸', unlocked: false, type: 'silver' },
                    { id: 'explorer', name: 'æ¢ç´¢è€…', description: 'æ¢ç´¢3ä¸ªä¸åŒåœ°ç‚¹', icon: 'ğŸ§­', unlocked: false, type: 'bronze' },
                    { id: 'survivor', name: 'ç”Ÿå­˜ä¸“å®¶', description: 'æ‹¥æœ‰8åå¹¸å­˜è€…', icon: 'ğŸ‘¥', unlocked: false, type: 'silver' },
                    { id: 'scientist', name: 'ç§‘å­¦å®¶', description: 'ç ”å‘5é¡¹ç§‘æŠ€', icon: 'ğŸ”¬', unlocked: false, type: 'silver' },
                    { id: 'architect', name: 'å»ºç­‘å¸ˆ', description: 'å»ºé€ æ‰€æœ‰ç±»å‹å»ºç­‘', icon: 'ğŸ›ï¸', unlocked: false, type: 'gold' },
                    { id: 'technocrat', name: 'æŠ€æœ¯ä¸“å®¶', description: 'ç ”å‘æ‰€æœ‰ç§‘æŠ€', icon: 'âš›ï¸', unlocked: false, type: 'gold' },
                    { id: 'collector', name: 'æ”¶è—å®¶', description: 'æ”¶é›†1000ä¸ªæ‰€æœ‰èµ„æº', icon: 'ğŸ“¦', unlocked: false, type: 'silver' },
                    { id: 'veteran', name: 'è€å…µ', description: 'ç”Ÿå­˜30å¤©', icon: 'ğŸ–ï¸', unlocked: false, type: 'gold' },
                    { id: 'pioneer', name: 'å¼€æ‹“è€…', description: 'æ¢ç´¢æ‰€æœ‰åœ°ç‚¹', icon: 'ğŸ—ºï¸', unlocked: false, type: 'gold' },
                    { id: 'leader', name: 'é¢†å¯¼è€…', description: 'æ‹¥æœ‰12åå¹¸å­˜è€…', icon: 'ğŸ‘‘', unlocked: false, type: 'platinum' },
                    { id: 'master', name: 'åºŸåœŸå¤§å¸ˆ', description: 'è§£é”æ‰€æœ‰æˆå°±', icon: 'ğŸ†', unlocked: false, type: 'platinum' }
                ];
                
                // DLCå†…å®¹ï¼ˆåŠ¨æ€åŠ è½½ï¼‰
                this.dlcContent = {
                    free: [],
                    paid: []
                };
                
                // ====== æ–°å¢ï¼šå‡çº§ç³»ç»Ÿæ•°æ® ======
                this.upgradeSystem = {
                    // å‡çº§ç‚¹æ•°
                    points: 0,
                    
                    // å»ºç­‘å‡çº§
                    buildingUpgrades: {
                        // å·²å‡çº§çš„å»ºç­‘
                        upgradedBuildings: {},
                        
                        // å¯ç”¨çš„å»ºç­‘å‡çº§
                        available: [
                            {
                                id: 'farm_upgrade_1',
                                buildingId: 'farm',
                                name: 'å†œç”°æ•ˆç‡æå‡',
                                description: 'å†œç”°é£Ÿç‰©äº§é‡+10/å°æ—¶',
                                cost: { points: 1, materials: 50 },
                                effect: { foodProd: 10 },
                                maxLevel: 5,
                                icon: 'ğŸŒ¾',
                                color: '#27ae60'
                            },
                            {
                                id: 'water_upgrade_1',
                                buildingId: 'water_plant',
                                name: 'å‡€æ°´ç³»ç»Ÿä¼˜åŒ–',
                                description: 'å‡€æ°´å‚äº§æ°´é‡+8/å°æ—¶',
                                cost: { points: 1, materials: 60 },
                                effect: { waterProd: 8 },
                                maxLevel: 5,
                                icon: 'ğŸ’§',
                                color: '#2980b9'
                            },
                            {
                                id: 'workshop_upgrade_1',
                                buildingId: 'workshop',
                                name: 'å·¥åŠå·¥å…·å‡çº§',
                                description: 'å·¥åŠææ–™äº§é‡+15/å°æ—¶',
                                cost: { points: 1, materials: 80 },
                                effect: { materialsProd: 15 },
                                maxLevel: 5,
                                icon: 'ğŸ”¨',
                                color: '#7f8c8d'
                            },
                            {
                                id: 'library_upgrade_1',
                                buildingId: 'library',
                                name: 'å›¾ä¹¦é¦†èµ„æ–™æ‰©å……',
                                description: 'å›¾ä¹¦é¦†ç§‘æŠ€ç‚¹äº§é‡+5/å°æ—¶',
                                cost: { points: 2, techPoints: 20 },
                                effect: { techPointsProd: 5 },
                                maxLevel: 3,
                                icon: 'ğŸ“š',
                                color: '#9b59b6'
                            }
                        ]
                    },
                    
                    // èµ„æºç”Ÿäº§å‡çº§
                    resourceUpgrades: {
                        upgradedResources: {},
                        available: [
                            {
                                id: 'food_production_boost',
                                name: 'é£Ÿç‰©ç”Ÿäº§å¼ºåŒ–',
                                description: 'æ‰€æœ‰é£Ÿç‰©ç”Ÿäº§å»ºç­‘æ•ˆç‡+15%',
                                cost: { points: 2, food: 100 },
                                effect: { foodProductionBonus: 0.15 },
                                maxLevel: 3,
                                icon: 'ğŸ',
                                color: '#2ecc71'
                            },
                            {
                                id: 'water_production_boost',
                                name: 'æ°´æºä¼˜åŒ–æŠ€æœ¯',
                                description: 'æ‰€æœ‰æ°´ç”Ÿäº§å»ºç­‘æ•ˆç‡+15%',
                                cost: { points: 2, water: 100 },
                                effect: { waterProductionBonus: 0.15 },
                                maxLevel: 3,
                                icon: 'ğŸ’§',
                                color: '#3498db'
                            },
                            {
                                id: 'energy_efficiency',
                                name: 'èƒ½æºæ•ˆç‡ä¼˜åŒ–',
                                description: 'èƒ½æºæ¶ˆè€—é™ä½10%',
                                cost: { points: 3, energy: 150 },
                                effect: { energyConsumptionReduction: 0.1 },
                                maxLevel: 2,
                                icon: 'âš¡',
                                color: '#f1c40f'
                            },
                            {
                                id: 'storage_expansion',
                                name: 'å­˜å‚¨ç©ºé—´æ‰©å±•',
                                description: 'æ‰€æœ‰èµ„æºå­˜å‚¨ä¸Šé™+20%',
                                cost: { points: 2, materials: 200 },
                                effect: { storageBonus: 0.2 },
                                maxLevel: 5,
                                icon: 'ğŸ“¦',
                                color: '#95a5a6'
                            }
                        ]
                    },
                    
                    // å¹¸å­˜è€…å¼ºåŒ–å‡çº§
                    survivorUpgrades: {
                        upgradedSurvivors: {},
                        available: [
                            {
                                id: 'health_boost',
                                name: 'å¥åº·å¼ºåŒ–',
                                description: 'æ‰€æœ‰å¹¸å­˜è€…å¥åº·ä¸Šé™+20%',
                                cost: { points: 2, medicine: 50 },
                                effect: { healthBonus: 0.2 },
                                maxLevel: 3,
                                icon: 'â¤ï¸',
                                color: '#e74c3c'
                            },
                            {
                                id: 'energy_boost',
                                name: 'èƒ½é‡æ¢å¤',
                                description: 'æ‰€æœ‰å¹¸å­˜è€…èƒ½é‡æ¢å¤é€Ÿåº¦+25%',
                                cost: { points: 2, food: 100 },
                                effect: { energyRecoveryBonus: 0.25 },
                                maxLevel: 3,
                                icon: 'âš¡',
                                color: '#3498db'
                            },
                            {
                                id: 'morale_boost',
                                name: 'å£«æ°”é¼“èˆ',
                                description: 'æ‰€æœ‰å¹¸å­˜è€…å£«æ°”æ¢å¤é€Ÿåº¦+30%',
                                cost: { points: 3, medicine: 30 },
                                effect: { moraleRecoveryBonus: 0.3 },
                                maxLevel: 2,
                                icon: 'ğŸ˜Š',
                                color: '#f39c12'
                            },
                            {
                                id: 'skill_training',
                                name: 'æŠ€èƒ½è®­ç»ƒ',
                                description: 'æ‰€æœ‰å¹¸å­˜è€…å·¥ä½œæ•ˆç‡+15%',
                                cost: { points: 3, materials: 150 },
                                effect: { workEfficiencyBonus: 0.15 },
                                maxLevel: 4,
                                icon: 'ğŸ“ˆ',
                                color: '#1abc9c'
                            }
                        ]
                    },
                    
                    // å…¨å±€å‡çº§
                    globalUpgrades: {
                        available: [
                            {
                                id: 'exploration_speed',
                                name: 'æ¢ç´¢åŠ é€Ÿ',
                                description: 'æ¢ç´¢æ—¶é—´å‡å°‘20%',
                                cost: { points: 3, materials: 100 },
                                effect: { explorationTimeReduction: 0.2 },
                                maxLevel: 2,
                                icon: 'â±ï¸',
                                color: '#3498db'
                            },
                            {
                                id: 'research_speed',
                                name: 'ç ”ç©¶åŠ é€Ÿ',
                                description: 'ç§‘æŠ€ç ”ç©¶æ—¶é—´å‡å°‘25%',
                                cost: { points: 4, techPoints: 50 },
                                effect: { researchTimeReduction: 0.25 },
                                maxLevel: 2,
                                icon: 'ğŸ”¬',
                                color: '#9b59b6'
                            },
                            {
                                id: 'building_speed',
                                name: 'å»ºé€ åŠ é€Ÿ',
                                description: 'å»ºç­‘å»ºé€ æ—¶é—´å‡å°‘30%',
                                cost: { points: 3, materials: 200 },
                                effect: { buildingTimeReduction: 0.3 },
                                maxLevel: 2,
                                icon: 'ğŸ—ï¸',
                                color: '#e67e22'
                            }
                        ]
                    }
                };
                
                // äº‹ä»¶æ—¥å¿—
                this.eventLog = [
                    { time: '07:00', message: 'æ–°çš„ä¸€å¤©å¼€å§‹äº†ï¼Œå¹¸å­˜è€…ä»¬å¼€å§‹å·¥ä½œ', type: 'info' },
                    { time: '07:00', message: 'åŸºåœ°åˆå§‹èµ„æºå·²åˆ†é…', type: 'info' }
                ];
                
                console.log("æ¸¸æˆæ•°æ®åˆå§‹åŒ–å®Œæˆ");
            }
            
            // åˆ›å»ºå¹¸å­˜è€…
            createSurvivor(id, name, skill) {
                const skills = {
                    'å»ºé€ ': { icon: 'ğŸ”¨', color: '#e67e22', desc: 'å»ºç­‘é€Ÿåº¦+20%' },
                    'åŒ»ç–—': { icon: 'ğŸ’Š', color: '#e74c3c', desc: 'æ²»ç–—æ•ˆç‡+30%' },
                    'ç ”ç©¶': { icon: 'ğŸ”¬', color: '#9b59b6', desc: 'ç§‘ç ”é€Ÿåº¦+25%' },
                    'æ¢ç´¢': { icon: 'ğŸ§­', color: '#3498db', desc: 'æ¢ç´¢æˆåŠŸç‡+15%' },
                    'æˆ˜æ–—': { icon: 'âš”ï¸', color: '#c0392b', desc: 'æˆ˜æ–—åŠ›+20%' },
                    'å†œä¸š': { icon: 'ğŸŒ¾', color: '#27ae60', desc: 'é£Ÿç‰©äº§é‡+25%' }
                };
                
                const skillData = skills[skill] || skills['å»ºé€ '];
                
                return {
                    id: id,
                    name: name,
                    skill: skill,
                    skillIcon: skillData.icon,
                    skillColor: skillData.color,
                    skillDesc: skillData.desc,
                    health: 85 + Math.floor(Math.random() * 15),
                    hunger: 40 + Math.floor(Math.random() * 30),
                    energy: 90 + Math.floor(Math.random() * 10),
                    morale: 70 + Math.floor(Math.random() * 30),
                    assigned: false,
                    level: 1,
                    experience: 0,
                    kills: 0,
                    status: 'ç©ºé—²',
                    exploring: false
                };
            }
            
            // åˆå§‹åŒ–æ¸¸æˆ
            initialize() {
                console.log("å¼€å§‹åˆå§‹åŒ–æ¸¸æˆ...");
                try {
                    this.showLoadingMessage('åˆå§‹åŒ–æ¸¸æˆç•Œé¢...');
                    
                    // è®¾ç½®UIäº‹ä»¶
                    this.setupUI();
                    
                    // åˆå§‹åŒ–Canvas
                    this.initCanvas();
                    
                    // åˆå§‹åŒ–DLCç®¡ç†å™¨
                    this.initDLCManager();
                    
                    // æ£€æŸ¥ä¿å­˜æ•°æ®
                    this.loadGame();
                    
                    this.showLoadingMessage('åŠ è½½æ¸¸æˆèµ„æº...');
                    
                    // å¯åŠ¨æ¸¸æˆ
                    this.startGameLoop();
                    this.updateUI();
                    
                    this.showLoadingMessage('æ¸¸æˆå‡†å¤‡å°±ç»ª...');
                    
                    // æ˜¾ç¤ºæ¸¸æˆç•Œé¢
                    setTimeout(() => {
                        document.getElementById('loading-screen').style.opacity = '0';
                        setTimeout(() => {
                            document.getElementById('loading-screen').style.display = 'none';
                            document.getElementById('game-container').style.display = 'flex';
                            this.showNotification('ã€ŠåºŸåœŸæ–¹èˆŸã€‹å·²å¯åŠ¨ï¼', 'success');
                            
                            // è‡ªåŠ¨åŒæ­¥DLCåˆ—è¡¨
                            setTimeout(() => {
                                if (this.dlcManager) {
                                    this.dlcManager.syncDLCList();
                                }
                            }, 2000);
                        }, 300);
                    }, 1000);
                    
                    this.isInitialized = true;
                    console.log('âœ… æ¸¸æˆåˆå§‹åŒ–å®Œæˆï¼');
                    
                } catch (error) {
                    console.error('âŒ æ¸¸æˆåˆå§‹åŒ–å¤±è´¥:', error);
                    this.showLoadingMessage('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                    
                    setTimeout(() => {
                        document.getElementById('loading-screen').innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #e74c3c;">
                                <div style="font-size: 24px; margin-bottom: 20px;">âš ï¸ å¯åŠ¨å¤±è´¥</div>
                                <div style="margin-bottom: 20px; font-size: 14px;">${error.message}</div>
                                <button onclick="location.reload()" style="
                                    background: #3498db;
                                    color: white;
                                    border: none;
                                    padding: 12px 24px;
                                    border-radius: 8px;
                                    font-size: 16px;
                                    cursor: pointer;
                                ">é‡æ–°åŠ è½½</button>
                            </div>
                        `;
                    }, 500);
                }
            }
            
            // åˆå§‹åŒ–DLCç®¡ç†å™¨
            initDLCManager() {
                this.dlcManager = new DLCManager(this);
                window.dlcManager = this.dlcManager;
                
                // åº”ç”¨å·²å®‰è£…çš„DLCæ•ˆæœ
                Object.keys(this.dlcManager.installedDLC).forEach(dlcId => {
                    const dlc = this.dlcManager.installedDLC[dlcId];
                    if (dlc.isActive) {
                        this.dlcManager.applyDLCEffects(dlcId);
                    }
                });
            }
            
            // æ˜¾ç¤ºåŠ è½½æ¶ˆæ¯
            showLoadingMessage(message) {
                const loadingText = document.getElementById('loading-text');
                if (loadingText) {
                    loadingText.textContent = message;
                }
            }
            
            // åˆå§‹åŒ–Canvas
            initCanvas() {
                console.log("åˆå§‹åŒ–Canvas...");
                this.canvas = document.getElementById('base-canvas');
                if (!this.canvas) throw new Error('Canvaså…ƒç´ æœªæ‰¾åˆ°');
                
                this.ctx = this.canvas.getContext('2d');
                if (!this.ctx) throw new Error('æ— æ³•è·å–Canvasä¸Šä¸‹æ–‡');
                
                this.resizeCanvas();
                
                window.addEventListener('resize', () => {
                    this.resizeCanvas();
                    this.drawMap();
                });
            }
            
            // è°ƒæ•´Canvaså¤§å°
            resizeCanvas() {
                const container = document.getElementById('map-container');
                if (!container) return;
                
                this.canvas.width = container.clientWidth;
                this.canvas.height = container.clientHeight;
            }
            
            // ç»˜åˆ¶åœ°å›¾
            drawMap() {
                if (!this.canvas || !this.ctx) return;
                
                const ctx = this.ctx;
                const width = this.canvas.width;
                const height = this.canvas.height;
                
                // æ¸…ç©ºç”»å¸ƒ
                ctx.fillStyle = '#0a0a12';
                ctx.fillRect(0, 0, width, height);
                
                // ç»˜åˆ¶èƒŒæ™¯ç½‘æ ¼
                ctx.strokeStyle = 'rgba(52, 152, 219, 0.1)';
                ctx.lineWidth = 1;
                const gridSize = Math.min(width, height) / 20;
                
                for (let x = 0; x < width; x += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, height);
                    ctx.stroke();
                }
                
                for (let y = 0; y < height; y += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(width, y);
                    ctx.stroke();
                }
                
                // ç»˜åˆ¶åŸºåœ°è¾¹ç•Œ
                ctx.strokeStyle = 'rgba(52, 152, 219, 0.3)';
                ctx.lineWidth = 3;
                ctx.setLineDash([10, 5]);
                ctx.beginPath();
                ctx.arc(width * 0.5, height * 0.5, Math.min(width, height) * 0.35, 0, Math.PI * 2);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // ç»˜åˆ¶å»ºç­‘
                this.drawBuildings(ctx, width, height);
                
                // ç»˜åˆ¶å¹¸å­˜è€…
                this.drawSurvivors(ctx, width, height);
            }
            
            // ç»˜åˆ¶å»ºç­‘
            drawBuildings(ctx, width, height) {
                const minDim = Math.min(width, height);
                const fontSize = Math.max(12, minDim * 0.03);
                
                // ç»˜åˆ¶å·²å»ºå»ºç­‘
                this.buildings.built.forEach(building => {
                    const x = building.x * width;
                    const y = building.y * height;
                    const size = minDim * 0.09;
                    
                    // å»ºç­‘èƒŒæ™¯
                    ctx.fillStyle = building.color + '80';
                    ctx.fillRect(x - size/2, y - size/2, size, size);
                    
                    // å»ºç­‘è¾¹æ¡†
                    ctx.strokeStyle = building.color;
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x - size/2, y - size/2, size, size);
                    
                    // å»ºç­‘å›¾æ ‡ï¼ˆæ–‡å­—ï¼‰
                    ctx.fillStyle = '#FFFFFF';
                    ctx.font = `bold ${fontSize}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(building.icon, x, y);
                    
                    // å»ºç­‘åç§°ï¼ˆå°å­—ï¼‰
                    ctx.font = `bold ${fontSize * 0.7}px Arial`;
                    ctx.fillText(`Lv${building.level}`, x, y + size/3);
                });
            }
            
            // ç»˜åˆ¶å¹¸å­˜è€…
            drawSurvivors(ctx, width, height) {
                const minDim = Math.min(width, height);
                
                this.survivors.forEach((survivor, index) => {
                    if (!survivor.assigned) return;
                    
                    const size = minDim * 0.05;
                    const x = width * 0.2 + (index % 4) * (width * 0.15);
                    const y = height * 0.85;
                    
                    // å¹¸å­˜è€…å›¾æ ‡
                    ctx.fillStyle = survivor.health < 50 ? '#e74c3c' : 
                                  survivor.energy < 30 ? '#f39c12' : 
                                  survivor.exploring ? '#3498db' : '#2ecc71';
                    ctx.beginPath();
                    ctx.arc(x, y, size/2, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // å¹¸å­˜è€…çŠ¶æ€
                    ctx.fillStyle = '#FFFFFF';
                    ctx.font = `bold ${Math.max(10, minDim * 0.025)}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(survivor.exploring ? 'ğŸš¶' : 'ğŸ‘¤', x, y);
                });
            }
            
            // è®¾ç½®UIäº‹ä»¶
            setupUI() {
                console.log("è®¾ç½®UIäº‹ä»¶...");
                
                // æŒ‰é’®äº‹ä»¶
                const buttons = [
                    { id: 'btn-explore', action: () => this.showExploreModal() },
                    { id: 'btn-pause', action: () => this.togglePause() },
                    { id: 'btn-settings', action: () => this.showModal('settings-modal') },
                    { id: 'btn-survivors', action: () => this.showSurvivorsModal() },
                    { id: 'btn-resources', action: () => this.showResourcesModal() },
                    { id: 'btn-buildings', action: () => this.showBuildingsModal() },
                    { id: 'btn-tech', action: () => this.showTechModal() },
                    { id: 'btn-upgrade', action: () => this.showUpgradeModal() },
                    { id: 'btn-achievements', action: () => this.showAchievementsModal() },
                    { id: 'btn-save', action: () => this.saveGame() },
                    { id: 'btn-load', action: () => this.loadGame() },
                    { id: 'btn-dlc', action: () => this.showDlcModal() },
                    { id: 'btn-dlc-manager', action: () => this.showDLCManagerModal() },
                    { id: 'recruit-btn', action: () => this.recruitSurvivor() },
                    
                    // DLCæŒ‰é’®äº‹ä»¶
                    { id: 'btn-sync-dlc', action: () => this.syncDLCList() },
                    { id: 'btn-refresh-dlc', action: () => this.refreshDLCList() },
                    { id: 'btn-wastelandTech', action: () => this.handleDLCButton('wastelandTech') },
                    { id: 'btn-undergroundShelter', action: () => this.handleDLCButton('undergroundShelter') },
                    { id: 'btn-mutatedCreatures', action: () => this.handleDLCButton('mutatedCreatures') },
                    { id: 'btn-allianceExpansion', action: () => this.handleDLCButton('allianceExpansion') },
                    { id: 'btn-mysteryOrigin', action: () => this.handleDLCButton('mysteryOrigin') },
                    { id: 'btn-futureCity', action: () => this.handleDLCButton('futureCity') },
                    { id: 'btn-spaceColony', action: () => this.handleDLCButton('spaceColony') },
                    { id: 'confirm-purchase', action: () => this.purchaseDLC() },
                    
                    // æ–°å¢ï¼šå‡çº§ç³»ç»ŸæŒ‰é’®
                    { id: 'btn-upgrade-buildings', action: () => this.showBuildingUpgrades() },
                    { id: 'btn-upgrade-resources', action: () => this.showResourceUpgrades() },
                    { id: 'btn-upgrade-survivors', action: () => this.showSurvivorUpgrades() },
                    { id: 'btn-reset-upgrades', action: () => this.resetUpgrades() },
                    { id: 'btn-get-upgrade-points', action: () => this.getUpgradePoints() }
                ];
                
                buttons.forEach(button => {
                    const element = document.getElementById(button.id);
                    if (element) {
                        element.addEventListener('click', button.action);
                    }
                });
                
                // æ¸¸æˆé€Ÿåº¦è®¾ç½®
                const gameSpeedSelect = document.getElementById('game-speed');
                if (gameSpeedSelect) {
                    gameSpeedSelect.addEventListener('change', (e) => {
                        this.gameState.gameSpeed = parseFloat(e.target.value);
                    });
                }
                
                // æ¢ç´¢è®¡æ—¶å™¨æ›´æ–°
                setInterval(() => {
                    this.updateExploreTimer();
                }, 1000);
                
                // æ”¯ä»˜æ–¹å¼é€‰æ‹©
                this.setupPaymentMethods();
            }
            
            // è®¾ç½®æ”¯ä»˜æ–¹å¼é€‰æ‹©
            setupPaymentMethods() {
                const payButtons = document.querySelectorAll('.pay-method');
                if (payButtons.length > 0) {
                    payButtons.forEach(button => {
                        button.addEventListener('click', function() {
                            // ç§»é™¤å…¶ä»–æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
                            document.querySelectorAll('.pay-method').forEach(btn => {
                                btn.style.background = btn.dataset.method === 'wechat' ? 'rgba(46, 204, 113, 0.1)' : 
                                                      btn.dataset.method === 'alipay' ? 'rgba(52, 152, 219, 0.1)' : 
                                                      'rgba(155, 89, 182, 0.1)';
                                btn.style.borderWidth = '2px';
                            });
                            
                            // è®¾ç½®å½“å‰æŒ‰é’®ä¸ºé€‰ä¸­çŠ¶æ€
                            this.style.background = this.dataset.method === 'wechat' ? 'rgba(46, 204, 113, 0.3)' : 
                                                   this.dataset.method === 'alipay' ? 'rgba(52, 152, 219, 0.3)' : 
                                                   'rgba(155, 89, 182, 0.3)';
                            this.style.borderWidth = '3px';
                        });
                    });
                }
            }
            
            // å¤„ç†DLCæŒ‰é’®ç‚¹å‡»
            handleDLCButton(dlcId) {
                if (!this.dlcManager) return;
                
                const dlc = this.dlcManager.installedDLC[dlcId];
                if (dlc) {
                    // DLCå·²å®‰è£…ï¼Œåˆ‡æ¢æ¿€æ´»çŠ¶æ€
                    if (dlc.isActive) {
                        this.dlcManager.deactivateDLC(dlcId);
                    } else {
                        this.dlcManager.activateDLC(dlcId);
                    }
                    this.dlcManager.updateDLCButtons();
                } else {
                    // DLCæœªå®‰è£…ï¼Œæ˜¾ç¤ºè¯¦æƒ…æˆ–è´­ä¹°
                    const availableDLC = this.dlcManager.availableDLC[dlcId];
                    if (availableDLC) {
                        if (availableDLC.type === 'free') {
                            this.dlcManager.installDLC(dlcId);
                            this.dlcManager.updateDLCButtons();
                        } else {
                            this.showPurchaseModal(dlcId);
                        }
                    } else {
                        this.showNotification('DLCæœªæ‰¾åˆ°ï¼Œè¯·å…ˆåŒæ­¥DLCåˆ—è¡¨', 'warning');
                    }
                }
            }
            
            // åŒæ­¥DLCåˆ—è¡¨
            syncDLCList() {
                if (this.dlcManager) {
                    this.dlcManager.syncDLCList();
                }
            }
            
            // åˆ·æ–°DLCåˆ—è¡¨
            refreshDLCList() {
                if (this.dlcManager) {
                    this.dlcManager.updateDLCManagerUI();
                    this.showNotification('DLCåˆ—è¡¨å·²åˆ·æ–°', 'success');
                }
            }
            
            // æ˜¾ç¤ºDLCç®¡ç†å™¨
            showDLCManagerModal() {
                if (this.dlcManager) {
                    this.dlcManager.updateDLCManagerUI();
                }
                this.showModal('dlc-manager-modal');
            }
            
            // å¼€å§‹æ¸¸æˆå¾ªç¯
            startGameLoop() {
                console.log("å¯åŠ¨æ¸¸æˆå¾ªç¯...");
                if (this.gameLoopId) clearInterval(this.gameLoopId);
                
                this.gameLoopId = setInterval(() => {
                    if (!this.isPaused) {
                        try {
                            this.updateGameTime();
                            this.updateResources();
                            this.updateSurvivors();
                            this.updateUI();
                            this.checkRandomEvents();
                        } catch (error) {
                            console.error('æ¸¸æˆå¾ªç¯é”™è¯¯:', error);
                        }
                    }
                }, 1000);
                
                console.log("âœ… æ¸¸æˆå¾ªç¯å·²å¯åŠ¨");
            }
            
            // æ›´æ–°æ¸¸æˆæ—¶é—´
            updateGameTime() {
                const speed = this.gameState.gameSpeed;
                
                // æ›´æ–°æ—¶é—´
                this.gameState.minute += speed;
                
                // æ¯å°æ—¶æ›´æ–°
                if (this.gameState.minute >= 60) {
                    this.gameState.hour += 1;
                    this.gameState.minute = 0;
                    
                    // æ¯å°æ—¶èµ„æºæ›´æ–°
                    this.updateHourlyResources();
                    
                    // æ¯æ—¥æ›´æ–°
                    if (this.gameState.hour >= 24) {
                        this.gameState.day += 1;
                        this.gameState.hour = 0;
                        this.updateDaily();
                    }
                }
            }
            
            // æ¯å°æ—¶èµ„æºæ›´æ–°
            updateHourlyResources() {
                // èµ„æºç”Ÿäº§ï¼ˆåº”ç”¨å‡çº§æ•ˆæœï¼‰
                Object.values(this.resources).forEach(res => {
                    // åŸºç¡€ç”Ÿäº§
                    let production = res.prod;
                    
                    // åº”ç”¨èµ„æºç”Ÿäº§å‡çº§æ•ˆæœ
                    if (this.upgradeSystem.resourceUpgrades.upgradedResources.food_production_boost && 
                        res.name === 'é£Ÿç‰©') {
                        const level = this.upgradeSystem.resourceUpgrades.upgradedResources.food_production_boost;
                        production *= (1 + 0.15 * level);
                    }
                    
                    if (this.upgradeSystem.resourceUpgrades.upgradedResources.water_production_boost && 
                        res.name === 'æ°´') {
                        const level = this.upgradeSystem.resourceUpgrades.upgradedResources.water_production_boost;
                        production *= (1 + 0.15 * level);
                    }
                    
                    res.amount = Math.min(res.max, res.amount + production);
                });
                
                // èµ„æºæ¶ˆè€—ï¼ˆåº”ç”¨èƒ½æºæ•ˆç‡å‡çº§ï¼‰
                const survivorCount = this.survivors.length;
                let energyConsumption = this.resources.energy.cons;
                
                if (this.upgradeSystem.resourceUpgrades.upgradedResources.energy_efficiency) {
                    const level = this.upgradeSystem.resourceUpgrades.upgradedResources.energy_efficiency;
                    energyConsumption *= (1 - 0.1 * level);
                }
                
                this.resources.food.amount = Math.max(0, this.resources.food.amount - survivorCount * this.resources.food.cons);
                this.resources.water.amount = Math.max(0, this.resources.water.amount - survivorCount * this.resources.water.cons);
                this.resources.energy.amount = Math.max(0, this.resources.energy.amount - survivorCount * energyConsumption);
                
                // ç§‘æŠ€ç‚¹ç”Ÿäº§ï¼ˆåº”ç”¨å›¾ä¹¦é¦†å‡çº§æ•ˆæœï¼‰
                const labCount = this.buildings.built.filter(b => b.type === 'å›¾ä¹¦é¦†').length;
                let techProduction = labCount * 5;
                
                // åº”ç”¨å›¾ä¹¦é¦†å‡çº§æ•ˆæœ
                if (this.upgradeSystem.buildingUpgrades.upgradedBuildings.library_upgrade_1) {
                    const level = this.upgradeSystem.buildingUpgrades.upgradedBuildings.library_upgrade_1;
                    techProduction += labCount * 5 * level;
                }
                
                this.gameState.techPoints += techProduction;
                
                // éšæœºäº‹ä»¶
                if (Math.random() < 0.15) {
                    this.triggerRandomEvent();
                }
            }
            
            // æ¯æ—¥æ›´æ–°
            updateDaily() {
                // æ›´æ–°å¤©æ°”
                const weathers = ['æ™´æœ—', 'å¤šäº‘', 'å°é›¨', 'å¤§é›¨', 'æ²™å°˜æš´', 'è¾å°„é›¨'];
                this.gameState.weather = weathers[Math.floor(Math.random() * weathers.length)];
                
                // å¹¸å­˜è€…éœ€æ±‚ï¼ˆåº”ç”¨å‡çº§æ•ˆæœï¼‰
                this.survivors.forEach(survivor => {
                    survivor.hunger += 15;
                    if (survivor.hunger > 80) {
                        survivor.health -= 8;
                        survivor.morale -= 10;
                    }
                    
                    // åº”ç”¨å¹¸å­˜è€…å‡çº§æ•ˆæœ
                    if (this.upgradeSystem.survivorUpgrades.upgradedSurvivors.health_boost) {
                        const level = this.upgradeSystem.survivorUpgrades.upgradedSurvivors.health_boost;
                        survivor.health = Math.min(100 * (1 + 0.2 * level), survivor.health);
                    }
                    
                    if (survivor.health < 30) {
                        survivor.morale -= 15;
                    }
                    
                    survivor.morale = Math.max(0, Math.min(100, survivor.morale));
                    
                    // åº”ç”¨èƒ½é‡æ¢å¤å‡çº§
                    if (!survivor.assigned && this.upgradeSystem.survivorUpgrades.upgradedSurvivors.energy_boost) {
                        const level = this.upgradeSystem.survivorUpgrades.upgradedSurvivors.energy_boost;
                        survivor.energy = Math.min(100, survivor.energy + 1 * (1 + 0.25 * level));
                    }
                });
                
                // æ£€æŸ¥æˆå°±
                this.checkAchievements();
                
                this.showNotification(`ç¬¬${this.gameState.day}å¤©å¼€å§‹äº†ï¼å¤©æ°”: ${this.gameState.weather}`, 'info');
            }
            
            // æ›´æ–°èµ„æº
            updateResources() {
                Object.values(this.resources).forEach(res => {
                    // åº”ç”¨å­˜å‚¨æ‰©å±•å‡çº§
                    let maxStorage = res.max;
                    if (this.upgradeSystem.resourceUpgrades.upgradedResources.storage_expansion) {
                        const level = this.upgradeSystem.resourceUpgrades.upgradedResources.storage_expansion;
                        maxStorage = res.max * (1 + 0.2 * level);
                    }
                    
                    res.amount = Math.max(0, Math.min(maxStorage, res.amount));
                });
            }
            
            // æ›´æ–°å¹¸å­˜è€…
            updateSurvivors() {
                this.survivors.forEach(survivor => {
                    // èƒ½é‡æ¢å¤ï¼ˆåº”ç”¨å‡çº§æ•ˆæœï¼‰
                    let energyRecovery = 1;
                    if (this.upgradeSystem.survivorUpgrades.upgradedSurvivors.energy_boost) {
                        const level = this.upgradeSystem.survivorUpgrades.upgradedSurvivors.energy_boost;
                        energyRecovery *= (1 + 0.25 * level);
                    }
                    
                    if (!survivor.assigned) {
                        survivor.energy = Math.min(100, survivor.energy + energyRecovery);
                    } else {
                        survivor.energy = Math.max(0, survivor.energy - 0.5);
                    }
                    
                    // å¥åº·æ¢å¤
                    if (survivor.health < 100) {
                        if (this.resources.medicine.amount > 0 && survivor.health < 70) {
                            survivor.health = Math.min(100, survivor.health + 0.5);
                            this.resources.medicine.amount -= 0.2;
                        } else if (!survivor.assigned) {
                            survivor.health = Math.min(100, survivor.health + 0.2);
                        }
                    }
                    
                    // å£«æ°”æ¢å¤ï¼ˆåº”ç”¨å‡çº§æ•ˆæœï¼‰
                    let moraleRecovery = 0.5;
                    if (this.upgradeSystem.survivorUpgrades.upgradedSurvivors.morale_boost) {
                        const level = this.upgradeSystem.survivorUpgrades.upgradedSurvivors.morale_boost;
                        moraleRecovery *= (1 + 0.3 * level);
                    }
                    
                    if (!survivor.assigned && survivor.health > 70) {
                        survivor.morale = Math.min(100, survivor.morale + moraleRecovery);
                    }
                });
            }
            
            // æ›´æ–°UI
            updateUI() {
                try {
                    // æ›´æ–°çŠ¶æ€æ 
                    document.getElementById('day-count').textContent = `ç¬¬${this.gameState.day}å¤©`;
                    document.getElementById('time-display').textContent = 
                        `${this.gameState.hour.toString().padStart(2, '0')}:${this.gameState.minute.toString().padStart(2, '0')}`;
                    document.getElementById('weather-display').textContent = this.gameState.weather;
                    document.getElementById('population').textContent = `${this.survivors.length}äºº`;
                    document.getElementById('tech-points').textContent = Math.floor(this.gameState.techPoints);
                    document.getElementById('survivor-count').textContent = this.survivors.length;
                    document.getElementById('settings-day').textContent = this.gameState.day;
                    
                    // æ›´æ–°æš‚åœæŒ‰é’®
                    const pauseBtn = document.getElementById('btn-pause');
                    if (pauseBtn) {
                        pauseBtn.innerHTML = this.isPaused ? 
                            '<span style="font-size: 16px;">â–¶ï¸</span><span style="font-size: 10px;">ç»§ç»­</span>' : 
                            '<span style="font-size: 16px;">â¸ï¸</span><span style="font-size: 10px;">æš‚åœ</span>';
                    }
                    
                    // é‡ç»˜åœ°å›¾
                    this.drawMap();
                } catch (error) {
                    console.error('æ›´æ–°UIé”™è¯¯:', error);
                }
            }
            
            // æ£€æŸ¥éšæœºäº‹ä»¶
            checkRandomEvents() {
                if (Math.random() < 0.001 * this.gameState.gameSpeed) {
                    this.triggerRandomEvent();
                }
            }
            
            // è§¦å‘éšæœºäº‹ä»¶
            triggerRandomEvent() {
                const events = [
                    {
                        type: 'resource',
                        message: 'å‘ç°äº†ä¸€ä¸ªèµ„æºç‚¹ï¼',
                        action: () => {
                            const resources = ['food', 'water', 'materials', 'medicine', 'ammunition', 'energy'];
                            const resource = resources[Math.floor(Math.random() * resources.length)];
                            const amount = 30 + Math.floor(Math.random() * 70);
                            this.resources[resource].amount += amount;
                            return `è·å¾—${this.resources[resource].name}+${amount}`;
                        }
                    },
                    {
                        type: 'survivor',
                        message: 'æ–°çš„å¹¸å­˜è€…è¯·æ±‚åŠ å…¥ï¼',
                        action: () => {
                            if (this.survivors.length < 12) {
                                this.recruitSurvivor();
                                return 'æ–°çš„å¹¸å­˜è€…åŠ å…¥äº†åŸºåœ°';
                            }
                            return 'åŸºåœ°å·²æ»¡å‘˜ï¼Œæ— æ³•æ¥çº³æ–°çš„å¹¸å­˜è€…';
                        }
                    },
                    {
                        type: 'tech',
                        message: 'ç ”ç©¶æœ‰äº†æ–°å‘ç°ï¼',
                        action: () => {
                            const points = 10 + Math.floor(Math.random() * 20);
                            this.gameState.techPoints += points;
                            return `è·å¾—ç§‘æŠ€ç‚¹+${points}`;
                        }
                    },
                    {
                        type: 'threat',
                        message: 'åŸºåœ°é™„è¿‘å‘ç°å¨èƒï¼',
                        action: () => {
                            this.gameState.threatLevel += 1;
                            return 'å¨èƒç­‰çº§ä¸Šå‡ï¼Œå»ºè®®åŠ å¼ºé˜²å¾¡';
                        }
                    },
                    {
                        type: 'upgrade',
                        message: 'å‘ç°äº†å‡çº§æŠ€æœ¯ï¼',
                        action: () => {
                            const points = 1 + Math.floor(Math.random() * 3);
                            this.upgradeSystem.points += points;
                            return `è·å¾—å‡çº§ç‚¹æ•°+${points}`;
                        }
                    }
                ];
                
                const event = events[Math.floor(Math.random() * events.length)];
                const result = event.action();
                this.showNotification(result, event.type === 'threat' ? 'warning' : 'success');
            }
            
            // ====== æ–°å¢ï¼šå‡çº§ç³»ç»ŸåŠŸèƒ½ ======
            
            // æ˜¾ç¤ºå‡çº§æ¨¡æ€çª—å£
            showUpgradeModal() {
                this.showModal('upgrade-modal');
                this.showBuildingUpgrades(); // é»˜è®¤æ˜¾ç¤ºå»ºç­‘å‡çº§
            }
            
            // æ˜¾ç¤ºå»ºç­‘å‡çº§
            showBuildingUpgrades() {
                const container = document.getElementById('upgrade-list-container');
                const typeDisplay = document.getElementById('selected-upgrade-type');
                
                if (!container) return;
                
                typeDisplay.textContent = 'å»ºç­‘';
                
                container.innerHTML = '';
                
                // æ›´æ–°å‡çº§ç‚¹æ•°æ˜¾ç¤º
                document.getElementById('upgrade-points').textContent = this.upgradeSystem.points;
                
                // æ˜¾ç¤ºå»ºç­‘å‡çº§åˆ—è¡¨
                this.upgradeSystem.buildingUpgrades.available.forEach(upgrade => {
                    const upgradeDiv = document.createElement('div');
                    
                    // æ£€æŸ¥æ˜¯å¦å¯ä»¥å‡çº§
                    const currentLevel = this.upgradeSystem.buildingUpgrades.upgradedBuildings[upgrade.id] || 0;
                    const canUpgrade = currentLevel < upgrade.maxLevel && 
                                      this.upgradeSystem.points >= upgrade.cost.points &&
                                      Object.entries(upgrade.cost).every(([resource, amount]) => {
                                          if (resource === 'points') return true;
                                          if (resource === 'techPoints') return this.gameState.techPoints >= amount;
                                          return this.resources[resource]?.amount >= amount;
                                      });
                    
                    upgradeDiv.className = `upgrade-item ${currentLevel > 0 ? 'upgraded' : ''} ${!canUpgrade ? 'insufficient' : ''}`;
                    
                    let costText = '';
                    Object.entries(upgrade.cost).forEach(([resource, amount]) => {
                        if (resource === 'points') {
                            costText += `ç‚¹æ•°: ${amount} `;
                        } else if (resource === 'techPoints') {
                            costText += `ç§‘æŠ€ç‚¹: ${amount} `;
                        } else {
                            costText += `${this.resources[resource]?.name}: ${amount} `;
                        }
                    });
                    
                    upgradeDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 24px; color: ${upgrade.color}; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); border-radius: 8px;">
                                ${upgrade.icon}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; font-size: 16px;">
                                    ${upgrade.name} (${currentLevel}/${upgrade.maxLevel})
                                </div>
                                <div style="font-size: 12px; color: #95a5a6; margin: 5px 0;">${upgrade.description}</div>
                                <div style="font-size: 11px; color: #bdc3c7; margin: 5px 0;">${costText}</div>
                                <div style="font-size: 10px; color: ${canUpgrade ? '#2ecc71' : '#e74c3c'};">
                                    ${canUpgrade ? 'å¯å‡çº§' : 'æ¡ä»¶ä¸è¶³'}
                                </div>
                            </div>
                            <div style="font-size: 24px;">
                                ${currentLevel >= upgrade.maxLevel ? 'ğŸ†' : (canUpgrade ? 'â¬†ï¸' : 'ğŸ”’')}
                            </div>
                        </div>
                    `;
                    
                    if (canUpgrade && currentLevel < upgrade.maxLevel) {
                        upgradeDiv.addEventListener('click', () => {
                            this.applyBuildingUpgrade(upgrade.id);
                        });
                    }
                    
                    container.appendChild(upgradeDiv);
                });
            }
            
            // åº”ç”¨å»ºç­‘å‡çº§
            applyBuildingUpgrade(upgradeId) {
                const upgrade = this.upgradeSystem.buildingUpgrades.available.find(u => u.id === upgradeId);
                if (!upgrade) {
                    this.showNotification('å‡çº§é¡¹ä¸å­˜åœ¨', 'danger');
                    return;
                }
                
                const currentLevel = this.upgradeSystem.buildingUpgrades.upgradedBuildings[upgrade.id] || 0;
                
                // æ£€æŸ¥æ˜¯å¦å¯ä»¥å‡çº§
                if (currentLevel >= upgrade.maxLevel) {
                    this.showNotification('å·²è¾¾åˆ°æœ€å¤§ç­‰çº§', 'warning');
                    return;
                }
                
                // æ£€æŸ¥èµ„æºæ˜¯å¦è¶³å¤Ÿ
                if (this.upgradeSystem.points < upgrade.cost.points) {
                    this.showNotification(`å‡çº§ç‚¹æ•°ä¸è¶³ï¼Œéœ€è¦${upgrade.cost.points}ç‚¹`, 'danger');
                    return;
                }
                
                for (const [resource, amount] of Object.entries(upgrade.cost)) {
                    if (resource === 'points') continue;
                    if (resource === 'techPoints') {
                        if (this.gameState.techPoints < amount) {
                            this.showNotification(`ç§‘æŠ€ç‚¹ä¸è¶³ï¼Œéœ€è¦${amount}ç‚¹`, 'danger');
                            return;
                        }
                    } else if (this.resources[resource]?.amount < amount) {
                        this.showNotification(`${this.resources[resource]?.name}ä¸è¶³ï¼Œéœ€è¦${amount}`, 'danger');
                        return;
                    }
                }
                
                // æ‰£é™¤èµ„æº
                this.upgradeSystem.points -= upgrade.cost.points;
                
                for (const [resource, amount] of Object.entries(upgrade.cost)) {
                    if (resource === 'points') continue;
                    if (resource === 'techPoints') {
                        this.gameState.techPoints -= amount;
                    } else {
                        this.resources[resource].amount -= amount;
                    }
                }
                
                // åº”ç”¨å‡çº§
                const newLevel = currentLevel + 1;
                this.upgradeSystem.buildingUpgrades.upgradedBuildings[upgrade.id] = newLevel;
                
                // åº”ç”¨å‡çº§æ•ˆæœ
                this.applyUpgradeEffect(upgrade, newLevel);
                
                this.showNotification(`${upgrade.name} å‡çº§åˆ° Lv.${newLevel}ï¼`, 'success');
                
                // åˆ·æ–°å‡çº§ç•Œé¢
                this.showBuildingUpgrades();
                this.updateUI();
            }
            
            // æ˜¾ç¤ºèµ„æºç”Ÿäº§å‡çº§
            showResourceUpgrades() {
                const container = document.getElementById('upgrade-list-container');
                const typeDisplay = document.getElementById('selected-upgrade-type');
                
                if (!container) return;
                
                typeDisplay.textContent = 'èµ„æºç”Ÿäº§';
                
                container.innerHTML = '';
                
                // æ›´æ–°å‡çº§ç‚¹æ•°æ˜¾ç¤º
                document.getElementById('upgrade-points').textContent = this.upgradeSystem.points;
                
                // æ˜¾ç¤ºèµ„æºå‡çº§åˆ—è¡¨
                this.upgradeSystem.resourceUpgrades.available.forEach(upgrade => {
                    const upgradeDiv = document.createElement('div');
                    
                    // æ£€æŸ¥æ˜¯å¦å¯ä»¥å‡çº§
                    const currentLevel = this.upgradeSystem.resourceUpgrades.upgradedResources[upgrade.id] || 0;
                    const canUpgrade = currentLevel < upgrade.maxLevel && 
                                      this.upgradeSystem.points >= upgrade.cost.points &&
                                      Object.entries(upgrade.cost).every(([resource, amount]) => {
                                          if (resource === 'points') return true;
                                          return this.resources[resource]?.amount >= amount;
                                      });
                    
                    upgradeDiv.className = `upgrade-item ${currentLevel > 0 ? 'upgraded' : ''} ${!canUpgrade ? 'insufficient' : ''}`;
                    
                    let costText = '';
                    Object.entries(upgrade.cost).forEach(([resource, amount]) => {
                        if (resource === 'points') {
                            costText += `ç‚¹æ•°: ${amount} `;
                        } else {
                            costText += `${this.resources[resource]?.name}: ${amount} `;
                        }
                    });
                    
                    upgradeDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 24px; color: ${upgrade.color}; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); border-radius: 8px;">
                                ${upgrade.icon}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; font-size: 16px;">
                                    ${upgrade.name} (${currentLevel}/${upgrade.maxLevel})
                                </div>
                                <div style="font-size: 12px; color: #95a5a6; margin: 5px 0;">${upgrade.description}</div>
                                <div style="font-size: 11px; color: #bdc3c7; margin: 5px 0;">${costText}</div>
                                <div style="font-size: 10px; color: ${canUpgrade ? '#2ecc71' : '#e74c3c'};">
                                    ${canUpgrade ? 'å¯å‡çº§' : 'æ¡ä»¶ä¸è¶³'}
                                </div>
                            </div>
                            <div style="font-size: 24px;">
                                ${currentLevel >= upgrade.maxLevel ? 'ğŸ†' : (canUpgrade ? 'â¬†ï¸' : 'ğŸ”’')}
                            </div>
                        </div>
                    `;
                    
                    if (canUpgrade && currentLevel < upgrade.maxLevel) {
                        upgradeDiv.addEventListener('click', () => {
                            this.applyResourceUpgrade(upgrade.id);
                        });
                    }
                    
                    container.appendChild(upgradeDiv);
                });
            }
            
            // åº”ç”¨èµ„æºå‡çº§
            applyResourceUpgrade(upgradeId) {
                const upgrade = this.upgradeSystem.resourceUpgrades.available.find(u => u.id === upgradeId);
                if (!upgrade) {
                    this.showNotification('å‡çº§é¡¹ä¸å­˜åœ¨', 'danger');
                    return;
                }
                
                const currentLevel = this.upgradeSystem.resourceUpgrades.upgradedResources[upgrade.id] || 0;
                
                // æ£€æŸ¥æ˜¯å¦å¯ä»¥å‡çº§
                if (currentLevel >= upgrade.maxLevel) {
                    this.showNotification('å·²è¾¾åˆ°æœ€å¤§ç­‰çº§', 'warning');
                    return;
                }
                
                // æ£€æŸ¥èµ„æºæ˜¯å¦è¶³å¤Ÿ
                if (this.upgradeSystem.points < upgrade.cost.points) {
                    this.showNotification(`å‡çº§ç‚¹æ•°ä¸è¶³ï¼Œéœ€è¦${upgrade.cost.points}ç‚¹`, 'danger');
                    return;
                }
                
                for (const [resource, amount] of Object.entries(upgrade.cost)) {
                    if (resource === 'points') continue;
                    if (this.resources[resource]?.amount < amount) {
                        this.showNotification(`${this.resources[resource]?.name}ä¸è¶³ï¼Œéœ€è¦${amount}`, 'danger');
                        return;
                    }
                }
                
                // æ‰£é™¤èµ„æº
                this.upgradeSystem.points -= upgrade.cost.points;
                
                for (const [resource, amount] of Object.entries(upgrade.cost)) {
                    if (resource === 'points') continue;
                    this.resources[resource].amount -= amount;
                }
                
                // åº”ç”¨å‡çº§
                const newLevel = currentLevel + 1;
                this.upgradeSystem.resourceUpgrades.upgradedResources[upgrade.id] = newLevel;
                
                // åº”ç”¨å‡çº§æ•ˆæœï¼ˆå·²åœ¨æ›´æ–°å‡½æ•°ä¸­åº”ç”¨ï¼‰
                this.showNotification(`${upgrade.name} å‡çº§åˆ° Lv.${newLevel}ï¼`, 'success');
                
                // åˆ·æ–°å‡çº§ç•Œé¢
                this.showResourceUpgrades();
                this.updateUI();
            }
            
            // æ˜¾ç¤ºå¹¸å­˜è€…å¼ºåŒ–å‡çº§
            showSurvivorUpgrades() {
                const container = document.getElementById('upgrade-list-container');
                const typeDisplay = document.getElementById('selected-upgrade-type');
                
                if (!container) return;
                
                typeDisplay.textContent = 'å¹¸å­˜è€…å¼ºåŒ–';
                
                container.innerHTML = '';
                
                // æ›´æ–°å‡çº§ç‚¹æ•°æ˜¾ç¤º
                document.getElementById('upgrade-points').textContent = this.upgradeSystem.points;
                
                // æ˜¾ç¤ºå¹¸å­˜è€…å‡çº§åˆ—è¡¨
                this.upgradeSystem.survivorUpgrades.available.forEach(upgrade => {
                    const upgradeDiv = document.createElement('div');
                    
                    // æ£€æŸ¥æ˜¯å¦å¯ä»¥å‡çº§
                    const currentLevel = this.upgradeSystem.survivorUpgrades.upgradedSurvivors[upgrade.id] || 0;
                    const canUpgrade = currentLevel < upgrade.maxLevel && 
                                      this.upgradeSystem.points >= upgrade.cost.points &&
                                      Object.entries(upgrade.cost).every(([resource, amount]) => {
                                          if (resource === 'points') return true;
                                          return this.resources[resource]?.amount >= amount;
                                      });
                    
                    upgradeDiv.className = `upgrade-item ${currentLevel > 0 ? 'upgraded' : ''} ${!canUpgrade ? 'insufficient' : ''}`;
                    
                    let costText = '';
                    Object.entries(upgrade.cost).forEach(([resource, amount]) => {
                        if (resource === 'points') {
                            costText += `ç‚¹æ•°: ${amount} `;
                        } else {
                            costText += `${this.resources[resource]?.name}: ${amount} `;
                        }
                    });
                    
                    upgradeDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 24px; color: ${upgrade.color}; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); border-radius: 8px;">
                                ${upgrade.icon}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; font-size: 16px;">
                                    ${upgrade.name} (${currentLevel}/${upgrade.maxLevel})
                                </div>
                                <div style="font-size: 12px; color: #95a5a6; margin: 5px 0;">${upgrade.description}</div>
                                <div style="font-size: 11px; color: #bdc3c7; margin: 5px 0;">${costText}</div>
                                <div style="font-size: 10px; color: ${canUpgrade ? '#2ecc71' : '#e74c3c'};">
                                    ${canUpgrade ? 'å¯å‡çº§' : 'æ¡ä»¶ä¸è¶³'}
                                </div>
                            </div>
                            <div style="font-size: 24px;">
                                ${currentLevel >= upgrade.maxLevel ? 'ğŸ†' : (canUpgrade ? 'â¬†ï¸' : 'ğŸ”’')}
                            </div>
                        </div>
                    `;
                    
                    if (canUpgrade && currentLevel < upgrade.maxLevel) {
                        upgradeDiv.addEventListener('click', () => {
                            this.applySurvivorUpgrade(upgrade.id);
                        });
                    }
                    
                    container.appendChild(upgradeDiv);
                });
            }
            
            // åº”ç”¨å¹¸å­˜è€…å‡çº§
            applySurvivorUpgrade(upgradeId) {
                const upgrade = this.upgradeSystem.survivorUpgrades.available.find(u => u.id === upgradeId);
                if (!upgrade) {
                    this.showNotification('å‡çº§é¡¹ä¸å­˜åœ¨', 'danger');
                    return;
                }
                
                const currentLevel = this.upgradeSystem.survivorUpgrades.upgradedSurvivors[upgrade.id] || 0;
                
                // æ£€æŸ¥æ˜¯å¦å¯ä»¥å‡çº§
                if (currentLevel >= upgrade.maxLevel) {
                    this.showNotification('å·²è¾¾åˆ°æœ€å¤§ç­‰çº§', 'warning');
                    return;
                }
                
                // æ£€æŸ¥èµ„æºæ˜¯å¦è¶³å¤Ÿ
                if (this.upgradeSystem.points < upgrade.cost.points) {
                    this.showNotification(`å‡çº§ç‚¹æ•°ä¸è¶³ï¼Œéœ€è¦${upgrade.cost.points}ç‚¹`, 'danger');
                    return;
                }
                
                for (const [resource, amount] of Object.entries(upgrade.cost)) {
                    if (resource === 'points') continue;
                    if (this.resources[resource]?.amount < amount) {
                        this.showNotification(`${this.resources[resource]?.name}ä¸è¶³ï¼Œéœ€è¦${amount}`, 'danger');
                        return;
                    }
                }
                
                // æ‰£é™¤èµ„æº
                this.upgradeSystem.points -= upgrade.cost.points;
                
                for (const [resource, amount] of Object.entries(upgrade.cost)) {
                    if (resource === 'points') continue;
                    this.resources[resource].amount -= amount;
                }
                
                // åº”ç”¨å‡çº§
                const newLevel = currentLevel + 1;
                this.upgradeSystem.survivorUpgrades.upgradedSurvivors[upgrade.id] = newLevel;
                
                // åº”ç”¨å‡çº§æ•ˆæœï¼ˆå·²åœ¨æ›´æ–°å‡½æ•°ä¸­åº”ç”¨ï¼‰
                this.showNotification(`${upgrade.name} å‡çº§åˆ° Lv.${newLevel}ï¼`, 'success');
                
                // åˆ·æ–°å‡çº§ç•Œé¢
                this.showSurvivorUpgrades();
                this.updateUI();
            }
            
            // åº”ç”¨å‡çº§æ•ˆæœ
            applyUpgradeEffect(upgrade, level) {
                // æ ¹æ®å‡çº§ç±»å‹åº”ç”¨æ•ˆæœ
                switch (upgrade.id) {
                    case 'farm_upgrade_1':
                        this.resources.food.prod += upgrade.effect.foodProd;
                        break;
                    case 'water_upgrade_1':
                        this.resources.water.prod += upgrade.effect.waterProd;
                        break;
                    case 'workshop_upgrade_1':
                        this.resources.materials.prod += upgrade.effect.materialsProd;
                        break;
                    case 'library_upgrade_1':
                        // å›¾ä¹¦é¦†æ•ˆæœå·²åœ¨æ¯å°æ—¶æ›´æ–°ä¸­å¤„ç†
                        break;
                }
            }
            
            // é‡ç½®å‡çº§
            resetUpgrades() {
                if (!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰å‡çº§å—ï¼Ÿè¿™å°†è¿”è¿˜50%çš„å‡çº§ç‚¹æ•°ï¼Œä½†èµ„æºä¸ä¼šè¿”è¿˜ã€‚')) {
                    return;
                }
                
                // è®¡ç®—è¿”è¿˜ç‚¹æ•°
                let totalPointsSpent = 0;
                
                // è®¡ç®—å»ºç­‘å‡çº§èŠ±è´¹
                Object.entries(this.upgradeSystem.buildingUpgrades.upgradedBuildings).forEach(([id, level]) => {
                    const upgrade = this.upgradeSystem.buildingUpgrades.available.find(u => u.id === id);
                    if (upgrade) {
                        totalPointsSpent += upgrade.cost.points * level;
                    }
                });
                
                // è®¡ç®—èµ„æºå‡çº§èŠ±è´¹
                Object.entries(this.upgradeSystem.resourceUpgrades.upgradedResources).forEach(([id, level]) => {
                    const upgrade = this.upgradeSystem.resourceUpgrades.available.find(u => u.id === id);
                    if (upgrade) {
                        totalPointsSpent += upgrade.cost.points * level;
                    }
                });
                
                // è®¡ç®—å¹¸å­˜è€…å‡çº§èŠ±è´¹
                Object.entries(this.upgradeSystem.survivorUpgrades.upgradedSurvivors).forEach(([id, level]) => {
                    const upgrade = this.upgradeSystem.survivorUpgrades.available.find(u => u.id === id);
                    if (upgrade) {
                        totalPointsSpent += upgrade.cost.points * level;
                    }
                });
                
                // è¿”è¿˜50%ç‚¹æ•°
                const refundPoints = Math.floor(totalPointsSpent * 0.5);
                this.upgradeSystem.points += refundPoints;
                
                // é‡ç½®æ‰€æœ‰å‡çº§
                this.upgradeSystem.buildingUpgrades.upgradedBuildings = {};
                this.upgradeSystem.resourceUpgrades.upgradedResources = {};
                this.upgradeSystem.survivorUpgrades.upgradedSurvivors = {};
                
                // é‡ç½®èµ„æºç”Ÿäº§ï¼ˆç§»é™¤å‡çº§æ•ˆæœï¼‰
                // è¿™é‡Œéœ€è¦é‡æ–°è®¡ç®—åŸºç¡€ç”Ÿäº§å€¼ï¼Œä½†ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬é‡ç½®ä¸ºåˆå§‹å€¼
                this.resources.food.prod = 5;
                this.resources.water.prod = 4;
                this.resources.materials.prod = 3;
                
                this.showNotification(`å·²é‡ç½®æ‰€æœ‰å‡çº§ï¼Œè¿”è¿˜${refundPoints}ç‚¹å‡çº§ç‚¹æ•°`, 'success');
                this.showBuildingUpgrades();
            }
            
            // è·å–å‡çº§ç‚¹æ•°
            getUpgradePoints() {
                const cost = { materials: 100, energy: 50, techPoints: 20 };
                
                // æ£€æŸ¥èµ„æºæ˜¯å¦è¶³å¤Ÿ
                for (const [resource, amount] of Object.entries(cost)) {
                    if (resource === 'techPoints') {
                        if (this.gameState.techPoints < amount) {
                            this.showNotification(`ç§‘æŠ€ç‚¹ä¸è¶³ï¼Œéœ€è¦${amount}ç‚¹`, 'danger');
                            return;
                        }
                    } else if (this.resources[resource]?.amount < amount) {
                        this.showNotification(`${this.resources[resource]?.name}ä¸è¶³ï¼Œéœ€è¦${amount}`, 'danger');
                        return;
                    }
                }
                
                // æ‰£é™¤èµ„æº
                for (const [resource, amount] of Object.entries(cost)) {
                    if (resource === 'techPoints') {
                        this.gameState.techPoints -= amount;
                    } else {
                        this.resources[resource].amount -= amount;
                    }
                }
                
                // è·å¾—å‡çº§ç‚¹æ•°
                const pointsGained = 2;
                this.upgradeSystem.points += pointsGained;
                
                this.showNotification(`æ¶ˆè€—èµ„æºè·å¾—${pointsGained}ç‚¹å‡çº§ç‚¹æ•°`, 'success');
                this.showBuildingUpgrades();
            }
            
            // ====== æ¨¡æ€çª—å£åŠŸèƒ½ ======
            
            // æ˜¾ç¤ºæ¨¡æ€çª—å£
            showModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'flex';
                    this.updateModalContent(modalId);
                }
            }
            
            // æ›´æ–°æ¨¡æ€çª—å£å†…å®¹
            updateModalContent(modalId) {
                switch (modalId) {
                    case 'survivors-modal':
                        this.updateSurvivorsModal();
                        break;
                    case 'resources-modal':
                        this.updateResourcesModal();
                        break;
                    case 'buildings-modal':
                        this.updateBuildingsModal();
                        break;
                    case 'tech-modal':
                        this.updateTechModal();
                        break;
                    case 'explore-modal':
                        this.updateExploreModal();
                        break;
                    case 'achievements-modal':
                        this.updateAchievementsModal();
                        break;
                    case 'dlc-modal':
                        this.updateDlcModal();
                        break;
                    case 'upgrade-modal':
                        // å‡çº§æ¨¡æ€çª—å£å†…å®¹åœ¨showUpgradeModalä¸­æ›´æ–°
                        break;
                }
            }
            
            // æ›´æ–°å¹¸å­˜è€…æ¨¡æ€çª—å£
            updateSurvivorsModal() {
                const container = document.getElementById('survivors-list');
                if (!container) return;
                
                container.innerHTML = '';
                
                this.survivors.forEach(survivor => {
                    const survivorDiv = document.createElement('div');
                    survivorDiv.className = 'survivor-item';
                    survivorDiv.style.cssText = `
                        background: rgba(255,255,255,0.05);
                        border-radius: 10px;
                        padding: 15px;
                        margin-bottom: 10px;
                        border-left: 4px solid ${survivor.skillColor};
                    `;
                    
                    const healthPercent = Math.max(0, Math.min(100, survivor.health));
                    const energyPercent = Math.max(0, Math.min(100, survivor.energy));
                    const moralePercent = Math.max(0, Math.min(100, survivor.morale));
                    
                    survivorDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 32px;">${survivor.skillIcon}</div>
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: bold; font-size: 16px;">${survivor.name}</div>
                                        <div style="font-size: 12px; color: ${survivor.skillColor};">${survivor.skill}ä¸“å®¶</div>
                                    </div>
                                    <div style="font-size: 12px; color: #95a5a6;">${survivor.status}${survivor.exploring ? ' (æ¢ç´¢ä¸­)' : ''}</div>
                                </div>
                                
                                <div style="margin: 8px 0;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                        <span style="font-size: 11px;">â¤ï¸ å¥åº·</span>
                                        <span style="font-size: 11px;">${Math.round(healthPercent)}%</span>
                                    </div>
                                    <div style="height: 6px; background: #34495e; border-radius: 3px; overflow: hidden;">
                                        <div style="height: 100%; width: ${healthPercent}%; background: #e74c3c;"></div>
                                    </div>
                                </div>
                                
                                <div style="margin: 8px 0;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                        <span style="font-size: 11px;">âš¡ èƒ½é‡</span>
                                        <span style="font-size: 11px;">${Math.round(energyPercent)}%</span>
                                    </div>
                                    <div style="height: 6px; background: #34495e; border-radius: 3px; overflow: hidden;">
                                        <div style="height: 100%; width: ${energyPercent}%; background: #3498db;"></div>
                                    </div>
                                </div>
                                
                                <div style="margin: 8px 0;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                        <span style="font-size: 11px;">ğŸ˜Š å£«æ°”</span>
                                        <span style="font-size: 11px;">${Math.round(moralePercent)}%</span>
                                    </div>
                                    <div style="height: 6px; background: #34495e; border-radius: 3px; overflow: hidden;">
                                        <div style="height: 100%; width: ${moralePercent}%; background: #f39c12;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(survivorDiv);
                });
            }
            
            // æ‹›å‹Ÿæ–°å¹¸å­˜è€…
            recruitSurvivor() {
                if (this.resources.materials.amount < 20) {
                    this.showNotification('ææ–™ä¸è¶³ï¼Œéœ€è¦20ææ–™', 'danger');
                    return;
                }
                
                if (this.survivors.length >= 12) {
                    this.showNotification('å¹¸å­˜è€…äººæ•°å·²è¾¾ä¸Šé™ (12äºº)', 'warning');
                    return;
                }
                
                const names = ['èµµæ•', 'åˆ˜å¼º', 'é™ˆé™', 'å­™æµ©', 'å‘¨å©·', 'å´æ˜', 'éƒ‘çˆ½', 'å†¯åˆš', 'é™ˆä¼Ÿ', 'æ¨é™'];
                const skills = ['å»ºé€ ', 'åŒ»ç–—', 'ç ”ç©¶', 'æ¢ç´¢', 'æˆ˜æ–—', 'å†œä¸š'];
                
                const randomName = names[Math.floor(Math.random() * names.length)];
                const randomSkill = skills[Math.floor(Math.random() * skills.length)];
                const newId = this.survivors.length > 0 ? Math.max(...this.survivors.map(s => s.id)) + 1 : 1;
                
                const newSurvivor = this.createSurvivor(newId, randomName, randomSkill);
                this.survivors.push(newSurvivor);
                this.resources.materials.amount -= 20;
                
                this.showNotification(`${newSurvivor.name}åŠ å…¥äº†ä½ çš„åŸºåœ°ï¼(æŠ€èƒ½: ${newSurvivor.skill})`, 'success');
                
                this.updateSurvivorsModal();
                this.updateUI();
                this.checkAchievements();
            }
            
            // æ›´æ–°èµ„æºæ¨¡æ€çª—å£
            updateResourcesModal() {
                const container = document.getElementById('resources-content');
                if (!container) return;
                
                container.innerHTML = '';
                
                Object.values(this.resources).forEach(resource => {
                    const percent = (resource.amount / resource.max) * 100;
                    const resourceDiv = document.createElement('div');
                    resourceDiv.style.cssText = `
                        background: rgba(255,255,255,0.05);
                        border-radius: 10px;
                        padding: 15px;
                        margin-bottom: 10px;
                        border-left: 4px solid ${resource.color};
                    `;
                    
                    resourceDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 32px;">${resource.icon}</div>
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="font-weight: bold; font-size: 16px;">${resource.name}</div>
                                    <div style="font-size: 14px;">${Math.floor(resource.amount)}/${resource.max}</div>
                                </div>
                                
                                <div style="margin: 10px 0;">
                                    <div style="height: 8px; background: #34495e; border-radius: 4px; overflow: hidden;">
                                        <div style="height: 100%; width: ${percent}%; background: ${resource.color};"></div>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; font-size: 11px; color: #95a5a6; margin-top: 3px;">
                                        <span>${percent.toFixed(1)}%</span>
                                        <span style="color: ${resource.prod > resource.cons ? '#2ecc71' : '#e74c3c'}">
                                            å‡€äº§é‡: ${(resource.prod - resource.cons).toFixed(1)}/å°æ—¶
                                        </span>
                                    </div>
                                </div>
                                
                                <div style="font-size: 12px; color: #bdc3c7;">
                                    äº§é‡: ${resource.prod}/h | æ¶ˆè€—: ${resource.cons}/h
                                </div>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(resourceDiv);
                });
            }
            
            // æ›´æ–°å»ºç­‘æ¨¡æ€çª—å£
            updateBuildingsModal() {
                const container = document.getElementById('buildings-list');
                if (!container) return;
                
                container.innerHTML = '';
                
                // å·²å»ºé€ çš„å»ºç­‘
                const builtDiv = document.createElement('div');
                builtDiv.innerHTML = '<div style="font-size: 14px; color: #2ecc71; margin-bottom: 10px;">âœ“ å·²å»ºé€ çš„å»ºç­‘:</div>';
                this.buildings.built.forEach(building => {
                    const buildingDiv = document.createElement('div');
                    buildingDiv.className = 'building-item built';
                    buildingDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 24px; color: ${building.color}; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); border-radius: 8px;">
                                ${building.icon}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; font-size: 16px;">${building.type} Lv.${building.level}</div>
                                <div style="font-size: 12px; color: #95a5a6;">${building.effect}</div>
                            </div>
                        </div>
                    `;
                    builtDiv.appendChild(buildingDiv);
                });
                container.appendChild(builtDiv);
                
                // å¯å»ºé€ çš„å»ºç­‘
                const availableDiv = document.createElement('div');
                availableDiv.innerHTML = '<div style="font-size: 14px; color: #3498db; margin: 15px 0 10px 0;">ğŸ”¨ å¯å»ºé€ çš„å»ºç­‘:</div>';
                
                this.buildings.available.forEach(building => {
                    const canAfford = Object.entries(building.cost).every(
                        ([resource, amount]) => this.resources[resource]?.amount >= amount
                    );
                    
                    const buildingDiv = document.createElement('div');
                    buildingDiv.className = `building-item ${canAfford ? '' : 'insufficient'}`;
                    buildingDiv.style.cursor = canAfford ? 'pointer' : 'not-allowed';
                    
                    let costText = '';
                    Object.entries(building.cost).forEach(([resource, amount]) => {
                        const hasEnough = this.resources[resource]?.amount >= amount;
                        costText += `<span style="color: ${hasEnough ? '#2ecc71' : '#e74c3c'}; margin-right: 8px;">${this.resources[resource]?.name}: ${amount}</span>`;
                    });
                    
                    buildingDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 24px; color: ${building.color}; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); border-radius: 8px;">
                                ${building.icon}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; font-size: 16px;">${building.type}</div>
                                <div style="font-size: 12px; color: #95a5a6; margin: 5px 0;">${building.effect}</div>
                                <div style="font-size: 11px; margin: 5px 0;">${costText}</div>
                            </div>
                            <div style="font-size: 24px;">
                                ${canAfford ? 'ğŸ”¨' : 'ğŸ”’'}
                            </div>
                        </div>
                    `;
                    
                    if (canAfford) {
                        buildingDiv.addEventListener('click', () => {
                            this.buildStructure(building);
                        });
                    }
                    
                    availableDiv.appendChild(buildingDiv);
                });
                
                container.appendChild(availableDiv);
            }
            
            // å»ºé€ å»ºç­‘
            buildStructure(building) {
                try {
                    // æ£€æŸ¥èµ„æº
                    Object.entries(building.cost).forEach(([resource, amount]) => {
                        if (this.resources[resource].amount < amount) {
                            throw new Error(`${this.resources[resource].name}ä¸è¶³ï¼éœ€è¦${amount}ï¼Œå½“å‰${this.resources[resource].amount}`);
                        }
                    });
                    
                    // æ‰£é™¤èµ„æº
                    Object.entries(building.cost).forEach(([resource, amount]) => {
                        this.resources[resource].amount -= amount;
                    });
                    
                    // æ·»åŠ å»ºç­‘åˆ°å·²å»ºåˆ—è¡¨
                    const newBuilding = {
                        id: building.id,
                        type: building.type,
                        level: 1,
                        x: building.position.x,
                        y: building.position.y,
                        icon: building.icon,
                        color: building.color,
                        effect: building.effect
                    };
                    
                    this.buildings.built.push(newBuilding);
                    
                    // åº”ç”¨å»ºç­‘æ•ˆæœ
                    this.applyBuildingEffect(building);
                    
                    // ç§»é™¤å¯å»ºé€ åˆ—è¡¨
                    this.buildings.available = this.buildings.available.filter(b => b.id !== building.id);
                    
                    this.showNotification(`${building.type}å»ºé€ å®Œæˆï¼(${building.effect})`, 'success');
                    
                    this.updateBuildingsModal();
                    this.updateUI();
                    this.checkAchievements();
                    
                } catch (error) {
                    this.showNotification(error.message, 'danger');
                }
            }
            
            // åº”ç”¨å»ºç­‘æ•ˆæœ
            applyBuildingEffect(building) {
                // æ ¹æ®å»ºç­‘ç±»å‹åº”ç”¨æ•ˆæœ
                if (building.effect.includes('é£Ÿç‰©')) {
                    const amount = parseInt(building.effect.match(/\d+/)[0]);
                    this.resources.food.prod += amount;
                } else if (building.effect.includes('æ°´')) {
                    const amount = parseInt(building.effect.match(/\d+/)[0]);
                    this.resources.water.prod += amount;
                } else if (building.effect.includes('ææ–™')) {
                    const amount = parseInt(building.effect.match(/\d+/)[0]);
                    this.resources.materials.prod += amount;
                } else if (building.effect.includes('è¯å“')) {
                    const amount = parseInt(building.effect.match(/\d+/)[0]);
                    this.resources.medicine.prod += amount;
                } else if (building.effect.includes('å¼¹è¯')) {
                    const amount = parseInt(building.effect.match(/\d+/)[0]);
                    this.resources.ammunition.prod += amount;
                } else if (building.effect.includes('èƒ½æº')) {
                    const amount = parseInt(building.effect.match(/\d+/)[0]);
                    this.resources.energy.prod += amount;
                } else if (building.effect.includes('å¨èƒ')) {
                    this.gameState.threatLevel = Math.max(1, this.gameState.threatLevel - 3);
                } else if (building.effect.includes('ç§‘æŠ€ç‚¹')) {
                    // å›¾ä¹¦é¦†æ•ˆæœå·²åœ¨æ¯å°æ—¶æ›´æ–°ä¸­å¤„ç†
                } else if (building.effect.includes('ä¸Šé™')) {
                    Object.values(this.resources).forEach(res => {
                        res.max = Math.floor(res.max * 1.3);
                    });
                }
            }
            
            // æ›´æ–°ç§‘æŠ€æ¨¡æ€çª—å£
            updateTechModal() {
                const container = document.getElementById('tech-tree');
                if (!container) return;
                
                container.innerHTML = '';
                
                this.techTree.forEach(tech => {
                    const isUnlocked = this.gameState.unlockedTech.includes(tech.id);
                    const canResearch = this.gameState.techPoints >= tech.cost && 
                                        tech.requires.every(req => this.gameState.unlockedTech.includes(req));
                    
                    const techDiv = document.createElement('div');
                    techDiv.className = `tech-item ${isUnlocked ? 'researched' : (canResearch ? '' : 'locked')}`;
                    
                    let requiresText = 'æ— å‰ç½®éœ€æ±‚';
                    if (tech.requires.length > 0) {
                        requiresText = 'éœ€è¦: ' + tech.requires.map(req => {
                            const reqTech = this.techTree.find(t => t.id === req);
                            return reqTech ? reqTech.name : req;
                        }).join(', ');
                    }
                    
                    techDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 32px;">${tech.icon}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; font-size: 16px;">${tech.name}</div>
                                <div style="font-size: 12px; color: #95a5a6; margin: 5px 0;">${tech.effect}</div>
                                <div style="font-size: 11px; color: #bdc3c7; margin: 5px 0;">${requiresText}</div>
                                <div style="font-size: 11px; color: #3498db;">ç ”ç©¶æ—¶é—´: ${tech.researchTime}å°æ—¶</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 14px; font-weight: bold; color: ${this.gameState.techPoints >= tech.cost ? '#2ecc71' : '#e74c3c'}">
                                    ${tech.cost} ç§‘æŠ€ç‚¹
                                </div>
                                <div style="font-size: 24px; margin-top: 5px;">
                                    ${isUnlocked ? 'âœ…' : (canResearch ? 'ğŸ”¬' : 'ğŸ”’')}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    if (canResearch && !isUnlocked) {
                        techDiv.addEventListener('click', () => {
                            this.researchTech(tech);
                        });
                    }
                    
                    container.appendChild(techDiv);
                });
            }
            
            // ç ”ç©¶ç§‘æŠ€
            researchTech(tech) {
                if (this.gameState.techPoints < tech.cost) {
                    this.showNotification(`ç§‘æŠ€ç‚¹ä¸è¶³ï¼éœ€è¦${tech.cost}ï¼Œå½“å‰${Math.floor(this.gameState.techPoints)}`, 'danger');
                    return;
                }
                
                if (!tech.requires.every(req => this.gameState.unlockedTech.includes(req))) {
                    this.showNotification('å‰ç½®ç§‘æŠ€æœªè§£é”ï¼', 'danger');
                    return;
                }
                
                this.gameState.techPoints -= tech.cost;
                this.gameState.unlockedTech.push(tech.id);
                
                // åº”ç”¨ç§‘æŠ€æ•ˆæœ
                this.applyTechEffect(tech);
                
                this.showNotification(`${tech.name}ç ”å‘æˆåŠŸï¼(${tech.effect})`, 'success');
                
                this.updateTechModal();
                this.checkAchievements();
            }
            
            // åº”ç”¨ç§‘æŠ€æ•ˆæœ
            applyTechEffect(tech) {
                // æ ¹æ®ç§‘æŠ€ç±»å‹åº”ç”¨æ•ˆæœ
                if (tech.effect.includes('é£Ÿç‰©äº§é‡')) {
                    this.resources.food.prod *= 1.25;
                } else if (tech.effect.includes('æ°´æ¶ˆè€—')) {
                    this.resources.water.cons *= 0.8;
                } else if (tech.effect.includes('å»ºç­‘é€Ÿåº¦')) {
                    // å»ºç­‘é€Ÿåº¦æ•ˆæœå°†åœ¨å»ºé€ æ—¶ä½“ç°
                } else if (tech.effect.includes('èƒ½æºäº§é‡')) {
                    const amount = parseInt(tech.effect.match(/\d+/)[0]);
                    this.resources.energy.prod += amount;
                } else if (tech.effect.includes('è¯å“äº§é‡')) {
                    const amount = parseInt(tech.effect.match(/\d+/)[0]);
                    this.resources.medicine.prod += amount;
                } else if (tech.effect.includes('å¼¹è¯äº§é‡')) {
                    const amount = parseInt(tech.effect.match(/\d+/)[0]);
                    this.resources.ammunition.prod += amount;
                } else if (tech.effect.includes('æ‰€æœ‰èµ„æºç”Ÿäº§')) {
                    Object.values(this.resources).forEach(res => {
                        res.prod *= 1.15;
                    });
                } else if (tech.effect.includes('å¥åº·ä¸Šé™')) {
                    // å¹¸å­˜è€…å¥åº·ä¸Šé™æ•ˆæœ
                } else if (tech.effect.includes('æ‰€æœ‰æ•ˆç‡')) {
                    Object.values(this.resources).forEach(res => {
                        res.prod *= 1.25;
                        res.cons *= 0.9;
                    });
                }
            }
            
            // æ›´æ–°æ¢ç´¢æ¨¡æ€çª—å£
            updateExploreModal() {
                const container = document.getElementById('explore-options');
                if (!container) return;
                
                container.innerHTML = '';
                
                // æ£€æŸ¥å¯ç”¨å¹¸å­˜è€…
                const availableSurvivors = this.survivors.filter(s => !s.assigned && !s.exploring);
                if (availableSurvivors.length === 0) {
                    container.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #e74c3c;">
                            <div style="font-size: 24px; margin-bottom: 10px;">âš ï¸</div>
                            <div>æ²¡æœ‰å¯ç”¨çš„å¹¸å­˜è€…è¿›è¡Œæ¢ç´¢ï¼</div>
                            <div style="font-size: 12px; color: #95a5a6; margin-top: 10px;">è¯·ç¡®ä¿æœ‰å¹¸å­˜è€…å¤„äºç©ºé—²çŠ¶æ€</div>
                        </div>
                    `;
                    return;
                }
                
                this.exploreLocations.forEach(location => {
                    const exploreBtn = document.createElement('button');
                    exploreBtn.className = 'btn';
                    exploreBtn.style.cssText = `
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        padding: 15px 10px;
                        height: auto;
                    `;
                    
                    const riskColor = location.risk === 'ä½' ? '#2ecc71' : 
                                     location.risk === 'ä¸­' ? '#f39c12' : 
                                     location.risk === 'é«˜' ? '#e67e22' : '#e74c3c';
                    
                    let rewardsText = '';
                    Object.entries(location.rewards).forEach(([resource, amount]) => {
                        const res = this.resources[resource];
                        if (res) {
                            rewardsText += `${res.name}+${amount} `;
                        } else if (resource === 'techPoints') {
                            rewardsText += `ç§‘æŠ€ç‚¹+${amount} `;
                        }
                    });
                    
                    exploreBtn.innerHTML = `
                        <span style="font-size: 32px; margin-bottom: 8px;">${location.icon}</span>
                        <span style="font-weight: bold; font-size: 14px; margin-bottom: 4px;">${location.name}</span>
                        <span style="font-size: 11px; color: ${riskColor};">é£é™©: ${location.risk}</span>
                        <span style="font-size: 10px; color: #95a5a6; margin-top: 4px;">è€—æ—¶: ${location.time}ç§’</span>
                        <span style="font-size: 9px; color: #bdc3c7; margin-top: 2px; text-align: center;">${location.desc}</span>
                    `;
                    
                    exploreBtn.addEventListener('click', () => {
                        this.startExploration(location);
                    });
                    
                    container.appendChild(exploreBtn);
                });
            }
            
            // å¼€å§‹æ¢ç´¢
            startExploration(location) {
                if (this.isExploring) {
                    this.showNotification('å·²ç»åœ¨æ¢ç´¢ä¸­ï¼', 'warning');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„å¹¸å­˜è€…
                const availableSurvivors = this.survivors.filter(s => !s.assigned && !s.exploring);
                if (availableSurvivors.length === 0) {
                    this.showNotification('æ²¡æœ‰å¯ç”¨çš„å¹¸å­˜è€…ï¼', 'danger');
                    return;
                }
                
                // é€‰æ‹©å¹¸å­˜è€…
                const explorer = availableSurvivors[0];
                explorer.exploring = true;
                explorer.status = `æ¢ç´¢${location.name}`;
                
                this.isExploring = true;
                this.currentExplore = location;
                this.exploreTimeLeft = location.time;
                
                closeModal('explore-modal');
                
                // æ˜¾ç¤ºæ¢ç´¢è®¡æ—¶å™¨
                const timerDisplay = document.getElementById('explore-timer');
                timerDisplay.style.display = 'block';
                this.updateExploreTimer();
                
                this.showNotification(`${explorer.name}å¼€å§‹æ¢ç´¢${location.name}...`, 'info');
            }
            
            // æ›´æ–°æ¢ç´¢è®¡æ—¶å™¨
            updateExploreTimer() {
                if (!this.isExploring) return;
                
                const timerDisplay = document.getElementById('explore-timer');
                if (this.exploreTimeLeft <= 0) {
                    this.finishExploration();
                    timerDisplay.style.display = 'none';
                    return;
                }
                
                this.exploreTimeLeft--;
                
                const explorer = this.survivors.find(s => s.exploring);
                if (explorer) {
                    timerDisplay.innerHTML = `
                        <div style="font-size: 14px; margin-bottom: 5px;">æ¢ç´¢ä¸­: ${this.currentExplore.name}</div>
                        <div style="font-size: 20px; font-weight: bold; color: #FFC107;">${this.exploreTimeLeft}ç§’</div>
                        <div style="font-size: 12px; margin-top: 5px;">æ¢ç´¢è€…: ${explorer.name}</div>
                        <div style="font-size: 10px; color: #95a5a6; margin-top: 3px;">é£é™©: ${this.currentExplore.risk}</div>
                    `;
                }
            }
            
            // å®Œæˆæ¢ç´¢
            finishExploration() {
                if (!this.currentExplore) return;
                
                // æ‰¾åˆ°æ¢ç´¢çš„å¹¸å­˜è€…
                const explorer = this.survivors.find(s => s.exploring);
                if (!explorer) return;
                
                this.isExploring = false;
                explorer.exploring = false;
                explorer.status = 'ç©ºé—²';
                
                // è®¡ç®—æ¢ç´¢ç»“æœ
                const successRate = this.currentExplore.risk === 'ä½' ? 0.85 : 
                                  this.currentExplore.risk === 'ä¸­' ? 0.65 : 
                                  this.currentExplore.risk === 'é«˜' ? 0.45 : 0.25;
                
                if (Math.random() < successRate) {
                    // æ¢ç´¢æˆåŠŸ
                    let rewardText = `æ¢ç´¢æˆåŠŸï¼${explorer.name}å¸¦å›äº†: `;
                    
                    Object.entries(this.currentExplore.rewards).forEach(([resource, amount]) => {
                        if (resource === 'techPoints') {
                            this.gameState.techPoints += amount;
                            rewardText += `ç§‘æŠ€ç‚¹+${amount} `;
                        } else if (this.resources[resource]) {
                            this.resources[resource].amount += amount;
                            rewardText += `${this.resources[resource].name}+${amount} `;
                        }
                    });
                    
                    // å¹¸å­˜è€…è·å¾—ç»éªŒ
                    explorer.experience += 20;
                    if (explorer.experience >= 100) {
                        explorer.level += 1;
                        explorer.experience = 0;
                        rewardText += ` ${explorer.name}å‡çº§åˆ°Lv.${explorer.level}`;
                    }
                    
                    this.showNotification(rewardText, 'success');
                    
                    // æ£€æŸ¥æ¢ç´¢æˆå°±
                    this.checkAchievements();
                } else {
                    // æ¢ç´¢å¤±è´¥
                    explorer.health -= 25;
                    explorer.morale -= 20;
                    this.showNotification(`æ¢ç´¢å¤±è´¥ï¼${explorer.name}åœ¨${this.currentExplore.name}å—ä¼¤`, 'danger');
                }
                
                this.currentExplore = null;
                this.updateUI();
            }
            
            // æ›´æ–°æˆå°±æ¨¡æ€çª—å£
            updateAchievementsModal() {
                const container = document.getElementById('achievements-list');
                if (!container) return;
                
                container.innerHTML = '';
                
                // è®¡ç®—å·²è§£é”æˆå°±æ•°é‡
                const unlockedCount = this.achievementsList.filter(a => a.unlocked).length;
                document.getElementById('unlocked-achievements').textContent = unlockedCount;
                
                this.achievementsList.forEach(achievement => {
                    const achievementDiv = document.createElement('div');
                    achievementDiv.className = `achievement-item ${achievement.unlocked ? 'unlocked' : ''}`;
                    
                    const typeColor = {
                        'bronze': '#cd7f32',
                        'silver': '#c0c0c0',
                        'gold': '#ffd700',
                        'platinum': '#e5e4e2'
                    }[achievement.type] || '#9b59b6';
                    
                    achievementDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 32px; color: ${typeColor};">${achievement.icon}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; font-size: 16px; color: ${achievement.unlocked ? '#2ecc71' : '#bdc3c7'}">
                                    ${achievement.name}
                                    <span style="font-size: 10px; padding: 2px 6px; background: ${typeColor}30; color: ${typeColor}; border-radius: 10px; margin-left: 8px;">
                                        ${achievement.type.toUpperCase()}
                                    </span>
                                </div>
                                <div style="font-size: 12px; color: #95a5a6; margin: 5px 0;">
                                    ${achievement.description}
                                </div>
                            </div>
                            <div style="font-size: 32px;">
                                ${achievement.unlocked ? 'ğŸ†' : 'ğŸ”’'}
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(achievementDiv);
                });
            }
            
            // æ£€æŸ¥æˆå°±
            checkAchievements() {
                let newAchievement = false;
                
                // æ£€æŸ¥å»ºç­‘æˆå°±
                const builtCount = this.buildings.built.length;
                if (builtCount >= 5) {
                    const achievement = this.achievementsList.find(a => a.id === 'builder');
                    if (achievement && !achievement.unlocked) {
                        achievement.unlocked = true;
                        newAchievement = true;
                    }
                }
                
                // æ£€æŸ¥å¹¸å­˜è€…æˆå°±
                if (this.survivors.length >= 8) {
                    const achievement = this.achievementsList.find(a => a.id === 'survivor');
                    if (achievement && !achievement.unlocked) {
                        achievement.unlocked = true;
                        newAchievement = true;
                    }
                }
                
                if (this.survivors.length >= 12) {
                    const achievement = this.achievementsList.find(a => a.id === 'leader');
                    if (achievement && !achievement.unlocked) {
                        achievement.unlocked = true;
                        newAchievement = true;
                    }
                }
                
                // æ£€æŸ¥ç§‘æŠ€æˆå°±
                const techCount = this.gameState.unlockedTech.length;
                if (techCount >= 5) {
                    const achievement = this.achievementsList.find(a => a.id === 'scientist');
                    if (achievement && !achievement.unlocked) {
                        achievement.unlocked = true;
                        newAchievement = true;
                    }
                }
                
                if (techCount >= this.techTree.length) {
                    const achievement = this.achievementsList.find(a => a.id === 'technocrat');
                    if (achievement && !achievement.unlocked) {
                        achievement.unlocked = true;
                        newAchievement = true;
                    }
                }
                
                // æ£€æŸ¥ç”Ÿå­˜å¤©æ•°æˆå°±
                if (this.gameState.day >= 30) {
                    const achievement = this.achievementsList.find(a => a.id === 'veteran');
                    if (achievement && !achievement.unlocked) {
                        achievement.unlocked = true;
                        newAchievement = true;
                    }
                }
                
                // æ£€æŸ¥èµ„æºæˆå°±
                const allResources = Object.values(this.resources);
                if (allResources.every(res => res.amount >= 1000)) {
                    const achievement = this.achievementsList.find(a => a.id === 'collector');
                    if (achievement && !achievement.unlocked) {
                        achievement.unlocked = true;
                        newAchievement = true;
                    }
                }
                
                // æ£€æŸ¥å»ºç­‘æˆå°±
                if (this.buildings.built.length >= this.buildings.available.length + 3) {
                    const achievement = this.achievementsList.find(a => a.id === 'architect');
                    if (achievement && !achievement.unlocked) {
                        achievement.unlocked = true;
                        newAchievement = true;
                    }
                }
                
                // æ£€æŸ¥æœ€ç»ˆæˆå°±
                const allUnlocked = this.achievementsList.filter(a => a.id !== 'master').every(a => a.unlocked);
                if (allUnlocked) {
                    const achievement = this.achievementsList.find(a => a.id === 'master');
                    if (achievement && !achievement.unlocked) {
                        achievement.unlocked = true;
                        newAchievement = true;
                    }
                }
                
                if (newAchievement) {
                    this.updateAchievementsModal();
                }
            }
            
            // æ›´æ–°DLCæ¨¡æ€çª—å£
            updateDlcModal() {
                const freeContainer = document.getElementById('free-dlc-list');
                const paidContainer = document.getElementById('paid-dlc-list');
                
                if (freeContainer) {
                    freeContainer.innerHTML = '';
                    this.dlcContent.free.forEach(dlc => {
                        const dlcDiv = document.createElement('div');
                        dlcDiv.className = 'dlc-item free';
                        dlcDiv.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="font-size: 24px;">${dlc.icon}</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; font-size: 16px; color: #2ecc71;">${dlc.name}</div>
                                    <div style="font-size: 12px; color: #95a5a6;">${dlc.description}</div>
                                </div>
                                <div style="font-size: 12px; padding: 4px 8px; background: rgba(46, 204, 113, 0.2); color: #2ecc71; border-radius: 12px;">
                                    ${dlc.status}
                                </div>
                            </div>
                        `;
                        freeContainer.appendChild(dlcDiv);
                    });
                }
                
                if (paidContainer) {
                    paidContainer.innerHTML = '';
                    this.dlcContent.paid.forEach(dlc => {
                        const dlcDiv = document.createElement('div');
                        dlcDiv.className = 'dlc-item paid';
                        dlcDiv.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="font-size: 24px;">${dlc.icon}</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; font-size: 16px; color: #f39c12;">${dlc.name}</div>
                                    <div style="font-size: 12px; color: #95a5a6;">${dlc.description}</div>
                                    ${dlc.price ? `<div style="font-size: 11px; color: #f39c12; margin-top: 3px;">å”®ä»·: ${dlc.price}</div>` : ''}
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 12px; padding: 4px 8px; background: rgba(243, 156, 18, 0.2); color: #f39c12; border-radius: 12px; margin-bottom: 5px;">
                                        ${dlc.status}
                                    </div>
                                    <div style="width: 60px; height: 6px; background: #34495e; border-radius: 3px; overflow: hidden;">
                                        <div style="height: 100%; width: ${dlc.progress}%; background: #f39c12;"></div>
                                    </div>
                                    <div style="font-size: 10px; color: #95a5a6;">${dlc.progress}%</div>
                                </div>
                            </div>
                        `;
                        paidContainer.appendChild(dlcDiv);
                    });
                }
            }
            
            // æ˜¾ç¤ºè´­ä¹°çª—å£
            showPurchaseModal(dlcId) {
                const dlcInfo = {
                    mysteryOrigin: {
                        name: 'ç¥ç§˜èµ·æºæ‰©å±•åŒ…',
                        icon: 'ğŸ”®',
                        price: 'Â¥10',
                        desc: 'å…¨æ–°å‰§æƒ…ã€åŒºåŸŸå’Œå¤šé‡ç»“å±€',
                        features: [
                            'å…¨æ–°çš„ä¸»çº¿å‰§æƒ…ä»»åŠ¡',
                            '3ä¸ªæ–°çš„æ¢ç´¢åŒºåŸŸ',
                            '5ç§æ–°çš„å»ºç­‘',
                            'å¤šé‡ç»“å±€ç³»ç»Ÿ',
                            '10ä¸ªæ–°æˆå°±'
                        ]
                    },
                    futureCity: {
                        name: 'æœªæ¥éƒ½å¸‚æ‰©å±•åŒ…',
                        icon: 'ğŸ™ï¸',
                        price: 'Â¥15',
                        desc: 'é‡å»ºç°ä»£åŒ–åŸå¸‚å’Œæ™ºèƒ½ç³»ç»Ÿ',
                        features: [
                            'å»ºè®¾æœªæ¥åŸå¸‚åŒºåŸŸ',
                            'æ™ºèƒ½ç®¡ç†ç³»ç»Ÿ',
                            'æ— äººæœºé…é€ç½‘ç»œ',
                            'é«˜ç§‘æŠ€é˜²å¾¡ç³»ç»Ÿ',
                            'è™šæ‹Ÿç°å®è®­ç»ƒ'
                        ]
                    },
                    spaceColony: {
                        name: 'å¤ªç©ºæ®–æ°‘æ‰©å±•åŒ…',
                        icon: 'ğŸš€',
                        price: 'Â¥20',
                        desc: 'å»ºç«‹å¤ªç©ºç«™å’Œæ¢ç´¢å¤–æ˜Ÿçƒ',
                        features: [
                            'å»ºé€ å¤ªç©ºè½¨é“ç«™',
                            'å¤–æ˜Ÿæ¢ç´¢ä»»åŠ¡',
                            'é›¶é‡åŠ›ç§‘æŠ€',
                            'æ˜Ÿé™…èµ„æºé‡‡é›†',
                            'å¤–æ˜Ÿæ–‡æ˜æ¥è§¦'
                        ]
                    }
                };
                
                const info = dlcInfo[dlcId];
                if (!info) return;
                
                // è®¾ç½®è´­ä¹°çª—å£å†…å®¹
                document.getElementById('dlc-icon').textContent = info.icon;
                document.getElementById('dlc-name').textContent = info.name;
                document.getElementById('dlc-price').textContent = info.price;
                document.getElementById('dlc-desc').textContent = info.desc;
                
                // è®¾ç½®åŠŸèƒ½åˆ—è¡¨
                const featuresContainer = document.getElementById('dlc-features');
                featuresContainer.innerHTML = '';
                info.features.forEach(feature => {
                    const featureDiv = document.createElement('div');
                    featureDiv.style.cssText = 'display: flex; align-items: center; gap: 10px;';
                    featureDiv.innerHTML = `
                        <span style="color: #2ecc71; font-size: 20px;">âœ“</span>
                        <span style="font-size: 14px; color: #bdc3c7;">${feature}</span>
                    `;
                    featuresContainer.appendChild(featureDiv);
                });
                
                // å­˜å‚¨å½“å‰è´­ä¹°çš„DLC ID
                document.getElementById('confirm-purchase').dataset.dlcId = dlcId;
                
                // æ˜¾ç¤ºè´­ä¹°çª—å£
                this.showModal('purchase-modal');
            }
            
            // è´­ä¹°DLC
            purchaseDLC() {
                const termsChecked = document.getElementById('terms-checkbox').checked;
                if (!termsChecked) {
                    this.showNotification('è¯·å…ˆåŒæ„ç”¨æˆ·åè®®å’Œé€€æ¬¾æ”¿ç­–', 'warning');
                    return;
                }
                
                const dlcId = document.getElementById('confirm-purchase').dataset.dlcId;
                const dlcName = document.getElementById('dlc-name').textContent;
                
                // æ¨¡æ‹Ÿè´­ä¹°è¿‡ç¨‹
                this.showNotification(`æ­£åœ¨å¤„ç†${dlcName}çš„è´­ä¹°...`, 'info');
                
                // æ¨¡æ‹Ÿæ”¯ä»˜å¤„ç†å»¶è¿Ÿ
                setTimeout(() => {
                    // è¿™é‡Œåº”è¯¥è°ƒç”¨çœŸå®çš„æ”¯ä»˜æ¥å£
                    // æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸ
                    if (this.dlcManager) {
                        this.dlcManager.installedDLC[dlcId] = {
                            dlcId: dlcId,
                            name: dlcName,
                            type: 'paid',
                            version: '1.0',
                            status: 'å·²è´­ä¹°',
                            icon: dlcId === 'mysteryOrigin' ? 'ğŸ”®' : dlcId === 'futureCity' ? 'ğŸ™ï¸' : 'ğŸš€',
                            description: document.getElementById('dlc-desc').textContent,
                            installedAt: new Date().toISOString(),
                            isActive: true
                        };
                        
                        this.dlcManager.saveInstalledDLC();
                        this.dlcManager.applyDLCEffects(dlcId);
                        this.dlcManager.updateDLCButtons();
                    }
                    
                    this.showNotification(`${dlcName} è´­ä¹°æˆåŠŸï¼æ‰©å±•å†…å®¹å·²è§£é”ã€‚`, 'success');
                    closeModal('purchase-modal');
                    
                }, 2000);
            }
            
            // åˆ‡æ¢æš‚åœçŠ¶æ€
            togglePause() {
                this.isPaused = !this.isPaused;
                this.showNotification(
                    this.isPaused ? 'æ¸¸æˆå·²æš‚åœ' : 'æ¸¸æˆç»§ç»­',
                    this.isPaused ? 'warning' : 'success'
                );
                this.updateUI();
            }
            
            // æ˜¾ç¤ºæ¢ç´¢æ¨¡æ€çª—å£
            showExploreModal() {
                if (this.isExploring) {
                    this.showNotification('æ­£åœ¨æ¢ç´¢ä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆ', 'warning');
                    return;
                }
                
                this.showModal('explore-modal');
            }
            
            // æ˜¾ç¤ºå¹¸å­˜è€…æ¨¡æ€çª—å£
            showSurvivorsModal() {
                this.showModal('survivors-modal');
            }
            
            // æ˜¾ç¤ºèµ„æºæ¨¡æ€çª—å£
            showResourcesModal() {
                this.showModal('resources-modal');
            }
            
            // æ˜¾ç¤ºå»ºç­‘æ¨¡æ€çª—å£
            showBuildingsModal() {
                this.showModal('buildings-modal');
            }
            
            // æ˜¾ç¤ºç§‘æŠ€æ¨¡æ€çª—å£
            showTechModal() {
                this.showModal('tech-modal');
            }
            
            // æ˜¾ç¤ºæˆå°±æ¨¡æ€çª—å£
            showAchievementsModal() {
                this.showModal('achievements-modal');
            }
            
            // æ˜¾ç¤ºDLCæ¨¡æ€çª—å£
            showDlcModal() {
                this.showModal('dlc-modal');
            }
            
            // æ˜¾ç¤ºé€šçŸ¥
            showNotification(message, type = 'info') {
                const container = document.getElementById('notification-container');
                if (!container) return;
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                container.appendChild(notification);
                
                // è‡ªåŠ¨ç§»é™¤é€šçŸ¥
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.style.opacity = '0';
                        notification.style.transform = 'translateY(-20px)';
                        setTimeout(() => {
                            if (notification.parentNode) {
                                notification.parentNode.removeChild(notification);
                            }
                        }, 300);
                    }
                }, 3000);
            }
            
            // ä¿å­˜æ¸¸æˆ
            saveGame() {
                try {
                    const saveData = {
                        gameState: this.gameState,
                        resources: this.resources,
                        survivors: this.survivors,
                        buildings: this.buildings,
                        achievements: this.achievementsList,
                        unlockedTech: this.gameState.unlockedTech,
                        dlcUnlocked: this.gameState.dlcUnlocked,
                        upgradeSystem: this.upgradeSystem
                    };
                    
                    localStorage.setItem('wastelandArkSave', JSON.stringify(saveData));
                    this.showNotification('æ¸¸æˆå·²ä¿å­˜ï¼', 'success');
                    console.log('ğŸ’¾ æ¸¸æˆä¿å­˜æˆåŠŸ');
                } catch (error) {
                    console.error('ä¿å­˜å¤±è´¥:', error);
                    this.showNotification('ä¿å­˜å¤±è´¥ï¼', 'danger');
                }
            }
            
            // åŠ è½½æ¸¸æˆ
            loadGame() {
                try {
                    const saveData = localStorage.getItem('wastelandArkSave');
                    if (!saveData) {
                        console.log('ğŸ“‚ æ— å­˜æ¡£æ•°æ®ï¼Œå¼€å§‹æ–°æ¸¸æˆ');
                        return;
                    }
                    
                    const data = JSON.parse(saveData);
                    
                    // åŠ è½½æ¸¸æˆçŠ¶æ€
                    this.gameState = data.gameState || this.gameState;
                    this.resources = data.resources || this.resources;
                    this.survivors = data.survivors || this.survivors;
                    this.buildings = data.buildings || this.buildings;
                    this.achievementsList = data.achievements || this.achievementsList;
                    this.gameState.unlockedTech = data.unlockedTech || [];
                    this.gameState.dlcUnlocked = data.dlcUnlocked || this.gameState.dlcUnlocked;
                    this.upgradeSystem = data.upgradeSystem || this.upgradeSystem;
                    
                    this.showNotification('æ¸¸æˆå·²åŠ è½½ï¼', 'success');
                    console.log('ğŸ“‚ æ¸¸æˆåŠ è½½æˆåŠŸ');
                    
                } catch (error) {
                    console.error('åŠ è½½å¤±è´¥:', error);
                    this.showNotification('åŠ è½½å­˜æ¡£å¤±è´¥ï¼Œå¼€å§‹æ–°æ¸¸æˆ', 'warning');
                }
            }
        }

        // ====== DLCç®¡ç†å™¨ç±» ======
        class DLCManager {
            constructor(game) {
                this.game = game;
                this.dlcList = [];
                this.installedDLC = {};
                this.availableDLC = {};
                this.isLoading = false;
                
                // ä»æœ¬åœ°å­˜å‚¨åŠ è½½å·²å®‰è£…çš„DLC
                this.loadInstalledDLC();
            }
            
            // åŠ è½½å·²å®‰è£…çš„DLC
            loadInstalledDLC() {
                try {
                    const saved = localStorage.getItem('wastelandArkDLC');
                    if (saved) {
                        this.installedDLC = JSON.parse(saved);
                        console.log(`ğŸ“¦ å·²åŠ è½½ ${Object.keys(this.installedDLC).length} ä¸ªDLC`);
                    }
                } catch (error) {
                    console.error('åŠ è½½DLCæ•°æ®å¤±è´¥:', error);
                }
            }
            
            // ä¿å­˜å·²å®‰è£…çš„DLC
            saveInstalledDLC() {
                try {
                    localStorage.setItem('wastelandArkDLC', JSON.stringify(this.installedDLC));
                } catch (error) {
                    console.error('ä¿å­˜DLCæ•°æ®å¤±è´¥:', error);
                }
            }
            
            // åŒæ­¥DLCåˆ—è¡¨ï¼ˆä»æœåŠ¡å™¨è·å–ï¼‰
            async syncDLCList() {
                if (this.isLoading) return;
                
                this.isLoading = true;
                this.game.showNotification('æ­£åœ¨åŒæ­¥DLCåˆ—è¡¨...', 'info');
                
                try {
                    const dlcPromises = DLC_CONFIG.DLC_FILES.map(file => 
                        this.loadDLCFile(file)
                    );
                    
                    const results = await Promise.allSettled(dlcPromises);
                    
                    // å¤„ç†ç»“æœ
                    this.dlcList = [];
                    this.availableDLC = {};
                    
                    results.forEach((result, index) => {
                        if (result.status === 'fulfilled' && result.value) {
                            const dlc = result.value;
                            this.dlcList.push(dlc);
                            this.availableDLC[dlc.dlcId] = dlc;
                            console.log(`âœ… å·²åŠ è½½DLC: ${dlc.name}`);
                        } else {
                            console.warn(`âŒ åŠ è½½DLCå¤±è´¥: ${DLC_CONFIG.DLC_FILES[index]}`);
                        }
                    });
                    
                    this.game.showNotification(`å·²åŒæ­¥ ${this.dlcList.length} ä¸ªDLC`, 'success');
                    
                    // æ›´æ–°DLCç®¡ç†å™¨ç•Œé¢
                    this.updateDLCManagerUI();
                    
                } catch (error) {
                    console.error('åŒæ­¥DLCå¤±è´¥:', error);
                    this.game.showNotification('åŒæ­¥DLCå¤±è´¥', 'danger');
                } finally {
                    this.isLoading = false;
                }
            }
            
            // åŠ è½½å•ä¸ªDLCæ–‡ä»¶
            async loadDLCFile(filename) {
                const url = DLC_CONFIG.SERVER_URL + filename;
                
                try {
                    const response = await fetch(url, {
                        cache: 'no-cache',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const dlcData = await response.json();
                    
                    // éªŒè¯DLCæ•°æ®æ ¼å¼
                    if (!dlcData.dlcId || !dlcData.name) {
                        throw new Error('æ— æ•ˆçš„DLCæ ¼å¼');
                    }
                    
                    return dlcData;
                    
                } catch (error) {
                    console.warn(`åŠ è½½DLCæ–‡ä»¶å¤±è´¥ ${filename}:`, error);
                    return null;
                }
            }
            
            // å®‰è£…DLC
            installDLC(dlcId) {
                const dlc = this.availableDLC[dlcId];
                if (!dlc) {
                    this.game.showNotification('DLCä¸å­˜åœ¨', 'danger');
                    return false;
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
                if (this.installedDLC[dlcId]) {
                    this.game.showNotification('è¯¥DLCå·²å®‰è£…', 'warning');
                    return false;
                }
                
                // å®‰è£…DLC
                this.installedDLC[dlcId] = {
                    ...dlc,
                    installedAt: new Date().toISOString(),
                    isActive: true
                };
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                this.saveInstalledDLC();
                
                // åº”ç”¨DLCæ•ˆæœ
                this.applyDLCEffects(dlcId);
                
                // æ›´æ–°æ¸¸æˆçŠ¶æ€
                this.updateGameDLCStatus(dlcId);
                
                this.game.showNotification(`${dlc.name} å·²æˆåŠŸå®‰è£…ï¼`, 'success');
                return true;
            }
            
            // å¸è½½DLC
            uninstallDLC(dlcId) {
                if (!this.installedDLC[dlcId]) {
                    this.game.showNotification('è¯¥DLCæœªå®‰è£…', 'warning');
                    return false;
                }
                
                // ç§»é™¤DLC
                delete this.installedDLC[dlcId];
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                this.saveInstalledDLC();
                
                // ç§»é™¤DLCæ•ˆæœ
                this.removeDLCEffects(dlcId);
                
                this.game.showNotification('DLCå·²å¸è½½', 'info');
                return true;
            }
            
            // æ¿€æ´»DLC
            activateDLC(dlcId) {
                const dlc = this.installedDLC[dlcId];
                if (!dlc) {
                    this.game.showNotification('è¯·å…ˆå®‰è£…è¯¥DLC', 'warning');
                    return false;
                }
                
                if (dlc.isActive) {
                    this.game.showNotification('è¯¥DLCå·²åœ¨è¿è¡Œä¸­', 'info');
                    return false;
                }
                
                // æ¿€æ´»DLC
                dlc.isActive = true;
                this.saveInstalledDLC();
                
                // åº”ç”¨DLCæ•ˆæœ
                this.applyDLCEffects(dlcId);
                
                this.game.showNotification(`${dlc.name} å·²æ¿€æ´»ï¼`, 'success');
                return true;
            }
            
            // åœç”¨DLC
            deactivateDLC(dlcId) {
                const dlc = this.installedDLC[dlcId];
                if (!dlc) {
                    this.game.showNotification('DLCæœªå®‰è£…', 'warning');
                    return false;
                }
                
                if (!dlc.isActive) {
                    this.game.showNotification('è¯¥DLCå·²åœç”¨', 'info');
                    return false;
                }
                
                // åœç”¨DLC
                dlc.isActive = false;
                this.saveInstalledDLC();
                
                // ç§»é™¤DLCæ•ˆæœ
                this.removeDLCEffects(dlcId);
                
                this.game.showNotification(`${dlc.name} å·²åœç”¨`, 'info');
                return true;
            }
            
            // åº”ç”¨DLCæ•ˆæœ
            applyDLCEffects(dlcId) {
                const dlc = this.installedDLC[dlcId];
                if (!dlc || !dlc.isActive) return;
                
                try {
                    // æ‰§è¡Œæ¿€æ´»è„šæœ¬
                    if (dlc.activationScript) {
                        const script = new Function('game', dlc.activationScript);
                        script(this.game);
                    }
                    
                    console.log(`ğŸ® å·²åº”ç”¨DLCæ•ˆæœ: ${dlc.name}`);
                    
                } catch (error) {
                    console.error(`åº”ç”¨DLCæ•ˆæœå¤±è´¥ ${dlcId}:`, error);
                }
            }
            
            // ç§»é™¤DLCæ•ˆæœ
            removeDLCEffects(dlcId) {
                // è¿™é‡Œå¯ä»¥æ ¹æ®éœ€è¦å®ç°ç§»é™¤DLCæ•ˆæœçš„é€»è¾‘
                console.log(`ğŸ”§ å·²ç§»é™¤DLCæ•ˆæœ: ${dlcId}`);
            }
            
            // æ›´æ–°æ¸¸æˆDLCçŠ¶æ€
            updateGameDLCStatus(dlcId) {
                const dlc = this.installedDLC[dlcId];
                if (!dlc) return;
                
                // æ›´æ–°æ¸¸æˆçŠ¶æ€ä¸­çš„DLCè§£é”çŠ¶æ€
                if (this.game.gameState.dlcUnlocked) {
                    this.game.gameState.dlcUnlocked[dlcId] = true;
                }
                
                // æ›´æ–°DLCæŒ‰é’®çŠ¶æ€
                this.updateDLCButtons();
            }
            
            // æ›´æ–°DLCæŒ‰é’®
            updateDLCButtons() {
                Object.keys(this.installedDLC).forEach(dlcId => {
                    const button = document.getElementById(`btn-${dlcId}`);
                    if (button) {
                        const dlc = this.installedDLC[dlcId];
                        const isActive = dlc.isActive;
                        
                        button.className = isActive ? 'btn btn-success' : 'btn btn-warning';
                        
                        // æ›´æ–°æŒ‰é’®æ–‡å­—
                        const icon = button.querySelector('span:nth-child(1)').textContent;
                        const name = dlc.name.replace('æ‰©å±•åŒ…', '');
                        
                        button.innerHTML = `
                            <span style="font-size: 24px;">${icon}</span>
                            <span style="font-size: 10px;">${name}</span>
                            <span style="font-size: 8px; color: rgba(255,255,255,0.7);">
                                ${isActive ? 'è¿è¡Œä¸­' : 'å·²åœç”¨'}
                            </span>
                        `;
                        
                        // æ›´æ–°ç‚¹å‡»äº‹ä»¶
                        button.onclick = () => {
                            if (isActive) {
                                this.deactivateDLC(dlcId);
                            } else {
                                this.activateDLC(dlcId);
                            }
                            this.updateDLCButtons();
                        };
                    }
                });
            }
            
            // æ›´æ–°DLCç®¡ç†å™¨ç•Œé¢
            updateDLCManagerUI() {
                // æ›´æ–°æœåŠ¡å™¨URLæ˜¾ç¤º
                const serverUrlElement = document.getElementById('dlc-server-url');
                if (serverUrlElement) {
                    serverUrlElement.textContent = DLC_CONFIG.SERVER_URL;
                }
                
                // æ›´æ–°å·²å®‰è£…DLCåˆ—è¡¨
                this.updateInstalledDLCList();
                
                // æ›´æ–°å¯ç”¨DLCåˆ—è¡¨
                this.updateAvailableDLCList();
            }
            
            // æ›´æ–°å·²å®‰è£…DLCåˆ—è¡¨
            updateInstalledDLCList() {
                const container = document.getElementById('installed-dlc-list');
                if (!container) return;
                
                container.innerHTML = '';
                
                const installed = Object.values(this.installedDLC);
                
                if (installed.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #95a5a6;">
                            <div style="font-size: 24px; margin-bottom: 10px;">ğŸ“­</div>
                            <div>æœªå®‰è£…ä»»ä½•DLC</div>
                        </div>
                    `;
                    return;
                }
                
                installed.forEach(dlc => {
                    const dlcDiv = document.createElement('div');
                    dlcDiv.className = `dlc-item ${dlc.type === 'free' ? 'free' : 'paid'}`;
                    dlcDiv.style.cursor = 'pointer';
                    dlcDiv.style.marginBottom = '10px';
                    
                    dlcDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 24px;">${dlc.icon}</div>
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="font-weight: bold; font-size: 16px; color: ${dlc.isActive ? '#2ecc71' : '#95a5a6'}">
                                        ${dlc.name}
                                    </div>
                                    <div style="font-size: 12px; padding: 2px 8px; background: ${dlc.isActive ? 'rgba(46, 204, 113, 0.2)' : 'rgba(149, 165, 166, 0.2)'}; color: ${dlc.isActive ? '#2ecc71' : '#95a5a6'}; border-radius: 10px;">
                                        ${dlc.isActive ? 'è¿è¡Œä¸­' : 'å·²åœç”¨'}
                                    </div>
                                </div>
                                <div style="font-size: 12px; color: #95a5a6; margin: 5px 0;">${dlc.description}</div>
                                <div style="font-size: 10px; color: #7f8c8d;">
                                    ç‰ˆæœ¬: ${dlc.version} | å®‰è£…äº: ${new Date(dlc.installedAt).toLocaleDateString()}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…
                    dlcDiv.addEventListener('click', () => {
                        this.showDLCDetail(dlc.dlcId);
                    });
                    
                    container.appendChild(dlcDiv);
                });
            }
            
            // æ›´æ–°å¯ç”¨DLCåˆ—è¡¨
            updateAvailableDLCList() {
                const container = document.getElementById('available-dlc-list');
                if (!container) return;
                
                container.innerHTML = '';
                
                const available = Object.values(this.availableDLC).filter(
                    dlc => !this.installedDLC[dlc.dlcId]
                );
                
                if (available.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #95a5a6;">
                            <div style="font-size: 24px; margin-bottom: 10px;">âœ…</div>
                            <div>æ‰€æœ‰DLCå‡å·²å®‰è£…</div>
                        </div>
                    `;
                    return;
                }
                
                available.forEach(dlc => {
                    const dlcDiv = document.createElement('div');
                    dlcDiv.className = `dlc-item ${dlc.type === 'free' ? 'free' : 'paid'}`;
                    dlcDiv.style.cursor = 'pointer';
                    dlcDiv.style.marginBottom = '10px';
                    
                    dlcDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 24px;">${dlc.icon}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; font-size: 16px; color: #3498db">${dlc.name}</div>
                                <div style="font-size: 12px; color: #95a5a6; margin: 5px 0;">${dlc.description}</div>
                                <div style="font-size: 11px; color: ${dlc.type === 'free' ? '#2ecc71' : '#f39c12'}">
                                    ${dlc.type === 'free' ? 'å…è´¹' : `ä»·æ ¼: ${dlc.price}`}
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-success" style="min-height: 40px; padding: 5px 10px;" data-dlc-id="${dlc.dlcId}">
                                    ${dlc.type === 'free' ? 'å®‰è£…' : 'è´­ä¹°'}
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // æ·»åŠ å®‰è£…/è´­ä¹°æŒ‰é’®äº‹ä»¶
                    const installBtn = dlcDiv.querySelector('button');
                    installBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        
                        if (dlc.type === 'free') {
                            this.installDLC(dlc.dlcId);
                            this.updateDLCManagerUI();
                            this.updateDLCButtons();
                        } else {
                            this.game.showPurchaseModal(dlc.dlcId);
                        }
                    });
                    
                    // ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…
                    dlcDiv.addEventListener('click', () => {
                        this.showDLCDetail(dlc.dlcId);
                    });
                    
                    container.appendChild(dlcDiv);
                });
            }
            
            // æ˜¾ç¤ºDLCè¯¦æƒ…
            showDLCDetail(dlcId) {
                const dlc = this.installedDLC[dlcId] || this.availableDLC[dlcId];
                if (!dlc) return;
                
                const container = document.getElementById('dlc-detail-content');
                if (!container) return;
                
                container.innerHTML = `
                    <div style="text-align: center; margin-bottom: 25px;">
                        <div style="font-size: 64px; margin-bottom: 15px;">${dlc.icon}</div>
                        <div style="font-size: 22px; color: #3498db; margin-bottom: 8px;">${dlc.name}</div>
                        <div style="font-size: 14px; color: #95a5a6; margin-bottom: 15px;">${dlc.description}</div>
                        
                        ${dlc.type === 'paid' ? `
                            <div style="font-size: 28px; color: #f39c12; font-weight: bold; margin-bottom: 15px;">
                                ${dlc.price}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div style="background: rgba(52, 152, 219, 0.1); border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                        <div style="font-size: 16px; color: #3498db; margin-bottom: 15px;">ğŸ“‹ æ‰©å±•å†…å®¹:</div>
                        <ul style="padding-left: 20px; color: #bdc3c7; font-size: 14px; line-height: 1.6;">
                            ${dlc.features ? dlc.features.map(f => `<li>${f}</li>`).join('') : ''}
                        </ul>
                    </div>
                    
                    ${dlc.requirements ? `
                        <div style="background: rgba(46, 204, 113, 0.1); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                            <div style="font-size: 14px; color: #2ecc71; margin-bottom: 10px;">âš™ï¸ ç³»ç»Ÿè¦æ±‚:</div>
                            <div style="font-size: 12px; color: #bdc3c7;">
                                æ¸¸æˆç‰ˆæœ¬: ${dlc.requirements.gameVersion || '2.0'}<br>
                                ${dlc.requirements.requiredLevel ? `æ‰€éœ€ç­‰çº§: ${dlc.requirements.requiredLevel}<br>` : ''}
                                ${dlc.requirements.requiredDay ? `ç”Ÿå­˜å¤©æ•°: ${dlc.requirements.requiredDay}<br>` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="display: flex; gap: 10px;">
                        ${this.installedDLC[dlcId] ? `
                            <button class="btn btn-${dlc.isActive ? 'warning' : 'success'}" onclick="game.dlcManager.${dlc.isActive ? 'deactivateDLC' : 'activateDLC'}('${dlcId}'); closeModal('dlc-detail-modal');" style="flex: 1;">
                                ${dlc.isActive ? 'åœç”¨' : 'å¯ç”¨'}
                            </button>
                            <button class="btn btn-danger" onclick="game.dlcManager.uninstallDLC('${dlcId}'); closeModal('dlc-detail-modal');" style="flex: 1;">
                                å¸è½½
                            </button>
                        ` : `
                            <button class="btn btn-${dlc.type === 'free' ? 'success' : 'warning'}" onclick="closeModal('dlc-detail-modal'); ${dlc.type === 'free' ? `game.dlcManager.installDLC('${dlcId}')` : `game.showPurchaseModal('${dlcId}')`};" style="flex: 1;">
                                ${dlc.type === 'free' ? 'å…è´¹å®‰è£…' : 'ç«‹å³è´­ä¹°'}
                            </button>
                        `}
                    </div>
                `;
                
                closeModal('dlc-manager-modal');
                this.game.showModal('dlc-detail-modal');
            }
        }

        // ====== å…¨å±€è¾…åŠ©å‡½æ•° ======
        
        // å…³é—­æ¨¡æ€çª—å£
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // è®¾ç½®å±å¹•æ–¹å‘
        function setOrientation(orientation) {
            document.body.className = orientation + '-mode';
            if (window.game) {
                game.gameState.orientation = orientation;
                game.resizeCanvas();
                game.drawMap();
            }
        }
        
        // é‡ç½®æ¸¸æˆ
        function resetGame() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ¸¸æˆå—ï¼Ÿæ‰€æœ‰è¿›åº¦éƒ½å°†ä¸¢å¤±ï¼')) {
                localStorage.removeItem('wastelandArkSave');
                localStorage.removeItem('wastelandArkDLC');
                location.reload();
            }
        }
        
        // DLCé€šçŸ¥
        function notifyDLC() {
            if (window.game) {
                game.showNotification('å·²è®°å½•æ‚¨çš„å…´è¶£ï¼DLCä¸Šçº¿æ—¶ä¼šé€šçŸ¥æ‚¨', 'success');
                closeModal('dlc-modal');
            }
        }

        // ====== æ¸¸æˆå¯åŠ¨ ======
        let game;

        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–æ¸¸æˆ...");
            
            try {
                // åˆ›å»ºæ¸¸æˆå®ä¾‹
                game = new WastelandArkGame();
                window.game = game;
                
                // åˆå§‹åŒ–æ¸¸æˆ
                setTimeout(() => {
                    game.initialize();
                }, 100);
                
                console.log('ğŸ° ã€ŠåºŸåœŸæ–¹èˆŸã€‹v2.0 æ­£åœ¨å¯åŠ¨...');
                console.log('âœ… å®Œæ•´DLCç³»ç»Ÿå·²é›†æˆ');
                console.log('âœ… å‡çº§ç³»ç»Ÿå·²æ·»åŠ ');
                console.log('âœ… DLCç®¡ç†å™¨å·²å°±ç»ª');
                console.log('âœ… æ¸¸æˆæœ¬ä½“å’ŒDLCå®Œå…¨è¿æ¥');
                
            } catch (error) {
                console.error('âŒ æ¸¸æˆå¯åŠ¨å¤±è´¥:', error);
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #e74c3c;">
                            <div style="font-size: 24px; margin-bottom: 20px;">âš ï¸ å¯åŠ¨å¤±è´¥</div>
                            <div style="margin-bottom: 20px; font-size: 14px;">${error.message}</div>
                            <button onclick="location.reload()" style="
                                background: #3498db;
                                color: white;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 8px;
                                font-size: 16px;
                                cursor: pointer;
                            ">é‡æ–°åŠ è½½</button>
                        </div>
                    `;
                }
            }
        });

        // çª—å£å¤§å°å˜åŒ–å¤„ç†
        window.addEventListener('resize', () => {
            if (game) {
                game.resizeCanvas();
                game.drawMap();
            }
        });

        // é˜²æ­¢é¡µé¢æ»šåŠ¨
        document.addEventListener('touchmove', (e) => {
            if (e.target.tagName !== 'CANVAS') {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>
