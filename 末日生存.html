<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>åºŸåœŸæ–¹èˆŸ</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ°</text></svg>">
    
    <style>
        /* ====== åŸºç¡€é‡ç½® ====== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #0a0a12;
            color: #e0e0ff;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        /* ====== PWAå…¨å±ä¼˜åŒ– ====== */
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }

        /* ====== æ¨ªç«–å±åˆ‡æ¢æ ·å¼ ====== */
        body.portrait-mode #game-container {
            flex-direction: column;
        }
        
        body.landscape-mode #game-container {
            flex-direction: row;
        }
        
        body.portrait-mode #main-content {
            flex-direction: column;
        }
        
        body.landscape-mode #main-content {
            flex-direction: row;
        }
        
        body.portrait-mode #map-container {
            height: 50vh;
            min-height: 300px;
        }
        
        body.landscape-mode #map-container {
            flex: 1;
            min-height: 0;
        }
        
        body.portrait-mode #control-panel {
            flex-direction: row;
            height: auto;
        }
        
        body.landscape-mode #control-panel {
            flex-direction: column;
            width: 120px;
        }

        /* ====== åŠ è½½åŠ¨ç”» ====== */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a2e;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        /* ====== æ¸¸æˆä¸»å®¹å™¨ ====== */
        #game-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 5px;
            gap: 5px;
            display: none;
        }

        /* ====== é¡¶éƒ¨çŠ¶æ€æ  ====== */
        #status-bar {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            border-radius: 8px;
            padding: 5px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #3498db;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.4);
            height: 45px;
            font-size: 12px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
            margin: 0 3px;
            flex-shrink: 0;
        }

        .status-icon {
            font-size: 14px;
            min-width: 20px;
            text-align: center;
        }

        .status-value {
            font-size: 13px;
            font-weight: bold;
            color: #fff;
            white-space: nowrap;
        }

        /* ====== ä¸»å†…å®¹åŒºåŸŸ ====== */
        #main-content {
            flex: 1;
            display: flex;
            gap: 5px;
            min-height: 0;
        }

        /* ====== ä¸­å¤®åœ°å›¾åŒºåŸŸ ====== */
        #map-container {
            flex: 1;
            background: rgba(25, 30, 45, 0.95);
            border-radius: 8px;
            border: 1px solid #444;
            position: relative;
            overflow: hidden;
        }

        #base-canvas {
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
        }

        /* ====== æ§åˆ¶é¢æ¿ ====== */
        #control-panel {
            display: flex;
            gap: 5px;
            padding: 8px;
            background: rgba(30, 35, 50, 0.95);
            border-radius: 8px;
            border: 1px solid #444;
        }

        /* ====== é€šç”¨æŒ‰é’®æ ·å¼ ====== */
        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            border: none;
            border-radius: 6px;
            color: white;
            padding: 5px 10px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            height: 30px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(52, 152, 219, 0.3);
        }

        .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .btn-success { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .btn-warning { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .btn-purple { background: linear-gradient(135deg, #9b59b6, #8e44ad); }

        .btn-small {
            padding: 3px 6px;
            font-size: 10px;
            height: 24px;
        }

        /* ====== å¼¹çª—ç³»ç»Ÿ ====== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 10px;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: relative;
            background: #2c3e50;
            border-radius: 10px;
            padding: 15px;
            width: 95%;
            max-width: 400px;
            border: 2px solid #3498db;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 15px;
            color: #3498db;
            margin-bottom: 10px;
            text-align: center;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        /* ====== å¢å¼ºå…³é—­æŒ‰é’®æ ·å¼ ====== */
        .close-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: #e74c3c;
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            z-index: 1001;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .close-btn:hover {
            background: #c0392b;
            transform: scale(1.1);
            box-shadow: 0 3px 8px rgba(0,0,0,0.4);
        }

        .close-btn:active {
            transform: scale(0.95);
        }

        /* ====== èµ„æºé¢æ¿æ ·å¼ ====== */
        .resource-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px;
            margin-bottom: 5px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            font-size: 11px;
        }

        .resource-icon {
            font-size: 14px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            flex-shrink: 0;
        }

        .resource-bar {
            height: 3px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin: 2px 0;
            overflow: hidden;
        }

        .resource-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s;
        }

        /* ====== ç§‘æŠ€æ ‘æ ·å¼ ====== */
        .tech-item {
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid #3498db;
            border-radius: 6px;
            padding: 6px;
            margin: 3px 0;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 11px;
        }

        .tech-item:hover {
            background: rgba(52, 152, 219, 0.2);
        }

        .tech-item.researched {
            background: rgba(46, 204, 113, 0.2);
            border-color: #2ecc71;
        }

        .tech-item.insufficient {
            background: rgba(231, 76, 60, 0.1);
            border-color: #e74c3c;
            opacity: 0.7;
        }

        /* ====== æˆå°±æ ·å¼ ====== */
        .achievement-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px;
            margin: 4px 0;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            font-size: 11px;
        }

        .achievement-item.locked {
            opacity: 0.5;
            filter: grayscale(1);
        }

        .achievement-icon {
            font-size: 16px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            flex-shrink: 0;
        }

        /* ====== è®¾ç½®é¡¹æ ·å¼ ====== */
        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            margin: 5px 0;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            font-size: 12px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #666;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #3498db;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* ====== æˆ˜æ–—ç•Œé¢æ ·å¼ ====== */
        .enemy-card {
            background: rgba(231, 76, 60, 0.2);
            border: 2px solid #e74c3c;
            border-radius: 8px;
            padding: 10px;
            margin: 6px 0;
            text-align: center;
            font-size: 12px;
        }

        .combat-log {
            height: 80px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 6px;
            padding: 6px;
            margin: 6px 0;
            font-size: 11px;
        }

        .combat-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-top: 8px;
        }

        /* ====== åŠ¨ç”»å®šä¹‰ ====== */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ====== é€šçŸ¥ç³»ç»Ÿ ====== */
        #notification-container {
            position: fixed;
            top: 50px;
            right: 10px;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 5px;
            max-width: 250px;
        }

        .notification {
            background: #2c3e50;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            animation: fadeIn 0.3s, fadeOut 0.3s 2.7s forwards;
            font-size: 12px;
        }

        .notification.success { border-left-color: #2ecc71; }
        .notification.warning { border-left-color: #f39c12; }
        .notification.danger { border-left-color: #e74c3c; }

        @keyframes fadeOut {
            to { opacity: 0; transform: translateY(-10px); }
        }

        /* ====== å®‰è£…æç¤º ====== */
        #install-prompt {
            position: fixed;
            top: 50px;
            right: 10px;
            background: #2ecc71;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            animation: fadeIn 0.3s;
            z-index: 1002;
            font-size: 12px;
            display: none;
        }

        #install-prompt button {
            background: white;
            color: #2ecc71;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            margin-left: 10px;
            cursor: pointer;
            font-weight: bold;
        }
        
        /* ====== æ—¶é—´æ˜¾ç¤ºæ ·å¼ ====== */
        #time-display {
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
        }
        
        /* ====== éŸ³é‡æ»‘å—æ ·å¼ ====== */
        input[type="range"] {
            width: 100px;
            height: 8px;
            -webkit-appearance: none;
            background: #34495e;
            border-radius: 4px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
        }
        
        /* ====== éŸ³ä¹æ§åˆ¶å®¹å™¨ ====== */
        .music-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
    </style>
</head>
<body class="portrait-mode">
    <!-- åŠ è½½å±å¹• -->
    <div id="loading-screen">
        <div class="loading-spinner"></div>
        <div style="font-size: 18px; color: #3498db; margin-bottom: 10px; font-weight: bold;">åºŸåœŸæ–¹èˆŸ</div>
        <div style="font-size: 12px; color: #8899cc; text-align: center; max-width: 300px;">
            åŠ è½½ä¸­...
        </div>
    </div>

    <!-- å®‰è£…æç¤º -->
    <div id="install-prompt">
        ğŸ“± æƒ³æ·»åŠ åˆ°æ¡Œé¢å—ï¼Ÿ
        <button id="install-btn">å®‰è£…</button>
    </div>

    <!-- ä¸»æ¸¸æˆç•Œé¢ -->
    <div id="game-container">
        <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
        <div id="status-bar">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div class="status-item">
                    <span class="status-icon">ğŸ“…</span>
                    <span class="status-value" id="day-count">ç¬¬1å¤©</span>
                </div>
                
                <div class="status-item">
                    <span class="status-icon">â°</span>
                    <span class="status-value" id="time-display">06:00:00</span>
                </div>
                
                <div class="status-item">
                    <span class="status-icon">â˜ï¸</span>
                    <span class="status-value" id="weather">æ™´æœ—</span>
                </div>
                
                <button class="btn btn-small btn-success" id="btn-explore">
                    <span>ğŸ§­</span>
                    <span>æ¢ç´¢</span>
                </button>
                
                <button class="btn btn-small btn-purple" id="btn-settings">
                    <span>âš™ï¸</span>
                    <span>è®¾ç½®</span>
                </button>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div id="main-content">
            <!-- ä¸­å¤®åœ°å›¾åŒºåŸŸ -->
            <div id="map-container">
                <canvas id="base-canvas"></canvas>
            </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div id="control-panel">
            <button class="btn btn-success" id="btn-resources">
                <span>ğŸ“¦</span>
                <span>èµ„æº</span>
            </button>
            <button class="btn btn-purple" id="btn-tech">
                <span>ğŸ”¬</span>
                <span>ç§‘æŠ€</span>
            </button>
            <button class="btn btn-warning" id="btn-upgrade">
                <span>â¬†ï¸</span>
                <span>å‡çº§</span>
            </button>
            <button class="btn" id="btn-achievements">
                <span>ğŸ†</span>
                <span>æˆå°±</span>
            </button>
            <button class="btn btn-success" id="btn-save">
                <span>ğŸ’¾</span>
                <span>ä¿å­˜</span>
            </button>
            <button class="btn" id="btn-load">
                <span>ğŸ“‚</span>
                <span>åŠ è½½</span>
            </button>
        </div>
    </div>

    <!-- é€šçŸ¥å®¹å™¨ -->
    <div id="notification-container"></div>

    <!-- ====== å¼¹çª—ç³»ç»Ÿ ====== -->
    
    <!-- èµ„æºç®¡ç†å¼¹çª— -->
    <div id="resources-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ğŸ“¦ èµ„æºç®¡ç†</div>
            <button class="close-btn" onclick="document.getElementById('resources-modal').style.display='none'">Ã—</button>
            <div id="resources-list" style="margin-top: 10px;"></div>
        </div>
    </div>

    <!-- ç§‘æŠ€æ ‘å¼¹çª— -->
    <div id="tech-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ğŸ”¬ ç§‘æŠ€æ ‘</div>
            <button class="close-btn" onclick="document.getElementById('tech-modal').style.display='none'">Ã—</button>
            <div id="tech-list" style="margin-top: 10px;"></div>
        </div>
    </div>

    <!-- åŸºåœ°å‡çº§å¼¹çª— -->
    <div id="upgrade-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">â¬†ï¸ åŸºåœ°å‡çº§</div>
            <button class="close-btn" onclick="document.getElementById('upgrade-modal').style.display='none'">Ã—</button>
            <div id="upgrade-list" style="margin-top: 10px;"></div>
        </div>
    </div>

    <!-- æˆå°±å¼¹çª— -->
    <div id="achievements-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ğŸ† æˆå°±ç³»ç»Ÿ</div>
            <button class="close-btn" onclick="document.getElementById('achievements-modal').style.display='none'">Ã—</button>
            <div id="achievements-list" style="margin-top: 10px;"></div>
        </div>
    </div>

    <!-- æ¢ç´¢å¼¹çª— -->
    <div id="explore-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ğŸ§­ æ¢ç´¢åºŸåœŸ</div>
            <button class="close-btn" onclick="document.getElementById('explore-modal').style.display='none'">Ã—</button>
            <div id="explore-options" style="margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px;"></div>
        </div>
    </div>

    <!-- è®¾ç½®å¼¹çª— -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">âš™ï¸ æ¸¸æˆè®¾ç½®</div>
            <button class="close-btn" onclick="document.getElementById('settings-modal').style.display='none'">Ã—</button>
            
            <div class="settings-item">
                <span>ğŸµ èƒŒæ™¯éŸ³ä¹</span>
                <div class="music-controls">
                    <label class="switch">
                        <input type="checkbox" id="music-toggle" checked>
                        <span class="slider"></span>
                    </label>
                    <button class="btn btn-small" id="btn-change-music" style="padding: 3px 8px;">
                        åˆ‡æ¢éŸ³ä¹
                    </button>
                </div>
            </div>
            
            <div class="settings-item">
                <span>ğŸ”Š éŸ³ä¹éŸ³é‡</span>
                <input type="range" id="music-volume" min="0" max="100" value="30">
            </div>
            
            <div class="settings-item">
                <span>âš¡ æ¸¸æˆé€Ÿåº¦</span>
                <select id="game-speed" style="background: #34495e; color: white; border: 1px solid #555; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                    <option value="0.1">0.1x (ææ…¢)</option>
                    <option value="0.5">0.5x (æ…¢é€Ÿ)</option>
                    <option value="1">1x (æ­£å¸¸)</option>
                    <option value="2">2x (å¿«é€Ÿ)</option>
                    <option value="5">5x (æå¿«)</option>
                </select>
            </div>
            
            <div class="settings-item">
                <span>ğŸ”„ å±å¹•æ–¹å‘</span>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-small" id="btn-portrait" style="padding: 3px 8px;">ğŸ“± ç«–å±</button>
                    <button class="btn btn-small" id="btn-landscape" style="padding: 3px 8px;">ğŸ”„ æ¨ªå±</button>
                </div>
            </div>
            
            <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                <button class="btn btn-danger" id="btn-exit-game" style="width: 100%; margin-bottom: 8px;">
                    ğŸšª é€€å‡ºæ¸¸æˆ
                </button>
            </div>
            
            <div style="margin-top: 15px; font-size: 10px; color: #8899cc; text-align: center;">
                ã€ŠåºŸåœŸæ–¹èˆŸã€‹æœ€ç»ˆç‰ˆ v1.0<br>
                ç”Ÿå­˜å¤©æ•°: <span id="settings-game-day">1</span>
            </div>
        </div>
    </div>

    <!-- æˆ˜æ–—å¼¹çª— -->
    <div id="combat-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">âš”ï¸ ä¸§å°¸æ¥è¢­ï¼</div>
            <button class="close-btn" onclick="document.getElementById('combat-modal').style.display='none'">Ã—</button>
            <div id="enemy-info"></div>
            <div class="combat-log" id="combat-log"></div>
            <div class="combat-actions">
                <button class="btn btn-success" id="btn-attack">ğŸ—¡ï¸ æ”»å‡»</button>
                <button class="btn" id="btn-defend">ğŸ›¡ï¸ é˜²å¾¡</button>
                <button class="btn btn-danger" id="btn-flee">ğŸƒ æ’¤é€€</button>
            </div>
        </div>
    </div>

    <!-- JavaScript ä»£ç  -->
    <script>
        // ====== æ¸¸æˆæ ¸å¿ƒç±» ======
        class SurvivalGame {
            constructor() {
                // æ¸¸æˆçŠ¶æ€
                this.gameState = {
                    day: 1,
                    hour: 6,
                    minute: 0,
                    second: 0,
                    weather: 'clear',
                    paused: false,
                    threat: 1,
                    tech: new Set(),
                    explored: new Set(),
                    achievements: new Set(),
                    settings: {
                        music: true,
                        speed: 1,
                        orientation: 'portrait',
                        volume: 0.3
                    }
                };
                
                // èµ„æºç³»ç»Ÿ
                this.resources = {
                    'é£Ÿç‰©': { amount: 100, max: 500, prod: 5, cons: 8, icon: 'ğŸ' },
                    'æ°´': { amount: 80, max: 300, prod: 3, cons: 6, icon: 'ğŸ’§' },
                    'ææ–™': { amount: 50, max: 1000, prod: 2, cons: 1, icon: 'ğŸ”¨' },
                    'è¯å“': { amount: 20, max: 200, prod: 0.5, cons: 0.2, icon: 'ğŸ’Š' },
                    'å¼¹è¯': { amount: 50, max: 500, prod: 1, cons: 0, icon: 'ğŸ”«' }
                };
                
                // å¹¸å­˜è€…
                this.survivorNames = ['å¼ ä¼Ÿ', 'æå¨œ', 'ç‹åˆš', 'èµµæ•', 'åˆ˜å¼º', 'é™ˆé™', 'å­™æµ©', 'å‘¨å©·'];
                this.survivors = [
                    this.createRandomSurvivor(1),
                    this.createRandomSurvivor(2),
                    this.createRandomSurvivor(3)
                ];
                
                // å»ºç­‘
                this.buildings = [
                    { id: 1, type: 'æŒ‡æŒ¥ä¸­å¿ƒ', level: 1, x: 150, y: 100 },
                    { id: 2, type: 'å®¿èˆ', level: 1, x: 100, y: 160 },
                    { id: 3, type: 'å¨æˆ¿', level: 1, x: 200, y: 160 }
                ];
                
                // äº‹ä»¶æ—¥å¿—
                this.events = [
                    { time: '06:00:00', message: 'æ–°çš„ä¸€å¤©å¼€å§‹äº†', type: 'info' }
                ];
                
                // ç§‘æŠ€æ ‘
                this.techTree = [
                    { id: 'basic_farming', name: 'åŸºç¡€å†œä¸š', cost: 50, desc: 'é£Ÿç‰©äº§é‡+20%', time: 24, icon: 'ğŸŒ±', require: [] },
                    { id: 'water_purify', name: 'å‡€æ°´æŠ€æœ¯', cost: 40, desc: 'æ°´æ¶ˆè€—-30%', time: 18, icon: 'ğŸ’§', require: [] },
                    { id: 'advanced_defense', name: 'é«˜çº§é˜²å¾¡', cost: 60, desc: 'é˜²å¾¡åŠ›+50%', time: 36, icon: 'ğŸ›¡ï¸', require: [] },
                    { id: 'solar_power', name: 'å¤ªé˜³èƒ½æŠ€æœ¯', cost: 70, desc: 'ææ–™+10/å°æ—¶', time: 48, icon: 'â˜€ï¸', require: ['advanced_defense'] }
                ];
                
                // æˆå°±ç³»ç»Ÿ
                this.achievementList = [
                    { id: 'first_light', name: 'ç¬¬ä¸€é“å…‰', desc: 'å»ºé€ ç¬¬ä¸€ä¸ªå»ºç­‘', icon: 'ğŸ—ï¸', condition: () => this.buildings.length >= 4 },
                    { id: 'dawn_breaker', name: 'ç ´æ™“ä¹‹äºº', desc: 'ç”Ÿå­˜è¶…è¿‡7å¤©', icon: 'ğŸŒ…', condition: () => this.gameState.day >= 7 },
                    { id: 'ark_heart', name: 'æ–¹èˆŸä¹‹å¿ƒ', desc: 'æ”¶å®¹5åå¹¸å­˜è€…', icon: 'â¤ï¸', condition: () => this.survivors.length >= 5 },
                    { id: 'explorer', name: 'æ¢ç´¢è€…', desc: 'æ¢ç´¢æ‰€æœ‰åœ°ç‚¹', icon: 'ğŸ§­', condition: () => this.gameState.explored.size >= 4 },
                    { id: 'zombie_slayer', name: 'ä¸§å°¸æ€æ‰‹', desc: 'å‡»è´¥10ä¸ªæ•Œäºº', icon: 'ğŸ§Ÿ', condition: () => this.gameState.threat >= 3 }
                ];
                
                // æ¢ç´¢åœ°ç‚¹
                this.exploreLocations = [
                    { name: 'åºŸå¢Ÿ', risk: 0.2, icon: 'ğŸšï¸', rewards: { 'ææ–™': 30, 'è¯å“': 10 } },
                    { name: 'åŒ»é™¢', risk: 0.4, icon: 'ğŸ¥', rewards: { 'è¯å“': 40, 'ææ–™': 15 } },
                    { name: 'è¶…å¸‚', risk: 0.3, icon: 'ğŸ›’', rewards: { 'é£Ÿç‰©': 50, 'æ°´': 30 } },
                    { name: 'å†›äº‹åŸºåœ°', risk: 0.6, icon: 'ğŸ–ï¸', rewards: { 'å¼¹è¯': 80, 'ææ–™': 40 } }
                ];
                
                // å»ºç­‘å‡çº§é€‰é¡¹
                this.buildingUpgrades = [
                    { name: 'å¼ºåŒ–å¢™å£', cost: 100, desc: 'åŸºåœ°é˜²å¾¡+20%', effect: () => this.gameState.threat = Math.max(1, this.gameState.threat - 1) },
                    { name: 'æ‰©å¤§ä»“åº“', cost: 150, desc: 'æ‰€æœ‰èµ„æºä¸Šé™+50', effect: () => Object.values(this.resources).forEach(r => r.max += 50) },
                    { name: 'æ”¹å–„ä¾›æ°´', cost: 120, desc: 'æ°´äº§é‡+5/å°æ—¶', effect: () => this.resources['æ°´'].prod += 5 },
                    { name: 'è‡ªåŠ¨é˜²å¾¡', cost: 200, desc: 'è‡ªåŠ¨å‡»é€€å°‘é‡ä¸§å°¸', effect: () => this.addEvent('è‡ªåŠ¨é˜²å¾¡ç³»ç»Ÿå·²å¯ç”¨', 'success') }
                ];
                
                // æ•Œäººç³»ç»Ÿ
                this.enemies = [];
                this.combatActive = false;
                this.currentEnemy = null;
                
                // éŸ³é¢‘ç³»ç»Ÿï¼ˆå¢å¼ºç‰ˆï¼‰
                this.audio = {
                    bgMusic: null,
                    bgMusicVolume: 0.3,
                    currentTrack: 0,
                    musicEnabled: true,
                    tracks: [
                        { name: 'åºŸåœŸä¸»é¢˜', url: 'https://assets.mixkit.co/music/preview/mixkit-game-level-music-689.mp3' },
                        { name: 'ç”Ÿå­˜ä¸»é¢˜', url: 'https://assets.mixkit.co/music/preview/mixkit-tech-house-vibes-130.mp3' },
                        { name: 'æ¢ç´¢ä¸»é¢˜', url: 'https://assets.mixkit.co/music/preview/mixkit-driving-ambition-32.mp3' }
                    ]
                };
                
                // åˆå§‹åŒ–
                this.init();
            }
            
            init() {
                this.initCanvas();
                this.setupUI();
                this.initAudio();
                this.startGameLoop();
                this.loadGame();
                
                setTimeout(() => {
                    document.getElementById('loading-screen').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('loading-screen').style.display = 'none';
                        document.getElementById('game-container').style.display = 'flex';
                        this.showNotification('åºŸåœŸæ–¹èˆŸå·²å¯åŠ¨', 'success');
                    }, 500);
                }, 1500);
            }
            
            initCanvas() {
                this.canvas = document.getElementById('base-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.resizeCanvas();
                this.drawBase();
                window.addEventListener('resize', () => this.resizeCanvas());
            }
            
            resizeCanvas() {
                const container = document.getElementById('map-container');
                this.canvas.width = container.clientWidth;
                this.canvas.height = container.clientHeight;
                this.drawBase();
            }
            
            initAudio() {
                if (!this.audio.musicEnabled) return;
                
                // åˆ›å»ºéŸ³é¢‘å…ƒç´ 
                this.audio.bgMusic = new Audio();
                this.audio.bgMusic.loop = true;
                this.audio.bgMusic.volume = this.audio.bgMusicVolume;
                
                // è®¾ç½®ç¬¬ä¸€é¦–éŸ³ä¹
                this.loadMusicTrack(this.audio.currentTrack);
                
                // éŸ³é¢‘äº‹ä»¶ç›‘å¬
                this.audio.bgMusic.addEventListener('ended', () => {
                    this.audio.currentTrack = (this.audio.currentTrack + 1) % this.audio.tracks.length;
                    this.loadMusicTrack(this.audio.currentTrack);
                    this.audio.bgMusic.play().catch(e => console.log('èƒŒæ™¯éŸ³ä¹è‡ªåŠ¨åˆ‡æ¢å¤±è´¥'));
                });
                
                // å°è¯•æ’­æ”¾éŸ³ä¹
                this.tryPlayMusic();
            }
            
            loadMusicTrack(index) {
                if (this.audio.tracks[index]) {
                    this.audio.bgMusic.src = this.audio.tracks[index].url;
                    // é™éŸ³åŠ è½½
                    this.audio.bgMusic.muted = true;
                    this.audio.bgMusic.load();
                    this.audio.bgMusic.muted = false;
                }
            }
            
            tryPlayMusic() {
                if (this.gameState.settings.music && this.audio.bgMusic) {
                    const playPromise = this.audio.bgMusic.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(e => {
                            console.log('èƒŒæ™¯éŸ³ä¹æ’­æ”¾å¤±è´¥ï¼Œéœ€è¦ç”¨æˆ·äº¤äº’');
                            // æ˜¾ç¤ºæç¤ºï¼Œéœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½æ’­æ”¾éŸ³ä¹
                            this.showNotification('ç‚¹å‡»ä»»æ„ä½ç½®ä»¥å¯ç”¨èƒŒæ™¯éŸ³ä¹', 'info', 5000);
                            
                            // æ·»åŠ ä¸€æ¬¡æ€§ç‚¹å‡»äº‹ä»¶æ¥å¯ç”¨éŸ³é¢‘
                            const enableAudio = () => {
                                this.audio.bgMusic.play().then(() => {
                                    console.log('èƒŒæ™¯éŸ³ä¹å·²å¯ç”¨');
                                    this.showNotification('èƒŒæ™¯éŸ³ä¹å·²å¯ç”¨', 'success');
                                }).catch(e2 => {
                                    console.log('ç”¨æˆ·æ‹’ç»æ’­æ”¾éŸ³ä¹');
                                });
                                
                                // ç§»é™¤äº‹ä»¶ç›‘å¬
                                document.removeEventListener('click', enableAudio);
                                document.removeEventListener('touchstart', enableAudio);
                            };
                            
                            document.addEventListener('click', enableAudio);
                            document.addEventListener('touchstart', enableAudio);
                        });
                    }
                }
            }
            
            setupUI() {
                this.updateUI();
                this.bindEvents();
                this.generateExploreOptions();
                this.updateAchievementsList();
                this.setupModalCloseButtons();
            }
            
            bindEvents() {
                // çŠ¶æ€æ æŒ‰é’®
                document.getElementById('btn-explore').addEventListener('click', () => {
                    document.getElementById('explore-modal').style.display = 'flex';
                });
                
                document.getElementById('btn-settings').addEventListener('click', () => {
                    this.showSettings();
                });
                
                // æ§åˆ¶é¢æ¿æŒ‰é’®
                document.getElementById('btn-resources').addEventListener('click', () => {
                    this.showResourcesModal();
                });
                
                document.getElementById('btn-tech').addEventListener('click', () => {
                    this.showTechModal();
                });
                
                document.getElementById('btn-upgrade').addEventListener('click', () => {
                    this.showUpgradeModal();
                });
                
                document.getElementById('btn-achievements').addEventListener('click', () => {
                    this.showAchievementsModal();
                });
                
                document.getElementById('btn-save').addEventListener('click', () => {
                    this.saveGame();
                });
                
                document.getElementById('btn-load').addEventListener('click', () => {
                    this.loadGame();
                });
                
                // è®¾ç½®é¢æ¿
                document.getElementById('music-toggle').addEventListener('change', (e) => {
                    this.gameState.settings.music = e.target.checked;
                    this.audio.musicEnabled = e.target.checked;
                    
                    if (e.target.checked) {
                        if (!this.audio.bgMusic) {
                            this.initAudio();
                        } else {
                            this.tryPlayMusic();
                        }
                        this.showNotification('èƒŒæ™¯éŸ³ä¹å·²å¼€å¯', 'success');
                    } else {
                        if (this.audio.bgMusic) {
                            this.audio.bgMusic.pause();
                        }
                        this.showNotification('èƒŒæ™¯éŸ³ä¹å·²å…³é—­', 'warning');
                    }
                    this.saveSettings();
                });
                
                // éŸ³ä¹åˆ‡æ¢æŒ‰é’®
                document.getElementById('btn-change-music').addEventListener('click', () => {
                    this.changeMusicTrack();
                });
                
                // éŸ³é‡æ§åˆ¶
                document.getElementById('music-volume').addEventListener('input', (e) => {
                    const volume = e.target.value / 100;
                    this.audio.bgMusicVolume = volume;
                    this.gameState.settings.volume = volume;
                    if (this.audio.bgMusic) {
                        this.audio.bgMusic.volume = volume;
                    }
                    this.saveSettings();
                });
                
                document.getElementById('game-speed').addEventListener('change', (e) => {
                    this.gameState.settings.speed = parseFloat(e.target.value);
                    this.saveSettings();
                });
                
                document.getElementById('btn-portrait').addEventListener('click', () => {
                    this.setOrientation('portrait');
                });
                
                document.getElementById('btn-landscape').addEventListener('click', () => {
                    this.setOrientation('landscape');
                });
                
                document.getElementById('btn-exit-game').addEventListener('click', () => {
                    if (confirm('ç¡®å®šè¦é€€å‡ºæ¸¸æˆå—ï¼Ÿ')) {
                        this.saveGame();
                        window.close();
                    }
                });
                
                // æˆ˜æ–—æŒ‰é’®
                document.getElementById('btn-attack').addEventListener('click', () => this.combatAction('attack'));
                document.getElementById('btn-defend').addEventListener('click', () => this.combatAction('defend'));
                document.getElementById('btn-flee').addEventListener('click', () => this.combatAction('flee'));
                
                // åœ°å›¾ç‚¹å‡»
                this.canvas.addEventListener('click', (e) => {
                    const rect = this.canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    this.buildings.forEach(building => {
                        const scale = this.canvas.width / 400;
                        const bX = building.x * scale;
                        const bY = building.y * scale;
                        const size = 40 * scale;
                        
                        if (x >= bX && x <= bX + size && y >= bY && y <= bY + size) {
                            this.showBuildingInfo(building);
                        }
                    });
                });
                
                // PWAå®‰è£…æç¤º
                let deferredPrompt;
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    deferredPrompt = e;
                    document.getElementById('install-prompt').style.display = 'block';
                });
                
                document.getElementById('install-btn').addEventListener('click', async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        if (outcome === 'accepted') {
                            document.getElementById('install-prompt').style.display = 'none';
                        }
                    }
                });
            }
            
            setupModalCloseButtons() {
                // ä¸ºæ‰€æœ‰å¼¹çª—æ·»åŠ ESCé”®å…³é—­
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeAllModals();
                    }
                });
                
                // ä¸ºæ‰€æœ‰å¼¹çª—æ·»åŠ ç‚¹å‡»èƒŒæ™¯å…³é—­
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.style.display = 'none';
                        }
                    });
                });
            }
            
            closeAllModals() {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    modal.style.display = 'none';
                });
            }
            
            setOrientation(orientation) {
                this.gameState.settings.orientation = orientation;
                document.body.className = orientation + '-mode';
                this.saveSettings();
                setTimeout(() => {
                    this.resizeCanvas();
                }, 100);
            }
            
            changeMusicTrack() {
                if (!this.audio.musicEnabled || !this.audio.bgMusic) return;
                
                this.audio.currentTrack = (this.audio.currentTrack + 1) % this.audio.tracks.length;
                this.loadMusicTrack(this.audio.currentTrack);
                
                const currentTrack = this.audio.tracks[this.audio.currentTrack];
                this.audio.bgMusic.play().then(() => {
                    this.showNotification(`åˆ‡æ¢éŸ³ä¹ï¼š${currentTrack.name}`, 'success');
                }).catch(e => {
                    console.log('éŸ³ä¹åˆ‡æ¢æ’­æ”¾å¤±è´¥');
                });
            }
            
            updateUI() {
                // çŠ¶æ€æ 
                document.getElementById('day-count').textContent = `ç¬¬${this.gameState.day}å¤©`;
                
                // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤ºï¼ˆæ—¶:åˆ†:ç§’ï¼‰
                const timeStr = `${this.gameState.hour.toString().padStart(2, '0')}:${this.gameState.minute.toString().padStart(2, '0')}:${this.gameState.second.toString().padStart(2, '0')}`;
                document.getElementById('time-display').textContent = timeStr;
                
                const weatherMap = {
                    'clear': 'â˜€ï¸æ™´æœ—', 'rain': 'ğŸŒ§ï¸é›¨å¤©', 
                    'fog': 'ğŸŒ«ï¸é›¾å¤©', 'storm': 'â›ˆï¸æš´é£é›¨'
                };
                document.getElementById('weather').textContent = 
                    weatherMap[this.gameState.weather] || this.gameState.weather;
                
                document.getElementById('settings-game-day').textContent = this.gameState.day;
                
                // ç”»å¸ƒ
                this.drawBase();
            }
            
            showResourcesModal() {
                const container = document.getElementById('resources-list');
                container.innerHTML = '';
                
                for (const [name, data] of Object.entries(this.resources)) {
                    const percent = (data.amount / data.max) * 100;
                    const color = percent > 50 ? '#2ecc71' : percent > 20 ? '#f39c12' : '#e74c3c';
                    
                    const item = document.createElement('div');
                    item.className = 'resource-item';
                    item.innerHTML = `
                        <div class="resource-icon">${data.icon}</div>
                        <div style="flex: 1;">
                            <div>${name}</div>
                            <div class="resource-bar">
                                <div class="resource-fill" style="width: ${percent}%; background: ${color};"></div>
                            </div>
                            <div style="font-size: 10px; color: #aaa;">
                                ${Math.floor(data.amount)}/${data.max}
                                <span style="color: ${data.prod > data.cons ? '#2ecc71' : '#e74c3c'}; margin-left: 5px;">
                                    ${data.prod > data.cons ? '+' : ''}${(data.prod - data.cons).toFixed(1)}/h
                                </span>
                            </div>
                        </div>
                    `;
                    container.appendChild(item);
                }
                
                const modal = document.getElementById('resources-modal');
                modal.style.display = 'flex';
                
                // å°†å¼¹çª—å†…å®¹æ»šåŠ¨åˆ°é¡¶éƒ¨
                setTimeout(() => {
                    const modalContent = modal.querySelector('.modal-content');
                    if (modalContent) {
                        modalContent.scrollTop = 0;
                    }
                }, 10);
            }
            
            showTechModal() {
                const container = document.getElementById('tech-list');
                container.innerHTML = '';
                
                this.techTree.forEach(tech => {
                    const canResearch = this.canResearchTech(tech);
                    const researched = this.gameState.tech.has(tech.id);
                    
                    const item = document.createElement('div');
                    item.className = `tech-item ${researched ? 'researched' : ''} ${!canResearch && !researched ? 'insufficient' : ''}`;
                    item.innerHTML = `
                        <div>${tech.icon} ${tech.name}</div>
                        <div style="font-size: 10px; color: #8899cc;">${tech.desc}</div>
                        <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                            <span style="color: #f39c12; font-size: 10px;">${tech.cost}ææ–™</span>
                            ${researched ? 
                                '<span style="color: #2ecc71; font-size: 10px;">âœ…å·²ç ”ç©¶</span>' : 
                                canResearch ? 
                                `<button class="btn btn-small" onclick="game.researchTech('${tech.id}')" style="padding: 2px 8px;">ç ”ç©¶</button>` :
                                '<span style="color: #e74c3c; font-size: 10px;">ğŸ”’æœªè§£é”</span>'
                            }
                        </div>
                    `;
                    
                    if (tech.require.length > 0) {
                        const reqNames = tech.require.map(r => this.techTree.find(t => t.id === r)?.name || r);
                        item.innerHTML += `<div style="font-size: 9px; color: #f39c12; margin-top: 3px;">éœ€è¦: ${reqNames.join(', ')}</div>`;
                    }
                    
                    container.appendChild(item);
                });
                
                const modal = document.getElementById('tech-modal');
                modal.style.display = 'flex';
                
                setTimeout(() => {
                    const modalContent = modal.querySelector('.modal-content');
                    if (modalContent) {
                        modalContent.scrollTop = 0;
                    }
                }, 10);
            }
            
            showUpgradeModal() {
                const container = document.getElementById('upgrade-list');
                container.innerHTML = '';
                
                this.buildingUpgrades.forEach(upgrade => {
                    const canAfford = this.resources['ææ–™'].amount >= upgrade.cost;
                    
                    const item = document.createElement('div');
                    item.className = `tech-item ${canAfford ? '' : 'insufficient'}`;
                    item.innerHTML = `
                        <div style="font-weight: bold; margin-bottom: 3px;">${upgrade.name}</div>
                        <div style="font-size: 10px; color: #8899cc; margin-bottom: 5px;">${upgrade.desc}</div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #f39c12; font-size: 11px;">${upgrade.cost}ææ–™</span>
                            ${canAfford ? 
                                `<button class="btn btn-small" onclick="game.purchaseUpgrade(${JSON.stringify(upgrade).replace(/"/g, '&quot;')})" style="padding: 2px 8px;">å‡çº§</button>` :
                                '<span style="color: #e74c3c; font-size: 10px;">ææ–™ä¸è¶³</span>'
                            }
                        </div>
                    `;
                    container.appendChild(item);
                });
                
                const modal = document.getElementById('upgrade-modal');
                modal.style.display = 'flex';
                
                setTimeout(() => {
                    const modalContent = modal.querySelector('.modal-content');
                    if (modalContent) {
                        modalContent.scrollTop = 0;
                    }
                }, 10);
            }
            
            showAchievementsModal() {
                const container = document.getElementById('achievements-list');
                container.innerHTML = '';
                
                this.achievementList.forEach(achievement => {
                    const unlocked = this.gameState.achievements.has(achievement.id);
                    
                    const item = document.createElement('div');
                    item.className = `achievement-item ${unlocked ? '' : 'locked'}`;
                    item.innerHTML = `
                        <div class="achievement-icon">${achievement.icon}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; font-size: 12px;">${achievement.name}</div>
                            <div style="font-size: 10px; color: #8899cc;">${achievement.desc}</div>
                            <div style="font-size: 9px; color: ${unlocked ? '#2ecc71' : '#e74c3c'}; margin-top: 3px;">
                                ${unlocked ? 'âœ… å·²è§£é”' : 'ğŸ”’ æœªè§£é”'}
                            </div>
                        </div>
                    `;
                    container.appendChild(item);
                });
                
                const modal = document.getElementById('achievements-modal');
                modal.style.display = 'flex';
                
                setTimeout(() => {
                    const modalContent = modal.querySelector('.modal-content');
                    if (modalContent) {
                        modalContent.scrollTop = 0;
                    }
                }, 10);
            }
            
            generateExploreOptions() {
                const container = document.getElementById('explore-options');
                container.innerHTML = '';
                
                this.exploreLocations.forEach(location => {
                    const button = document.createElement('button');
                    button.className = 'btn';
                    button.style.flexDirection = 'column';
                    button.style.height = 'auto';
                    button.style.padding = '10px 5px';
                    button.innerHTML = `
                        <span style="font-size: 24px;">${location.icon}</span>
                        <span style="font-size: 12px; margin-top: 5px;">${location.name}</span>
                        <span style="font-size: 10px; color: ${location.risk < 0.3 ? '#2ecc71' : location.risk < 0.5 ? '#f39c12' : '#e74c3c'};">
                            ${location.risk < 0.3 ? 'ä½é£é™©' : location.risk < 0.5 ? 'ä¸­é£é™©' : 'é«˜é£é™©'}
                        </span>
                    `;
                    
                    button.addEventListener('click', () => {
                        this.exploreLocation(location);
                        document.getElementById('explore-modal').style.display = 'none';
                    });
                    
                    container.appendChild(button);
                });
            }
            
            showSettings() {
                const modal = document.getElementById('settings-modal');
                modal.style.display = 'flex';
                
                setTimeout(() => {
                    const modalContent = modal.querySelector('.modal-content');
                    if (modalContent) {
                        modalContent.scrollTop = 0;
                    }
                }, 10);
            }
            
            // ====== æ¸¸æˆå¾ªç¯ ======
            startGameLoop() {
                setInterval(() => {
                    this.updateGame();
                }, 1000 / this.gameState.settings.speed);
            }
            
            updateGame() {
                // æ—¶é—´æµé€ï¼ˆç§’çº§æ›´æ–°ï¼‰
                this.gameState.second++;
                if (this.gameState.second >= 60) {
                    this.gameState.second = 0;
                    this.gameState.minute++;
                    
                    if (this.gameState.minute >= 60) {
                        this.gameState.minute = 0;
                        this.gameState.hour++;
                        
                        if (this.gameState.hour >= 24) {
                            this.gameState.hour = 0;
                            this.gameState.day++;
                            this.addEvent(`ç¬¬${this.gameState.day}å¤©å¼€å§‹äº†`, 'info');
                            
                            // æ¯å¤©å¢åŠ å¨èƒ
                            if (this.gameState.day % 3 === 0) {
                                this.gameState.threat = Math.min(10, this.gameState.threat + 1);
                                this.addEvent('å¨èƒç­‰çº§æå‡äº†ï¼', 'warning');
                            }
                        }
                    }
                }
                
                // éšæœºå¤©æ°”
                if (Math.random() < 0.001) { // é™ä½å¤©æ°”å˜åŒ–é¢‘ç‡
                    const weathers = ['clear', 'rain', 'fog', 'storm'];
                    this.gameState.weather = weathers[Math.floor(Math.random() * weathers.length)];
                }
                
                // æ¯ç§’æ›´æ–°èµ„æº
                for (const [name, data] of Object.entries(this.resources)) {
                    const net = (data.prod - data.cons) / 3600; // æ¯ç§’äº§é‡
                    data.amount = Math.max(0, Math.min(data.amount + net, data.max));
                }
                
                // æ¯åˆ†é’Ÿæ›´æ–°å¹¸å­˜è€…çŠ¶æ€
                if (this.gameState.second === 0) {
                    this.survivors.forEach(survivor => {
                        survivor.hunger += 0.1;
                        survivor.energy -= 0.05;
                        
                        if (survivor.hunger > 80) survivor.health -= 0.2;
                        if (survivor.energy < 30) survivor.health -= 0.1;
                        
                        // è‡ªåŠ¨æ¢å¤
                        if (survivor.hunger < 20 && survivor.energy > 70) {
                            survivor.health = Math.min(100, survivor.health + 0.05);
                        }
                        
                        // é™åˆ¶èŒƒå›´
                        survivor.hunger = Math.max(0, Math.min(100, survivor.hunger));
                        survivor.energy = Math.max(0, Math.min(100, survivor.energy));
                        survivor.health = Math.max(0, Math.min(100, survivor.health));
                        
                        // æ­»äº¡æ£€æŸ¥
                        if (survivor.health <= 0) {
                            this.handleDeath(survivor);
                        }
                    });
                }
                
                // æ¯å°æ—¶éšæœºäº‹ä»¶
                if (this.gameState.minute === 0 && this.gameState.second === 0 && Math.random() < 0.3) {
                    this.randomEvent();
                }
                
                // éšæœºæ•Œäºº
                if (Math.random() < 0.0005 + this.gameState.threat * 0.0001) {
                    this.spawnEnemy();
                }
                
                // æ£€æŸ¥æˆå°±
                this.checkAchievements();
                
                // æ›´æ–°UI
                this.updateUI();
            }
            
            // ====== æ¸¸æˆåŠŸèƒ½æ–¹æ³• ======
            createRandomSurvivor(id) {
                const name = this.survivorNames[Math.floor(Math.random() * this.survivorNames.length)];
                const skills = ['å»ºé€ ', 'åŒ»ç–—', 'æˆ˜æ–—', 'æ¢ç´¢', 'ç ”ç©¶'];
                const skill = skills[Math.floor(Math.random() * skills.length)];
                
                return {
                    id: id,
                    name: name,
                    health: 70 + Math.floor(Math.random() * 30),
                    hunger: 40 + Math.floor(Math.random() * 40),
                    energy: 60 + Math.floor(Math.random() * 40),
                    skill: skill,
                    status: 'ç©ºé—²',
                    experience: 0,
                    level: 1
                };
            }
            
            addEvent(message, type = 'info') {
                const time = `${this.gameState.hour.toString().padStart(2, '0')}:${this.gameState.minute.toString().padStart(2, '0')}:${this.gameState.second.toString().padStart(2, '0')}`;
                this.events.push({ time, message, type });
                
                this.showNotification(message, type);
            }
            
            showNotification(message, type = 'info', duration = 3000) {
                const container = document.getElementById('notification-container');
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                // è®¾ç½®è‡ªå®šä¹‰æ ·å¼
                notification.style.animation = `fadeIn 0.3s, fadeOut 0.3s ${duration - 300}ms forwards`;
                
                container.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, duration);
            }
            
            // ====== å»ºç­‘ç³»ç»Ÿ ======
            buildStructure(type, cost) {
                if (this.resources['ææ–™'].amount < cost) {
                    this.showNotification(`ææ–™ä¸è¶³ï¼éœ€è¦${cost}ææ–™`, 'danger');
                    return;
                }
                
                this.resources['ææ–™'].amount -= cost;
                
                const newId = this.buildings.length + 1;
                const x = 50 + (this.buildings.length % 4) * 80;
                const y = 50 + Math.floor(this.buildings.length / 4) * 70;
                
                const building = {
                    id: newId,
                    type: type,
                    level: 1,
                    x: Math.min(x, 320),
                    y: Math.min(y, 210)
                };
                
                this.buildings.push(building);
                
                switch(type) {
                    case 'å¨æˆ¿':
                        this.resources['é£Ÿç‰©'].prod += 3;
                        break;
                    case 'åŒ»ç–—ç«™':
                        this.resources['è¯å“'].prod += 2;
                        break;
                    case 'ä»“åº“':
                        Object.values(this.resources).forEach(r => r.max += 200);
                        break;
                }
                
                this.addEvent(`å»ºé€ äº†æ–°çš„${type}`, 'success');
                this.checkAchievement('first_light');
                this.updateUI();
            }
            
            showBuildingInfo(building) {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                `;
                
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 250px;">
                        <div class="modal-title">${this.getBuildingEmoji(building.type)} ${building.type}</div>
                        <button class="close-btn" style="top: 8px; right: 8px;">Ã—</button>
                        <div style="padding: 10px;">
                            <div style="margin-bottom: 8px; color: #aabbee;">ç­‰çº§: ${building.level}</div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-close-building" 
                                        style="flex: 1; background: #e74c3c;">
                                    å…³é—­
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                modal.querySelector('.btn-close-building').addEventListener('click', () => {
                    modal.remove();
                });
                
                modal.querySelector('.close-btn').addEventListener('click', () => {
                    modal.remove();
                });
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }
            
            getBuildingEmoji(type) {
                const emojis = {
                    'æŒ‡æŒ¥ä¸­å¿ƒ': 'ğŸ¢', 'å®¿èˆ': 'ğŸ›ï¸', 'å¨æˆ¿': 'ğŸ³', 'åŒ»ç–—ç«™': 'ğŸ¥',
                    'ç­æœ›å¡”': 'ğŸ”­', 'ä»“åº“': 'ğŸ“¦', 'ç ”ç©¶æ‰€': 'ğŸ”¬'
                };
                return emojis[type] || 'ğŸ ';
            }
            
            purchaseUpgrade(upgrade) {
                if (this.resources['ææ–™'].amount < upgrade.cost) {
                    this.showNotification(`éœ€è¦${upgrade.cost}ææ–™`, 'danger');
                    return;
                }
                
                this.resources['ææ–™'].amount -= upgrade.cost;
                upgrade.effect();
                this.addEvent(`${upgrade.name}å‡çº§å®Œæˆ`, 'success');
                document.getElementById('upgrade-modal').style.display = 'none';
                this.updateUI();
            }
            
            // ====== å¹¸å­˜è€…ç³»ç»Ÿ ======
            recruitSurvivor() {
                const maxPopulation = 4 + this.buildings.filter(b => b.type === 'å®¿èˆ').length * 4;
                if (this.survivors.length >= maxPopulation) {
                    this.showNotification('äººå£å·²è¾¾ä¸Šé™ï¼Œéœ€è¦å»ºé€ æ›´å¤šå®¿èˆ', 'warning');
                    return;
                }
                
                if (this.resources['é£Ÿç‰©'].amount < 20 || this.resources['æ°´'].amount < 15) {
                    this.showNotification('èµ„æºä¸è¶³ï¼Œæ— æ³•æ‹›å‹Ÿå¹¸å­˜è€…', 'danger');
                    return;
                }
                
                this.resources['é£Ÿç‰©'].amount -= 20;
                this.resources['æ°´'].amount -= 15;
                
                const newId = this.survivors.length + 1;
                const newSurvivor = this.createRandomSurvivor(newId);
                this.survivors.push(newSurvivor);
                
                this.addEvent(`${newSurvivor.name}åŠ å…¥äº†åŸºåœ°`, 'success');
                this.checkAchievement('ark_heart');
                this.updateUI();
            }
            
            handleDeath(survivor) {
                const index = this.survivors.findIndex(s => s.id === survivor.id);
                if (index !== -1) {
                    this.addEvent(`ğŸ˜¢ ${survivor.name}ä¸å¹¸å»ä¸–äº†...`, 'danger');
                    this.survivors.splice(index, 1);
                    this.updateUI();
                }
            }
            
            // ====== æ¢ç´¢ç³»ç»Ÿ ======
            exploreLocation(location) {
                if (this.resources['é£Ÿç‰©'].amount < 10 || this.resources['æ°´'].amount < 5) {
                    this.showNotification('èµ„æºä¸è¶³ï¼Œæ— æ³•æ¢ç´¢', 'danger');
                    return;
                }
                
                this.resources['é£Ÿç‰©'].amount -= 10;
                this.resources['æ°´'].amount -= 5;
                
                let result = '';
                let success = Math.random() > location.risk;
                
                this.gameState.explored.add(location.name);
                this.checkAchievement('explorer');
                
                if (success) {
                    // æˆåŠŸæ¢ç´¢
                    result = `æ¢ç´¢${location.name}æˆåŠŸï¼è·å¾—ï¼š`;
                    for (const [resource, amount] of Object.entries(location.rewards)) {
                        this.resources[resource].amount = Math.min(
                            this.resources[resource].max,
                            this.resources[resource].amount + amount
                        );
                        result += ` ${amount}${resource}`;
                    }
                    
                    this.addEvent(result, 'success');
                    this.showNotification('æ¢ç´¢æˆåŠŸï¼', 'success');
                } else {
                    // æ¢ç´¢å¤±è´¥
                    result = `æ¢ç´¢${location.name}å¤±è´¥ï¼æŸå¤±äº†éƒ¨åˆ†èµ„æº`;
                    this.resources['ææ–™'].amount = Math.max(0, this.resources['ææ–™'].amount - 10);
                    this.addEvent(result, 'danger');
                    this.showNotification('æ¢ç´¢å¤±è´¥ï¼', 'danger');
                }
                
                this.updateUI();
            }
            
            // ====== æˆ˜æ–—ç³»ç»Ÿ ======
            spawnEnemy() {
                if (this.combatActive || this.enemies.length > 0) return;
                
                const enemyType = { 
                    type: 'ä¸§å°¸', 
                    health: 50 + this.gameState.threat * 10, 
                    damage: 10 + this.gameState.threat * 2, 
                    speed: 1, 
                    icon: 'ğŸ§Ÿ' 
                };
                
                const enemy = {
                    ...enemyType,
                    id: 1,
                    maxHealth: enemyType.health,
                    health: enemyType.health
                };
                
                this.enemies.push(enemy);
                this.addEvent(`âš ï¸ ä¸§å°¸æ­£åœ¨æ¥è¿‘åŸºåœ°ï¼`, 'danger');
                
                setTimeout(() => {
                    if (!this.combatActive && this.enemies.length > 0) {
                        this.startCombat();
                    }
                }, 2000);
            }
            
            startCombat() {
                if (this.enemies.length === 0) return;
                
                this.combatActive = true;
                this.currentEnemy = this.enemies[0];
                
                document.getElementById('enemy-info').innerHTML = `
                    <div class="enemy-card">
                        <div style="font-size: 48px;">${this.currentEnemy.icon}</div>
                        <div style="font-size: 18px; margin: 10px 0; color: #e74c3c;">${this.currentEnemy.type}</div>
                        <div>â¤ï¸ ç”Ÿå‘½å€¼: ${this.currentEnemy.health}/${this.currentEnemy.maxHealth}</div>
                        <div>âš”ï¸ ä¼¤å®³: ${this.currentEnemy.damage}</div>
                    </div>
                `;
                
                document.getElementById('combat-log').innerHTML = 
                    `<div style="color: #e74c3c;">${this.currentEnemy.type}å‡ºç°åœ¨åŸºåœ°å¤–å›´ï¼</div>`;
                
                const modal = document.getElementById('combat-modal');
                modal.style.display = 'flex';
                
                setTimeout(() => {
                    const modalContent = modal.querySelector('.modal-content');
                    if (modalContent) {
                        modalContent.scrollTop = 0;
                    }
                }, 10);
            }
            
            combatAction(action) {
                if (!this.currentEnemy) return;
                
                const log = document.getElementById('combat-log');
                
                switch(action) {
                    case 'attack':
                        const playerDamage = 20 + Math.floor(Math.random() * 15) + this.survivors.length * 2;
                        this.currentEnemy.health -= playerDamage;
                        
                        log.innerHTML += `<div>ä½ çš„é˜Ÿä¼å¯¹${this.currentEnemy.type}é€ æˆ${playerDamage}ç‚¹ä¼¤å®³ï¼</div>`;
                        
                        if (this.currentEnemy.health > 0) {
                            const enemyDamage = this.currentEnemy.damage - Math.floor(Math.random() * 5);
                            log.innerHTML += `<div>${this.currentEnemy.type}åå‡»ï¼Œé€ æˆ${enemyDamage}ç‚¹ä¼¤å®³ï¼</div>`;
                        }
                        break;
                        
                    case 'defend':
                        log.innerHTML += `<div>ä½ çš„é˜Ÿä¼é‡‡å–é˜²å¾¡å§¿æ€ï¼Œå‡å°‘äº†ä¸‹ä¸€æ¬¡ä¼¤å®³ï¼</div>`;
                        break;
                        
                    case 'flee':
                        log.innerHTML += `<div>ä½ çš„é˜Ÿä¼æ’¤é€€äº†ï¼æŸå¤±äº†éƒ¨åˆ†èµ„æºã€‚</div>`;
                        this.resources['ææ–™'].amount = Math.max(0, this.resources['ææ–™'].amount - 20);
                        this.resources['é£Ÿç‰©'].amount = Math.max(0, this.resources['é£Ÿç‰©'].amount - 15);
                        this.endCombat(false);
                        return;
                }
                
                if (this.currentEnemy.health <= 0) {
                    log.innerHTML += `<div style="color: #2ecc71;">âœ… å‡»è´¥äº†${this.currentEnemy.type}ï¼</div>`;
                    
                    const reward = Math.floor(Math.random() * 30) + 15;
                    this.resources['å¼¹è¯'].amount += reward;
                    this.addEvent(`å‡»è´¥${this.currentEnemy.type}ï¼Œè·å¾—${reward}å¼¹è¯`, 'success');
                    
                    this.enemies.shift();
                    
                    if (this.enemies.length === 0) {
                        this.checkAchievement('zombie_slayer');
                    }
                    
                    this.endCombat(this.enemies.length === 0);
                } else {
                    log.scrollTop = log.scrollHeight;
                }
                
                this.updateUI();
            }
            
            endCombat(victory) {
                this.combatActive = false;
                this.currentEnemy = null;
                
                setTimeout(() => {
                    document.getElementById('combat-modal').style.display = 'none';
                }, 2000);
                
                if (victory) {
                    this.addEvent('æˆåŠŸå‡»é€€æ•Œäººï¼', 'success');
                }
                
                this.updateUI();
            }
            
            // ====== ç§‘æŠ€ç³»ç»Ÿ ======
            canResearchTech(tech) {
                if (!tech) return false;
                if (this.gameState.tech.has(tech.id)) return false;
                if (this.resources['ææ–™'].amount < tech.cost) return false;
                
                for (const req of tech.require) {
                    if (!this.gameState.tech.has(req)) return false;
                }
                
                return true;
            }
            
            researchTech(techId) {
                const tech = this.techTree.find(t => t.id === techId);
                if (!tech) return;
                
                if (this.gameState.tech.has(techId)) {
                    this.showNotification('è¯¥ç§‘æŠ€å·²ç ”ç©¶å®Œæˆ', 'info');
                    return;
                }
                
                if (!this.canResearchTech(tech)) {
                    if (this.resources['ææ–™'].amount < tech.cost) {
                        this.showNotification(`ææ–™ä¸è¶³ï¼éœ€è¦${tech.cost}ææ–™`, 'danger');
                    } else if (tech.require.length > 0) {
                        this.showNotification('æœªæ»¡è¶³å‰ç½®ç§‘æŠ€æ¡ä»¶', 'warning');
                    }
                    return;
                }
                
                this.resources['ææ–™'].amount -= tech.cost;
                this.gameState.tech.add(tech.id);
                
                this.showNotification(`å¼€å§‹ç ”ç©¶ ${tech.name}`, 'success');
                this.updateUI();
                
                setTimeout(() => {
                    this.showNotification(`${tech.name} ç ”ç©¶å®Œæˆï¼`, 'success');
                    this.applyTechEffect(tech.id);
                    this.updateUI();
                }, tech.time * 1000 * (1 / this.gameState.settings.speed));
            }
            
            applyTechEffect(techId) {
                switch(techId) {
                    case 'basic_farming':
                        this.resources['é£Ÿç‰©'].prod *= 1.2;
                        break;
                    case 'water_purify':
                        this.resources['æ°´'].cons *= 0.7;
                        break;
                    case 'advanced_defense':
                        this.gameState.threat = Math.max(1, this.gameState.threat - 2);
                        break;
                    case 'solar_power':
                        this.resources['ææ–™'].prod += 10;
                        break;
                }
            }
            
            // ====== æˆå°±ç³»ç»Ÿ ======
            checkAchievements() {
                this.achievementList.forEach(achievement => {
                    if (!this.gameState.achievements.has(achievement.id) && achievement.condition()) {
                        this.unlockAchievement(achievement.id);
                    }
                });
            }
            
            unlockAchievement(achievementId) {
                const achievement = this.achievementList.find(a => a.id === achievementId);
                if (achievement && !this.gameState.achievements.has(achievementId)) {
                    this.gameState.achievements.add(achievementId);
                    this.addEvent(`ğŸ† æˆå°±è§£é”ï¼š${achievement.name}`, 'success');
                    this.showAchievementsModal();
                    this.saveGame();
                }
            }
            
            // ====== ç”»å¸ƒç»˜åˆ¶ ======
            drawBase() {
                if (!this.ctx) return;
                
                const ctx = this.ctx;
                const width = this.canvas.width;
                const height = this.canvas.height;
                
                // æ¸…é™¤ç”»å¸ƒ
                ctx.clearRect(0, 0, width, height);
                
                // ç»˜åˆ¶èƒŒæ™¯
                ctx.fillStyle = '#1a1a2e';
                ctx.fillRect(0, 0, width, height);
                
                // ç»˜åˆ¶ç½‘æ ¼
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
                ctx.lineWidth = 1;
                const gridSize = 40;
                for (let x = 0; x < width; x += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, height);
                    ctx.stroke();
                }
                for (let y = 0; y < height; y += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(width, y);
                    ctx.stroke();
                }
                
                // ç»˜åˆ¶åŸºåœ°è¾¹ç•Œ
                ctx.strokeStyle = 'rgba(52, 152, 219, 0.3)';
                ctx.lineWidth = 2;
                ctx.setLineDash([10, 5]);
                ctx.strokeRect(20, 20, width - 40, height - 40);
                ctx.setLineDash([]);
                
                // ç»˜åˆ¶å»ºç­‘
                this.buildings.forEach(building => {
                    this.drawBuildingOnCanvas(building);
                });
            }
            
            drawBuildingOnCanvas(building) {
                const ctx = this.ctx;
                const scale = Math.min(this.canvas.width / 400, this.canvas.height / 300);
                const x = building.x * scale;
                const y = building.y * scale;
                const size = 35 * scale;
                
                // å»ºç­‘é¢œè‰²
                const colors = {
                    'æŒ‡æŒ¥ä¸­å¿ƒ': '#3498db', 'å®¿èˆ': '#2ecc71', 'å¨æˆ¿': '#e74c3c',
                    'åŒ»ç–—ç«™': '#9b59b6', 'ç­æœ›å¡”': '#f1c40f', 'ä»“åº“': '#95a5a6',
                    'ç ”ç©¶æ‰€': '#1abc9c'
                };
                
                // å»ºç­‘ä¸»ä½“
                ctx.fillStyle = colors[building.type] || '#34495e';
                ctx.fillRect(x, y, size, size);
                
                // è¾¹æ¡†
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = 1.5;
                ctx.strokeRect(x, y, size, size);
                
                // å»ºç­‘å›¾æ ‡
                const icon = this.getBuildingEmoji(building.type);
                ctx.fillStyle = 'white';
                ctx.font = `${14 * scale}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(icon, x + size/2, y + size/2);
                
                // ç­‰çº§
                ctx.font = `${8 * scale}px Arial`;
                ctx.fillText(`Lv.${building.level}`, x + size/2, y + size + 10 * scale);
            }
            
            // ====== ä¿å­˜/åŠ è½½ç³»ç»Ÿ ======
            saveGame() {
                const saveData = {
                    gameState: this.gameState,
                    resources: this.resources,
                    survivors: this.survivors,
                    buildings: this.buildings,
                    tech: Array.from(this.gameState.tech),
                    achievements: Array.from(this.gameState.achievements),
                    explored: Array.from(this.gameState.explored)
                };
                
                try {
                    localStorage.setItem('åºŸåœŸæ–¹èˆŸ_save', JSON.stringify(saveData));
                    this.showNotification('æ¸¸æˆè¿›åº¦å·²ä¿å­˜ï¼', 'success');
                } catch (e) {
                    this.showNotification('ä¿å­˜å¤±è´¥ï¼šå­˜å‚¨ç©ºé—´ä¸è¶³', 'danger');
                }
            }
            
            saveSettings() {
                localStorage.setItem('åºŸåœŸæ–¹èˆŸ_settings', JSON.stringify(this.gameState.settings));
            }
            
            loadGame() {
                try {
                    const saveData = localStorage.getItem('åºŸåœŸæ–¹èˆŸ_save');
                    if (saveData) {
                        const data = JSON.parse(saveData);
                        this.gameState = { ...this.gameState, ...data.gameState };
                        this.resources = data.resources || this.resources;
                        this.survivors = data.survivors || this.survivors;
                        this.buildings = data.buildings || this.buildings;
                        this.gameState.tech = new Set(data.tech || []);
                        this.gameState.achievements = new Set(data.achievements || []);
                        this.gameState.explored = new Set(data.explored || []);
                        this.showNotification('è¯»å–å­˜æ¡£æˆåŠŸï¼', 'success');
                    } else {
                        this.showNotification('æ²¡æœ‰æ‰¾åˆ°å­˜æ¡£', 'warning');
                    }
                    
                    const settingsData = localStorage.getItem('åºŸåœŸæ–¹èˆŸ_settings');
                    if (settingsData) {
                        this.gameState.settings = { ...this.gameState.settings, ...JSON.parse(settingsData) };
                        this.applySettingsToUI();
                    }
                } catch (e) {
                    console.error('è¯»å–å­˜æ¡£å¤±è´¥:', e);
                    this.showNotification('è¯»å–å­˜æ¡£å¤±è´¥', 'danger');
                }
            }
            
            applySettingsToUI() {
                document.getElementById('music-toggle').checked = this.gameState.settings.music;
                document.getElementById('game-speed').value = this.gameState.settings.speed;
                
                // æ¢å¤éŸ³é‡è®¾ç½®
                const volumeSlider = document.getElementById('music-volume');
                if (volumeSlider) {
                    volumeSlider.value = this.gameState.settings.volume * 100;
                    this.audio.bgMusicVolume = this.gameState.settings.volume;
                    if (this.audio.bgMusic) {
                        this.audio.bgMusic.volume = this.gameState.settings.volume;
                    }
                }
                
                // åº”ç”¨å±å¹•æ–¹å‘
                this.setOrientation(this.gameState.settings.orientation);
                
                if (this.gameState.settings.music && this.audio.bgMusic) {
                    this.tryPlayMusic();
                }
            }
            
            // ====== éšæœºäº‹ä»¶ ====== */
            randomEvent() {
                const events = [
                    { 
                        message: 'ğŸŒ§ï¸ ä¸‹äº†ä¸€åœºé›¨ï¼Œæ”¶é›†åˆ°ä¸€äº›å¹²å‡€çš„æ°´', 
                        effect: () => this.resources['æ°´'].amount += 30 
                    },
                    { 
                        message: 'ğŸ å‘ç°äº†åºŸå¼ƒçš„ç‰©èµ„ç®±', 
                        effect: () => {
                            this.resources['ææ–™'].amount += 20;
                            this.resources['é£Ÿç‰©'].amount += 15;
                        }
                    },
                    { 
                        message: 'ğŸ’Š æ‰¾åˆ°äº†åŒ»ç–—ç”¨å“', 
                        effect: () => this.resources['è¯å“'].amount += 25 
                    }
                ];
                
                const event = events[Math.floor(Math.random() * events.length)];
                this.addEvent(event.message, 'info');
                event.effect();
            }
            
            checkAchievement(achievementId) {
                const achievement = this.achievementList.find(a => a.id === achievementId);
                if (achievement && !this.gameState.achievements.has(achievementId) && achievement.condition()) {
                    this.unlockAchievement(achievementId);
                }
            }
        }

        // ====== æ¸¸æˆå¯åŠ¨ ======
        let game;
        
        document.addEventListener('DOMContentLoaded', () => {
            game = new SurvivalGame();
            window.game = game;
            
            console.log('ğŸ° ã€ŠåºŸåœŸæ–¹èˆŸã€‹æœ€ç»ˆç‰ˆå·²å¯åŠ¨ï¼');
            console.log('ğŸµ èƒŒæ™¯éŸ³ä¹ç³»ç»Ÿå·²åŠ è½½');
            console.log('ğŸ“± æ”¯æŒæ¨ªç«–å±åˆ‡æ¢');
            console.log('â° æ—¶é—´ç³»ç»Ÿï¼šæ—¶:åˆ†:ç§’æ˜¾ç¤º');
            console.log('âš¡ æ¸¸æˆé€Ÿåº¦ï¼šå¤šæ¡£å¯é€‰');
            console.log('ğŸ® æ‰€æœ‰å¼¹çª—å‡æœ‰å¢å¼ºå…³é—­æŒ‰é’®');
            
            // æ³¨å†ŒService Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').then(() => {
                    console.log('Service Worker æ³¨å†ŒæˆåŠŸ');
                }).catch(err => {
                    console.log('Service Worker æ³¨å†Œå¤±è´¥:', err);
                });
            }
        });
    </script>
</body>
</html>        }

        /* ====== PWAå…¨å±ä¼˜åŒ– ====== */
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }

        /* æ¨ªå±æç¤º */
        @media (orientation: landscape) and (max-height: 600px) {
            body::before {
                content: "ğŸ“± è¯·æ—‹è½¬è®¾å¤‡ä¸ºç«–å±ä»¥è·å¾—æœ€ä½³ä½“éªŒ";
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: #000;
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 99999;
                font-size: 18px;
                text-align: center;
                padding: 20px;
                backdrop-filter: blur(10px);
            }
        }

        /* ====== æ¸¸æˆå®¹å™¨ - ç½‘æ ¼å¸ƒå±€ ====== */
        #game-container {
            width: 100vw;
            height: 100vh;
            padding: 6px;
            display: grid;
            grid-template-columns: 1fr 1.5fr 1fr;
            grid-template-rows: min-content 1fr min-content;
            gap: 6px;
            grid-template-areas:
                "status status status"
                "resources base survivors"
                "events events events";
        }

        /* ====== çŠ¶æ€æ ï¼ˆé¡¶éƒ¨ï¼‰ ====== */
        #status-bar {
            grid-area: status;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            border-radius: 10px;
            padding: 5px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #3498db;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.4);
            min-height: 45px;
            flex-wrap: wrap;
            font-size: 12px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 4px;
            margin: 1px 3px;
            flex-shrink: 0;
        }

        .status-icon {
            font-size: 14px;
            min-width: 20px;
            text-align: center;
        }

        .status-value {
            font-size: 13px;
            font-weight: bold;
            color: #fff;
            white-space: nowrap;
        }

        /* ====== é€šç”¨æŒ‰é’®æ ·å¼ï¼ˆå°å°ºå¯¸ï¼‰ ====== */
        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            border: none;
            border-radius: 8px;
            color: white;
            padding: 5px 10px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            min-height: 28px;
            min-width: 55px;
        }

        .btn:hover, .btn:active {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(52, 152, 219, 0.3);
        }

        .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .btn-success { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .btn-warning { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .btn-purple { background: linear-gradient(135deg, #9b59b6, #8e44ad); }

        .btn-small {
            padding: 3px 6px;
            font-size: 10px;
            min-height: 24px;
            min-width: 45px;
        }

        /* ====== å·¦ä¾§èµ„æºé¢æ¿ ====== */
        #resource-panel {
            grid-area: resources;
            background: rgba(30, 35, 50, 0.95);
            border-radius: 10px;
            padding: 8px;
            border: 1px solid #444;
            overflow-y: auto;
            font-size: 11px;
        }

        .panel-title {
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #3498db;
            display: flex;
            align-items: center;
            gap: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .resource-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px;
            margin-bottom: 5px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            font-size: 11px;
        }

        .resource-icon {
            font-size: 14px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            flex-shrink: 0;
        }

        .resource-bar {
            height: 3px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin: 2px 0;
            overflow: hidden;
        }

        .resource-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s;
        }

        /* ====== ç§‘æŠ€æ ‘ ====== */
        #tech-tree {
            margin-top: 10px;
        }

        .tech-item {
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid #3498db;
            border-radius: 6px;
            padding: 6px;
            margin: 3px 0;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 11px;
        }

        .tech-item:hover {
            background: rgba(52, 152, 219, 0.2);
        }

        .tech-item.researched {
            background: rgba(46, 204, 113, 0.2);
            border-color: #2ecc71;
        }

        .tech-item.insufficient {
            background: rgba(231, 76, 60, 0.1);
            border-color: #e74c3c;
            opacity: 0.7;
        }

        /* ====== ä¸­å¤®åŸºåœ°é¢æ¿ ====== */
        #base-panel {
            grid-area: base;
            background: rgba(25, 30, 45, 0.95);
            border-radius: 10px;
            padding: 8px;
            border: 1px solid #444;
            display: flex;
            flex-direction: column;
        }

        #base-canvas {
            width: 100%;
            flex: 1;
            min-height: 180px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            margin: 5px 0;
            border: 1px solid #555;
        }

        #building-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
            margin-top: 6px;
        }

        .btn-build {
            background: rgba(155, 89, 182, 0.7);
            border: 1px solid #9b59b6;
            border-radius: 6px;
            padding: 6px 3px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            font-size: 10px;
            min-height: 50px;
        }

        .btn-build:hover {
            background: rgba(155, 89, 182, 0.9);
        }

        .btn-build span:first-child {
            font-size: 16px;
        }

        /* ====== å³ä¾§å¹¸å­˜è€…é¢æ¿ ====== */
        #survivor-panel {
            grid-area: survivors;
            background: rgba(30, 35, 50, 0.95);
            border-radius: 10px;
            padding: 8px;
            border: 1px solid #444;
            overflow-y: auto;
            font-size: 11px;
        }

        .survivor-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 6px;
            margin-bottom: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 11px;
        }

        .survivor-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
        }

        .survivor-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #e74c3c, #f39c12);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }

        .stat-row {
            display: flex;
            align-items: center;
            margin: 2px 0;
            gap: 4px;
            font-size: 10px;
        }

        .stat-bar {
            flex: 1;
            height: 3px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .stat-fill {
            height: 100%;
            border-radius: 2px;
        }

        .health-bar { background: linear-gradient(90deg, #e74c3c, #f39c12); }
        .hunger-bar { background: linear-gradient(90deg, #f1c40f, #f39c12); }
        .energy-bar { background: linear-gradient(90deg, #3498db, #2980b9); }

        /* ====== åº•éƒ¨äº‹ä»¶é¢æ¿ ====== */
        #event-panel {
            grid-area: events;
            background: rgba(30, 35, 50, 0.95);
            border-radius: 10px;
            padding: 8px;
            border: 1px solid #444;
            min-height: 120px;
            max-height: 140px;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
            flex-wrap: wrap;
        }

        #event-log {
            flex: 1;
            overflow-y: auto;
            margin: 3px 0;
            padding-right: 6px;
            font-size: 11px;
        }

        .log-entry {
            padding: 4px 6px;
            margin-bottom: 3px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            border-left: 3px solid #3498db;
            animation: fadeIn 0.3s;
        }

        .log-entry.warning { border-left-color: #f39c12; }
        .log-entry.danger { border-left-color: #e74c3c; }
        .log-entry.success { border-left-color: #2ecc71; }
        .log-entry.build { border-left-color: #9b59b6; }

        /* ====== æ¢ç´¢é¢æ¿ ====== */
        #explore-panel {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 4px;
            margin-top: 6px;
            display: none;
        }

        .btn-explore {
            background: rgba(46, 204, 113, 0.7);
            border: 1px solid #2ecc71;
            border-radius: 6px;
            padding: 6px 3px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            font-size: 10px;
            min-height: 45px;
        }

        .btn-explore:hover {
            background: rgba(46, 204, 113, 0.9);
        }

        .btn-explore span:first-child {
            font-size: 16px;
        }

        /* ====== å¼¹çª—ç³»ç»Ÿ ====== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 10px;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: #2c3e50;
            border-radius: 12px;
            padding: 12px;
            width: 95%;
            max-width: 400px;
            border: 2px solid #3498db;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 15px;
            color: #3498db;
            margin-bottom: 10px;
            text-align: center;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        /* ====== è®¾ç½®é¢æ¿ ====== */
        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            margin: 5px 0;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #666;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #3498db;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* ====== æˆå°±ç³»ç»Ÿ ====== */
        .achievement {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px;
            margin: 4px 0;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
        }

        .achievement.locked {
            opacity: 0.5;
            filter: grayscale(1);
        }

        .achievement-icon {
            font-size: 20px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
        }

        /* ====== å¿«æ·æ“ä½œæ  ====== */
        .quick-actions {
            position: fixed;
            bottom: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 900;
        }

        .quick-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #3498db;
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
        }

        .quick-btn:hover {
            transform: scale(1.1);
        }

        /* ====== é€šçŸ¥ç³»ç»Ÿ ====== */
        #notification-container {
            position: fixed;
            top: 50px;
            right: 10px;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 5px;
            max-width: 250px;
        }

        .notification {
            background: #2c3e50;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            animation: slideInRight 0.3s, fadeOut 0.3s 2.7s forwards;
            font-size: 12px;
        }

        .notification.success { border-left-color: #2ecc71; }
        .notification.warning { border-left-color: #f39c12; }
        .notification.danger { border-left-color: #e74c3c; }
        .notification.info { border-left-color: #3498db; }

        /* ====== åŠ è½½åŠ¨ç”» ====== */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a2e;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        /* ====== åŠ¨ç”»å®šä¹‰ ====== */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            to { opacity: 0; transform: translateY(-10px); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translate(-50%, -50%); }
            10%, 30%, 50%, 70%, 90% { transform: translate(-51%, -50%); }
            20%, 40%, 60%, 80% { transform: translate(-49%, -50%); }
        }

        .pulse { animation: pulse 2s infinite; }
        .shake { animation: shake 0.5s ease; }

        /* ====== ç ”ç©¶é¢æ¿ç‰¹æ®Šæ ·å¼ ====== */
        .research-modal {
            animation: fadeIn 0.3s ease;
        }

        .insufficient-materials {
            border-color: #e74c3c !important;
            background: rgba(231, 76, 60, 0.1) !important;
        }

        /* ====== æˆ˜æ–—ç•Œé¢ ====== */
        .enemy-card {
            background: rgba(231, 76, 60, 0.2);
            border: 2px solid #e74c3c;
            border-radius: 8px;
            padding: 10px;
            margin: 6px 0;
            text-align: center;
            font-size: 12px;
        }

        .combat-log {
            height: 100px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 6px;
            padding: 6px;
            margin: 6px 0;
            font-size: 11px;
        }

        .combat-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-top: 8px;
        }

        /* ====== å“åº”å¼è°ƒæ•´ ====== */
        @media (max-width: 768px) {
            #game-container {
                grid-template-columns: 1fr;
                grid-template-rows: min-content min-content 1fr min-content min-content;
                grid-template-areas:
                    "status"
                    "base"
                    "resources"
                    "survivors"
                    "events";
                gap: 4px;
            }
            
            #resource-panel, #survivor-panel {
                max-height: 180px;
            }
            
            #event-panel {
                max-height: 120px;
            }
            
            #base-canvas {
                min-height: 200px;
            }
            
            .btn {
                font-size: 10px;
                padding: 4px 8px;
            }
            
            .status-value {
                font-size: 12px;
            }
        }

        @media (max-width: 360px) {
            #status-bar {
                padding: 3px 6px;
            }
            
            .status-icon {
                font-size: 12px;
            }
            
            .btn {
                min-width: 40px;
                font-size: 9px;
            }
            
            #building-controls {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* ====== æ»šåŠ¨æ¡ç¾åŒ– ====== */
        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 2px;
        }

        ::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 2px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #2980b9;
        }
    </style>
    
    <!-- éŸ³ä¹åº“é“¾æ¥ -->
    <link rel="preload" href="https://assets.mixkit.co/music/preview/mixkit-game-show-suspense-waiting-667.mp3" as="audio" crossorigin="anonymous">
</head>
<body>
    <!-- åŠ è½½å±å¹• -->
    <div id="loading-screen">
        <div class="loading-spinner"></div>
        <div style="font-size: 18px; color: #3498db; margin-bottom: 10px; font-weight: bold;">åºŸåœŸæ–¹èˆŸ</div>
        <div style="font-size: 12px; color: #8899cc; text-align: center; max-width: 300px;">
            åŠ è½½å¹¸å­˜è€…æ•°æ®åº“...
        </div>
    </div>

    <!-- ä¸»æ¸¸æˆç•Œé¢ -->
    <div id="game-container" style="display: none;">
        <!-- çŠ¶æ€æ  -->
        <div id="status-bar">
            <div class="status-item">
                <span class="status-icon">ğŸ“…</span>
                <span class="status-value" id="day-count">ç¬¬1å¤©</span>
            </div>
            
            <div class="status-item">
                <span class="status-icon">â°</span>
                <span class="status-value" id="time-display">06:00</span>
            </div>
            
            <div class="status-item">
                <span class="status-icon">â˜ï¸</span>
                <span class="status-value" id="weather">æ™´æœ—</span>
            </div>
            
            <div class="status-item">
                <span class="status-icon">ğŸ˜Š</span>
                <span class="status-value" id="morale">å£«æ°”: 75</span>
            </div>
            
            <div class="status-item">
                <span class="status-icon">ğŸ‘¥</span>
                <span class="status-value" id="survivor-count">4äºº</span>
            </div>
            
            <button class="btn btn-small" id="btn-pause">
                <span>â¸ï¸</span>
                <span>æš‚åœ</span>
            </button>
            
            <button class="btn btn-small btn-danger" id="btn-save">
                <span>ğŸ’¾</span>
                <span>ä¿å­˜</span>
            </button>
            
            <button class="btn btn-small btn-purple" id="btn-settings">
                <span>âš™ï¸</span>
                <span>è®¾ç½®</span>
            </button>
        </div>

        <!-- å·¦ä¾§èµ„æºé¢æ¿ -->
        <div id="resource-panel">
            <div class="panel-title">
                <span>ğŸ“¦</span>
                <span>èµ„æºç®¡ç†</span>
                <span id="total-resources" style="margin-left: auto; font-size: 10px; color: #f39c12;"></span>
            </div>
            <div id="resource-list">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div class="panel-title" style="margin-top: 10px;">
                <span>ğŸ”¬</span>
                <span>ç§‘æŠ€æ ‘</span>
                <span id="tech-progress" style="margin-left: auto; font-size: 10px; color: #2ecc71;"></span>
            </div>
            <div id="tech-tree">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- ä¸­å¤®åŸºåœ°é¢æ¿ -->
        <div id="base-panel">
            <div class="panel-title">
                <span>ğŸ°</span>
                <span>åŸºåœ°æ€»è§ˆ</span>
                <span id="defense-level" style="margin-left: auto; font-size: 10px; color: #f39c12;">é˜²å¾¡: 1çº§</span>
            </div>
            
            <canvas id="base-canvas"></canvas>
            
            <div id="building-controls">
                <!-- åŸºç¡€å»ºç­‘ -->
                <button class="btn-build" data-type="å®¿èˆ" data-cost="30">
                    <span>ğŸ›ï¸</span>
                    <span>å®¿èˆ</span>
                    <small>+4äººå£</small>
                </button>
                <button class="btn-build" data-type="å¨æˆ¿" data-cost="30">
                    <span>ğŸ³</span>
                    <span>å¨æˆ¿</span>
                    <small>é£Ÿç‰©+3/h</small>
                </button>
                <button class="btn-build" data-type="åŒ»ç–—ç«™" data-cost="30">
                    <span>ğŸ¥</span>
                    <span>åŒ»ç–—ç«™</span>
                    <small>æ²»ç–—ä¼¤ç—…</small>
                </button>
                <button class="btn-build" data-type="ç­æœ›å¡”" data-cost="30">
                    <span>ğŸ”­</span>
                    <span>ç­æœ›å¡”</span>
                    <small>è§†é‡+50%</small>
                </button>
                <button class="btn-build" data-type="ä»“åº“" data-cost="40">
                    <span>ğŸ“¦</span>
                    <span>ä»“åº“</span>
                    <small>å®¹é‡+200</small>
                </button>
                <button class="btn-build" data-type="ç ”ç©¶æ‰€" data-cost="50">
                    <span>ğŸ”¬</span>
                    <span>ç ”ç©¶æ‰€</span>
                    <small>ç ”ç©¶ç§‘æŠ€</small>
                </button>
                <!-- é«˜çº§å»ºç­‘ï¼ˆéœ€ç§‘æŠ€è§£é”ï¼‰ -->
                <button class="btn-build" data-type="æ°´å¤„ç†å‚" data-cost="60" data-tech="water_purify">
                    <span>ğŸ’§</span>
                    <span>æ°´å‚</span>
                    <small>æ°´+5/h</small>
                </button>
                <button class="btn-build" data-type="å‘ç”µç«™" data-cost="70" data-tech="advanced_defense">
                    <span>âš¡</span>
                    <span>ç”µç«™</span>
                    <small>ç”µåŠ›+10</small>
                </button>
                <button class="btn-build" data-type="è®­ç»ƒåœº" data-cost="45">
                    <span>âš”ï¸</span>
                    <span>è®­ç»ƒåœº</span>
                    <small>æˆ˜æ–—+1</small>
                </button>
            </div>
        </div>

        <!-- å³ä¾§å¹¸å­˜è€…é¢æ¿ -->
        <div id="survivor-panel">
            <div class="panel-title">
                <span>ğŸ‘¥</span>
                <span>å¹¸å­˜è€…</span>
                <button class="btn btn-small btn-success" id="btn-recruit" style="margin-left: auto; padding: 3px 6px;">
                    <span>ğŸ“¢</span>
                    <span>æ‹›å‹Ÿ</span>
                </button>
            </div>
            <div id="survivor-list">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- åº•éƒ¨äº‹ä»¶é¢æ¿ -->
        <div id="event-panel">
            <div class="panel-header">
                <div class="panel-title" style="margin: 0; padding: 0;">
                    <span>ğŸ“œ</span>
                    <span>äº‹ä»¶æ—¥å¿—</span>
                </div>
                <button class="btn btn-small" id="btn-explore" style="margin-left: auto; padding: 3px 6px;">
                    <span>ğŸ§­</span>
                    <span>æ¢ç´¢</span>
                </button>
                <button class="btn btn-small btn-danger" id="btn-combat" style="padding: 3px 6px;">
                    <span>âš”ï¸</span>
                    <span>æˆ˜æ–—</span>
                </button>
                <button class="btn btn-small btn-warning" id="btn-achievements" style="padding: 3px 6px;">
                    <span>ğŸ†</span>
                    <span>æˆå°±</span>
                </button>
            </div>
            
            <div id="event-log">
                <!-- äº‹ä»¶æ—¥å¿—åŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div id="explore-panel">
                <button class="btn-explore" data-location="åºŸå¢Ÿ" data-risk="0.2">
                    <span>ğŸšï¸</span>
                    <span>åºŸå¢Ÿ</span>
                    <small>ä½é£é™©</small>
                </button>
                <button class="btn-explore" data-location="åŒ»é™¢" data-risk="0.4">
                    <span>ğŸ¥</span>
                    <span>åŒ»é™¢</span>
                    <small>ä¸­é£é™©</small>
                </button>
                <button class="btn-explore" data-location="è¶…å¸‚" data-risk="0.3">
                    <span>ğŸ›’</span>
                    <span>è¶…å¸‚</span>
                    <small>ä½é£é™©</small>
                </button>
                <button class="btn-explore" data-location="å†›äº‹åŸºåœ°" data-risk="0.6">
                    <span>ğŸ–ï¸</span>
                    <span>å†›äº‹åŸºåœ°</span>
                    <small>é«˜é£é™©</small>
                </button>
                <button class="btn-explore" data-location="å†œåœº" data-risk="0.3">
                    <span>ğŸŒ¾</span>
                    <span>å†œåœº</span>
                    <small>ä¸­é£é™©</small>
                </button>
                <button class="btn-explore" data-location="ç ”ç©¶æ‰€åºŸå¢Ÿ" data-risk="0.5">
                    <span>ğŸ”¬</span>
                    <span>ç ”ç©¶æ‰€</span>
                    <small>é«˜é£é™©</small>
                </button>
            </div>
        </div>
    </div>

    <!-- å¿«æ·æ“ä½œæ  -->
    <div class="quick-actions">
        <button class="quick-btn" id="quick-pause" title="æš‚åœ/ç»§ç»­">
            â¸ï¸
        </button>
        <button class="quick-btn" id="quick-save" title="ä¿å­˜æ¸¸æˆ">
            ğŸ’¾
        </button>
        <button class="quick-btn" id="quick-explore" title="æ¢ç´¢">
            ğŸ§­
        </button>
        <button class="quick-btn" id="quick-menu" title="å¿«æ·èœå•">
            âš™ï¸
        </button>
    </div>

    <!-- é€šçŸ¥å®¹å™¨ -->
    <div id="notification-container"></div>

    <!-- ====== å¼¹çª—ç³»ç»Ÿ ====== -->
    
    <!-- è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">âš™ï¸ æ¸¸æˆè®¾ç½®</div>
            
            <div class="settings-item">
                <span>ğŸµ èƒŒæ™¯éŸ³ä¹</span>
                <label class="switch">
                    <input type="checkbox" id="music-toggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="settings-item">
                <span>ğŸ”Š æ¸¸æˆéŸ³æ•ˆ</span>
                <label class="switch">
                    <input type="checkbox" id="sfx-toggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="settings-item">
                <span>âš¡ æ¸¸æˆé€Ÿåº¦</span>
                <select id="game-speed" style="background: #34495e; color: white; border: 1px solid #555; padding: 4px 8px; border-radius: 4px;">
                    <option value="0.5">æ…¢é€Ÿ (0.5x)</option>
                    <option value="1" selected>æ­£å¸¸ (1x)</option>
                    <option value="2">å¿«é€Ÿ (2x)</option>
                    <option value="5">æé€Ÿ (5x)</option>
                </select>
            </div>
            
            <div class="settings-item">
                <span>ğŸŒ™ å¤œé—´æ¨¡å¼</span>
                <label class="switch">
                    <input type="checkbox" id="night-mode">
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="settings-item">
                <span>ğŸ“± æŒ¯åŠ¨åé¦ˆ</span>
                <label class="switch">
                    <input type="checkbox" id="vibration-toggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            
            <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                <button class="btn btn-danger" id="btn-exit-game" style="width: 100%; margin-bottom: 8px;">
                    ğŸšª é€€å‡ºæ¸¸æˆ
                </button>
                <button class="btn" id="btn-close-settings" style="width: 100%;">
                    å…³é—­è®¾ç½®
                </button>
            </div>
            
            <div style="margin-top: 15px; font-size: 10px; color: #8899cc; text-align: center;">
                ã€ŠåºŸåœŸæ–¹èˆŸã€‹v1.0<br>
                å¹¸å­˜è€…æ•°é‡: <span id="settings-survivor-count">4</span> | 
                æ¸¸æˆå¤©æ•°: <span id="settings-game-day">1</span>
            </div>
        </div>
    </div>

    <!-- æˆå°±æ¨¡æ€æ¡† -->
    <div id="achievements-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ğŸ† æˆå°±ç³»ç»Ÿ</div>
            <div id="achievements-list" style="max-height: 300px; overflow-y: auto; padding: 5px;">
                <!-- æˆå°±åŠ¨æ€ç”Ÿæˆ -->
            </div>
            <button class="btn" id="btn-close-achievements" style="width: 100%; margin-top: 10px;">
                å…³é—­
            </button>
        </div>
    </div>

    <!-- æ¢ç´¢ç»“æœæ¨¡æ€æ¡† -->
    <div id="explore-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="explore-title">ğŸ§­ æ¢ç´¢ç»“æœ</div>
            <div id="explore-result"></div>
            <button class="btn" id="btn-close-explore" style="width: 100%; margin-top: 10px;">
                å…³é—­
            </button>
        </div>
    </div>

    <!-- æˆ˜æ–—æ¨¡æ€æ¡† -->
    <div id="combat-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">âš”ï¸ ä¸§å°¸æ¥è¢­ï¼</div>
            <div id="enemy-info"></div>
            <div class="combat-log" id="combat-log"></div>
            <div class="combat-actions">
                <button class="btn btn-success" id="btn-attack">ğŸ—¡ï¸ æ”»å‡»</button>
                <button class="btn" id="btn-defend">ğŸ›¡ï¸ é˜²å¾¡</button>
                <button class="btn btn-danger" id="btn-flee">ğŸƒ æ’¤é€€</button>
            </div>
        </div>
    </div>

    <!-- ç ”ç©¶æ¨¡æ€æ¡†ï¼ˆæ—§ç‰ˆï¼Œå°†è¢«åŠ¨æ€åˆ›å»ºæ›¿ä»£ï¼‰ -->
    <div id="research-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ğŸ”¬ ç§‘æŠ€ç ”ç©¶</div>
            <div id="research-info"></div>
            <button class="btn btn-success" id="btn-research" style="width: 100%; margin-top: 10px;">
                å¼€å§‹ç ”ç©¶
            </button>
        </div>
    </div>

    <!-- å¹¸å­˜è€…è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="survivor-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="survivor-modal-title">ğŸ‘¤ å¹¸å­˜è€…è¯¦æƒ…</div>
            <div id="survivor-details"></div>
            <button class="btn" id="btn-close-survivor" style="width: 100%; margin-top: 10px;">
                å…³é—­
            </button>
        </div>
    </div>

    <!-- å»ºç­‘è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="building-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="building-modal-title">ğŸ—ï¸ å»ºç­‘è¯¦æƒ…</div>
            <div id="building-details"></div>
            <button class="btn" id="btn-close-building" style="width: 100%; margin-top: 10px;">
                å…³é—­
            </button>
        </div>
    </div>

    <!-- JavaScript ä»£ç  -->
    <script>
        // ====== æ¸¸æˆæ ¸å¿ƒç±» ======
        class SurvivalGame {
            constructor() {
                // æ¸¸æˆçŠ¶æ€
                this.gameState = {
                    day: 1,
                    hour: 6,
                    weather: 'clear',
                    morale: 75,
                    paused: false,
                    threat: 1,
                    tech: new Set(),
                    explored: new Set(),
                    achievements: new Set(),
                    settings: {
                        music: true,
                        sfx: true,
                        speed: 1,
                        nightMode: false,
                        vibration: true
                    }
                };
                
                // èµ„æºç³»ç»Ÿ
                this.resources = {
                    'é£Ÿç‰©': { amount: 100, max: 500, prod: 5, cons: 8 },
                    'æ°´': { amount: 80, max: 300, prod: 3, cons: 6 },
                    'ææ–™': { amount: 50, max: 1000, prod: 2, cons: 1 },
                    'è¯å“': { amount: 20, max: 200, prod: 0.5, cons: 0.2 },
                    'å¼¹è¯': { amount: 50, max: 500, prod: 1, cons: 0 },
                    'ç”µåŠ›': { amount: 100, max: 200, prod: 10, cons: 5 }
                };
                
                // å¹¸å­˜è€…åå­—åº“ï¼ˆ50+ä¸ªï¼‰
                this.survivorNames = [
                    'å¼ ä¼Ÿ', 'æå¨œ', 'ç‹åˆš', 'èµµæ•', 'åˆ˜å¼º', 'é™ˆé™', 'å­™æµ©', 'å‘¨å©·', 'å´ç£Š', 'éƒ‘èŠ³',
                    'æ¨æ˜', 'é»„éœ', 'æœ±å‹‡', 'æ—èŠ³', 'å‘¨æ°', 'å´åˆš', 'éƒ‘å‡¯', 'ç‹èŠ³', 'æå¼º', 'å¼ æ•',
                    'é™ˆä¼Ÿ', 'åˆ˜èŠ³', 'æ¨å†›', 'é»„å‹‡', 'å‘¨æ¢…', 'å´é™', 'éƒ‘æ˜', 'ç‹å‹‡', 'æéœ', 'å¼ å‹‡',
                    'è€å…µé™ˆ', 'åŒ»ç”Ÿæ', 'å·¥ç¨‹å¸ˆç‹', 'çŒäººå¼ ', 'å†œå¤«åˆ˜', 'æ•™å¸ˆèµµ', 'å­¦ç”Ÿå‘¨', 'å·¥äººå´',
                    'é˜Ÿé•¿å­™', 'ä¾¦å¯Ÿå…µæ¨', 'æœºæ¢°å¸ˆé»„', 'è¯å‰‚å¸ˆæ—', 'å»ºç­‘å¸ˆéƒ‘', 'ç”µå·¥æœ±', 'æœ¨å·¥é©¬',
                    'é“åŒ éŸ©', 'å¨å¸ˆå”', 'å›­ä¸å®‹', 'å­¦è€…ç§¦', 'è¿åŠ¨å‘˜è®¸'
                ];
                
                // å¹¸å­˜è€…æŠ€èƒ½åº“
                this.survivorSkills = ['å»ºé€ ', 'åŒ»ç–—', 'æˆ˜æ–—', 'ç ”ç©¶', 'æ¢ç´¢', 'é¢†å¯¼', 'æœºæ¢°', 'å†œä¸š', 'çƒ¹é¥ª', 'å°„å‡»'];
                
                // åˆå§‹å¹¸å­˜è€…
                this.survivors = [
                    this.createRandomSurvivor(1),
                    this.createRandomSurvivor(2),
                    this.createRandomSurvivor(3),
                    this.createRandomSurvivor(4)
                ];
                
                // å»ºç­‘ç±»å‹ï¼ˆ18ç§ï¼‰
                this.buildingTypes = {
                    'æŒ‡æŒ¥ä¸­å¿ƒ': { cost: 0, workers: 3, effect: 'æ ¸å¿ƒå»ºç­‘' },
                    'å®¿èˆ': { cost: 30, workers: 0, effect: '+4äººå£å®¹é‡' },
                    'å¨æˆ¿': { cost: 30, workers: 2, effect: 'é£Ÿç‰©+3/h' },
                    'åŒ»ç–—ç«™': { cost: 30, workers: 2, effect: 'æ²»ç–—ä¼¤ç—…' },
                    'ç­æœ›å¡”': { cost: 30, workers: 1, effect: 'è§†é‡+50%' },
                    'ä»“åº“': { cost: 40, workers: 1, effect: 'å®¹é‡+200' },
                    'ç ”ç©¶æ‰€': { cost: 50, workers: 3, effect: 'ç ”ç©¶ç§‘æŠ€' },
                    'æ°´å¤„ç†å‚': { cost: 60, workers: 2, effect: 'æ°´+5/h', require: 'water_purify' },
                    'å‘ç”µç«™': { cost: 70, workers: 2, effect: 'ç”µåŠ›+10', require: 'advanced_defense' },
                    'è®­ç»ƒåœº': { cost: 45, workers: 1, effect: 'æˆ˜æ–—+1' },
                    'å†œåœº': { cost: 35, workers: 2, effect: 'é£Ÿç‰©+4/h' },
                    'å›´å¢™': { cost: 25, workers: 0, effect: 'é˜²å¾¡+10' },
                    'å“¨å¡”': { cost: 40, workers: 1, effect: 'é˜²å¾¡+15' },
                    'å·¥åŠ': { cost: 55, workers: 3, effect: 'ææ–™+2/h' },
                    'å¨±ä¹å®¤': { cost: 30, workers: 0, effect: 'å£«æ°”+5' },
                    'é€šè®¯ç«™': { cost: 65, workers: 2, effect: 'æ¢ç´¢æ•ˆç‡+20%' },
                    'å†›æ¢°åº“': { cost: 50, workers: 1, effect: 'å¼¹è¯+2/h' },
                    'æ¸©å®¤': { cost: 45, workers: 2, effect: 'é£Ÿç‰©+2/h æ°´-1/h' }
                };
                
                // åˆå§‹å»ºç­‘
                this.buildings = [
                    { id: 1, type: 'æŒ‡æŒ¥ä¸­å¿ƒ', level: 1, x: 200, y: 150, workers: [], efficiency: 1.0 },
                    { id: 2, type: 'å®¿èˆ', level: 1, x: 300, y: 200, workers: [1, 2], efficiency: 0.8 },
                    { id: 3, type: 'å¨æˆ¿', level: 1, x: 100, y: 200, workers: [], efficiency: 0.6 },
                    { id: 4, type: 'åŒ»ç–—ç«™', level: 1, x: 200, y: 250, workers: [2], efficiency: 0.9 },
                    { id: 5, type: 'ç­æœ›å¡”', level: 1, x: 400, y: 150, workers: [3], efficiency: 0.7 }
                ];
                
                // äº‹ä»¶æ—¥å¿—
                this.events = [
                    { time: '06:00', message: 'æ–°çš„ä¸€å¤©å¼€å§‹äº†ã€‚æ˜¨æ™šå¹³å®‰æ— äº‹ã€‚', type: 'info' },
                    { time: '07:00', message: 'å¼ ä¼Ÿä¿®å¤äº†å›´å¢™çš„ç ´æŸå¤„ã€‚', type: 'work' }
                ];
                
                // æ•Œäººç³»ç»Ÿ
                this.enemies = [];
                this.combatActive = false;
                this.currentEnemy = null;
                
                // æˆå°±ç³»ç»Ÿï¼ˆ25ä¸ªï¼‰
                this.achievementList = [
                    { id: 'first_light', name: 'ç¬¬ä¸€é“å…‰', desc: 'å»ºé€ ç¬¬ä¸€ä¸ªå»ºç­‘', icon: 'ğŸ—ï¸', condition: () => this.buildings.length >= 2 },
                    { id: 'dawn_breaker', name: 'ç ´æ™“ä¹‹äºº', desc: 'ç”Ÿå­˜è¶…è¿‡7å¤©', icon: 'ğŸŒ…', condition: () => this.gameState.day >= 7 },
                    { id: 'wasteland_gardener', name: 'åºŸåœŸå›­ä¸', desc: 'é¦–æ¬¡æ”¶è·é£Ÿç‰©', icon: 'ğŸŒ±', condition: () => this.resources['é£Ÿç‰©'].amount >= 200 },
                    { id: 'iron_fortress', name: 'é’¢é“å ¡å’', desc: 'å»ºé€ æ‰€æœ‰é˜²å¾¡å»ºç­‘', icon: 'ğŸ°', condition: () => this.buildings.filter(b => ['å›´å¢™', 'å“¨å¡”', 'ç­æœ›å¡”'].includes(b.type)).length >= 3 },
                    { id: 'ark_heart', name: 'æ–¹èˆŸä¹‹å¿ƒ', desc: 'æ”¶å®¹10åå¹¸å­˜è€…', icon: 'â¤ï¸', condition: () => this.survivors.length >= 10 },
                    { id: 'civilization_spark', name: 'æ–‡æ˜ç«ç§', desc: 'ç ”ç©¶æ‰€æœ‰ç§‘æŠ€', icon: 'ğŸ”¥', condition: () => this.gameState.tech.size >= 3 },
                    { id: 'wasteland_revival', name: 'åºŸåœŸå¤å…´', desc: 'å»ºç«‹è‡ªç»™è‡ªè¶³ç¤¾åŒº', icon: 'ğŸ˜ï¸', condition: () => this.resources['é£Ÿç‰©'].prod > 20 && this.resources['æ°´'].prod > 15 },
                    { id: 'doom_terminator', name: 'æœ«æ—¥ç»ˆç»“è€…', desc: 'ç”Ÿå­˜365å¤©', icon: 'âš”ï¸', condition: () => this.gameState.day >= 365 },
                    { id: 'ark_commander', name: 'æ–¹èˆŸæŒ‡æŒ¥å®˜', desc: 'å®Œå…¨é€šå…³æ¸¸æˆ', icon: 'ğŸ–ï¸', condition: () => this.gameState.day >= 100 && this.survivors.length >= 15 },
                    { id: 'resource_master', name: 'èµ„æºå¤§å¸ˆ', desc: 'æ‰€æœ‰èµ„æºè¾¾åˆ°ä¸Šé™', icon: 'ğŸ“Š', condition: () => Object.values(this.resources).every(r => r.amount >= r.max * 0.9) },
                    { id: 'explorer', name: 'æ¢ç´¢è€…', desc: 'æ¢ç´¢æ‰€æœ‰åœ°ç‚¹', icon: 'ğŸ§­', condition: () => this.gameState.explored.size >= 6 },
                    { id: 'zombie_slayer', name: 'ä¸§å°¸æ€æ‰‹', desc: 'å‡»è´¥100ä¸ªæ•Œäºº', icon: 'ğŸ§Ÿ', condition: () => this.gameState.threat >= 10 },
                    { id: 'tech_master', name: 'ç§‘æŠ€å¤§å¸ˆ', desc: 'ç ”ç©¶5é¡¹ç§‘æŠ€', icon: 'ğŸ”¬', condition: () => this.gameState.tech.size >= 5 },
                    { id: 'builder', name: 'å»ºé€ å¤§å¸ˆ', desc: 'å»ºé€ 10ç§ä¸åŒå»ºç­‘', icon: 'ğŸ‘·', condition: () => new Set(this.buildings.map(b => b.type)).size >= 10 },
                    { id: 'leader', name: 'é¢†è¢–', desc: 'å£«æ°”ç»´æŒ100ç‚¹è¶…è¿‡1å¤©', icon: 'ğŸ‘‘', condition: () => this.gameState.morale >= 100 },
                    { id: 'medic', name: 'åŒ»ç–—å…µ', desc: 'æ²»ç–—10æ¬¡ä¼¤ç—…', icon: 'ğŸ¥', condition: () => this.survivors.filter(s => s.health >= 90).length >= 5 },
                    { id: 'farmer', name: 'å†œåœºä¸»', desc: 'é£Ÿç‰©äº§é‡è¾¾åˆ°50/h', icon: 'ğŸŒ¾', condition: () => this.resources['é£Ÿç‰©'].prod >= 50 },
                    { id: 'engineer', name: 'å·¥ç¨‹å¸ˆ', desc: 'ææ–™äº§é‡è¾¾åˆ°30/h', icon: 'ğŸ”§', condition: () => this.resources['ææ–™'].prod >= 30 },
                    { id: 'scout', name: 'ä¾¦å¯Ÿå…µ', desc: 'æˆåŠŸæ¢ç´¢10æ¬¡', icon: 'ğŸ”­', condition: () => this.gameState.explored.size >= 10 },
                    { id: 'trader', name: 'è´¸æ˜“å•†', desc: 'äº¤æ˜“èµ„æºæ€»å€¼è¾¾åˆ°1000', icon: 'ğŸ’°', condition: () => Object.values(this.resources).reduce((sum, r) => sum + r.amount, 0) >= 1000 },
                    { id: 'survivor', name: 'ç”Ÿå­˜ä¸“å®¶', desc: 'è¿ç»­30å¤©æ— äººå‘˜æ­»äº¡', icon: 'ğŸ›¡ï¸', condition: () => this.gameState.day >= 30 },
                    { id: 'inventor', name: 'å‘æ˜å®¶', desc: 'è§£é”æ‰€æœ‰é«˜çº§å»ºç­‘', icon: 'ğŸ’¡', condition: () => this.buildings.filter(b => ['æ°´å¤„ç†å‚', 'å‘ç”µç«™', 'é€šè®¯ç«™'].includes(b.type)).length >= 3 },
                    { id: 'strategist', name: 'æˆ˜ç•¥å®¶', desc: 'é˜²å¾¡ç­‰çº§è¾¾åˆ°10çº§', icon: 'ğŸ¯', condition: () => this.gameState.threat >= 10 },
                    { id: 'collector', name: 'æ”¶è—å®¶', desc: 'æ”¶é›†æ‰€æœ‰ç±»å‹èµ„æº', icon: 'ğŸ“¦', condition: () => Object.keys(this.resources).length >= 6 },
                    { id: 'legend', name: 'ä¼ å¥‡æŒ‡æŒ¥å®˜', desc: 'è¾¾æˆæ‰€æœ‰æˆå°±', icon: 'ğŸŒŸ', condition: () => this.gameState.achievements.size >= 24 }
                ];
                
                // ç§‘æŠ€ç³»ç»Ÿï¼ˆ12é¡¹ï¼‰
                this.techTree = [
                    { id: 'basic_farming', name: 'åŸºç¡€å†œä¸š', cost: 50, desc: 'é£Ÿç‰©äº§é‡+20%', time: 24, icon: 'ğŸŒ±', require: [] },
                    { id: 'water_purify', name: 'å‡€æ°´æŠ€æœ¯', cost: 40, desc: 'æ°´æ¶ˆè€—-30%', time: 18, icon: 'ğŸ’§', require: [] },
                    { id: 'advanced_defense', name: 'é«˜çº§é˜²å¾¡', cost: 60, desc: 'é˜²å¾¡åŠ›+50%', time: 36, icon: 'ğŸ›¡ï¸', require: [] },
                    { id: 'solar_power', name: 'å¤ªé˜³èƒ½æŠ€æœ¯', cost: 70, desc: 'ç”µåŠ›+15/h', time: 48, icon: 'â˜€ï¸', require: ['advanced_defense'] },
                    { id: 'advanced_medicine', name: 'é«˜çº§åŒ»ç–—', cost: 55, desc: 'æ²»ç–—æ•ˆæœ+40%', time: 30, icon: 'ğŸ’Š', require: [] },
                    { id: 'reinforced_structure', name: 'å¼ºåŒ–ç»“æ„', cost: 65, desc: 'å»ºç­‘è€ä¹…+30%', time: 42, icon: 'ğŸ—ï¸', require: ['advanced_defense'] },
                    { id: 'hydroponics', name: 'æ°´è€•æŠ€æœ¯', cost: 80, desc: 'é£Ÿç‰©+5/h æ°´-2/h', time: 60, icon: 'ğŸŒ¿', require: ['basic_farming', 'water_purify'] },
                    { id: 'recycling', name: 'èµ„æºå›æ”¶', cost: 45, desc: 'ææ–™æ¶ˆè€—-25%', time: 24, icon: 'â™»ï¸', require: [] },
                    { id: 'surveillance', name: 'ç›‘æ§ç³»ç»Ÿ', cost: 75, desc: 'å¨èƒé¢„è­¦+50%', time: 54, icon: 'ğŸ“¹', require: ['advanced_defense'] },
                    { id: 'education', name: 'æ•™è‚²ç³»ç»Ÿ', desc: 'å¹¸å­˜è€…æŠ€èƒ½æˆé•¿+20%', cost: 50, time: 36, icon: 'ğŸ“š', require: [] },
                    { id: 'automation', name: 'è‡ªåŠ¨åŒ–', cost: 90, desc: 'å·¥äººéœ€æ±‚-30%', time: 72, icon: 'ğŸ¤–', require: ['solar_power', 'recycling'] },
                    { id: 'biotech', name: 'ç”Ÿç‰©ç§‘æŠ€', cost: 100, desc: 'è§£é”åŸºå› æ”¹è‰¯', time: 96, icon: 'ğŸ§¬', require: ['advanced_medicine', 'hydroponics'] }
                ];
                
                // å¤šåª’ä½“ç³»ç»Ÿ
                this.audio = {
                    bgMusic: null,
                    sfx: {
                        build: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-building-wood-hit-3122.mp3'),
                        click: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3'),
                        combat: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-sword-attack-2766.mp3'),
                        success: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3'),
                        error: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3')
                    }
                };
                
                // åˆå§‹åŒ–
                this.init();
            }
            
            // ====== åˆå§‹åŒ–æ–¹æ³• ======
            init() {
                this.initCanvas();
                this.setupUI();
                this.initAudio();
                this.startGameLoop();
                this.loadGame();
                this.checkAchievements();
                
                // éšè—åŠ è½½ç•Œé¢
                setTimeout(() => {
                    document.getElementById('loading-screen').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('loading-screen').style.display = 'none';
                        document.getElementById('game-container').style.display = 'grid';
                        this.showNotification('ã€ŠåºŸåœŸæ–¹èˆŸã€‹å·²åŠ è½½å®Œæˆï¼', 'success');
                    }, 500);
                }, 1500);
            }
            
            initCanvas() {
                this.canvas = document.getElementById('base-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.resizeCanvas();
                this.drawBase();
                window.addEventListener('resize', () => this.resizeCanvas());
            }
            
            resizeCanvas() {
                const container = this.canvas.parentElement;
                this.canvas.width = container.clientWidth - 16;
                this.canvas.height = container.clientHeight - 120;
                this.drawBase();
            }
            
            initAudio() {
                // èƒŒæ™¯éŸ³ä¹
             this.audio.bgMusic = new Audio('https://anrao1314.github.io/MP3/mixkit-cyberpunk-city-140.mp3');
                
                // è®¾ç½®éŸ³æ•ˆéŸ³é‡
                Object.values(this.audio.sfx).forEach(sfx => {
                    sfx.volume = 0.5;
                });
                
                // åº”ç”¨è®¾ç½®
                this.applyAudioSettings();
            }
            
            applyAudioSettings() {
                if (this.audio.bgMusic) {
                    this.audio.bgMusic.muted = !this.gameState.settings.music;
                }
                Object.values(this.audio.sfx).forEach(sfx => {
                    sfx.muted = !this.gameState.settings.sfx;
                });
            }
            
            playSound(soundName) {
                if (this.audio.sfx[soundName] && this.gameState.settings.sfx) {
                    this.audio.sfx[soundName].currentTime = 0;
                    this.audio.sfx[soundName].play().catch(e => console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e));
                }
            }
            
            // ====== UI è®¾ç½® ======
            setupUI() {
                this.updateUI();
                this.bindButtonEvents();
                this.setupCanvasEvents();
                this.setupQuickActions();
            }
            
            updateUI() {
                // çŠ¶æ€æ 
                document.getElementById('day-count').textContent = `ç¬¬${this.gameState.day}å¤©`;
                document.getElementById('time-display').textContent = 
                    `${this.gameState.hour.toString().padStart(2, '0')}:00`;
                
                const weatherMap = {
                    'clear': 'â˜€ï¸æ™´æœ—', 'rain': 'ğŸŒ§ï¸é›¨å¤©', 
                    'fog': 'ğŸŒ«ï¸é›¾å¤©', 'storm': 'â›ˆï¸æš´é£é›¨',
                    'windy': 'ğŸ’¨å¤§é£', 'snow': 'â„ï¸é›ªå¤©'
                };
                document.getElementById('weather').textContent = 
                    weatherMap[this.gameState.weather] || this.gameState.weather;
                
                document.getElementById('morale').textContent = `å£«æ°”: ${this.gameState.morale}`;
                document.getElementById('survivor-count').textContent = `${this.survivors.length}äºº`;
                document.getElementById('settings-survivor-count').textContent = this.survivors.length;
                document.getElementById('settings-game-day').textContent = this.gameState.day;
                
                // èµ„æºåˆ—è¡¨
                this.updateResourceList();
                
                // ç§‘æŠ€æ ‘
                this.updateTechTree();
                
                // å¹¸å­˜è€…åˆ—è¡¨
                this.updateSurvivorList();
                
                // äº‹ä»¶æ—¥å¿—
                this.updateEventLog();
                
                // é˜²å¾¡ç­‰çº§
                const defenseBuildings = this.buildings.filter(b => 
                    ['ç­æœ›å¡”', 'å›´å¢™', 'å“¨å¡”'].includes(b.type)
                ).length;
                document.getElementById('defense-level').textContent = 
                    `é˜²å¾¡: ${Math.min(10, Math.floor(defenseBuildings / 2) + 1)}çº§`;
                
                // æ€»èµ„æºç»Ÿè®¡
                const total = Object.values(this.resources).reduce((sum, r) => sum + r.amount, 0);
                document.getElementById('total-resources').textContent = `æ€»é‡: ${Math.floor(total)}`;
                
                // ç§‘æŠ€è¿›åº¦
                const researched = this.gameState.tech.size;
                const totalTech = this.techTree.length;
                document.getElementById('tech-progress').textContent = `${researched}/${totalTech}`;
                
                // ç”»å¸ƒæ›´æ–°
                this.drawBase();
            }
            
            updateResourceList() {
                const container = document.getElementById('resource-list');
                container.innerHTML = '';
                
                for (const [name, data] of Object.entries(this.resources)) {
                    const percent = (data.amount / data.max) * 100;
                    const color = percent > 50 ? '#2ecc71' : percent > 20 ? '#f39c12' : '#e74c3c';
                    const icon = this.getResourceIcon(name);
                    
                    const item = document.createElement('div');
                    item.className = 'resource-item';
                    item.innerHTML = `
                        <div class="resource-icon">${icon}</div>
                        <div class="resource-info" style="flex: 1;">
                            <div>${name}</div>
                            <div class="resource-bar">
                                <div class="resource-fill" style="width: ${percent}%; background: ${color};"></div>
                            </div>
                            <div style="font-size: 10px; color: #aaa;">
                                ${Math.floor(data.amount)}/${data.max}
                                <span style="color: ${data.prod > data.cons ? '#2ecc71' : '#e74c3c'}; margin-left: 5px;">
                                    ${data.prod > data.cons ? '+' : ''}${(data.prod - data.cons).toFixed(1)}/h
                                </span>
                            </div>
                        </div>
                    `;
                    container.appendChild(item);
                }
            }
            
            updateTechTree() {
                const container = document.getElementById('tech-tree');
                container.innerHTML = '';
                
                this.techTree.forEach(tech => {
                    const canResearch = this.canResearchTech(tech);
                    const researched = this.gameState.tech.has(tech.id);
                    
                    const item = document.createElement('div');
                    item.className = `tech-item ${researched ? 'researched' : ''} ${!canResearch && !researched ? 'insufficient' : ''}`;
                    item.dataset.tech = tech.id;
                    
                    let requirements = '';
                    if (tech.require.length > 0) {
                        requirements = `<small style="color: #f39c12;">éœ€è¦: ${tech.require.map(r => this.techTree.find(t => t.id === r)?.name || r).join(', ')}</small>`;
                    }
                    
                    item.innerHTML = `
                        <div>${tech.icon} ${tech.name}</div>
                        <small style="color: #8899cc;">${tech.desc}</small>
                        <div style="display: flex; justify-content: space-between; margin-top: 3px;">
                            <span style="color: #f39c12; font-size: 10px;">${tech.cost}ææ–™</span>
                            <span style="color: #3498db; font-size: 10px;">${researched ? 'âœ…å·²ç ”ç©¶' : canResearch ? 'ğŸŸ¡å¯ç ”ç©¶' : 'ğŸ”’æœªè§£é”'}</span>
                        </div>
                        ${requirements}
                    `;
                    
                    container.appendChild(item);
                });
            }
            
            updateSurvivorList() {
                const container = document.getElementById('survivor-list');
                container.innerHTML = '';
                
                this.survivors.forEach(survivor => {
                    const card = document.createElement('div');
                    card.className = 'survivor-card';
                    card.dataset.id = survivor.id;
                    card.innerHTML = `
                        <div class="survivor-header">
                            <div class="survivor-avatar">${survivor.name.charAt(0)}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; font-size: 12px;">${survivor.name}</div>
                                <div style="font-size: 10px; color: #3498db;">${survivor.skill}</div>
                                <div style="font-size: 9px; color: #aaa;">${survivor.status}</div>
                            </div>
                            <button class="btn btn-small btn-feed" data-id="${survivor.id}" style="padding: 2px 5px; font-size: 9px;">
                                ğŸ–å–‚é£Ÿ
                            </button>
                        </div>
                        
                        <div class="stat-row">
                            <span style="width: 40px; font-size: 9px;">â¤ï¸å¥åº·</span>
                            <div class="stat-bar">
                                <div class="stat-fill health-bar" style="width: ${survivor.health}%;"></div>
                            </div>
                            <span style="width: 25px; font-size: 9px; text-align: right;">${Math.floor(survivor.health)}%</span>
                        </div>
                        
                        <div class="stat-row">
                            <span style="width: 40px; font-size: 9px;">ğŸ–é¥¥é¥¿</span>
                            <div class="stat-bar">
                                <div class="stat-fill hunger-bar" style="width: ${survivor.hunger}%;"></div>
                            </div>
                            <span style="width: 25px; font-size: 9px; text-align: right;">${Math.floor(survivor.hunger)}%</span>
                        </div>
                        
                        <div class="stat-row">
                            <span style="width: 40px; font-size: 9px;">âš¡ç²¾åŠ›</span>
                            <div class="stat-bar">
                                <div class="stat-fill energy-bar" style="width: ${survivor.energy}%;"></div>
                            </div>
                            <span style="width: 25px; font-size: 9px; text-align: right;">${Math.floor(survivor.energy)}%</span>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }
            
            updateEventLog() {
                const container = document.getElementById('event-log');
                container.innerHTML = '';
                
                const recentEvents = this.events.slice(-8);
                
                recentEvents.forEach(event => {
                    const entry = document.createElement('div');
                    entry.className = `log-entry ${event.type}`;
                    entry.innerHTML = `
                        <span style="color: #aaa; font-size: 10px;">[${event.time}]</span>
                        <span style="font-size: 11px;">${event.message}</span>
                    `;
                    container.appendChild(entry);
                });
                
                container.scrollTop = container.scrollHeight;
            }
            
            updateAchievements() {
                const container = document.getElementById('achievements-list');
                if (!container) return;
                
                container.innerHTML = '';
                
                this.achievementList.forEach(achievement => {
                    const unlocked = this.gameState.achievements.has(achievement.id);
                    
                    const item = document.createElement('div');
                    item.className = `achievement ${unlocked ? '' : 'locked'}`;
                    item.innerHTML = `
                        <div class="achievement-icon">${achievement.icon}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; font-size: 12px;">${achievement.name}</div>
                            <div style="font-size: 10px; color: ${unlocked ? '#8899cc' : '#666'};">${achievement.desc}</div>
                            <div style="font-size: 9px; color: ${unlocked ? '#2ecc71' : '#e74c3c'}; margin-top: 2px;">
                                ${unlocked ? 'âœ… å·²è§£é”' : 'ğŸ”’ æœªè§£é”'}
                            </div>
                        </div>
                    `;
                    container.appendChild(item);
                });
            }
            
            // ====== æ¸¸æˆå¾ªç¯ ======
            startGameLoop() {
                setInterval(() => {
                    if (!this.gameState.paused) {
                        this.updateGame();
                    }
                }, 1000 / this.gameState.settings.speed);
            }
            
            updateGame() {
                // æ—¶é—´æµé€
                this.gameState.hour++;
                if (this.gameState.hour >= 24) {
                    this.gameState.hour = 0;
                    this.gameState.day++;
                    this.addEvent(`ç¬¬${this.gameState.day}å¤©å¼€å§‹äº†`, 'info');
                    
                    // æ¯å¤©å¢åŠ å¨èƒ
                    if (this.gameState.day % 3 === 0) {
                        this.gameState.threat = Math.min(10, this.gameState.threat + 1);
                        this.addEvent('å¨èƒç­‰çº§æå‡äº†ï¼', 'alert');
                    }
                }
                
                // éšæœºå¤©æ°”
                if (Math.random() < 0.1) {
                    const weathers = ['clear', 'rain', 'fog', 'storm', 'windy', 'snow'];
                    this.gameState.weather = weathers[Math.floor(Math.random() * weathers.length)];
                }
                
                // æ›´æ–°èµ„æº
                for (const [name, data] of Object.entries(this.resources)) {
                    const net = data.prod - data.cons;
                    data.amount = Math.max(0, Math.min(data.amount + net, data.max));
                    
                    if (data.amount < data.max * 0.2 && Math.random() < 0.1) {
                        this.addEvent(`âš ï¸ ${name}å‚¨é‡ä¸è¶³ï¼`, 'danger');
                    }
                }
                
                // æ›´æ–°å¹¸å­˜è€…
                this.survivors.forEach(survivor => {
                    survivor.hunger += 0.5;
                    survivor.energy -= 0.3;
                    
                    if (survivor.hunger > 80) {
                        survivor.health -= 1;
                    }
                    
                    if (survivor.energy < 30) {
                        survivor.health -= 0.5;
                    }
                    
                    // è‡ªåŠ¨æ¢å¤
                    if (survivor.hunger < 20 && survivor.energy > 70) {
                        survivor.health = Math.min(100, survivor.health + 0.2);
                    }
                    
                    // é™åˆ¶èŒƒå›´
                    survivor.hunger = Math.max(0, Math.min(100, survivor.hunger));
                    survivor.energy = Math.max(0, Math.min(100, survivor.energy));
                    survivor.health = Math.max(0, Math.min(100, survivor.health));
                    
                    // æ­»äº¡æ£€æŸ¥
                    if (survivor.health <= 0) {
                        this.handleDeath(survivor);
                    }
                });
                
                // æ›´æ–°å£«æ°”
                const avgHealth = this.survivors.reduce((sum, s) => sum + s.health, 0) / this.survivors.length;
                const avgHunger = this.survivors.reduce((sum, s) => sum + s.hunger, 0) / this.survivors.length;
                
                this.gameState.morale = Math.max(0, Math.min(100,
                    avgHealth * 0.5 + (100 - avgHunger) * 0.3 + 
                    (this.buildings.length * 2) + (this.gameState.tech.size * 5)
                ));
                
                // éšæœºäº‹ä»¶
                if (Math.random() < 0.05) {
                    this.randomEvent();
                }
                
                // éšæœºæ•Œäºº
                if (Math.random() < 0.02 + this.gameState.threat * 0.01) {
                    this.spawnEnemy();
                }
                
                // æ£€æŸ¥æˆå°±
                this.checkAchievements();
                
                // æ›´æ–°UI
                this.updateUI();
            }
            
            // ====== æ ¸å¿ƒæ¸¸æˆåŠŸèƒ½ ======
            createRandomSurvivor(id) {
                const name = this.survivorNames[Math.floor(Math.random() * this.survivorNames.length)];
                const skill = this.survivorSkills[Math.floor(Math.random() * this.survivorSkills.length)];
                
                return {
                    id: id,
                    name: name,
                    health: 70 + Math.floor(Math.random() * 30),
                    hunger: 40 + Math.floor(Math.random() * 40),
                    energy: 60 + Math.floor(Math.random() * 40),
                    skill: skill,
                    status: 'ç©ºé—²',
                    experience: 0,
                    level: 1
                };
            }
            
            getResourceIcon(name) {
                const icons = {
                    'é£Ÿç‰©': 'ğŸ', 'æ°´': 'ğŸ’§', 'ææ–™': 'ğŸ”¨',
                    'è¯å“': 'ğŸ’Š', 'å¼¹è¯': 'ğŸ”«', 'ç”µåŠ›': 'âš¡'
                };
                return icons[name] || 'ğŸ“¦';
            }
            
            // ====== äº‹ä»¶ç³»ç»Ÿ ======
            addEvent(message, type = 'info') {
                const time = new Date().toLocaleTimeString('zh-CN', { 
                    hour: '2-digit', minute: '2-digit', hour12: false 
                });
                this.events.push({ time, message, type });
                
                // æ˜¾ç¤ºé€šçŸ¥
                this.showNotification(message, type);
                
                this.updateEventLog();
                this.playSound(type === 'success' ? 'success' : 'click');
            }
            
            showNotification(message, type = 'info') {
                const container = document.getElementById('notification-container');
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                container.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
            
            // ====== æŒ‰é’®äº‹ä»¶ç»‘å®š ======
            bindButtonEvents() {
                // æ§åˆ¶æŒ‰é’®
                document.getElementById('btn-pause').addEventListener('click', () => this.togglePause());
                document.getElementById('btn-save').addEventListener('click', () => this.saveGame());
                document.getElementById('btn-explore').addEventListener('click', () => this.toggleExplorePanel());
                document.getElementById('btn-combat').addEventListener('click', () => this.checkCombat());
                document.getElementById('btn-recruit').addEventListener('click', () => this.recruitSurvivor());
                document.getElementById('btn-settings').addEventListener('click', () => this.showSettings());
                document.getElementById('btn-achievements').addEventListener('click', () => this.showAchievements());
                
                // å¿«æ·æŒ‰é’®
                document.getElementById('quick-pause').addEventListener('click', () => this.togglePause());
                document.getElementById('quick-save').addEventListener('click', () => this.saveGame());
                document.getElementById('quick-explore').addEventListener('click', () => this.toggleExplorePanel());
                document.getElementById('quick-menu').addEventListener('click', () => this.showQuickMenu());
                
                // å»ºé€ æŒ‰é’®
                document.querySelectorAll('.btn-build').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const type = e.currentTarget.dataset.type;
                        const cost = parseInt(e.currentTarget.dataset.cost);
                        const requiredTech = e.currentTarget.dataset.tech;
                        
                        if (requiredTech && !this.gameState.tech.has(requiredTech)) {
                            this.showNotification(`éœ€è¦ç ”ç©¶"${this.techTree.find(t => t.id === requiredTech)?.name || requiredTech}"`, 'warning');
                            return;
                        }
                        
                        if (this.resources['ææ–™'].amount >= cost) {
                            this.buildStructure(type, cost);
                            this.playSound('build');
                        } else {
                            this.showNotification(`ææ–™ä¸è¶³ï¼éœ€è¦${cost}ææ–™`, 'danger');
                            this.playSound('error');
                        }
                    });
                });
                
                // æ¢ç´¢æŒ‰é’®
                document.querySelectorAll('.btn-explore').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const location = e.currentTarget.dataset.location;
                        const risk = parseFloat(e.currentTarget.dataset.risk);
                        this.exploreLocation(location, risk);
                    });
                });
                
                // ç§‘æŠ€ç ”ç©¶
                document.getElementById('tech-tree').addEventListener('click', (e) => {
                    const techItem = e.target.closest('.tech-item');
                    if (techItem) {
                        const techId = techItem.dataset.tech;
                        if (!this.gameState.tech.has(techId) && this.canResearchTech(this.techTree.find(t => t.id === techId))) {
                            this.showResearchModal(techId);
                        }
                    }
                });
                
                // å¹¸å­˜è€…å–‚é£Ÿï¼ˆäº‹ä»¶å§”æ‰˜ï¼‰
                document.getElementById('survivor-panel').addEventListener('click', (e) => {
                    if (e.target.closest('.btn-feed')) {
                        const survivorId = parseInt(e.target.closest('.btn-feed').dataset.id);
                        this.feedSurvivor(survivorId);
                    }
                });
                
                // è®¾ç½®é¢æ¿
                document.getElementById('music-toggle').addEventListener('change', (e) => {
                    this.gameState.settings.music = e.target.checked;
                    this.applyAudioSettings();
                    if (e.target.checked) {
                        this.audio.bgMusic.play().catch(e => console.log('éŸ³ä¹æ’­æ”¾å¤±è´¥'));
                    }
                });
                
                document.getElementById('sfx-toggle').addEventListener('change', (e) => {
                    this.gameState.settings.sfx = e.target.checked;
                    this.applyAudioSettings();
                });
                
                document.getElementById('game-speed').addEventListener('change', (e) => {
                    this.gameState.settings.speed = parseFloat(e.target.value);
                });
                
                document.getElementById('night-mode').addEventListener('change', (e) => {
                    this.gameState.settings.nightMode = e.target.checked;
                    document.body.classList.toggle('night-mode', e.target.checked);
                });
                
                document.getElementById('vibration-toggle').addEventListener('change', (e) => {
                    this.gameState.settings.vibration = e.target.checked;
                });
                
                document.getElementById('btn-exit-game').addEventListener('click', () => {
                    if (confirm('ç¡®å®šè¦é€€å‡ºæ¸¸æˆå—ï¼Ÿæœªä¿å­˜çš„è¿›åº¦å¯èƒ½ä¼šä¸¢å¤±ã€‚')) {
                        this.saveGame();
                        window.close();
                    }
                });
                
                document.getElementById('btn-close-settings').addEventListener('click', () => {
                    document.getElementById('settings-modal').style.display = 'none';
                    this.saveSettings();
                });
                
                // æˆå°±é¢æ¿
                document.getElementById('btn-close-achievements').addEventListener('click', () => {
                    document.getElementById('achievements-modal').style.display = 'none';
                });
                
                // æ¢ç´¢é¢æ¿
                document.getElementById('btn-close-explore').addEventListener('click', () => {
                    document.getElementById('explore-modal').style.display = 'none';
                });
                
                // æˆ˜æ–—é¢æ¿
                document.getElementById('btn-attack').addEventListener('click', () => this.combatAction('attack'));
                document.getElementById('btn-defend').addEventListener('click', () => this.combatAction('defend'));
                document.getElementById('btn-flee').addEventListener('click', () => this.combatAction('flee'));
                
                // çª—å£å¤§å°å˜åŒ–
                window.addEventListener('resize', () => {
                    this.resizeCanvas();
                });
            }
            
            setupCanvasEvents() {
                const canvas = document.getElementById('base-canvas');
                
                canvas.addEventListener('click', (e) => {
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    // æ£€æŸ¥ç‚¹å‡»å»ºç­‘
                    this.buildings.forEach(building => {
                        const scale = canvas.width / 600;
                        const bX = building.x * scale;
                        const bY = building.y * scale;
                        const size = 50 * scale;
                        
                        if (x >= bX && x <= bX + size && y >= bY && y <= bY + size) {
                            this.showBuildingInfo(building);
                        }
                    });
                });
                
                canvas.addEventListener('mousemove', (e) => {
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    let hovered = false;
                    this.buildings.forEach(building => {
                        const scale = canvas.width / 600;
                        const bX = building.x * scale;
                        const bY = building.y * scale;
                        const size = 50 * scale;
                        
                        if (x >= bX && x <= bX + size && y >= bY && y <= bY + size) {
                            canvas.style.cursor = 'pointer';
                            hovered = true;
                        }
                    });
                    
                    if (!hovered) canvas.style.cursor = 'default';
                });
            }
            
            setupQuickActions() {
                // å¿«æ·èœå•æŒ‰é’®
                document.getElementById('quick-menu').addEventListener('click', () => {
                    this.showQuickMenu();
                });
            }
            
            // ====== æ¸¸æˆåŠŸèƒ½æ–¹æ³• ======
            togglePause() {
                this.gameState.paused = !this.gameState.paused;
                const btn = document.getElementById('btn-pause');
                if (this.gameState.paused) {
                    btn.innerHTML = '<span>â–¶ï¸</span><span>ç»§ç»­</span>';
                    this.addEvent('æ¸¸æˆå·²æš‚åœ', 'info');
                    this.audio.bgMusic?.pause();
                } else {
                    btn.innerHTML = '<span>â¸ï¸</span><span>æš‚åœ</span>';
                    this.addEvent('æ¸¸æˆç»§ç»­', 'info');
                    if (this.gameState.settings.music) {
                        this.audio.bgMusic?.play().catch(e => console.log('éŸ³ä¹æ’­æ”¾å¤±è´¥'));
                    }
                }
            }
            
            saveGame() {
                const saveData = {
                    gameState: this.gameState,
                    resources: this.resources,
                    survivors: this.survivors,
                    buildings: this.buildings,
                    tech: Array.from(this.gameState.tech),
                    achievements: Array.from(this.gameState.achievements),
                    explored: Array.from(this.gameState.explored)
                };
                
                try {
                    localStorage.setItem('åºŸåœŸæ–¹èˆŸ_save', JSON.stringify(saveData));
                    this.showNotification('æ¸¸æˆè¿›åº¦å·²ä¿å­˜ï¼', 'success');
                    
                    // ä¿å­˜è®¾ç½®
                    this.saveSettings();
                    
                    // æŒ‰é’®åé¦ˆ
                    const btn = document.getElementById('btn-save');
                    const original = btn.innerHTML;
                    btn.innerHTML = '<span>âœ…</span><span>å·²ä¿å­˜</span>';
                    setTimeout(() => {
                        btn.innerHTML = original;
                    }, 1000);
                } catch (e) {
                    this.showNotification('ä¿å­˜å¤±è´¥ï¼šå­˜å‚¨ç©ºé—´ä¸è¶³', 'danger');
                }
            }
            
            saveSettings() {
                localStorage.setItem('åºŸåœŸæ–¹èˆŸ_settings', JSON.stringify(this.gameState.settings));
            }
            
            loadGame() {
                try {
                    // åŠ è½½æ¸¸æˆå­˜æ¡£
                    const saveData = localStorage.getItem('åºŸåœŸæ–¹èˆŸ_save');
                    if (saveData) {
                        const data = JSON.parse(saveData);
                        this.gameState = { ...this.gameState, ...data.gameState };
                        this.resources = data.resources || this.resources;
                        this.survivors = data.survivors || this.survivors;
                        this.buildings = data.buildings || this.buildings;
                        this.gameState.tech = new Set(data.tech || []);
                        this.gameState.achievements = new Set(data.achievements || []);
                        this.gameState.explored = new Set(data.explored || []);
                        
                        // æ¢å¤Setå¯¹è±¡
                        this.gameState.tech = new Set(this.gameState.tech);
                        this.gameState.achievements = new Set(this.gameState.achievements);
                        this.gameState.explored = new Set(this.gameState.explored);
                        
                        this.addEvent('è¯»å–å­˜æ¡£æˆåŠŸï¼', 'success');
                    }
                    
                    // åŠ è½½è®¾ç½®
                    const settingsData = localStorage.getItem('åºŸåœŸæ–¹èˆŸ_settings');
                    if (settingsData) {
                        this.gameState.settings = { ...this.gameState.settings, ...JSON.parse(settingsData) };
                        this.applySettingsToUI();
                    }
                } catch (e) {
                    console.error('è¯»å–å­˜æ¡£å¤±è´¥:', e);
                }
            }
            
            applySettingsToUI() {
                document.getElementById('music-toggle').checked = this.gameState.settings.music;
                document.getElementById('sfx-toggle').checked = this.gameState.settings.sfx;
                document.getElementById('game-speed').value = this.gameState.settings.speed;
                document.getElementById('night-mode').checked = this.gameState.settings.nightMode;
                document.getElementById('vibration-toggle').checked = this.gameState.settings.vibration;
                
                document.body.classList.toggle('night-mode', this.gameState.settings.nightMode);
                this.applyAudioSettings();
                
                if (this.gameState.settings.music) {
                    this.audio.bgMusic?.play().catch(e => console.log('éŸ³ä¹æ’­æ”¾å¤±è´¥'));
                }
            }
            
            // ====== å»ºç­‘ç³»ç»Ÿ ======
            buildStructure(type, cost) {
                if (this.resources['ææ–™'].amount < cost) {
                    this.showNotification(`ææ–™ä¸è¶³ï¼éœ€è¦${cost}ææ–™`, 'danger');
                    return;
                }
                
                // æ£€æŸ¥äººå£é™åˆ¶
                if (type === 'å®¿èˆ') {
                    const maxPopulation = 4 + this.buildings.filter(b => b.type === 'å®¿èˆ').length * 4;
                    if (this.survivors.length >= maxPopulation) {
                        this.showNotification('äººå£å·²è¾¾ä¸Šé™ï¼Œéœ€è¦å»ºé€ æ›´å¤šå®¿èˆ', 'warning');
                        return;
                    }
                }
                
                // æ‰£é™¤èµ„æº
                this.resources['ææ–™'].amount -= cost;
                
                // åˆ›å»ºæ–°å»ºç­‘
                const newId = this.buildings.length + 1;
                const x = 50 + (this.buildings.length % 5) * 100;
                const y = 50 + Math.floor(this.buildings.length / 5) * 80;
                
                const building = {
                    id: newId,
                    type: type,
                    level: 1,
                    x: Math.min(x, 550),
                    y: Math.min(y, 350),
                    workers: [],
                    efficiency: 1.0
                };
                
                this.buildings.push(building);
                
                // å»ºç­‘æ•ˆæœ
                this.applyBuildingEffect(type);
                
                this.addEvent(`å»ºé€ äº†æ–°çš„${type}`, 'success');
                this.checkAchievement('builder');
                
                this.updateUI();
            }
            
            applyBuildingEffect(type) {
                switch(type) {
                    case 'å¨æˆ¿':
                        this.resources['é£Ÿç‰©'].prod += 3;
                        break;
                    case 'åŒ»ç–—ç«™':
                        this.survivors.forEach(s => s.health = Math.min(100, s.health + 10));
                        break;
                    case 'ä»“åº“':
                        Object.values(this.resources).forEach(r => r.max += 200);
                        break;
                    case 'æ°´å¤„ç†å‚':
                        this.resources['æ°´'].prod += 5;
                        break;
                    case 'å‘ç”µç«™':
                        this.resources['ç”µåŠ›'].prod += 10;
                        break;
                    case 'å†œåœº':
                        this.resources['é£Ÿç‰©'].prod += 4;
                        break;
                    case 'å·¥åŠ':
                        this.resources['ææ–™'].prod += 2;
                        break;
                    case 'å¨±ä¹å®¤':
                        this.gameState.morale = Math.min(100, this.gameState.morale + 5);
                        break;
                    case 'å†›æ¢°åº“':
                        this.resources['å¼¹è¯'].prod += 2;
                        break;
                    case 'æ¸©å®¤':
                        this.resources['é£Ÿç‰©'].prod += 2;
                        this.resources['æ°´'].cons += 1;
                        break;
                }
            }
            
            showBuildingInfo(building) {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                `;
                
                const workers = building.workers.map(id => 
                    this.survivors.find(s => s.id === id)?.name || 'æœªçŸ¥'
                ).join(', ') || 'æ— ';
                
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 300px;">
                        <div class="modal-title">${this.getBuildingEmoji(building.type)} ${building.type}</div>
                        <div style="padding: 10px;">
                            <div style="margin-bottom: 8px; color: #aabbee;">ç­‰çº§: ${building.level}</div>
                            <div style="margin-bottom: 8px; color: #aabbee;">æ•ˆç‡: ${Math.round(building.efficiency * 100)}%</div>
                            <div style="margin-bottom: 15px; color: #aabbee;">å·¥äºº: ${workers}</div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-success btn-upgrade" data-id="${building.id}" 
                                        style="flex: 1;">
                                    â¬†ï¸ å‡çº§
                                </button>
                                <button class="btn btn-close-building" 
                                        style="flex: 1; background: #e74c3c;">
                                    å…³é—­
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                modal.querySelector('.btn-upgrade').addEventListener('click', () => {
                    this.upgradeBuilding(building.id);
                    modal.remove();
                });
                
                modal.querySelector('.btn-close-building').addEventListener('click', () => {
                    modal.remove();
                });
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }
            
            getBuildingEmoji(type) {
                const emojis = {
                    'æŒ‡æŒ¥ä¸­å¿ƒ': 'ğŸ¢', 'å®¿èˆ': 'ğŸ›ï¸', 'å¨æˆ¿': 'ğŸ³', 'åŒ»ç–—ç«™': 'ğŸ¥',
                    'ç­æœ›å¡”': 'ğŸ”­', 'ä»“åº“': 'ğŸ“¦', 'ç ”ç©¶æ‰€': 'ğŸ”¬', 'æ°´å¤„ç†å‚': 'ğŸ’§',
                    'å‘ç”µç«™': 'âš¡', 'è®­ç»ƒåœº': 'âš”ï¸', 'å†œåœº': 'ğŸŒ¾', 'å›´å¢™': 'ğŸ§±',
                    'å“¨å¡”': 'ğŸ¹', 'å·¥åŠ': 'ğŸ”¨', 'å¨±ä¹å®¤': 'ğŸ®', 'é€šè®¯ç«™': 'ğŸ“¡',
                    'å†›æ¢°åº“': 'ğŸ”«', 'æ¸©å®¤': 'ğŸŒ¿'
                };
                return emojis[type] || 'ğŸ ';
            }
            
            upgradeBuilding(buildingId) {
                const building = this.buildings.find(b => b.id === buildingId);
                if (!building) return;
                
                const upgradeCost = building.level * 75;
                
                if (this.resources['ææ–™'].amount < upgradeCost) {
                    this.showNotification(`å‡çº§éœ€è¦${upgradeCost}ææ–™`, 'danger');
                    return;
                }
                
                this.resources['ææ–™'].amount -= upgradeCost;
                building.level++;
                building.efficiency = Math.min(1.5, building.efficiency + 0.1);
                
                // å‡çº§æ•ˆæœ
                switch(building.type) {
                    case 'å¨æˆ¿':
                        this.resources['é£Ÿç‰©'].prod += 2;
                        break;
                    case 'åŒ»ç–—ç«™':
                        this.survivors.forEach(s => s.health = Math.min(100, s.health + 5));
                        break;
                    case 'ç­æœ›å¡”':
                        this.gameState.threat = Math.max(1, this.gameState.threat - 0.5);
                        break;
                }
                
                this.addEvent(`${building.type}å‡çº§åˆ°${building.level}çº§`, 'success');
                this.updateUI();
            }
            
            // ====== å¹¸å­˜è€…ç³»ç»Ÿ ======
            feedSurvivor(survivorId) {
                if (this.resources['é£Ÿç‰©'].amount < 5) {
                    this.showNotification('é£Ÿç‰©ä¸è¶³ï¼', 'danger');
                    return;
                }
                
                const survivor = this.survivors.find(s => s.id === survivorId);
                if (survivor) {
                    this.resources['é£Ÿç‰©'].amount -= 5;
                    survivor.hunger = Math.max(0, survivor.hunger - 30);
                    survivor.health = Math.min(100, survivor.health + 10);
                    this.addEvent(`å–‚é£Ÿäº†${survivor.name}`, 'success');
                    this.updateUI();
                    this.playSound('click');
                }
            }
            
            recruitSurvivor() {
                const maxPopulation = 4 + this.buildings.filter(b => b.type === 'å®¿èˆ').length * 4;
                if (this.survivors.length >= maxPopulation) {
                    this.showNotification('äººå£å·²è¾¾ä¸Šé™ï¼Œéœ€è¦å»ºé€ æ›´å¤šå®¿èˆ', 'warning');
                    return;
                }
                
                if (this.resources['é£Ÿç‰©'].amount < 20 || this.resources['æ°´'].amount < 15) {
                    this.showNotification('èµ„æºä¸è¶³ï¼Œæ— æ³•æ‹›å‹Ÿå¹¸å­˜è€…', 'danger');
                    return;
                }
                
                this.resources['é£Ÿç‰©'].amount -= 20;
                this.resources['æ°´'].amount -= 15;
                
                const newId = this.survivors.length + 1;
                const newSurvivor = this.createRandomSurvivor(newId);
                this.survivors.push(newSurvivor);
                
                this.addEvent(`${newSurvivor.name}åŠ å…¥äº†åŸºåœ°ï¼ˆæŠ€èƒ½ï¼š${newSurvivor.skill}ï¼‰`, 'success');
                this.checkAchievement('ark_heart');
                this.updateUI();
                this.playSound('success');
            }
            
            handleDeath(survivor) {
                const index = this.survivors.findIndex(s => s.id === survivor.id);
                if (index !== -1) {
                    this.addEvent(`ğŸ˜¢ ${survivor.name}ä¸å¹¸å»ä¸–äº†...`, 'danger');
                    this.survivors.splice(index, 1);
                    this.gameState.morale -= 20;
                    this.updateUI();
                }
            }
            
            // ====== æ¢ç´¢ç³»ç»Ÿ ======
            toggleExplorePanel() {
                const panel = document.getElementById('explore-panel');
                panel.style.display = panel.style.display === 'none' ? 'grid' : 'none';
            }
            
            exploreLocation(location, risk) {
                const availableSurvivors = this.survivors.filter(s => s.health > 50 && s.energy > 40);
                if (availableSurvivors.length < 2) {
                    this.showNotification('æ²¡æœ‰è¶³å¤Ÿçš„å¥åº·å¹¸å­˜è€…è¿›è¡Œæ¢ç´¢', 'danger');
                    return;
                }
                
                // æ¶ˆè€—ç²¾åŠ›
                availableSurvivors.slice(0, 2).forEach(s => {
                    s.energy -= 30;
                    s.hunger += 20;
                });
                
                // æ¢ç´¢ç»“æœ
                let result = '';
                let success = Math.random() > risk;
                
                // æ·»åŠ åˆ°æ¢ç´¢è®°å½•
                this.gameState.explored.add(location);
                this.checkAchievement('explorer');
                
                if (success) {
                    // æˆåŠŸæ¢ç´¢
                    const rewards = this.getExploreRewards(location);
                    let totalFound = 0;
                    
                    result = `æ¢ç´¢${location}æˆåŠŸï¼å‘ç°ï¼š`;
                    for (const [resource, amount] of Object.entries(rewards)) {
                        this.resources[resource].amount = Math.min(
                            this.resources[resource].max,
                            this.resources[resource].amount + amount
                        );
                        result += ` ${amount}${resource}`;
                        totalFound += amount;
                    }
                    
                    if (Math.random() < 0.3) {
                        // 30%æ¦‚ç‡æ‰¾åˆ°ç‰¹æ®Šç‰©å“
                        const specialItems = ['è®¾è®¡å›¾', 'æ—¥è®°', 'ç…§ç‰‡', 'é’¥åŒ™', 'åœ°å›¾'];
                        const item = specialItems[Math.floor(Math.random() * specialItems.length)];
                        result += ` ä»¥åŠä¸€å¼ ${item}`;
                        this.addEvent(`æ‰¾åˆ°äº†ç‰¹æ®Šçš„${item}`, 'success');
                    }
                    
                    this.addEvent(result, 'success');
                    
                    // æ˜¾ç¤ºæ¢ç´¢ç»“æœ
                    document.getElementById('explore-title').textContent = `ğŸ§­ æ¢ç´¢${location}æˆåŠŸ`;
                    document.getElementById('explore-result').innerHTML = `
                        <div style="text-align: center; padding: 15px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">ğŸ‰</div>
                            <div style="font-size: 16px; margin-bottom: 10px; color: #2ecc71;">æ¢ç´¢æˆåŠŸï¼</div>
                            <div style="margin-bottom: 15px; font-size: 14px;">${result}</div>
                            <div style="color: #2ecc71; font-size: 12px;">
                                é˜Ÿä¼å®‰å…¨è¿”å›åŸºåœ°
                            </div>
                        </div>
                    `;
                } else {
                    // æ¢ç´¢å¤±è´¥
                    const damage = Math.floor(Math.random() * 30) + 10;
                    const survivor = availableSurvivors[0];
                    survivor.health -= damage;
                    
                    result = `æ¢ç´¢${location}å¤±è´¥ï¼${survivor.name}å—ä¼¤ï¼ˆ-${damage}å¥åº·ï¼‰`;
                    this.addEvent(result, 'danger');
                    
                    document.getElementById('explore-title').textContent = `âš ï¸ æ¢ç´¢${location}å¤±è´¥`;
                    document.getElementById('explore-result').innerHTML = `
                        <div style="text-align: center; padding: 15px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">ğŸ˜¨</div>
                            <div style="font-size: 16px; margin-bottom: 10px; color: #e74c3c;">æ¢ç´¢å¤±è´¥ï¼</div>
                            <div style="margin-bottom: 15px; font-size: 14px;">${result}</div>
                            <div style="color: #e74c3c; font-size: 12px;">
                                é˜Ÿä¼é­é‡å±é™©ï¼ŒåŒ†å¿™æ’¤é€€
                            </div>
                        </div>
                    `;
                }
                
                // éšè—æ¢ç´¢é¢æ¿ï¼Œæ˜¾ç¤ºç»“æœ
                document.getElementById('explore-panel').style.display = 'none';
                document.getElementById('explore-modal').style.display = 'flex';
                
                this.updateUI();
                this.playSound(success ? 'success' : 'error');
            }
            
            getExploreRewards(location) {
                const rewards = {
                    'åºŸå¢Ÿ': { 'ææ–™': 30, 'è¯å“': 10 },
                    'åŒ»é™¢': { 'è¯å“': 40, 'ææ–™': 15 },
                    'è¶…å¸‚': { 'é£Ÿç‰©': 50, 'æ°´': 30 },
                    'å†›äº‹åŸºåœ°': { 'å¼¹è¯': 80, 'ææ–™': 40 },
                    'å†œåœº': { 'é£Ÿç‰©': 60, 'æ°´': 20 },
                    'ç ”ç©¶æ‰€åºŸå¢Ÿ': { 'ææ–™': 25, 'è¯å“': 20 }
                };
                
                const base = rewards[location] || { 'ææ–™': 20 };
                const result = {};
                
                for (const [resource, amount] of Object.entries(base)) {
                    const variation = Math.floor(Math.random() * 20) - 10; // -10åˆ°+10çš„éšæœºå˜åŒ–
                    result[resource] = Math.max(5, amount + variation);
                }
                
                return result;
            }
            
            // ====== æˆ˜æ–—ç³»ç»Ÿ ======
            spawnEnemy() {
                if (this.combatActive || this.enemies.length > 0) return;
                
                const enemyTypes = [
                    { type: 'æ™®é€šä¸§å°¸', health: 50, damage: 10, speed: 1, icon: 'ğŸ§Ÿ' },
                    { type: 'å¿«é€Ÿæ„ŸæŸ“è€…', health: 30, damage: 15, speed: 2, icon: 'ğŸƒâ€â™‚ï¸' },
                    { type: 'å·¨å‹ä¸§å°¸', health: 100, damage: 20, speed: 0.5, icon: 'ğŸ‘¹' },
                    { type: 'å˜å¼‚çŠ¬', health: 40, damage: 12, speed: 3, icon: 'ğŸ•' },
                    { type: 'è¾å°„ä¸§å°¸', health: 60, damage: 18, speed: 1, icon: 'â˜¢ï¸' }
                ];
                
                const enemyType = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
                const count = Math.min(3, Math.floor(this.gameState.threat / 2) + 1);
                
                for (let i = 0; i < count; i++) {
                    const enemy = {
                        ...enemyType,
                        id: this.enemies.length + 1,
                        maxHealth: enemyType.health,
                        health: enemyType.health,
                        x: 550 + i * 40,
                        y: Math.random() * 300 + 50
                    };
                    this.enemies.push(enemy);
                }
                
                this.addEvent(`âš ï¸ ${count}ä¸ª${enemyType.type}æ­£åœ¨æ¥è¿‘åŸºåœ°ï¼`, 'danger');
                
                // è‡ªåŠ¨å¼€å§‹æˆ˜æ–—
                setTimeout(() => {
                    if (!this.combatActive && this.enemies.length > 0) {
                        this.startCombat();
                    }
                }, 3000);
                
                this.updateUI();
                this.playSound('combat');
            }
            
            startCombat() {
                if (this.enemies.length === 0) {
                    this.showNotification('å½“å‰æ²¡æœ‰æ•Œäºº', 'info');
                    return;
                }
                
                this.combatActive = true;
                this.currentEnemy = this.enemies[0];
                
                document.getElementById('enemy-info').innerHTML = `
                    <div class="enemy-card">
                        <div style="font-size: 48px;">${this.currentEnemy.icon}</div>
                        <div style="font-size: 18px; margin: 10px 0; color: #e74c3c;">${this.currentEnemy.type}</div>
                        <div>â¤ï¸ ç”Ÿå‘½å€¼: ${this.currentEnemy.health}/${this.currentEnemy.maxHealth}</div>
                        <div>âš”ï¸ ä¼¤å®³: ${this.currentEnemy.damage}</div>
                        <div>ğŸ¯ å‰©ä½™æ•Œäºº: ${this.enemies.length}</div>
                    </div>
                `;
                
                document.getElementById('combat-log').innerHTML = 
                    `<div style="color: #e74c3c;">${this.currentEnemy.type}å‡ºç°åœ¨åŸºåœ°å¤–å›´ï¼</div>`;
                
                document.getElementById('combat-modal').style.display = 'flex';
            }
            
            combatAction(action) {
                if (!this.currentEnemy) return;
                
                const log = document.getElementById('combat-log');
                
                switch(action) {
                    case 'attack':
                        // ç©å®¶æ”»å‡»
                        const playerDamage = 20 + Math.floor(Math.random() * 15);
                        this.currentEnemy.health -= playerDamage;
                        
                        log.innerHTML += `<div>ä½ çš„é˜Ÿä¼å¯¹${this.currentEnemy.type}é€ æˆ${playerDamage}ç‚¹ä¼¤å®³ï¼</div>`;
                        
                        // æ•Œäººåå‡»
                        if (this.currentEnemy.health > 0) {
                            const enemyDamage = this.currentEnemy.damage - Math.floor(Math.random() * 5);
                            const randomSurvivor = this.survivors[Math.floor(Math.random() * this.survivors.length)];
                            randomSurvivor.health -= enemyDamage;
                            
                            log.innerHTML += `<div>${this.currentEnemy.type}åå‡»ï¼Œ${randomSurvivor.name}å—åˆ°${enemyDamage}ç‚¹ä¼¤å®³ï¼</div>`;
                        }
                        break;
                        
                    case 'defend':
                        log.innerHTML += `<div>ä½ çš„é˜Ÿä¼é‡‡å–é˜²å¾¡å§¿æ€ï¼Œå‡å°‘äº†ä¸‹ä¸€æ¬¡ä¼¤å®³ï¼</div>`;
                        break;
                        
                    case 'flee':
                        log.innerHTML += `<div>ä½ çš„é˜Ÿä¼æ’¤é€€äº†ï¼æŸå¤±äº†éƒ¨åˆ†èµ„æºã€‚</div>`;
                        this.resources['ææ–™'].amount = Math.max(0, this.resources['ææ–™'].amount - 20);
                        this.resources['é£Ÿç‰©'].amount = Math.max(0, this.resources['é£Ÿç‰©'].amount - 15);
                        this.endCombat(false);
                        return;
                }
                
                // æ£€æŸ¥æ•Œäººæ˜¯å¦æ­»äº¡
                if (this.currentEnemy.health <= 0) {
                    log.innerHTML += `<div style="color: #2ecc71;">âœ… å‡»è´¥äº†${this.currentEnemy.type}ï¼</div>`;
                    
                    // æ‰è½å¥–åŠ±
                    const rewards = ['ææ–™', 'è¯å“', 'å¼¹è¯'];
                    const reward = rewards[Math.floor(Math.random() * rewards.length)];
                    const amount = Math.floor(Math.random() * 30) + 15;
                    
                    this.resources[reward].amount += amount;
                    this.addEvent(`å‡»è´¥${this.currentEnemy.type}ï¼Œè·å¾—${amount}${reward}`, 'success');
                    
                    // ç§»é™¤æ•Œäºº
                    this.enemies.shift();
                    
                    // æ£€æŸ¥æˆå°±
                    if (this.enemies.length === 0) {
                        this.checkAchievement('zombie_slayer');
                    }
                    
                    this.endCombat(this.enemies.length === 0);
                } else {
                    log.scrollTop = log.scrollHeight;
                }
                
                this.updateUI();
                this.playSound('combat');
            }
            
            endCombat(victory) {
                this.combatActive = false;
                this.currentEnemy = null;
                
                setTimeout(() => {
                    document.getElementById('combat-modal').style.display = 'none';
                }, 2000);
                
                if (victory) {
                    this.addEvent('æˆåŠŸå‡»é€€æ‰€æœ‰æ•Œäººï¼å£«æ°”å¤§æŒ¯ï¼', 'success');
                    this.gameState.morale = Math.min(100, this.gameState.morale + 15);
                    this.gameState.threat = Math.max(1, this.gameState.threat - 1);
                }
                
                this.updateUI();
            }
            
            checkCombat() {
                if (this.enemies.length > 0) {
                    this.startCombat();
                } else {
                    this.showNotification('å½“å‰æ²¡æœ‰æ•Œäºº', 'info');
                }
            }
            
            // ====== ç§‘æŠ€ç ”ç©¶ç³»ç»Ÿ ======
            canResearchTech(tech) {
                if (!tech) return false;
                if (this.gameState.tech.has(tech.id)) return false;
                if (this.resources['ææ–™'].amount < tech.cost) return false;
                
                // æ£€æŸ¥å‰ç½®ç§‘æŠ€
                for (const req of tech.require) {
                    if (!this.gameState.tech.has(req)) return false;
                }
                
                return true;
            }
            
            showResearchModal(techId) {
                const tech = this.techTree.find(t => t.id === techId);
                if (!tech) return;
                
                if (this.gameState.tech.has(techId)) {
                    this.showNotification('è¯¥ç§‘æŠ€å·²ç ”ç©¶å®Œæˆ', 'info');
                    return;
                }
                
                const canResearch = this.canResearchTech(tech);
                
                // åˆ›å»ºç ”ç©¶é¢æ¿
                const modal = document.createElement('div');
                modal.className = `research-modal ${canResearch ? '' : 'insufficient-materials'}`;
                modal.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: #2c3e50;
                    border: 2px solid ${canResearch ? '#3498db' : '#e74c3c'};
                    border-radius: 12px;
                    padding: 15px;
                    z-index: 1001;
                    width: 90%;
                    max-width: 350px;
                    backdrop-filter: blur(10px);
                    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
                `;
                
                let requirements = '';
                if (tech.require.length > 0) {
                    const reqNames = tech.require.map(r => this.techTree.find(t => t.id === r)?.name || r);
                    requirements = `
                        <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 8px; margin: 8px 0; font-size: 12px;">
                            <div style="color: #f39c12; margin-bottom: 4px;">å‰ç½®ç§‘æŠ€ï¼š</div>
                            <div>${reqNames.join('ã€')}</div>
                        </div>
                    `;
                }
                
                modal.innerHTML = `
                    <div style="text-align: center; margin-bottom: 12px;">
                        <div style="font-size: 40px; margin-bottom: 8px;">${tech.icon}</div>
                        <div style="font-size: 18px; color: ${canResearch ? '#3498db' : '#e74c3c'}; margin-bottom: 5px;">
                            ${tech.name}
                        </div>
                        <div style="color: #aabbee; font-size: 13px; margin-bottom: 10px;">${tech.desc}</div>
                    </div>
                    
                    ${requirements}
                    
                    <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12px;">
                            <span style="color: #8899cc;">æ‰€éœ€ææ–™</span>
                            <span style="color: ${canResearch ? '#2ecc71' : '#e74c3c'}; font-weight: bold;">
                                ${tech.cost} ææ–™
                                ${canResearch ? 'âœ…' : 'âŒ'}
                            </span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px;">
                            <span style="color: #8899cc;">å½“å‰åº“å­˜</span>
                            <span style="color: #f39c12; font-weight: bold;">
                                ${Math.floor(this.resources['ææ–™'].amount)} ææ–™
                            </span>
                        </div>
                    </div>
                    
                    <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px; margin-bottom: 15px;">
                        <div style="color: #8899cc; margin-bottom: 5px; font-size: 12px;">ç ”ç©¶æ—¶é—´</div>
                        <div style="color: #3498db; font-size: 16px; font-weight: bold;">
                            ${tech.time} å°æ—¶
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 8px;">
                        ${canResearch ? `
                            <button id="confirm-research" 
                                    style="flex: 2; background: linear-gradient(135deg, #2ecc71, #27ae60); 
                                           color: white; border: none; padding: 10px; border-radius: 8px; 
                                           cursor: pointer; font-weight: bold; font-size: 14px;">
                                ğŸ”¬ å¼€å§‹ç ”ç©¶
                            </button>
                        ` : `
                            <button id="close-research" 
                                    style="flex: 2; background: linear-gradient(135deg, #e74c3c, #c0392b); 
                                           color: white; border: none; padding: 10px; border-radius: 8px; 
                                           cursor: pointer; font-weight: bold; font-size: 14px;">
                                âŒ ${tech.require.length > 0 ? 'æœªæ»¡è¶³å‰ç½®æ¡ä»¶' : 'ææ–™ä¸è¶³'}
                            </button>
                        `}
                        
                        <button id="cancel-research" 
                                style="flex: 1; background: rgba(255,255,255,0.1); 
                                       color: #ddd; border: 1px solid #666; padding: 10px; border-radius: 8px; 
                                       cursor: pointer; font-weight: bold; font-size: 12px;">
                            å…³é—­
                        </button>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // ç»‘å®šæŒ‰é’®äº‹ä»¶
                if (canResearch) {
                    modal.querySelector('#confirm-research').addEventListener('click', () => {
                        this.startResearch(tech);
                        modal.remove();
                    });
                } else {
                    modal.querySelector('#close-research').addEventListener('click', () => {
                        modal.remove();
                        if (tech.require.length > 0) {
                            this.showNotification('æœªæ»¡è¶³å‰ç½®ç§‘æŠ€æ¡ä»¶', 'warning');
                        } else {
                            this.showNotification('ææ–™ä¸è¶³ï¼Œæ— æ³•ç ”ç©¶', 'danger');
                        }
                    });
                }
                
                modal.querySelector('#cancel-research').addEventListener('click', () => {
                    modal.remove();
                });
                
                // ç‚¹å‡»å¤–éƒ¨å…³é—­
                setTimeout(() => {
                    const closeHandler = (e) => {
                        if (!modal.contains(e.target) && !e.target.closest('.tech-item')) {
                            modal.remove();
                            document.removeEventListener('click', closeHandler);
                        }
                    };
                    document.addEventListener('click', closeHandler);
                }, 100);
            }
            
            startResearch(tech) {
                // æ‰£é™¤ææ–™
                this.resources['ææ–™'].amount -= tech.cost;
                
                // æ·»åŠ åˆ°ç ”ç©¶ä¸­
                this.gameState.tech.add(tech.id);
                
                // æ˜¾ç¤ºé€šçŸ¥
                this.showNotification(`å¼€å§‹ç ”ç©¶ ${tech.name}ï¼Œéœ€è¦${tech.time}å°æ—¶`, 'success');
                
                // æ›´æ–°UI
                this.updateUI();
                this.checkAchievement('tech_master');
                
                // æ¨¡æ‹Ÿç ”ç©¶å®Œæˆï¼ˆå®é™…åº”è¯¥ç”¨æ¸¸æˆæ—¶é—´ï¼‰
                setTimeout(() => {
                    this.showNotification(`${tech.name} ç ”ç©¶å®Œæˆï¼ğŸ‰`, 'success');
                    this.applyTechEffect(tech.id);
                    this.updateUI();
                }, tech.time * 1000 * (1 / this.gameState.settings.speed)); // æ ¹æ®æ¸¸æˆé€Ÿåº¦è°ƒæ•´
                
                this.playSound('success');
            }
            
            applyTechEffect(techId) {
                switch(techId) {
                    case 'basic_farming':
                        this.resources['é£Ÿç‰©'].prod *= 1.2;
                        break;
                    case 'water_purify':
                        this.resources['æ°´'].cons *= 0.7;
                        break;
                    case 'advanced_defense':
                        this.gameState.threat = Math.max(1, this.gameState.threat - 2);
                        break;
                    case 'solar_power':
                        this.resources['ç”µåŠ›'].prod += 15;
                        break;
                    case 'advanced_medicine':
                        this.survivors.forEach(s => s.health = Math.min(100, s.health + 20));
                        break;
                    case 'reinforced_structure':
                        this.buildings.forEach(b => b.efficiency *= 1.3);
                        break;
                    case 'hydroponics':
                        this.resources['é£Ÿç‰©'].prod += 5;
                        this.resources['æ°´'].cons += 2;
                        break;
                    case 'recycling':
                        Object.values(this.resources).forEach(r => {
                            if (r.cons > 0) r.cons *= 0.75;
                        });
                        break;
                    case 'surveillance':
                        this.addEvent('ç›‘æ§ç³»ç»Ÿå·²å¯ç”¨ï¼Œå¨èƒé¢„è­¦èƒ½åŠ›æå‡', 'success');
                        break;
                    case 'education':
                        this.survivors.forEach(s => {
                            if (s.experience < 100) s.experience += 20;
                        });
                        break;
                    case 'automation':
                        this.buildings.forEach(b => {
                            if (b.workers.length > 0) b.workers.pop();
                        });
                        break;
                    case 'biotech':
                        this.survivors.forEach(s => {
                            s.health = Math.min(100, s.health + 30);
                            s.energy = Math.min(100, s.energy + 30);
                        });
                        break;
                }
            }
            
            // ====== æˆå°±ç³»ç»Ÿ ======
            checkAchievements() {
                this.achievementList.forEach(achievement => {
                    if (!this.gameState.achievements.has(achievement.id) && achievement.condition()) {
                        this.unlockAchievement(achievement.id);
                    }
                });
            }
            
            checkAchievement(achievementId) {
                const achievement = this.achievementList.find(a => a.id === achievementId);
                if (achievement && !this.gameState.achievements.has(achievementId) && achievement.condition()) {
                    this.unlockAchievement(achievementId);
                }
            }
            
            unlockAchievement(achievementId) {
                const achievement = this.achievementList.find(a => a.id === achievementId);
                if (achievement && !this.gameState.achievements.has(achievementId)) {
                    this.gameState.achievements.add(achievementId);
                    this.addEvent(`ğŸ† æˆå°±è§£é”ï¼š${achievement.name} - ${achievement.desc}`, 'success');
                    
                    // æˆå°±å¥–åŠ±
                    switch(achievementId) {
                        case 'first_light':
                            this.resources['ææ–™'].amount += 50;
                            break;
                        case 'dawn_breaker':
                            this.gameState.morale += 20;
                            break;
                        case 'ark_heart':
                            this.resources['é£Ÿç‰©'].amount += 100;
                            this.resources['æ°´'].amount += 80;
                            break;
                        case 'civilization_spark':
                            this.gameState.tech.add('education');
                            break;
                        case 'legend':
                            this.addEvent('ğŸ‰ æ­å–œè¾¾æˆå…¨æˆå°±ï¼ä½ æ˜¯çœŸæ­£çš„åºŸåœŸä¼ å¥‡ï¼', 'success');
                            break;
                    }
                    
                    this.updateAchievements();
                    this.saveGame();
                }
            }
            
            showAchievements() {
                this.updateAchievements();
                document.getElementById('achievements-modal').style.display = 'flex';
            }
            
            // ====== è®¾ç½®ç³»ç»Ÿ ======
            showSettings() {
                document.getElementById('settings-modal').style.display = 'flex';
            }
            
            // ====== å¿«æ·èœå• ======
            showQuickMenu() {
                const menu = document.createElement('div');
                menu.style.cssText = `
                    position: fixed;
                    bottom: 50px;
                    right: 10px;
                    background: #2c3e50;
                    border: 2px solid #3498db;
                    border-radius: 10px;
                    padding: 10px;
                    z-index: 1000;
                    min-width: 140px;
                    box-shadow: 0 5px 20px rgba(0,0,0,0.3);
                    animation: fadeIn 0.2s ease;
                `;
                
                menu.innerHTML = `
                    <div style="color: #3498db; font-weight: bold; margin-bottom: 8px; text-align: center; font-size: 12px;">å¿«æ·èœå•</div>
                    <button class="btn btn-small" onclick="game.showResearchModal('basic_farming')" style="width: 100%; margin: 3px 0; padding: 5px; font-size: 10px;">
                        ğŸ”¬ ç ”ç©¶å†œä¸š
                    </button>
                    <button class="btn btn-small" onclick="game.recruitSurvivor()" style="width: 100%; margin: 3px 0; padding: 5px; font-size: 10px;">
                        ğŸ“¢ æ‹›å‹Ÿå¹¸å­˜è€…
                    </button>
                    <button class="btn btn-small" onclick="game.showAchievements()" style="width: 100%; margin: 3px 0; padding: 5px; font-size: 10px;">
                        ğŸ† æŸ¥çœ‹æˆå°±
                    </button>
                    <button class="btn btn-small" onclick="game.toggleExplorePanel()" style="width: 100%; margin: 3px 0; padding: 5px; font-size: 10px;">
                        ğŸ§­ æ¢ç´¢åœ°ç‚¹
                    </button>
                    <button class="btn btn-small btn-danger" onclick="this.parentElement.remove()" style="width: 100%; margin: 3px 0; padding: 5px; font-size: 10px;">
                        å…³é—­èœå•
                    </button>
                `;
                
                document.body.appendChild(menu);
                
                // ç‚¹å‡»å¤–éƒ¨å…³é—­
                setTimeout(() => {
                    const closeHandler = (e) => {
                        if (!menu.contains(e.target) && e.target.id !== 'quick-menu') {
                            menu.remove();
                            document.removeEventListener('click', closeHandler);
                        }
                    };
                    document.addEventListener('click', closeHandler);
                }, 100);
            }
            
            // ====== éšæœºäº‹ä»¶ ======
            randomEvent() {
                const events = [
                    { 
                        message: 'ğŸŒ§ï¸ ä¸‹äº†ä¸€åœºé›¨ï¼Œæ”¶é›†åˆ°ä¸€äº›å¹²å‡€çš„æ°´', 
                        effect: () => this.resources['æ°´'].amount += 30 
                    },
                    { 
                        message: 'ğŸ å‘ç°äº†åºŸå¼ƒçš„ç‰©èµ„ç®±', 
                        effect: () => {
                            this.resources['ææ–™'].amount += 20;
                            this.resources['é£Ÿç‰©'].amount += 15;
                        }
                    },
                    { 
                        message: 'ğŸ¤¢ æœ‰äººé£Ÿç‰©ä¸­æ¯’äº†', 
                        effect: () => {
                            const s = this.survivors[Math.floor(Math.random() * this.survivors.length)];
                            s.health -= 20;
                            s.hunger += 30;
                        }
                    },
                    { 
                        message: 'ğŸ’Š æ‰¾åˆ°äº†åŒ»ç–—ç”¨å“', 
                        effect: () => this.resources['è¯å“'].amount += 25 
                    },
                    { 
                        message: 'ğŸ”§ æ”¹è¿›äº†ç”Ÿäº§è®¾å¤‡ï¼Œæ•ˆç‡æå‡', 
                        effect: () => {
                            this.resources['ææ–™'].prod += 1;
                            this.resources['é£Ÿç‰©'].prod += 0.5;
                        }
                    },
                    { 
                        message: 'âš¡ å¤ªé˜³èƒ½æ¿æ•ˆç‡æå‡', 
                        effect: () => {
                            if (this.gameState.tech.has('solar_power')) {
                                this.resources['ç”µåŠ›'].prod += 5;
                            }
                        }
                    },
                    { 
                        message: 'ğŸŒ± å†œä½œç‰©ä¸°æ”¶', 
                        effect: () => {
                            this.resources['é£Ÿç‰©'].amount += 40;
                            if (this.gameState.tech.has('basic_farming')) {
                                this.resources['é£Ÿç‰©'].amount += 20;
                            }
                        }
                    },
                    { 
                        message: 'ğŸ› ï¸ å¹¸å­˜è€…å­¦ä¼šäº†æ–°æŠ€èƒ½', 
                        effect: () => {
                            const s = this.survivors[Math.floor(Math.random() * this.survivors.length)];
                            s.experience += 25;
                            if (s.experience >= 100) {
                                s.level++;
                                s.experience = 0;
                                this.addEvent(`${s.name}å‡çº§åˆ°${s.level}çº§ï¼`, 'success');
                            }
                        }
                    }
                ];
                
                const event = events[Math.floor(Math.random() * events.length)];
                this.addEvent(event.message, 'info');
                event.effect();
            }
            
            // ====== ç”»å¸ƒç»˜åˆ¶ ======
            drawBase() {
                if (!this.ctx) return;
                
                const ctx = this.ctx;
                const width = this.canvas.width;
                const height = this.canvas.height;
                
                // æ¸…é™¤ç”»å¸ƒ
                ctx.clearRect(0, 0, width, height);
                
                // ç»˜åˆ¶èƒŒæ™¯
                ctx.fillStyle = '#1a1a2e';
                ctx.fillRect(0, 0, width, height);
                
                // ç»˜åˆ¶ç½‘æ ¼
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
                ctx.lineWidth = 1;
                const gridSize = 40;
                for (let x = 0; x < width; x += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, height);
                    ctx.stroke();
                }
                for (let y = 0; y < height; y += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(width, y);
                    ctx.stroke();
                }
                
                // ç»˜åˆ¶åŸºåœ°è¾¹ç•Œ
                ctx.strokeStyle = 'rgba(52, 152, 219, 0.3)';
                ctx.lineWidth = 2;
                ctx.setLineDash([10, 5]);
                ctx.strokeRect(20, 20, width - 40, height - 40);
                ctx.setLineDash([]);
                
                // ç»˜åˆ¶å»ºç­‘
                this.buildings.forEach(building => {
                    this.drawBuilding(building);
                });
                
                // ç»˜åˆ¶æ•Œäºº
                this.enemies.forEach(enemy => {
                    this.drawEnemy(enemy);
                });
            }
            
            drawBuilding(building) {
                const ctx = this.ctx;
                const scale = this.canvas.width / 600;
                const x = building.x * scale;
                const y = building.y * scale;
                const size = 45 * scale;
                
                // å»ºç­‘é¢œè‰²
                const colors = {
                    'æŒ‡æŒ¥ä¸­å¿ƒ': '#3498db', 'å®¿èˆ': '#2ecc71', 'å¨æˆ¿': '#e74c3c',
                    'åŒ»ç–—ç«™': '#9b59b6', 'ç­æœ›å¡”': '#f1c40f', 'ä»“åº“': '#95a5a6',
                    'ç ”ç©¶æ‰€': '#1abc9c', 'æ°´å¤„ç†å‚': '#3498db', 'å‘ç”µç«™': '#f39c12',
                    'è®­ç»ƒåœº': '#e74c3c', 'å†œåœº': '#2ecc71', 'å›´å¢™': '#7f8c8d',
                    'å“¨å¡”': '#d35400', 'å·¥åŠ': '#34495e', 'å¨±ä¹å®¤': '#8e44ad',
                    'é€šè®¯ç«™': '#2980b9', 'å†›æ¢°åº“': '#c0392b', 'æ¸©å®¤': '#27ae60'
                };
                
                // å»ºç­‘ä¸»ä½“
                ctx.fillStyle = colors[building.type] || '#34495e';
                ctx.fillRect(x, y, size, size);
                
                // è¾¹æ¡†
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = 1.5;
                ctx.strokeRect(x, y, size, size);
                
                // å»ºç­‘å›¾æ ‡
                const icon = this.getBuildingEmoji(building.type);
                ctx.fillStyle = 'white';
                ctx.font = `${16 * scale}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(icon, x + size/2, y + size/2);
                
                // ç­‰çº§
                ctx.font = `${8 * scale}px Arial`;
                ctx.fillText(`Lv.${building.level}`, x + size/2, y + size + 12 * scale);
                
                // å·¥äººæŒ‡ç¤º
                if (building.workers.length > 0) {
                    ctx.fillStyle = '#2ecc71';
                    ctx.beginPath();
                    ctx.arc(x + size - 6 * scale, y + 6 * scale, 4 * scale, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            drawEnemy(enemy) {
                if (!enemy) return;
                
                const ctx = this.ctx;
                const scale = this.canvas.width / 600;
                const x = enemy.x * scale;
                const y = enemy.y * scale;
                const size = 25 * scale;
                
                // æ•Œäººä¸»ä½“
                ctx.fillStyle = '#e74c3c';
                ctx.beginPath();
                ctx.arc(x, y, size/2, 0, Math.PI * 2);
                ctx.fill();
                
                // æ•Œäººå›¾æ ‡
                ctx.fillStyle = 'white';
                ctx.font = `${12 * scale}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(enemy.icon, x, y);
                
                // è¡€æ¡
                const healthPercent = enemy.health / enemy.maxHealth;
                ctx.fillStyle = '#e74c3c';
                ctx.fillRect(x - size/2, y - size - 4, size, 3);
                ctx.fillStyle = '#2ecc71';
                ctx.fillRect(x - size/2, y - size - 4, size * healthPercent, 3);
            }
        }

        // ====== æ¸¸æˆå¯åŠ¨ ======
        let game;
        
        document.addEventListener('DOMContentLoaded', () => {
            // åˆ›å»ºæ¸¸æˆå®ä¾‹
            game = new SurvivalGame();
            window.game = game; // æ–¹ä¾¿è°ƒè¯•
            
            // æ·»åŠ PWAå®‰è£…æç¤º
            if ('serviceWorker' in navigator && 'PushManager' in window) {
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    const installBtn = document.createElement('button');
                    installBtn.innerHTML = 'ğŸ“± æ·»åŠ åˆ°æ¡Œé¢';
                    installBtn.className = 'btn btn-success';
                    installBtn.style.cssText = 'position: fixed; top: 10px; right: 10px; z-index: 9999;';
                    installBtn.addEventListener('click', () => {
                        e.prompt();
                        installBtn.remove();
                    });
                    document.body.appendChild(installBtn);
                    
                    setTimeout(() => installBtn.remove(), 10000);
                });
            }
            
            console.log('ğŸ° ã€ŠåºŸåœŸæ–¹èˆŸã€‹å·²å¯åŠ¨ï¼');
            console.log('ğŸ® ç‰ˆæœ¬: 1.0 (PWAæ‰‹æœºä¼˜åŒ–ç‰ˆ)');
            console.log('ğŸ“± é€‚é…: æ‰‹æœºç«–å±å…¨å±');
            console.log('ğŸµ åŠŸèƒ½: èƒŒæ™¯éŸ³ä¹/éŸ³æ•ˆç³»ç»Ÿ');
            console.log('ğŸ† åŒ…å«: 25ä¸ªæˆå°±ç³»ç»Ÿ');
            console.log('ğŸ”¬ ç§‘æŠ€: 12é¡¹ç ”ç©¶é¡¹ç›®');
            console.log('ğŸ—ï¸ å»ºç­‘: 18ç§å»ºç­‘ç±»å‹');
            console.log('ğŸ‘¥ å¹¸å­˜è€…: 50+éšæœºåå­—');
        });

        // ====== PWA Service Worker æ³¨å†Œ ======
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(err => {
                    console.log('Service Worker æ³¨å†Œå¤±è´¥:', err);
                });
            });
        }
    </script>
        <link rel="stylesheet" href="manifest.json">
        <script src="sw.js"></script>
</body>

</html>
